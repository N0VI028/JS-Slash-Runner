import*as e from"../../../../../lib/jszip.min.js";import{Generate as t,MAX_INJECTION_DEPTH as n,activateSendButtons as i,addOneMessage as r,baseChatReplace as s,characters as a,chat as o,chat_metadata as c,cleanUpMessage as l,countOccurrences as u,deactivateSendButtons as d,eventSource as p,event_types as h,extension_prompt_roles as f,extension_prompt_types as m,getBiasStrings as g,getCharacterCardFields as v,getCurrentChatId as y,getExtensionPromptByName as b,getExtensionPromptRoleByName as w,getMaxContextSize as k,getOneCharacter as S,getPastCharacterChats as E,getRequestHeaders as I,getThumbnailUrl as x,isOdd as T,messageFormatting as O,name1 as A,name2 as N,online_status as C,reloadCurrentChat as D,reloadMarkdownProcessor as L,saveCharacterDebounced as R,saveChatConditional as j,saveMetadata as P,saveSettings as U,saveSettingsDebounced as M,setExtensionPrompt as z,setGenerationProgress as F,showSwipeButtons as B,stopGeneration as G,substituteParams as V,substituteParamsExtended as Z,system_message_types as q,this_chid as H,updateMessageBlock as W,user_avatar as J}from"../../../../../script.js";import{extensionTypes as K,extension_settings as Y,getContext as X,renderExtensionTemplateAsync as Q,saveMetadataDebounced as ee,writeExtensionField as te}from"../../../../../scripts/extensions.js";import{POPUP_TYPE as ne,callGenericPopup as ie}from"../../../../../scripts/popup.js";import{isMobile as re}from"../../../../../scripts/RossAscends-mods.js";import{Stopwatch as se,download as ae,ensureImageFormatSupported as oe,getBase64Async as ce,getCharaFilename as le,getSortableDelay as ue,isDataURL as de,loadFileToDocument as pe,showFontAwesomePicker as he,uuidv4 as fe}from"../../../../../scripts/utils.js";import{MacrosParser as me,getLastMessageId as ge}from"../../../../../scripts/macros.js";import{ChatCompletion as ve,Message as ye,MessageCollection as _e,chat_completion_sources as be,isImageInliningSupported as we,oai_settings as $e,prepareOpenAIMessages as ke,promptManager as Se,sendOpenAIRequest as Ee,setOpenAIMessageExamples as Ie,setOpenAIMessages as xe,setupChatCompletionPromptManager as Te}from"../../../../../scripts/openai.js";import{getTokenCountAsync as Oe}from"../../../../../scripts/tokenizers.js";import{getRegexedString as Ae,regex_placement as Ne}from"../../../../../scripts/extensions/regex/engine.js";import{SlashCommandParser as Ce}from"../../../../../scripts/slash-commands/SlashCommandParser.js";import{flushEphemeralStoppingStrings as De,persona_description_positions as Le,power_user as Re}from"../../../../../scripts/power-user.js";import{METADATA_KEY as je,createNewWorldInfo as Pe,deleteWorldInfo as Ue,getWorldInfoPrompt as Me,getWorldInfoSettings as ze,loadWorldInfo as Fe,parseRegexFromString as Be,saveWorldInfo as Ge,selected_world_info as Ve,setWorldInfoButtonClass as Ze,wi_anchor_position as qe,world_info as He,world_info_include_names as We,world_names as Je}from"../../../../../scripts/world-info.js";import{NOTE_MODULE_NAME as Ke,metadata_keys as Ye,shouldWIAddPrompt as Xe}from"../../../../../scripts/authors-note.js";import{Prompt as Qe,PromptCollection as et}from"../../../../../scripts/PromptManager.js";import{t as tt}from"../../../../../scripts/i18n.js";import{getPresetManager as nt}from"../../../../../scripts/preset-manager.js";import{executeSlashCommandsWithOptions as it}from"../../../../../scripts/slash-commands.js";import{SlashCommand as rt}from"../../../../../scripts/slash-commands/SlashCommand.js";import{ARGUMENT_TYPE as st,SlashCommandArgument as at,SlashCommandNamedArgument as ot}from"../../../../../scripts/slash-commands/SlashCommandArgument.js";import{commonEnumProviders as ct,enumIcons as lt}from"../../../../../scripts/slash-commands/SlashCommandCommonEnumsProvider.js";import{SlashCommandEnumValue as ut,enumTypes as dt}from"../../../../../scripts/slash-commands/SlashCommandEnumValue.js";var pt={176:function(e){
/*!***************************************************
* mark.js v8.11.1
* https://markjs.io/
* Copyright (c) 2014–2018, Julian Kühnel
* Released under the MIT license https://git.io/vwTVl
*****************************************************/
e.exports=function(){var e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},t=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},n=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),i=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},r=function(){function e(n){var i=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:5e3;t(this,e),this.ctx=n,this.iframes=i,this.exclude=r,this.iframesTimeout=s}return n(e,[{key:"getContexts",value:function(){var e=[];return(void 0!==this.ctx&&this.ctx?NodeList.prototype.isPrototypeOf(this.ctx)?Array.prototype.slice.call(this.ctx):Array.isArray(this.ctx)?this.ctx:"string"==typeof this.ctx?Array.prototype.slice.call(document.querySelectorAll(this.ctx)):[this.ctx]:[]).forEach(function(t){var n=e.filter(function(e){return e.contains(t)}).length>0;-1!==e.indexOf(t)||n||e.push(t)}),e}},{key:"getIframeContents",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(){},i=void 0;try{var r=e.contentWindow;if(i=r.document,!r||!i)throw new Error("iframe inaccessible")}catch(e){n()}i&&t(i)}},{key:"isIframeBlank",value:function(e){var t="about:blank",n=e.getAttribute("src").trim();return e.contentWindow.location.href===t&&n!==t&&n}},{key:"observeIframeLoad",value:function(e,t,n){var i=this,r=!1,s=null,a=function a(){if(!r){r=!0,clearTimeout(s);try{i.isIframeBlank(e)||(e.removeEventListener("load",a),i.getIframeContents(e,t,n))}catch(e){n()}}};e.addEventListener("load",a),s=setTimeout(a,this.iframesTimeout)}},{key:"onIframeReady",value:function(e,t,n){try{"complete"===e.contentWindow.document.readyState?this.isIframeBlank(e)?this.observeIframeLoad(e,t,n):this.getIframeContents(e,t,n):this.observeIframeLoad(e,t,n)}catch(e){n()}}},{key:"waitForIframes",value:function(e,t){var n=this,i=0;this.forEachIframe(e,function(){return!0},function(e){i++,n.waitForIframes(e.querySelector("html"),function(){--i||t()})},function(e){e||t()})}},{key:"forEachIframe",value:function(t,n,i){var r=this,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:function(){},a=t.querySelectorAll("iframe"),o=a.length,c=0;a=Array.prototype.slice.call(a);var l=function(){--o<=0&&s(c)};o||l(),a.forEach(function(t){e.matches(t,r.exclude)?l():r.onIframeReady(t,function(e){n(t)&&(c++,i(e)),l()},l)})}},{key:"createIterator",value:function(e,t,n){return document.createNodeIterator(e,t,n,!1)}},{key:"createInstanceOnIframe",value:function(t){return new e(t.querySelector("html"),this.iframes)}},{key:"compareNodeIframe",value:function(e,t,n){if(e.compareDocumentPosition(n)&Node.DOCUMENT_POSITION_PRECEDING){if(null===t)return!0;if(t.compareDocumentPosition(n)&Node.DOCUMENT_POSITION_FOLLOWING)return!0}return!1}},{key:"getIteratorNode",value:function(e){var t=e.previousNode();return{prevNode:t,node:(null===t||e.nextNode())&&e.nextNode()}}},{key:"checkIframeFilter",value:function(e,t,n,i){var r=!1,s=!1;return i.forEach(function(e,t){e.val===n&&(r=t,s=e.handled)}),this.compareNodeIframe(e,t,n)?(!1!==r||s?!1===r||s||(i[r].handled=!0):i.push({val:n,handled:!0}),!0):(!1===r&&i.push({val:n,handled:!1}),!1)}},{key:"handleOpenIframes",value:function(e,t,n,i){var r=this;e.forEach(function(e){e.handled||r.getIframeContents(e.val,function(e){r.createInstanceOnIframe(e).forEachNode(t,n,i)})})}},{key:"iterateThroughNodes",value:function(e,t,n,i,r){for(var s=this,a=this.createIterator(t,e,i),o=[],c=[],l=void 0,u=void 0,d=function(){var e=s.getIteratorNode(a);return u=e.prevNode,l=e.node};d();)this.iframes&&this.forEachIframe(t,function(e){return s.checkIframeFilter(l,u,e,o)},function(t){s.createInstanceOnIframe(t).forEachNode(e,function(e){return c.push(e)},i)}),c.push(l);c.forEach(function(e){n(e)}),this.iframes&&this.handleOpenIframes(o,e,n,i),r()}},{key:"forEachNode",value:function(e,t,n){var i=this,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:function(){},s=this.getContexts(),a=s.length;a||r(),s.forEach(function(s){var o=function(){i.iterateThroughNodes(e,s,t,n,function(){--a<=0&&r()})};i.iframes?i.waitForIframes(s,o):o()})}}],[{key:"matches",value:function(e,t){var n="string"==typeof t?[t]:t,i=e.matches||e.matchesSelector||e.msMatchesSelector||e.mozMatchesSelector||e.oMatchesSelector||e.webkitMatchesSelector;if(i){var r=!1;return n.every(function(t){return!i.call(e,t)||(r=!0,!1)}),r}return!1}}]),e}(),s=function(){function s(e){t(this,s),this.ctx=e,this.ie=!1;var n=window.navigator.userAgent;(n.indexOf("MSIE")>-1||n.indexOf("Trident")>-1)&&(this.ie=!0)}return n(s,[{key:"log",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"debug",i=this.opt.log;this.opt.debug&&"object"===(void 0===i?"undefined":e(i))&&"function"==typeof i[n]&&i[n]("mark.js: "+t)}},{key:"escapeStr",value:function(e){return e.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")}},{key:"createRegExp",value:function(e){return"disabled"!==this.opt.wildcards&&(e=this.setupWildcardsRegExp(e)),e=this.escapeStr(e),Object.keys(this.opt.synonyms).length&&(e=this.createSynonymsRegExp(e)),(this.opt.ignoreJoiners||this.opt.ignorePunctuation.length)&&(e=this.setupIgnoreJoinersRegExp(e)),this.opt.diacritics&&(e=this.createDiacriticsRegExp(e)),e=this.createMergedBlanksRegExp(e),(this.opt.ignoreJoiners||this.opt.ignorePunctuation.length)&&(e=this.createJoinersRegExp(e)),"disabled"!==this.opt.wildcards&&(e=this.createWildcardsRegExp(e)),e=this.createAccuracyRegExp(e)}},{key:"createSynonymsRegExp",value:function(e){var t=this.opt.synonyms,n=this.opt.caseSensitive?"":"i",i=this.opt.ignoreJoiners||this.opt.ignorePunctuation.length?"\0":"";for(var r in t)if(t.hasOwnProperty(r)){var s=t[r],a="disabled"!==this.opt.wildcards?this.setupWildcardsRegExp(r):this.escapeStr(r),o="disabled"!==this.opt.wildcards?this.setupWildcardsRegExp(s):this.escapeStr(s);""!==a&&""!==o&&(e=e.replace(new RegExp("("+this.escapeStr(a)+"|"+this.escapeStr(o)+")","gm"+n),i+"("+this.processSynomyms(a)+"|"+this.processSynomyms(o)+")"+i))}return e}},{key:"processSynomyms",value:function(e){return(this.opt.ignoreJoiners||this.opt.ignorePunctuation.length)&&(e=this.setupIgnoreJoinersRegExp(e)),e}},{key:"setupWildcardsRegExp",value:function(e){return(e=e.replace(/(?:\\)*\?/g,function(e){return"\\"===e.charAt(0)?"?":""})).replace(/(?:\\)*\*/g,function(e){return"\\"===e.charAt(0)?"*":""})}},{key:"createWildcardsRegExp",value:function(e){var t="withSpaces"===this.opt.wildcards;return e.replace(/\u0001/g,t?"[\\S\\s]?":"\\S?").replace(/\u0002/g,t?"[\\S\\s]*?":"\\S*")}},{key:"setupIgnoreJoinersRegExp",value:function(e){return e.replace(/[^(|)\\]/g,function(e,t,n){var i=n.charAt(t+1);return/[(|)\\]/.test(i)||""===i?e:e+"\0"})}},{key:"createJoinersRegExp",value:function(e){var t=[],n=this.opt.ignorePunctuation;return Array.isArray(n)&&n.length&&t.push(this.escapeStr(n.join(""))),this.opt.ignoreJoiners&&t.push("\\u00ad\\u200b\\u200c\\u200d"),t.length?e.split(/\u0000+/).join("["+t.join("")+"]*"):e}},{key:"createDiacriticsRegExp",value:function(e){var t=this.opt.caseSensitive?"":"i",n=this.opt.caseSensitive?["aàáảãạăằắẳẵặâầấẩẫậäåāą","AÀÁẢÃẠĂẰẮẲẴẶÂẦẤẨẪẬÄÅĀĄ","cçćč","CÇĆČ","dđď","DĐĎ","eèéẻẽẹêềếểễệëěēę","EÈÉẺẼẸÊỀẾỂỄỆËĚĒĘ","iìíỉĩịîïī","IÌÍỈĨỊÎÏĪ","lł","LŁ","nñňń","NÑŇŃ","oòóỏõọôồốổỗộơởỡớờợöøō","OÒÓỎÕỌÔỒỐỔỖỘƠỞỠỚỜỢÖØŌ","rř","RŘ","sšśșş","SŠŚȘŞ","tťțţ","TŤȚŢ","uùúủũụưừứửữựûüůū","UÙÚỦŨỤƯỪỨỬỮỰÛÜŮŪ","yýỳỷỹỵÿ","YÝỲỶỸỴŸ","zžżź","ZŽŻŹ"]:["aàáảãạăằắẳẵặâầấẩẫậäåāąAÀÁẢÃẠĂẰẮẲẴẶÂẦẤẨẪẬÄÅĀĄ","cçćčCÇĆČ","dđďDĐĎ","eèéẻẽẹêềếểễệëěēęEÈÉẺẼẸÊỀẾỂỄỆËĚĒĘ","iìíỉĩịîïīIÌÍỈĨỊÎÏĪ","lłLŁ","nñňńNÑŇŃ","oòóỏõọôồốổỗộơởỡớờợöøōOÒÓỎÕỌÔỒỐỔỖỘƠỞỠỚỜỢÖØŌ","rřRŘ","sšśșşSŠŚȘŞ","tťțţTŤȚŢ","uùúủũụưừứửữựûüůūUÙÚỦŨỤƯỪỨỬỮỰÛÜŮŪ","yýỳỷỹỵÿYÝỲỶỸỴŸ","zžżźZŽŻŹ"],i=[];return e.split("").forEach(function(r){n.every(function(n){if(-1!==n.indexOf(r)){if(i.indexOf(n)>-1)return!1;e=e.replace(new RegExp("["+n+"]","gm"+t),"["+n+"]"),i.push(n)}return!0})}),e}},{key:"createMergedBlanksRegExp",value:function(e){return e.replace(/[\s]+/gim,"[\\s]+")}},{key:"createAccuracyRegExp",value:function(e){var t=this,n="!\"#$%&'()*+,-./:;<=>?@[\\]^_`{|}~¡¿",i=this.opt.accuracy,r="string"==typeof i?i:i.value,s="string"==typeof i?[]:i.limiters,a="";switch(s.forEach(function(e){a+="|"+t.escapeStr(e)}),r){case"partially":default:return"()("+e+")";case"complementary":return"()([^"+(a="\\s"+(a||this.escapeStr(n)))+"]*"+e+"[^"+a+"]*)";case"exactly":return"(^|\\s"+a+")("+e+")(?=$|\\s"+a+")"}}},{key:"getSeparatedKeywords",value:function(e){var t=this,n=[];return e.forEach(function(e){t.opt.separateWordSearch?e.split(" ").forEach(function(e){e.trim()&&-1===n.indexOf(e)&&n.push(e)}):e.trim()&&-1===n.indexOf(e)&&n.push(e)}),{keywords:n.sort(function(e,t){return t.length-e.length}),length:n.length}}},{key:"isNumeric",value:function(e){return Number(parseFloat(e))==e}},{key:"checkRanges",value:function(e){var t=this;if(!Array.isArray(e)||"[object Object]"!==Object.prototype.toString.call(e[0]))return this.log("markRanges() will only accept an array of objects"),this.opt.noMatch(e),[];var n=[],i=0;return e.sort(function(e,t){return e.start-t.start}).forEach(function(e){var r=t.callNoMatchOnInvalidRanges(e,i),s=r.start,a=r.end;r.valid&&(e.start=s,e.length=a-s,n.push(e),i=a)}),n}},{key:"callNoMatchOnInvalidRanges",value:function(e,t){var n=void 0,i=void 0,r=!1;return e&&void 0!==e.start?(i=(n=parseInt(e.start,10))+parseInt(e.length,10),this.isNumeric(e.start)&&this.isNumeric(e.length)&&i-t>0&&i-n>0?r=!0:(this.log("Ignoring invalid or overlapping range: "+JSON.stringify(e)),this.opt.noMatch(e))):(this.log("Ignoring invalid range: "+JSON.stringify(e)),this.opt.noMatch(e)),{start:n,end:i,valid:r}}},{key:"checkWhitespaceRanges",value:function(e,t,n){var i=void 0,r=!0,s=n.length,a=t-s,o=parseInt(e.start,10)-a;return(i=(o=o>s?s:o)+parseInt(e.length,10))>s&&(i=s,this.log("End range automatically set to the max value of "+s)),o<0||i-o<0||o>s||i>s?(r=!1,this.log("Invalid range: "+JSON.stringify(e)),this.opt.noMatch(e)):""===n.substring(o,i).replace(/\s+/g,"")&&(r=!1,this.log("Skipping whitespace only range: "+JSON.stringify(e)),this.opt.noMatch(e)),{start:o,end:i,valid:r}}},{key:"getTextNodes",value:function(e){var t=this,n="",i=[];this.iterator.forEachNode(NodeFilter.SHOW_TEXT,function(e){i.push({start:n.length,end:(n+=e.textContent).length,node:e})},function(e){return t.matchesExclude(e.parentNode)?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT},function(){e({value:n,nodes:i})})}},{key:"matchesExclude",value:function(e){return r.matches(e,this.opt.exclude.concat(["script","style","title","head","html"]))}},{key:"wrapRangeInTextNode",value:function(e,t,n){var i=this.opt.element?this.opt.element:"mark",r=e.splitText(t),s=r.splitText(n-t),a=document.createElement(i);return a.setAttribute("data-markjs","true"),this.opt.className&&a.setAttribute("class",this.opt.className),a.textContent=r.textContent,r.parentNode.replaceChild(a,r),s}},{key:"wrapRangeInMappedTextNode",value:function(e,t,n,i,r){var s=this;e.nodes.every(function(a,o){var c=e.nodes[o+1];if(void 0===c||c.start>t){if(!i(a.node))return!1;var l=t-a.start,u=(n>a.end?a.end:n)-a.start,d=e.value.substr(0,a.start),p=e.value.substr(u+a.start);if(a.node=s.wrapRangeInTextNode(a.node,l,u),e.value=d+p,e.nodes.forEach(function(t,n){n>=o&&(e.nodes[n].start>0&&n!==o&&(e.nodes[n].start-=u),e.nodes[n].end-=u)}),n-=u,r(a.node.previousSibling,a.start),!(n>a.end))return!1;t=a.end}return!0})}},{key:"wrapMatches",value:function(e,t,n,i,r){var s=this,a=0===t?0:t+1;this.getTextNodes(function(t){t.nodes.forEach(function(t){t=t.node;for(var r=void 0;null!==(r=e.exec(t.textContent))&&""!==r[a];)if(n(r[a],t)){var o=r.index;if(0!==a)for(var c=1;c<a;c++)o+=r[c].length;t=s.wrapRangeInTextNode(t,o,o+r[a].length),i(t.previousSibling),e.lastIndex=0}}),r()})}},{key:"wrapMatchesAcrossElements",value:function(e,t,n,i,r){var s=this,a=0===t?0:t+1;this.getTextNodes(function(t){for(var o=void 0;null!==(o=e.exec(t.value))&&""!==o[a];){var c=o.index;if(0!==a)for(var l=1;l<a;l++)c+=o[l].length;var u=c+o[a].length;s.wrapRangeInMappedTextNode(t,c,u,function(e){return n(o[a],e)},function(t,n){e.lastIndex=n,i(t)})}r()})}},{key:"wrapRangeFromIndex",value:function(e,t,n,i){var r=this;this.getTextNodes(function(s){var a=s.value.length;e.forEach(function(e,i){var o=r.checkWhitespaceRanges(e,a,s.value),c=o.start,l=o.end;o.valid&&r.wrapRangeInMappedTextNode(s,c,l,function(n){return t(n,e,s.value.substring(c,l),i)},function(t){n(t,e)})}),i()})}},{key:"unwrapMatches",value:function(e){for(var t=e.parentNode,n=document.createDocumentFragment();e.firstChild;)n.appendChild(e.removeChild(e.firstChild));t.replaceChild(n,e),this.ie?this.normalizeTextNode(t):t.normalize()}},{key:"normalizeTextNode",value:function(e){if(e){if(3===e.nodeType)for(;e.nextSibling&&3===e.nextSibling.nodeType;)e.nodeValue+=e.nextSibling.nodeValue,e.parentNode.removeChild(e.nextSibling);else this.normalizeTextNode(e.firstChild);this.normalizeTextNode(e.nextSibling)}}},{key:"markRegExp",value:function(e,t){var n=this;this.opt=t,this.log('Searching with expression "'+e+'"');var i=0,r="wrapMatches",s=function(e){i++,n.opt.each(e)};this.opt.acrossElements&&(r="wrapMatchesAcrossElements"),this[r](e,this.opt.ignoreGroups,function(e,t){return n.opt.filter(t,e,i)},s,function(){0===i&&n.opt.noMatch(e),n.opt.done(i)})}},{key:"mark",value:function(e,t){var n=this;this.opt=t;var i=0,r="wrapMatches",s=this.getSeparatedKeywords("string"==typeof e?[e]:e),a=s.keywords,o=s.length,c=this.opt.caseSensitive?"":"i",l=function e(t){var s=new RegExp(n.createRegExp(t),"gm"+c),l=0;n.log('Searching with expression "'+s+'"'),n[r](s,1,function(e,r){return n.opt.filter(r,t,i,l)},function(e){l++,i++,n.opt.each(e)},function(){0===l&&n.opt.noMatch(t),a[o-1]===t?n.opt.done(i):e(a[a.indexOf(t)+1])})};this.opt.acrossElements&&(r="wrapMatchesAcrossElements"),0===o?this.opt.done(i):l(a[0])}},{key:"markRanges",value:function(e,t){var n=this;this.opt=t;var i=0,r=this.checkRanges(e);r&&r.length?(this.log("Starting to mark with the following ranges: "+JSON.stringify(r)),this.wrapRangeFromIndex(r,function(e,t,i,r){return n.opt.filter(e,t,i,r)},function(e,t){i++,n.opt.each(e,t)},function(){n.opt.done(i)})):this.opt.done(i)}},{key:"unmark",value:function(e){var t=this;this.opt=e;var n=this.opt.element?this.opt.element:"*";n+="[data-markjs]",this.opt.className&&(n+="."+this.opt.className),this.log('Removal selector "'+n+'"'),this.iterator.forEachNode(NodeFilter.SHOW_ELEMENT,function(e){t.unwrapMatches(e)},function(e){var i=r.matches(e,n),s=t.matchesExclude(e);return!i||s?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT},this.opt.done)}},{key:"opt",set:function(e){this._opt=i({},{element:"",className:"",exclude:[],iframes:!1,iframesTimeout:5e3,separateWordSearch:!0,diacritics:!0,synonyms:{},accuracy:"partially",acrossElements:!1,caseSensitive:!1,ignoreJoiners:!1,ignoreGroups:0,ignorePunctuation:[],wildcards:"disabled",each:function(){},noMatch:function(){},filter:function(){return!0},done:function(){},debug:!1,log:window.console},e)},get:function(){return this._opt}},{key:"iterator",get:function(){return new r(this.ctx,this.opt.iframes,this.opt.exclude,this.opt.iframesTimeout)}}]),s}();function a(e){var t=this,n=new s(e);return this.mark=function(e,i){return n.mark(e,i),t},this.markRegExp=function(e,i){return n.markRegExp(e,i),t},this.markRanges=function(e,i){return n.markRanges(e,i),t},this.unmark=function(e){return n.unmark(e),t},this}return a}()},363:function(e,t,n){var i,r;i=function(){var e=function(){},t="undefined",n=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),i=["trace","debug","info","warn","error"],r={},s=null;function a(e,t){var n=e[t];if("function"==typeof n.bind)return n.bind(e);try{return Function.prototype.bind.call(n,e)}catch(t){return function(){return Function.prototype.apply.apply(n,[e,arguments])}}}function o(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function c(i){return"debug"===i&&(i="log"),typeof console!==t&&("trace"===i&&n?o:void 0!==console[i]?a(console,i):void 0!==console.log?a(console,"log"):e)}function l(){for(var n=this.getLevel(),r=0;r<i.length;r++){var s=i[r];this[s]=r<n?e:this.methodFactory(s,n,this.name)}if(this.log=this.debug,typeof console===t&&n<this.levels.SILENT)return"No console available for logging"}function u(e){return function(){typeof console!==t&&(l.call(this),this[e].apply(this,arguments))}}function d(e,t,n){return c(e)||u.apply(this,arguments)}function p(e,n){var a,o,c,u=this,p="loglevel";function h(e){var n=(i[e]||"silent").toUpperCase();if(typeof window!==t&&p){try{return void(window.localStorage[p]=n)}catch(e){}try{window.document.cookie=encodeURIComponent(p)+"="+n+";"}catch(e){}}}function f(){var e;if(typeof window!==t&&p){try{e=window.localStorage[p]}catch(e){}if(typeof e===t)try{var n=window.document.cookie,i=encodeURIComponent(p),r=n.indexOf(i+"=");-1!==r&&(e=/^([^;]+)/.exec(n.slice(r+i.length+1))[1])}catch(e){}return void 0===u.levels[e]&&(e=void 0),e}}function m(){if(typeof window!==t&&p){try{window.localStorage.removeItem(p)}catch(e){}try{window.document.cookie=encodeURIComponent(p)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch(e){}}}function g(e){var t=e;if("string"==typeof t&&void 0!==u.levels[t.toUpperCase()]&&(t=u.levels[t.toUpperCase()]),"number"==typeof t&&t>=0&&t<=u.levels.SILENT)return t;throw new TypeError("log.setLevel() called with invalid level: "+e)}"string"==typeof e?p+=":"+e:"symbol"==typeof e&&(p=void 0),u.name=e,u.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},u.methodFactory=n||d,u.getLevel=function(){return null!=c?c:null!=o?o:a},u.setLevel=function(e,t){return c=g(e),!1!==t&&h(c),l.call(u)},u.setDefaultLevel=function(e){o=g(e),f()||u.setLevel(e,!1)},u.resetLevel=function(){c=null,m(),l.call(u)},u.enableAll=function(e){u.setLevel(u.levels.TRACE,e)},u.disableAll=function(e){u.setLevel(u.levels.SILENT,e)},u.rebuild=function(){if(s!==u&&(a=g(s.getLevel())),l.call(u),s===u)for(var e in r)r[e].rebuild()},a=g(s?s.getLevel():"WARN");var v=f();null!=v&&(c=g(v)),l.call(u)}(s=new p).getLogger=function(e){if("symbol"!=typeof e&&"string"!=typeof e||""===e)throw new TypeError("You must supply a name when creating a logger.");var t=r[e];return t||(t=r[e]=new p(e,s.methodFactory)),t};var h=typeof window!==t?window.log:void 0;return s.noConflict=function(){return typeof window!==t&&window.log===s&&(window.log=h),s},s.getLoggers=function(){return r},s.default=s,s},void 0===(r="function"==typeof i?i.call(t,n,t,e):i)||(e.exports=r)},730:t=>{t.exports=e}},ht={};function ft(e){var t=ht[e];if(void 0!==t)return t.exports;var n=ht[e]={exports:{}};return pt[e].call(n.exports,n,n.exports,ft),n.exports}ft.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return ft.d(t,{a:t}),t},ft.d=(e,t)=>{for(var n in t)ft.o(t,n)&&!ft.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},ft.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),ft.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var mt={};ft.r(mt),ft.d(mt,{BOM:()=>co,DOCUMENT:()=>lo,FLOW_END:()=>uo,SCALAR:()=>po,createScalarToken:()=>Ka,isCollection:()=>ho,isScalar:()=>fo,prettyToken:()=>mo,resolveAsScalar:()=>Ja,setScalarValue:()=>Ya,stringify:()=>eo,tokenType:()=>go,visit:()=>ao});var gt={};ft.r(gt),ft.d(gt,{Alias:()=>Dr,CST:()=>mt,Composer:()=>Wa,Document:()=>ba,Lexer:()=>ko,LineCounter:()=>So,Pair:()=>ps,Parser:()=>No,Scalar:()=>jr,Schema:()=>_a,YAMLError:()=>$a,YAMLMap:()=>ys,YAMLParseError:()=>ka,YAMLSeq:()=>bs,YAMLWarning:()=>Sa,isAlias:()=>sr,isCollection:()=>dr,isDocument:()=>ar,isMap:()=>or,isNode:()=>pr,isPair:()=>cr,isScalar:()=>lr,isSeq:()=>ur,parse:()=>Ro,parseAllDocuments:()=>Do,parseDocument:()=>Lo,stringify:()=>jo,visit:()=>vr,visitAsync:()=>_r});var vt={};ft.r(vt),ft.d(vt,{Decoder:()=>Vl,Encoder:()=>Bl,PacketType:()=>Fl,protocol:()=>zl});var yt={};ft.r(yt),ft.d(yt,{BIGINT_FORMAT_RANGES:()=>Fh,Class:()=>nf,NUMBER_FORMAT_RANGES:()=>zh,aborted:()=>Wh,allowsEval:()=>xh,assert:()=>oh,assertEqual:()=>ih,assertIs:()=>sh,assertNever:()=>ah,assertNotEqual:()=>rh,assignProp:()=>yh,cached:()=>dh,captureStackTrace:()=>Eh,cleanEnum:()=>tf,cleanRegex:()=>hh,clone:()=>Rh,cloneDef:()=>bh,createTransparentProxy:()=>Ph,defineLazy:()=>gh,esc:()=>Sh,escapeRegex:()=>Lh,extend:()=>Vh,finalizeIssue:()=>Yh,floatSafeRemainder:()=>fh,getElementAtPath:()=>wh,getEnumValues:()=>ch,getLengthableOrigin:()=>Qh,getParsedType:()=>Nh,getSizableOrigin:()=>Xh,isObject:()=>Ih,isPlainObject:()=>Th,issue:()=>ef,joinValues:()=>lh,jsonStringifyReplacer:()=>uh,merge:()=>Zh,mergeDefs:()=>_h,normalizeParams:()=>jh,nullish:()=>ph,numKeys:()=>Ah,objectClone:()=>vh,omit:()=>Gh,optionalKeys:()=>Mh,partial:()=>qh,pick:()=>Bh,prefixIssues:()=>Jh,primitiveTypes:()=>Dh,promiseAllObject:()=>$h,propertyKeyTypes:()=>Ch,randomString:()=>kh,required:()=>Hh,shallowClone:()=>Oh,stringifyPrimitive:()=>Uh,unwrapMessage:()=>Kh});var _t={};ft.r(_t),ft.d(_t,{base64:()=>Zf,base64url:()=>qf,bigint:()=>nm,boolean:()=>sm,browserEmail:()=>Uf,cidrv4:()=>Gf,cidrv6:()=>Vf,cuid:()=>bf,cuid2:()=>wf,date:()=>Yf,datetime:()=>em,domain:()=>Wf,duration:()=>If,e164:()=>Jf,email:()=>Df,emoji:()=>zf,extendedDuration:()=>xf,guid:()=>Tf,hostname:()=>Hf,html5Email:()=>Lf,idnEmail:()=>Pf,integer:()=>im,ipv4:()=>Ff,ipv6:()=>Bf,ksuid:()=>Sf,lowercase:()=>cm,nanoid:()=>Ef,null:()=>am,number:()=>rm,rfc5322Email:()=>Rf,string:()=>tm,time:()=>Qf,ulid:()=>$f,undefined:()=>om,unicodeEmail:()=>jf,uppercase:()=>lm,uuid:()=>Of,uuid4:()=>Af,uuid6:()=>Nf,uuid7:()=>Cf,xid:()=>kf});var bt={};ft.r(bt),ft.d(bt,{ar:()=>hv,az:()=>mv,be:()=>yv,ca:()=>bv,cs:()=>$v,da:()=>Sv,de:()=>Iv,en:()=>Tv,eo:()=>Av,es:()=>Cv,fa:()=>Lv,fi:()=>jv,fr:()=>Uv,frCA:()=>zv,he:()=>Bv,hu:()=>Vv,id:()=>qv,is:()=>Wv,it:()=>Kv,ja:()=>Xv,kh:()=>ey,ko:()=>ny,mk:()=>ry,ms:()=>ay,nl:()=>cy,no:()=>uy,ota:()=>py,pl:()=>gy,ps:()=>fy,pt:()=>yy,ru:()=>wy,sl:()=>ky,sv:()=>Ey,ta:()=>xy,th:()=>Oy,tr:()=>Ny,ua:()=>Dy,ur:()=>Ry,vi:()=>Py,yo:()=>Gy,zhCN:()=>My,zhTW:()=>Fy});var wt={};ft.r(wt);var $t={};ft.r($t),ft.d($t,{$ZodAny:()=>bg,$ZodArray:()=>Ig,$ZodAsyncError:()=>eh,$ZodBase64:()=>sg,$ZodBase64URL:()=>og,$ZodBigInt:()=>mg,$ZodBigIntFormat:()=>gg,$ZodBoolean:()=>fg,$ZodCIDRv4:()=>ng,$ZodCIDRv6:()=>ig,$ZodCUID:()=>Zm,$ZodCUID2:()=>qm,$ZodCatch:()=>tv,$ZodCheck:()=>um,$ZodCheckBigIntFormat:()=>gm,$ZodCheckEndsWith:()=>Om,$ZodCheckGreaterThan:()=>hm,$ZodCheckIncludes:()=>xm,$ZodCheckLengthEquals:()=>$m,$ZodCheckLessThan:()=>pm,$ZodCheckLowerCase:()=>Em,$ZodCheckMaxLength:()=>bm,$ZodCheckMaxSize:()=>vm,$ZodCheckMimeType:()=>Cm,$ZodCheckMinLength:()=>wm,$ZodCheckMinSize:()=>ym,$ZodCheckMultipleOf:()=>fm,$ZodCheckNumberFormat:()=>mm,$ZodCheckOverwrite:()=>Dm,$ZodCheckProperty:()=>Nm,$ZodCheckRegex:()=>Sm,$ZodCheckSizeEquals:()=>_m,$ZodCheckStartsWith:()=>Tm,$ZodCheckStringFormat:()=>km,$ZodCheckUpperCase:()=>Im,$ZodCustom:()=>uv,$ZodCustomStringFormat:()=>dg,$ZodDate:()=>Sg,$ZodDefault:()=>Jg,$ZodDiscriminatedUnion:()=>Ng,$ZodE164:()=>cg,$ZodEmail:()=>Fm,$ZodEmoji:()=>Gm,$ZodEnum:()=>Bg,$ZodError:()=>sf,$ZodFile:()=>Vg,$ZodFunction:()=>Yb,$ZodGUID:()=>Mm,$ZodIPv4:()=>eg,$ZodIPv6:()=>tg,$ZodISODate:()=>Ym,$ZodISODateTime:()=>Km,$ZodISODuration:()=>Qm,$ZodISOTime:()=>Xm,$ZodIntersection:()=>Cg,$ZodJWT:()=>ug,$ZodKSUID:()=>Jm,$ZodLazy:()=>lv,$ZodLiteral:()=>Gg,$ZodMap:()=>Ug,$ZodNaN:()=>nv,$ZodNanoID:()=>Vm,$ZodNever:()=>$g,$ZodNonOptional:()=>Xg,$ZodNull:()=>_g,$ZodNullable:()=>Wg,$ZodNumber:()=>pg,$ZodNumberFormat:()=>hg,$ZodObject:()=>Tg,$ZodOptional:()=>Hg,$ZodPipe:()=>iv,$ZodPrefault:()=>Yg,$ZodPromise:()=>cv,$ZodReadonly:()=>sv,$ZodRealError:()=>af,$ZodRecord:()=>Pg,$ZodRegistry:()=>qy,$ZodSet:()=>zg,$ZodString:()=>Pm,$ZodStringFormat:()=>Um,$ZodSuccess:()=>ev,$ZodSymbol:()=>vg,$ZodTemplateLiteral:()=>ov,$ZodTransform:()=>Zg,$ZodTuple:()=>Rg,$ZodType:()=>jm,$ZodULID:()=>Hm,$ZodURL:()=>Bm,$ZodUUID:()=>zm,$ZodUndefined:()=>yg,$ZodUnion:()=>Ag,$ZodUnknown:()=>wg,$ZodVoid:()=>kg,$ZodXID:()=>Wm,$brand:()=>Qp,$constructor:()=>Xp,$input:()=>Zy,$output:()=>Vy,Doc:()=>Lm,JSONSchema:()=>wt,JSONSchemaGenerator:()=>Qb,NEVER:()=>Yp,TimePrecision:()=>__,_any:()=>z_,_array:()=>wb,_base64:()=>m_,_base64url:()=>g_,_bigint:()=>D_,_boolean:()=>N_,_catch:()=>Mb,_check:()=>Wb,_cidrv4:()=>h_,_cidrv6:()=>f_,_coercedBigint:()=>L_,_coercedBoolean:()=>C_,_coercedDate:()=>Z_,_coercedNumber:()=>E_,_coercedString:()=>Ky,_cuid:()=>a_,_cuid2:()=>o_,_custom:()=>Zb,_date:()=>V_,_default:()=>jb,_discriminatedUnion:()=>kb,_e164:()=>v_,_email:()=>Yy,_emoji:()=>r_,_endsWith:()=>hb,_enum:()=>Ob,_file:()=>Cb,_float32:()=>x_,_float64:()=>T_,_gt:()=>J_,_gte:()=>K_,_guid:()=>Xy,_includes:()=>db,_int:()=>I_,_int32:()=>O_,_int64:()=>R_,_intersection:()=>Sb,_ipv4:()=>d_,_ipv6:()=>p_,_isoDate:()=>w_,_isoDateTime:()=>b_,_isoDuration:()=>k_,_isoTime:()=>$_,_jwt:()=>y_,_ksuid:()=>u_,_lazy:()=>Gb,_length:()=>ob,_literal:()=>Nb,_lowercase:()=>lb,_lt:()=>H_,_lte:()=>W_,_map:()=>xb,_max:()=>W_,_maxLength:()=>sb,_maxSize:()=>nb,_mime:()=>mb,_min:()=>K_,_minLength:()=>ab,_minSize:()=>ib,_multipleOf:()=>tb,_nan:()=>q_,_nanoid:()=>s_,_nativeEnum:()=>Ab,_negative:()=>X_,_never:()=>B_,_nonnegative:()=>eb,_nonoptional:()=>Pb,_nonpositive:()=>Q_,_normalize:()=>vb,_null:()=>M_,_nullable:()=>Rb,_number:()=>S_,_optional:()=>Lb,_overwrite:()=>gb,_parse:()=>pf,_parseAsync:()=>ff,_pipe:()=>zb,_positive:()=>Y_,_promise:()=>Vb,_property:()=>fb,_readonly:()=>Fb,_record:()=>Ib,_refine:()=>qb,_regex:()=>cb,_safeParse:()=>gf,_safeParseAsync:()=>yf,_set:()=>Tb,_size:()=>rb,_startsWith:()=>pb,_string:()=>Jy,_stringFormat:()=>Kb,_stringbool:()=>Jb,_success:()=>Ub,_superRefine:()=>Hb,_symbol:()=>P_,_templateLiteral:()=>Bb,_toLowerCase:()=>_b,_toUpperCase:()=>bb,_transform:()=>Db,_trim:()=>yb,_tuple:()=>Eb,_uint32:()=>A_,_uint64:()=>j_,_ulid:()=>c_,_undefined:()=>U_,_union:()=>$b,_unknown:()=>F_,_uppercase:()=>ub,_url:()=>i_,_uuid:()=>Qy,_uuidv4:()=>e_,_uuidv6:()=>t_,_uuidv7:()=>n_,_void:()=>G_,_xid:()=>l_,clone:()=>Rh,config:()=>nh,flattenError:()=>of,formatError:()=>cf,function:()=>Xb,globalConfig:()=>th,globalRegistry:()=>Wy,isValidBase64:()=>rg,isValidBase64URL:()=>ag,isValidJWT:()=>lg,locales:()=>bt,parse:()=>hf,parseAsync:()=>mf,prettifyError:()=>df,regexes:()=>_t,registry:()=>Hy,safeParse:()=>vf,safeParseAsync:()=>_f,toDotPath:()=>uf,toJSONSchema:()=>ew,treeifyError:()=>lf,util:()=>yt,version:()=>Rm});var kt={};ft.r(kt),ft.d(kt,{ZodISODate:()=>rw,ZodISODateTime:()=>nw,ZodISODuration:()=>cw,ZodISOTime:()=>aw,date:()=>sw,datetime:()=>iw,duration:()=>lw,time:()=>ow});var St={};ft.r(St),ft.d(St,{bigint:()=>lS,boolean:()=>cS,date:()=>uS,number:()=>oS,string:()=>aS});var Et={};ft.r(Et),ft.d(Et,{$brand:()=>Qp,$input:()=>Zy,$output:()=>Vy,NEVER:()=>Yp,TimePrecision:()=>__,ZodAny:()=>D$,ZodArray:()=>G$,ZodBase64:()=>t$,ZodBase64URL:()=>i$,ZodBigInt:()=>$$,ZodBigIntFormat:()=>S$,ZodBoolean:()=>b$,ZodCIDRv4:()=>Yw,ZodCIDRv6:()=>Qw,ZodCUID:()=>Pw,ZodCUID2:()=>Mw,ZodCatch:()=>Dk,ZodCustom:()=>Hk,ZodCustomStringFormat:()=>l$,ZodDate:()=>F$,ZodDefault:()=>Ek,ZodDiscriminatedUnion:()=>X$,ZodE164:()=>s$,ZodEmail:()=>$w,ZodEmoji:()=>Dw,ZodEnum:()=>dk,ZodError:()=>dw,ZodFile:()=>gk,ZodFirstPartyTypeKind:()=>sS,ZodGUID:()=>Sw,ZodIPv4:()=>Hw,ZodIPv6:()=>Jw,ZodISODate:()=>rw,ZodISODateTime:()=>nw,ZodISODuration:()=>cw,ZodISOTime:()=>aw,ZodIntersection:()=>ek,ZodIssueCode:()=>nS,ZodJWT:()=>o$,ZodKSUID:()=>Zw,ZodLazy:()=>Gk,ZodLiteral:()=>fk,ZodMap:()=>ok,ZodNaN:()=>Rk,ZodNanoID:()=>Rw,ZodNever:()=>P$,ZodNonOptional:()=>Ok,ZodNull:()=>N$,ZodNullable:()=>$k,ZodNumber:()=>p$,ZodNumberFormat:()=>f$,ZodObject:()=>q$,ZodOptional:()=>bk,ZodPipe:()=>Pk,ZodPrefault:()=>xk,ZodPromise:()=>Zk,ZodReadonly:()=>Mk,ZodRealError:()=>pw,ZodRecord:()=>rk,ZodSet:()=>lk,ZodString:()=>_w,ZodStringFormat:()=>ww,ZodSuccess:()=>Nk,ZodSymbol:()=>x$,ZodTemplateLiteral:()=>Fk,ZodTransform:()=>yk,ZodTuple:()=>nk,ZodType:()=>vw,ZodULID:()=>Fw,ZodURL:()=>Nw,ZodUUID:()=>Iw,ZodUndefined:()=>O$,ZodUnion:()=>K$,ZodUnknown:()=>R$,ZodVoid:()=>M$,ZodXID:()=>Gw,_ZodString:()=>yw,_default:()=>Ik,any:()=>L$,array:()=>V$,base64:()=>n$,base64url:()=>r$,bigint:()=>k$,boolean:()=>w$,catch:()=>Lk,check:()=>Wk,cidrv4:()=>Xw,cidrv6:()=>e$,clone:()=>Rh,coerce:()=>St,config:()=>nh,core:()=>$t,cuid:()=>Uw,cuid2:()=>zw,custom:()=>Jk,date:()=>B$,discriminatedUnion:()=>Q$,e164:()=>a$,email:()=>kw,emoji:()=>Lw,endsWith:()=>hb,enum:()=>pk,file:()=>vk,flattenError:()=>of,float32:()=>g$,float64:()=>v$,formatError:()=>cf,function:()=>Xb,getErrorMap:()=>rS,globalRegistry:()=>Wy,gt:()=>J_,gte:()=>K_,guid:()=>Ew,hostname:()=>d$,includes:()=>db,instanceof:()=>Xk,int:()=>m$,int32:()=>y$,int64:()=>E$,intersection:()=>tk,ipv4:()=>Ww,ipv6:()=>Kw,iso:()=>kt,json:()=>eS,jwt:()=>c$,keyof:()=>Z$,ksuid:()=>qw,lazy:()=>Vk,length:()=>ob,literal:()=>mk,locales:()=>bt,looseObject:()=>J$,lowercase:()=>lb,lt:()=>H_,lte:()=>W_,map:()=>ck,maxLength:()=>sb,maxSize:()=>nb,mime:()=>mb,minLength:()=>ab,minSize:()=>ib,multipleOf:()=>tb,nan:()=>jk,nanoid:()=>jw,nativeEnum:()=>hk,negative:()=>X_,never:()=>U$,nonnegative:()=>eb,nonoptional:()=>Ak,nonpositive:()=>Q_,normalize:()=>vb,null:()=>C$,nullable:()=>kk,nullish:()=>Sk,number:()=>h$,object:()=>H$,optional:()=>wk,overwrite:()=>gb,parse:()=>hw,parseAsync:()=>fw,partialRecord:()=>ak,pipe:()=>Uk,positive:()=>Y_,prefault:()=>Tk,preprocess:()=>tS,prettifyError:()=>df,promise:()=>qk,property:()=>fb,readonly:()=>zk,record:()=>sk,refine:()=>Kk,regex:()=>cb,regexes:()=>_t,registry:()=>Hy,safeParse:()=>mw,safeParseAsync:()=>gw,set:()=>uk,setErrorMap:()=>iS,size:()=>rb,startsWith:()=>pb,strictObject:()=>W$,string:()=>bw,stringFormat:()=>u$,stringbool:()=>Qk,success:()=>Ck,superRefine:()=>Yk,symbol:()=>T$,templateLiteral:()=>Bk,toJSONSchema:()=>ew,toLowerCase:()=>_b,toUpperCase:()=>bb,transform:()=>_k,treeifyError:()=>lf,trim:()=>yb,tuple:()=>ik,uint32:()=>_$,uint64:()=>I$,ulid:()=>Bw,undefined:()=>A$,union:()=>Y$,unknown:()=>j$,uppercase:()=>ub,url:()=>Cw,uuid:()=>xw,uuidv4:()=>Tw,uuidv6:()=>Ow,uuidv7:()=>Aw,void:()=>z$,xid:()=>Vw});class It{$container;$header;$content;options;isAnimating=!1;static initAll(e,t={}){const n=[];return $(e).each(function(){n.push(new It($(this),t))}),n}constructor(e,t={}){this.$container=e;this.options={headerSelector:".collapsible-header",contentSelector:".collapsible-content",expandedClass:"expanded",animationDuration:{expand:280,collapse:250},easingFunction:"swing",initiallyExpanded:!1,callbacks:{},...t},this.$header=this.$container.find(this.options.headerSelector),this.$content=this.$container.find(this.options.contentSelector),this.initEvents(),this.options.initiallyExpanded?(this.$container.addClass(this.options.expandedClass),this.$content.show()):(this.$container.removeClass(this.options.expandedClass),this.$content.hide())}initEvents(){this.$header.on("click",e=>{this.shouldIgnoreClick(e.target)||this.toggle()})}shouldIgnoreClick(e){const t=$(e);return!!(t.hasClass("toggle-switch")||t.hasClass("toggle-input")||t.hasClass("toggle-label")||t.hasClass("toggle-handle")||t.closest(".toggle-switch").length>0)||(!!(t.hasClass("menu_button")||t.closest(".menu_button").length>0||t.hasClass("TavernHelper-button")||t.closest(".TavernHelper-button").length>0)||!!(t.is("input, select, textarea, button, a")||t.closest("input, select, textarea, button, a").length>0))}toggle(){this.isAnimating||(this.$container.hasClass(this.options.expandedClass)?this.collapse():this.expand())}expand(){this.isAnimating||this.$container.hasClass(this.options.expandedClass)||(this.isAnimating=!0,this.options.callbacks?.beforeExpand&&this.options.callbacks.beforeExpand(),this.$container.addClass(this.options.expandedClass),this.$content.addClass("animating"),this.$content.slideDown({duration:this.options.animationDuration.expand,easing:this.options.easingFunction,start:function(){$(this).css({opacity:0,transform:"translateY(-10px) scaleY(0.95)"})},progress:function(e,t){$(this).css({opacity:t,transform:`translateY(${-10*(1-t)}px) scaleY(${.95+.05*t})`})},complete:()=>{this.$content.css({opacity:"",transform:""}).removeClass("animating"),this.isAnimating=!1,this.options.callbacks?.afterExpand&&this.options.callbacks.afterExpand()}}))}collapse(){!this.isAnimating&&this.$container.hasClass(this.options.expandedClass)&&(this.isAnimating=!0,this.options.callbacks?.beforeCollapse&&this.options.callbacks.beforeCollapse(),this.$container.removeClass(this.options.expandedClass),this.$content.addClass("animating"),this.$content.slideUp({duration:this.options.animationDuration.collapse,easing:this.options.easingFunction,start:function(){$(this).css({opacity:1,transform:"translateY(0) scaleY(1)"})},progress:function(e,t){const n=1-t;$(this).css({opacity:n,transform:`translateY(${-5*t}px) scaleY(${1-.05*t})`})},complete:()=>{this.$content.css({opacity:"",transform:""}).removeClass("animating"),this.isAnimating=!1,this.options.callbacks?.afterCollapse&&this.options.callbacks.afterCollapse()}}))}isExpanded(){return this.$container.hasClass(this.options.expandedClass)}destroy(){this.$header.off("click")}}const xt="JS-Slash-Runner",Tt="TavernHelper",Ot=`third-party/${xt}`,At="/characters/",Nt=()=>`./User Avatars/${J}`,Ct=()=>{const e=x("avatar",a[H]?.avatar||a[H]?.name||""),t=e.substring(e.lastIndexOf("=")+1);return At+t};function Dt(e,t=void 0){return _.get(Y[Tt],e,t)}function Lt(e,t){return _.set(Y[Tt],e,t),M(),t}async function Rt(e,t){return _.has(Y[Tt],e)?Dt(e):Lt(e,t)}var jt=ft(363),Pt=ft.n(jt);let Ut,Mt,zt=[],Ft=[],Bt=!0,Gt=!0;const Vt=`${Ot}/src/component/audio`;async function Zt(e="bgm",t=!1){if(!Dt("audio.audio_enabled"))return;if(!Dt("bgm"===e?"audio.bgm_enabled":"audio.ambient_enabled"))return;const n="bgm"===e?Bt:Gt,i=`#audio_${e}`;if(!t&&""!=$(i).attr("src")&&!n)return;let r="";const s=await Ht(e);if(t)r="bgm"===e?Dt("audio.bgm_selected")||s[0]:Dt("audio.ambient_selected")||s[0];else{r=function(e,t,n){if(!t||0===t.length)return"";switch(e){case"repeat":default:return t[0];case"single":return n||t[0];case"random":{const e=t.filter(e=>e!==n);if(0===e.length)return t[0];return e[Math.floor(Math.random()*e.length)]}case"stop":return""}}(Dt("bgm"===e?"audio.bgm_mode":"audio.ambient_mode"),s,Dt("bgm"===e?"audio.bgm_selected":"audio.ambient_selected"))}if(!r)return;const a=$(i)[0];if("ambient"===e){const e=a.src.split("?")[0],t=r.split("?")[0];if(decodeURIComponent(e)===decodeURIComponent(t)&&!n)return}else if(decodeURIComponent(a.src)===decodeURIComponent(r)&&!n)return;if("bgm"===e?Bt=!1:Gt=!1,"bgm"===e)a.src=r,a.load(),await new Promise(e=>{const t=()=>{a.removeEventListener("canplaythrough",t),e()};a.readyState>=HTMLMediaElement.HAVE_ENOUGH_DATA?e():a.addEventListener("canplaythrough",t)}),await nn(e);else{const t=function(e){if(!e)return"";const t=(new Date).getTime(),n=e.includes("?")?"&":"?";return`${e}${n}_=${t}`}(r);a.src=t,a.load(),await new Promise(e=>{const t=()=>{a.removeEventListener("canplaythrough",t),e()};a.readyState>=HTMLMediaElement.HAVE_ENOUGH_DATA?e():a.addEventListener("canplaythrough",t)}),await nn(e)}Lt("bgm"===e?"audio.bgm_selected":"audio.ambient_selected",r);const o=$(`#audio_${e}_select`);o.val()!==r&&o.val(r),M()}async function qt(e="bgm"){if(!Dt(`audio.${e}_enabled`))return;const t=$(`#audio_${e}_select`);t.empty(),"bgm"===e?zt=await Ht("bgm"):Ft=await Ht("ambient");const n="bgm"===e?zt:Ft;let i=Dt("bgm"===e?"audio.bgm_selected":"audio.ambient_selected");if(n&&n.length>0){n.includes(i)||(Pt().warn(`[Audio] 当前选择的音频 ${i} 不在列表中，自动选择列表第一个音频`),i=n[0],Lt("bgm"===e?"audio.bgm_selected":"audio.ambient_selected",i),M());const r=Array.isArray(n)?n:n.split(",").map(e=>e.trim());r.forEach(e=>{const n=e.replace(/^.*[\\\/]/,"").replace(/\.[^/.]+$/,"");t.append(new Option(n,e))}),t.val(i)}else Pt().warn(`[Audio] 暂无可用的 ${e.toUpperCase()} 资源`)}async function Ht(e="bgm"){const t="bgm"===e?"bgmurl":"ambienturl";return c.variables?.[t]||[]}function Wt(e,t="enable"){const n=$("#audio_enabled").prop("checked")&&"enable"===t;[`#audio_${e}_play_pause`,`#audio_${e}_mute`,`#audio_${e}_mode`,`#audio_${e}_select`,`#audio_${e}_volume_slider`].forEach(e=>{$(e).prop("disabled",!n)})}async function Jt(e="bgm"){const t=$(`#enable_${e}`).prop("checked");Lt(`audio.${e}_enabled`,t),t?(Wt(e,"enable"),await Zt(e,!1)):($(`#audio_${e}`)[0].pause(),Wt(e,"disable"))}function Kt(e){$(`#audio_${e}`).on("ended",async function(){"bgm"===e?Bt=!0:Gt=!0;"stop"!==Dt(`audio.${e}_mode`)&&await Zt(e,!1)})}function Yt(e){const t=$(this);e.preventDefault(),e.stopPropagation();const n=e.deltaY/20;let i=Number(t.val())-n;i<0?i=0:i>100&&(i=100),t.val(i).trigger("input")}function Xt(e,t){const n=$(`#${e}`),i=$(`#${t}`);let r;re()&&(i.on("touchstart",function(e){r=setTimeout(()=>{n.css("display","block")},500)}),i.on("touchend",function(e){clearTimeout(r)}),$(document).on("click",function(e){i.is(e.target)||0!==i.has(e.target).length||n.is(e.target)||0!==n.has(e.target).length||n.css("display","none")}))}async function Qt(){qt("bgm"),qt("ambient")}async function en(e){const t=$(await Q(`${Vt}`,"audio_url_manager"));t.prepend('\n    <style>\n      #saved_audio_url.empty::after {\n        content: "暂无音频";\n        color: #999;\n        margin-top: 20px;\n        font-size: 12px;\n      }\n    </style>\n  ');const n=t.find("#saved_audio_url").empty(),i=$(await Q(`${Vt}`,"audio_url_template"));c.variables||(c.variables={});let r=c.variables[e];if(r)try{0===r.length&&n.addClass("empty")}catch(t){return Pt().error(`[Audio] Failed to parse ${e}:`,t),null}else r=[],n.addClass("empty");const s={};let a=[...r];function o(e,t){const r=i.clone();let a;if(t.includes("/")){const e=t.split("/");a=e[e.length-1]||e[e.length-2]}else a=t;const o=a.replace(/\./g,"-");r.attr("id",o),r.find(".audio_url_name").text(a),r.find(".audio_url_name").attr("data-url",t),r.find(".edit_existing_url").on("click",async function(){const e=r.find(".audio_url_name").attr("data-url");if(!e)return void Pt().error("[Audio] No URL found for this element.");const t=await ie("",ne.INPUT,e);if(!t)return;const n=t.split("/").pop(),i=n.replace(/\./g,"-");r.attr("id",i),r.find(".audio_url_name").text(n),r.find(".audio_url_name").attr("data-url",t),s[e]=t}),r.find(".delete_url").on("click",async function(){await ie("确认要删除此链接?",ne.CONFIRM)&&(r.remove(),0===n.find(".audio_url_name").length&&n.addClass("empty"))}),e.append(r)}r.forEach(e=>{o(n,e)}),t.find("#import_button").on("click",async function(){const t=await async function(){const e=await ie("输入要导入的网络音频链接（每行一个）",ne.INPUT,"");if(!e)return Pt().debug("[Audio] URL import cancelled"),null;const t=e.trim().split("\n").map(e=>e.trim()).filter(e=>""!==e);return Array.from(new Set(t))}();t?(n.removeClass("empty"),t.forEach(e=>{o(n,e)})):Pt().debug(`[Audio] ${e} URL导入已取消`)}),n.sortable({delay:ue(),handle:".drag-handle",stop:function(){a=[],n.find(".audio_url_name").each(function(){const e=$(this).attr("data-url");e&&a.push(e)})}});if(await ie(t,ne.CONFIRM,"",{okButton:"确认",cancelButton:"取消"})){const t=[];n.find(".audio_url_name").each(function(){const e=$(this).attr("data-url");e&&t.push(e)});const i=Dt("audio.bgm_selected"),r=Dt("audio.ambient_selected");if("bgmurl"===e&&i&&!t.includes(i)){$("#audio_bgm")[0].pause(),Bt=!0}else if("ambienturl"===e&&r&&!t.includes(r)){$("#audio_ambient")[0].pause(),Gt=!0}c.variables[e]=t,ee(),"bgmurl"===e?qt("bgm"):"ambienturl"===e&&qt("ambient")}}async function tn(e=!0,t=!0){if(t&&(Mt=e,Lt("audio.audio_enabled",Mt)),e){if($("#audio-player-content").removeClass("audio-disabled-mask"),void 0===Ut&&(Ut=Dt("enabled_extension")),!Ut)return;Wt("bgm","enable"),Wt("ambient","enable");const e=await Ht("bgm"),t=await Ht("ambient");if(e.length>0){const e=$("#audio_bgm")[0];try{await e.play()}catch(e){throw new Error("[Audio] 播放音乐失败：没有提供有效源")}}if(t.length>0){const e=$("#audio_ambient")[0];try{await e.play()}catch(e){throw new Error("[Audio] 播放音效失败：没有提供有效源")}}}else $("#audio-player-content").addClass("audio-disabled-mask"),$("#audio_bgm")[0].pause(),$("#audio_ambient")[0].pause(),Wt("bgm","disable"),Wt("ambient","disable")}async function nn(e){if(!Dt("enabled_extension")||!Dt("audio.audio_enabled")||!Dt(`audio.${e}_enabled`))return;const t=$(`#audio_${e}`)[0],n=$(`#audio_${e}_play_pause_icon`);if(t.error&&4===t.error.code){Pt().warn(`The ${e} element has no supported sources. Trying to reload selected audio from dropdown...`);const n=$(`#audio_${e}_select`).val();if(!n)return void Pt().error(`No audio selected for ${e}`);t.src=n,t.load()}try{await t.play(),n.removeClass("fa-play"),n.addClass("fa-pause")}catch(t){Pt().error(`[Audio] 播放 ${e} 音频时出错:`,t)}}async function rn(e){const t=[{mode:"repeat",icon:"fa-repeat"},{mode:"random",icon:"fa-random"},{mode:"single",icon:"fa-redo-alt"},{mode:"stop",icon:"fa-cancel"}],n=(t.findIndex(t=>t.mode===Dt(`audio.${e}_mode`))+1)%t.length;Lt(`audio.${e}_mode`,t[n].mode),$(`#audio_${e}_mode_icon`).removeClass("fa-repeat fa-random fa-redo-alt fa-cancel"),$(`#audio_${e}_mode_icon`).addClass(t[n].icon)}async function sn(e){Lt(`audio.${e}_selected`,$(`#audio_${e}_select`).val()),await Zt(e,!0)}async function an(){Lt("audio.audio_cooldown",~~$("#audio_cooldown").val())}async function on(e){Lt(`audio.${e}_volume`,~~$(`#audio_${e}_volume_slider`).val()),$(`#audio_${e}`).prop("volume",.01*Dt(`audio.${e}_volume`)),$(`#audio_${e}_volume`).text(Dt(`audio.${e}_volume`))}async function cn(e){Lt(`audio.${e}_muted`,!Dt(`audio.${e}_muted`)),$(`#audio_${e}_mute_icon`).toggleClass("fa-volume-high"),$(`#audio_${e}_mute_icon`).toggleClass("fa-volume-mute"),$(`#audio_${e}`).prop("muted",!$(`#audio_${e}`).prop("muted")),$(`#audio_${e}_mute`).toggleClass("redOverlayGlow")}async function ln(e){if(!Dt("audio.audio_enabled"))return;const t=$(`#audio_${e}`)[0],n=$(`#audio_${e}_play_pause_icon`);t.paused?await nn(e):(t.pause(),n.removeClass("fa-pause"),n.addClass("fa-play"))}function un(e){$(`#audio_${e}`).hide(),Dt(`audio.${e}_muted`)?($(`#audio_${e}_mute_icon`).removeClass("fa-volume-high"),$(`#audio_${e}_mute_icon`).addClass("fa-volume-mute"),$(`#audio_${e}_mute`).addClass("redOverlayGlow"),$(`#audio_${e}`).prop("muted",!0)):($(`#audio_${e}_mute_icon`).addClass("fa-volume-high"),$(`#audio_${e}_mute_icon`).removeClass("fa-volume-mute"),$(`#audio_${e}_mute`).removeClass("redOverlayGlow"),$(`#audio_${e}`).prop("muted",!1)),$(`#enable_${e}`).prop("checked",Dt(`audio.${e}_enabled`));const t=$(`#audio_${e}`)[0],n=$(`#audio_${e}_play_pause_icon`);t&&t.paused?(n.removeClass("fa-pause"),n.addClass("fa-play")):t&&!t.paused&&(n.removeClass("fa-play"),n.addClass("fa-pause")),qt(e),function(e){const t=$(`#audio_${e}`),n=$(`#audio_${e}_progress_slider`);t.on("timeupdate",function(){if(!isNaN(this.duration)){const e=this.currentTime/this.duration*100;n.val(e)}const e=Dt("audio.audio_cooldown"),t=this.duration-this.currentTime;if(e>0&&t<=e&&!this.isFadingOut){const t=this.volume/(10*e);this.isFadingOut=!0;const n=setInterval(()=>{this.volume>0?this.volume=Math.max(0,this.volume-t):(clearInterval(n),this.isFadingOut=!1)},100)}}),t.on("play",function(){const t=Dt("audio.audio_cooldown"),n=$(`#audio_${e}_volume_slider`).val()/100;if(t<=0)return void(this.volume=n);this.volume=0;const i=n/(10*t),r=setInterval(()=>{this.volume<n?this.volume=Math.min(n,this.volume+i):clearInterval(r)},100)}),t.on("loadedmetadata",function(){isNaN(this.duration)||n.attr("max",100)}),n.on("input",function(){const e=$(this).val();isNaN(t[0].duration)||(t[0].currentTime=e/100*t[0].duration)})}(e)}async function dn(){await pe(`/scripts/extensions/${Ot}/src/component/audio/style.css`,"css"),Mt=Dt("audio.audio_enabled"),tn(Mt,!1),$("#audio-enable-toggle").prop("checked",Mt).on("click",e=>tn(e.target.checked,!0)),It.initAll("#audio-player-header",{headerSelector:"#audio-player-header",contentSelector:"#audio-player-content",initiallyExpanded:!0,animationDuration:{expand:280,collapse:250}}),un("bgm"),un("ambient");const e=["bgm","ambient"];e.forEach(e=>{$(`#enable_${e}`).on("click",()=>Jt(e)),((e,t)=>{t.forEach(({selector:t,event:n,handler:i})=>{$(`#${t}`).on(n,()=>i(e))})})(e,[{selector:`enable_${e}`,event:"click",handler:Jt},{selector:`audio_${e}_mode`,event:"click",handler:rn},{selector:`audio_${e}_mute`,event:"click",handler:cn},{selector:`audio_${e}_volume_slider`,event:"input",handler:on},{selector:`audio_${e}_select`,event:"change",handler:sn},{selector:`audio_${e}_play_pause`,event:"click",handler:ln}]),$("#audio_cooldown").on("input",an).val(Dt("audio.audio_cooldown")),Kt("bgm"),Kt("ambient");const t=$(`#audio_${e}_volume_slider`).get(0);t&&t.addEventListener("wheel",Yt,{passive:!1})}),$("#audio_refresh_assets").on("click",async()=>{await Qt()}),Xt("bgm-volume-control","audio_bgm_mute_icon"),Xt("ambient-volume-control","audio_ambient_mute_icon");const t={bgm:"bgmurl",ambient:"ambienturl"};e.forEach(e=>{$(`#${e}_manager_button`).on("click",async()=>{await en(t[e]),await Qt()})});const n=$("#audio_bgm")[0],i=$("#audio_ambient")[0],r=(e,t)=>{const n=$(t);e.addEventListener("play",()=>n.removeClass("fa-play").addClass("fa-pause")),e.addEventListener("pause",()=>n.removeClass("fa-pause").addClass("fa-play"))};r(n,"#audio_bgm_play_pause_icon"),r(i,"#audio_ambient_play_pause_icon")}p.on(h.CHAT_CHANGED,async()=>{const e=$("#audio_bgm")[0],t=$("#audio_ambient")[0];e&&!e.paused&&e.pause(),t&&!t.paused&&t.pause(),await Qt(),Pt().info("[Audio] 聊天已更改，音频资源刷新完成")});const pn=new Map([["userAvatarPath",Nt],["charAvatarPath",Ct]]);function hn(e){if(!Dt("render.render_hide_style"))return;if(e.prev(".code-toggle-button").length>0)return;const t=$('<div class="code-toggle-button" title="关闭[酒馆助手-渲染器-渲染优化]以取消此折叠功能">显示代码块</div>');t.on("click",function(){e.is(":visible")?(e.hide(),$(this).text("显示代码块")):(e.show(),$(this).text("隐藏代码块"))}),e.before(t)}function fn(){if(!Dt("render.render_hide_style")||Dt("render.render_enabled"))return;const e=$("#chat");e.length&&e.find(".mes .mes_block .mes_text, .mes .mes_block .mes_reasoning_details").each(function(e,t){!function(e){e.find(".code-toggle-button").length>0||0===e.find("pre").length||e.find("pre").each(function(e,t){const n=$(t);n.find("code").length&&hn(n)})}($(t))})}function mn(){!function(){const e="hidden-code-block-styles";let t=document.getElementById(e);t||(t=document.createElement("style"),t.setAttribute("type","text/css"),t.setAttribute("id",e),document.head.appendChild(t)),t.innerHTML="\n      pre {\n        display: none;\n      }\n      .code-toggle-button {\n        display: inline-block;\n        margin: 5px 0;\n        padding: 5px 10px;\n        background-color: rgba(0, 0, 0, 0.1);\n        border-radius: 4px;\n        cursor: pointer;\n        font-size: 0.9em;\n        user-select: none;\n        transition: background-color 0.3s;\n      }\n      .code-toggle-button:hover {\n        background-color: rgba(0, 0, 0, 0.2);\n      }\n      .popup:has(#qr--modalEditor) .popup-content > #qr--modalEditor > #qr--main > .qr--modal-messageContainer > #qr--modal-messageHolder > #qr--modal-message {\n        color: var(--SmartThemeEmColor) !important;\n      }\n    "}(),fn()}function gn(){!function(){const e=document.getElementById("hidden-code-block-styles");e&&e.remove()}(),$(".code-toggle-button").each(function(){$(this).off("click").remove()}),$("pre").css("display","block")}function vn(e){let t="";return $(e).contents().each(function(){this.nodeType===Node.TEXT_NODE?t+=this.textContent:this.nodeType===Node.ELEMENT_NODE&&(t+=vn(this))}),t}function yn(e,t,n){const i=e.get(t);if(i)return i;const r=n();return e.set(t,r),r}const _n=new class{map=new Map;get(e){return this.map.get(e)}set(e,t){this.map.set(e,function(e){return URL.createObjectURL(new Blob([e],{type:"application/javascript"}))}(t))}delete(e){const t=function(e,t){const n=e.get(t);if(n)return e.delete(t),n}(this.map,e);return t?(URL.revokeObjectURL(t),t):t}};const bn='<link rel="stylesheet" href="https://testingcf.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css"/> <script src="https://testingcf.jsdelivr.net/npm/jquery/dist/jquery.min.js"><\/script> <script src="https://testingcf.jsdelivr.net/npm/jquery-ui/dist/jquery-ui.min.js"><\/script> <link rel="stylesheet" href="https://testingcf.jsdelivr.net/npm/jquery-ui/themes/base/theme.min.css"/> <script src="https://testingcf.jsdelivr.net/npm/lodash/lodash.min.js"><\/script> ',wn="FULL",$n="PARTIAL";async function kn(e=wn,t=null){if(!Dt("enabled_extension")||!Dt("render.render_enabled"))return;const n=X(),i=n.chat.length,r=Dt("render.render_depth")??0,s=r>0?r:i,a=[...Array(i).keys()].slice(-s);let o=[];const c=[...Array(i).keys()].filter(e=>!a.includes(e));if(e===wn)o=a;else if(e===$n&&null!==t){if(!a.includes(t))return;o=[t]}for(const e of c){const t=n.chat[e],i=$(`[id^="message-iframe-${e}-"]`);if(i.length>0&&(i.each(function(){Nn(this)}),W(e,t)),Dt("render.render_hide_style")){$(`.mes[mesid="${e}"] .mes_block .mes_reasoning_details, .mes[mesid="${e}"] .mes_block .mes_text`).each(function(){const e=$(this).find("pre");e.length&&hn(e)})}}for(const e of o){const t=$(`.mes[mesid="${e}"]`);if(!t.length){log.debug(`未找到 mesid: ${e} 对应的消息元素。`);continue}const n=t.find("pre");if(!n.length)continue;let i=1;n.each(function(){let t=vn(this);if(t.includes("<body")&&t.includes("</body>")){const n=/<!--\s*disable-default-loading\s*-->/.test(t),r=/min-height:\s*[^;]*vh/.test(t),s=/\d+vh/.test(t);(r||s)&&(t=Sn(t));const a=r||s;let o=$("<div>").css({position:"relative",width:"100%"});const c=$("<iframe>").attr({id:`message-iframe-${e}-${i}`,loading:"lazy"}).css({margin:"5px auto",border:"none",width:"100%"});i++,a&&c.attr("data-needs-vh","true");let l=null;if(!n){const e=$("<div>").addClass("iframe-loading-overlay").html('\n                <div class="iframe-loading-content">\n                  <i class="fa-solid fa-spinner fa-spin"></i>\n                  <span class="loading-text">Loading...</span>\n                </div>');l=setTimeout(()=>{const t=e.find(".loading-text");t.length&&t.text("如加载时间过长，请检查网络")},1e4),o.append(e)}o.append(c);const u=`\n            <html>\n            <head>\n              <style>\n              ${a?`:root{--viewport-height:${window.innerHeight}px;}`:""}\n              html,body{margin:0;padding:0;overflow:hidden!important;max-width:100%!important;box-sizing:border-box}\n              .user_avatar,.user-avatar{background-image:url('${Nt()}')}\n              .char_avatar,.char-avatar{background-image:url('${Ct()}')}\n              </style>\n              ${bn}\n              <script src="${_n.get("iframe")}"><\/script>\n            </head>\n            <body>\n              ${t}\n              ${a?`<script src="${_n.get("viewport_adjust_script")}"><\/script>`:""}\n            </body>\n            </html>\n          `;c.attr("srcdoc",u),c.on("load",function(){if(In(this),o=$(this).parent(),o.length){const e=o.find(".iframe-loading-overlay");e.length&&(e.css("opacity","0"),setTimeout(()=>e.remove(),300))}"true"===$(this).attr("data-needs-vh")&&this.contentWindow?.postMessage({request:"updateViewportHeight",newHeight:window.innerHeight},"*"),p.emitAndWait("message_iframe_render_ended",this.id),Dt("render.render_hide_style")&&$(`div[mesid="${e}"] .mes_text .code-toggle-button`).each(function(){$(this).off("click").remove()}),l&&clearTimeout(l)}),p.emitAndWait("message_iframe_render_started",c.attr("id")),$(this).replaceWith(o)}else hn($(this))})}}function Sn(e){const t=window.innerHeight;let n=e.replace(/((?:document\.body\.style\.minHeight|\.style\.minHeight|setProperty\s*\(\s*['"]min-height['"])\s*[=,]\s*['"`])([^'"`]*?)(['"`])/g,(e,n,i,r)=>{if(i.includes("vh")){return n+i.replace(/(\d+(?:\.\d+)?)vh/g,e=>{const n=parseFloat(e);return 100===n?`var(--viewport-height, ${t}px)`:`calc(var(--viewport-height, ${t}px) * ${n/100})`})+r}return e});return n=n.replace(/min-height:\s*([^;]*vh[^;]*);/g,e=>`${e.replace(/(\d+(?:\.\d+)?)vh/g,e=>{const n=parseFloat(e);return 100===n?`var(--viewport-height, ${t}px)`:`calc(var(--viewport-height, ${t}px) * ${n/100})`})};`),n=n.replace(/style\s*=\s*["']([^"']*min-height:\s*[^"']*vh[^"']*?)["']/gi,(e,n)=>{const i=n.replace(/min-height:\s*([^;]*vh[^;]*)/g,e=>e.replace(/(\d+(?:\.\d+)?)vh/g,e=>{const n=parseFloat(e);return 100===n?`var(--viewport-height, ${t}px)`:`calc(var(--viewport-height, ${t}px) * ${n/100})`}));return e.replace(n,i)}),n}function En(e){const t=$(e);if(!t.length||!t[0].contentWindow||!t[0].contentWindow.document.body)return;const n=t[0].contentWindow.document,i=n.body.offsetHeight,r=n.documentElement.offsetHeight,s=Math.max(i,r),a=parseFloat(t.css("height"))||0;Math.abs(a-s)>5&&(t.css("height",s+"px"),"true"===t.attr("data-needs-vh")&&e.contentWindow&&e.contentWindow.postMessage({request:"updateViewportHeight",newHeight:window.innerHeight},"*"))}function In(e){const t=$(e);if(t.length&&t[0].contentWindow&&t[0].contentWindow.document.body)try{const n=t[0].contentWindow.document.body,i=(window._sharedResizeObserver||(window._observedElements=new Map,window._sharedResizeObserver=new ResizeObserver(e=>{for(const t of e){const e=t.target,n=window._observedElements?.get(e);if(n){const{iframe:e}=n;En(e)}}})),window._sharedResizeObserver);if(window._observedElements)for(const[t,n]of window._observedElements.entries())if(n.iframe===e){i.unobserve(t),window._observedElements.delete(t);break}window._observedElements?.set(n,{iframe:e}),i.observe(n),En(e)}catch(e){log.error("[Render] 设置 iframe 内容观察时出错:",e)}}const xn=[h.CHARACTER_MESSAGE_RENDERED,h.USER_MESSAGE_RENDERED,h.MESSAGE_UPDATED,h.MESSAGE_SWIPED];async function Tn(){await Cn(),void 0!==H&&(await D(),await On())}async function On(){await kn(wn),log.info("[Render] 渲染所有iframe")}async function An(e){const t=parseInt($("#render-depth").val(),10),n=X().chat.length;if(t>0){if(e<n-t)return}await kn($n,e),log.info("[Render] 渲染"+e+"号消息的iframe")}function Nn(e){const t=$(e);if(t.length){if(window._sharedResizeObserver&&window._observedElements)for(const[t,n]of window._observedElements.entries())if(n.iframe===e){window._sharedResizeObserver.unobserve(t),window._observedElements.delete(t);break}t.remove(),0===window._observedElements?.size&&window._sharedResizeObserver&&(window._sharedResizeObserver.disconnect(),window._sharedResizeObserver=void 0,log.info("[Render] 所有iframe已移除，停止观察"))}}async function Cn(){$('iframe[id^="message-iframe"]').each(function(){Nn(this)})}const Dn=hljs.highlightElement;function Ln(){hljs.highlightElement=function(){}}function Rn(){hljs.highlightElement=Dn}const jn={render_enabled:!0,render_depth:0,render_optimize:!1,render_hide_style:!1};async function Pn(){const e=Dt("render.render_optimize")??jn.render_optimize;e&&await zn(!0,!1),$("#render-optimize-toggle").prop("checked",e).on("click",e=>zn(e.target.checked,!0));const t=Dt("render.render_depth")??jn.render_depth;$("#render-depth").val(t).on("blur",function(e){!async function(e){const t=parseInt(e,10);if(t<0)return toastr.warning("处理深度不能为负数"),void $("#render-depth").val(Dt("render.render_depth"));Lt("render.render_depth",t),await Tn()}(e.target.value)});const n=Dt("render.render_enabled")??jn.render_enabled;await Un(n,!1),$("#render-enable-toggle").prop("checked",n).on("click",e=>Un(e.target.checked,!0));const i=Dt("render.render_hide_style");i&&await Mn(!0,!1),$("#render-hide-style-toggle").prop("checked",i).on("click",e=>Mn(e.target.checked,!0)),$(window).on("resize",function(){$('iframe[data-needs-vh="true"]').length&&$(window).on("resize",function(){if($('iframe[data-needs-vh="true"]').length){const e=window.innerHeight;$('iframe[data-needs-vh="true"]').each(function(){const t=this;t.contentWindow&&t.contentWindow.postMessage({request:"updateViewportHeight",newHeight:e},"*")})}})}),function(){if($("#iframe-loading-styles").length)return;const e=$("<style>",{id:"iframe-loading-styles",text:"\n        .iframe-loading-overlay{\n          position:absolute;\n          top:0;\n          left:0;\n          right:0;\n          bottom:0;\n          background:rgba(0,0,0,.7);\n          display:flex;\n          justify-content:center;\n          align-items:center;\n          z-index:1000;\n          transition:opacity .3s ease\n        }\n        .iframe-loading-content{\n          color:#fff;\n          display:flex;\n          align-items:center;\n          gap:10px;\n          font-size:16px\n        }\n        .iframe-loading-content i{\n          font-size:20px\n        }\n        .loading-text {\n          transition: opacity 0.3s ease;\n        }"});$("head").append(e)}(),function(){const e=new MutationObserver(e=>{e.forEach(e=>{e.removedNodes.length&&e.removedNodes.forEach(e=>{if(e instanceof HTMLIFrameElement)Nn(e);else if(e instanceof HTMLElement){const t=e.querySelectorAll("iframe");t.length&&t.forEach(e=>{Nn(e)})}})})});e.observe(document.body,{childList:!0,subtree:!0})}()}async function Un(e,t=!0){!function(e){$("#render-enable-toggle").prop("checked",e),$("#tavern-helper-render-text").text(e?"关闭前端渲染":"开启前端渲染")}(e),t&&Lt("render.render_enabled",e),e?($("#render-settings-content .extension-content-item").slice(3).css("opacity",1),await On()):($("#render-settings-content .extension-content-item").slice(3).css("opacity",.5),await Cn(),t&&void 0!==H&&await D())}async function Mn(e,t=!0){t&&Lt("render.render_hide_style",e),e?(mn(),t&&await Tn()):(gn(),t&&await Tn())}async function zn(e,t=!0){t&&Lt("render.render_optimize",e),e?(Ln(),t&&await Tn()):(Rn(),t&&await Tn())}let Fn=null,Bn=!1;function Gn(e){Fn=e}function Vn(){const e=X().mainApi;return"string"==typeof e&&Object.values(be).includes(e)}function Zn(e){e.dryRun||(Vn()?(Bn&&(G(),Bn=!1),setTimeout(async()=>{if(!Fn)return;const t=await Promise.all(e.chat.map(async({role:e,content:t})=>({role:e,content:t,token:await Oe(t)}))),n=await Oe(t.map(e=>e.content).join("\n"));await Fn(t,n),function(){const e=$(".prompt-view-header");e.find(".prompt-view-process-warning").length>0&&e.find(".prompt-view-process-warning").remove();const t=!0===$e.squash_system_messages,n=""!=$e.custom_prompt_post_processing;t&&Hn(e,"squash");n&&Hn(e,"post-processing")}()})):toastr.error("当前 API 不是聊天补全类型, 无法使用提示词查看器功能","不支持的 API 类型"))}function qn(){Vn()?"no_connection"!==C?(Bn=!0,t("normal")):Fn&&Fn([],0):toastr.error("当前 API 不是聊天补全类型, 无法使用提示词查看器功能","不支持的 API 类型")}function Hn(e,t){const n=$('<div class="prompt-view-process-warning">');"squash"===t?n.text("⚠️ 本次提示词发送经过了预设中的“系统消息压缩”合并处理"):"post-processing"===t&&n.text("⚠️ 本次提示词发送经过了API中的“提示词后处理”合并处理"),e.prepend(n)}class Wn{static DEFAULT_MIN_WIDTH=300;static DEFAULT_MIN_HEIGHT=250;static DEFAULT_WIDTH=600;static DEFAULT_HEIGHT=400;static MOBILE_DEFAULT_MIN_WIDTH=280;static MOBILE_DEFAULT_MIN_HEIGHT=200;static MOBILE_DEFAULT_WIDTH=200;static MOBILE_DEFAULT_HEIGHT=100;static instances=new Map;dialog=null;content=null;options;isCollapsed=!1;constructor(e){const t=re(),n=t?e.mobileMinWidth??Wn.MOBILE_DEFAULT_MIN_WIDTH:e.minWidth??Wn.DEFAULT_MIN_WIDTH,i=t?e.mobileMinHeight??Wn.MOBILE_DEFAULT_MIN_HEIGHT:e.minHeight??Wn.DEFAULT_MIN_HEIGHT,r=t?e.mobileWidth??Wn.MOBILE_DEFAULT_WIDTH:e.width??Wn.DEFAULT_WIDTH,s=t?e.mobileHeight??Wn.MOBILE_DEFAULT_HEIGHT:e.height??Wn.DEFAULT_HEIGHT;this.options={...e,minWidth:n,minHeight:i,width:r,height:s,resizable:e.resizable??!0,draggable:e.draggable??!0,collapsible:e.collapsible??!0,onClose:e.onClose??(()=>{}),onToggle:e.onToggle??(()=>{}),mobileMinWidth:e.mobileMinWidth,mobileMinHeight:e.mobileMinHeight,mobileWidth:e.mobileWidth,mobileHeight:e.mobileHeight}}static create(e){const t=Wn.instances.get(e.id);if(t)return t.focus(),null;const n=new Wn(e);return Wn.instances.set(e.id,n),n}static getInstance(e){return Wn.instances.get(e)||null}static close(e){const t=Wn.instances.get(e);return!!t&&(t.close(),!0)}render(){this.unrender(),this.dialog=$(`\n      <div class="floating-dialog" data-dialog-id="${this.options.id}">\n        <div class="dialog-header">\n          <div class="dialog-title">${this.options.title}</div>\n          <div class="dialog-controls">\n            ${this.options.collapsible?'<button class="dialog-toggle-btn" title="折叠/展开内容"><i class="fa-solid fa-chevron-up"></i></button>':""}\n            <button class="dialog-close-btn" title="关闭"><i class="fa-solid fa-times"></i></button>\n          </div>\n        </div>\n        <div class="dialog-content"></div>\n        ${re()?'<div class="dialog-resize-handle"></div>':""}\n      </div>\n    `),this.content=this.dialog.find(".dialog-content");const e={width:this.resolveCssSize(this.options.width,"w"),height:this.resolveCssSize(this.options.height,"h"),minWidth:this.resolveCssSize(this.options.minWidth,"w"),minHeight:this.resolveCssSize(this.options.minHeight,"h")};return this.dialog.css(e),this.bindEvents(),this.initInteractions(),$("body").append(this.dialog),this.centerDialog(),this.content}resolveCssSize(e,t){if("number"==typeof e||void 0===e){const n=re();let i;i="w"===t?n?Wn.MOBILE_DEFAULT_WIDTH:Wn.DEFAULT_WIDTH:n?Wn.MOBILE_DEFAULT_HEIGHT:Wn.DEFAULT_HEIGHT;const r="number"==typeof e?e:i;return"number"==typeof r?`${r}px`:r}return e}computePixelSize(e,t){const n=$(window).width()||0,i=$(window).height()||0,r=re(),s="w"===t?r?Wn.MOBILE_DEFAULT_MIN_WIDTH:Wn.DEFAULT_MIN_WIDTH:r?Wn.MOBILE_DEFAULT_MIN_HEIGHT:Wn.DEFAULT_MIN_HEIGHT;if("number"==typeof e||void 0===e)return"number"==typeof e?e:s;const a=e.trim(),o=a.match(/^([0-9]+(?:\.[0-9]+)?)%$/);if(o){const e=parseFloat(o[1])/100;return Math.max(0,Math.round(("w"===t?n:i)*e))}const c=a.match(/^([0-9]+(?:\.[0-9]+)?)vw$/i);if(c&&"w"===t){const e=parseFloat(c[1])/100;return Math.max(0,Math.round(n*e))}const l=a.match(/^([0-9]+(?:\.[0-9]+)?)vh$/i);if(l&&"h"===t){const e=parseFloat(l[1])/100;return Math.max(0,Math.round(i*e))}const u=$("<div/>").css({position:"absolute",visibility:"hidden",width:"w"===t?a:"auto",height:"h"===t?a:"auto"});$("body").append(u);const d="w"===t?u.outerWidth()||0:u.outerHeight()||0;return u.remove(),d||s}getContent(){return this.content}focus(){if(this.dialog){const e=Math.max(...Array.from($(".floating-dialog")).map(e=>parseInt($(e).css("z-index")||"4000")));this.dialog.css("z-index",e+1)}}setTitle(e){this.dialog&&this.dialog.find(".dialog-title").text(e)}toggle(){if(!this.options.collapsible||!this.dialog)return;const e=this.dialog.find(".dialog-content"),t=this.dialog.find(".dialog-toggle-btn i"),n=this.dialog.find(".dialog-resize-handle");this.isCollapsed=!this.isCollapsed,e.slideToggle(300,()=>{this.isCollapsed?(t.removeClass("fa-chevron-up").addClass("fa-chevron-down"),n.hide()):(t.removeClass("fa-chevron-down").addClass("fa-chevron-up"),n.show())}),this.dialog.toggleClass("content-collapsed",this.isCollapsed),this.options.onToggle(this.isCollapsed)}close(){this.dialog&&(this.options.onClose(),this.unrender(),Wn.instances.delete(this.options.id))}unrender(){this.dialog&&(this.dialog.remove(),this.dialog=null,this.content=null)}bindEvents(){this.dialog&&(this.dialog.find(".dialog-close-btn").on("click",()=>{this.close()}),this.options.collapsible&&this.dialog.find(".dialog-toggle-btn").on("click",()=>{this.toggle()}),this.dialog.on("mousedown",()=>{this.focus()}))}initInteractions(){if(!this.dialog)return;const e=re();this.options.draggable&&this.dialog.draggable({handle:".dialog-header",containment:"window",start:()=>{this.dialog?.addClass("dragging"),this.focus()},stop:()=>{this.dialog?.removeClass("dragging")}}),this.options.resizable&&this.dialog.resizable({handles:e?"se":"n,e,s,w,ne,se,sw,nw",minHeight:this.computePixelSize(this.options.minHeight,"h"),minWidth:this.computePixelSize(this.options.minWidth,"w"),start:()=>{this.dialog?.addClass("resizing"),this.focus();const e=this.computePixelSize(this.options.minWidth,"w"),t=this.computePixelSize(this.options.minHeight,"h");this.dialog.resizable("option","minWidth",e),this.dialog.resizable("option","minHeight",t)},stop:()=>{this.dialog?.removeClass("resizing")}}),e&&this.options.resizable&&this.dialog.find(".dialog-resize-handle").show()}centerDialog(){if(!this.dialog)return;const e=$(window).width()||0,t=$(window).height()||0,n=this.dialog.outerWidth()||0,i=this.dialog.outerHeight()||0,r=Math.max(0,(e-n)/2),s=Math.max(0,(t-i)/2);this.dialog.css({left:`${r}px`,top:`${s}px`,position:"fixed",zIndex:4e3}),this.focus()}}var Jn=ft(176),Kn=ft.n(Jn);const Yn=`${Ot}/src/component/prompt_view/public`,Xn=new Map;function Qn(e){const t=parseInt(e.attr("data-prompt-index")||"-1");return t>=0&&Xn.has(t)?Xn.get(t)||"":e.text()}async function ei(){await async function(e,t,n){return new Promise((i,r)=>{if("css"===t)fetch(e).then(e=>{if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return e.text()}).then(e=>{if(n){const e=document.getElementById(n);e&&e.remove()}const t=document.createElement("style");if(t.textContent=e,n){const e=n.toString().replace(/[^a-z0-9_-]/gi,"_");t.id=e}document.head.appendChild(t),i(t)}).catch(e=>{r(e)});else if("js"===t){const t=document.createElement("script");if(t.src=e,n){const e=n.toString().replace(/[^a-z0-9_-]/gi,"_");t.id=e}t.onload=i,t.onerror=r,document.body.appendChild(t)}else r("Invalid type specified")})}(`/scripts/extensions/${Yn}/style.css`,"css","prompt-view-style");const e=Wn.create({id:"prompt-view-dialog",title:"提示词发送情况",width:"50vw",height:"70vh",mobileWidth:"80vw",mobileHeight:"70vh",minWidth:"15vw",minHeight:"30vh",mobileMinWidth:"70vw",mobileMinHeight:"30vh",resizable:!0,draggable:!0,collapsible:!0,onClose:()=>{p.removeListener(h.CHAT_COMPLETION_PROMPT_READY,Zn),Gn(null),$("style#prompt-view-style").remove(),Xn.clear()}});if(!e)return;const t=e.render(),n=await Q(`${Yn}`,"prompt_view_content"),i=$(n);function r(e,t=!1,n=!1){$(".prompt-view-item").each(function(){const i=$(this),r=i.find(".prompt-view-item-content");if(function(e){if(e.removeClass("context-view-mode search-highlighted"),e[0]){new(Kn())(e[0]).unmark()}const t=Qn(e);t&&e.html($("<div>").text(t).html());e.off("click.contextExpand click.contextCollapse")}(r),!e)return void i.attr("data-search-visible","true");const a=Qn(r).trim(),o=function(e,t,n){try{let i=[];if(n){const n=new RegExp(t,"gi");i=[...e.matchAll(n)]}else{const n=function(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}(t),r=new RegExp(n,"gi");i=[...e.matchAll(r)]}return{matches:i.length>0,positions:i}}catch(e){return Pt().warn("搜索处理错误:",e),{matches:!1}}}(a,e,t);if(o.matches)if(n){const n=function(e,t,n=5){if(!t.matches)return[];const i=e.split(/\r?\n/),r=[];let s=0;for(let e=0;e<i.length;e++){const n=i[e],a=s,o=s+n.length;t.positions?t.positions.forEach(t=>{void 0!==t.index&&t.index>=a&&t.index<o&&r.push({line_number:e,start_column:t.index-a,end_column:t.index-a+t[0].length})}):t.indices&&t.indices.forEach(t=>{t.start>=a&&t.start<o&&r.push({line_number:e,start_column:t.start-a,end_column:t.end-a})}),s=o+1}const a=new Map;return r.forEach(e=>{const t=Math.floor(e.line_number/n);a.has(t)||a.set(t,[]),a.get(t).push(e)}),Array.from(a.entries()).map(([e,t])=>{const r=e*n,s=Math.min(r+n,i.length);return{context:{start_line:r,content:i.slice(r,s)},matches:t}})}(a,o);n.length>0?function(e,t,n,i=1){if(!n||0===t.length)return;e.addClass("context-view-mode");const r=Qn(e),s=function(e,t,n,i=1){if(!n||0===t.length)return e;const r=e.split(/\r?\n/),s=r.length,a=new Set,o=new Map;t.forEach(e=>{e.matches.forEach(e=>{a.add(e.line_number),o.has(e.line_number)||o.set(e.line_number,[]),o.get(e.line_number).push({start:e.start_column||0,end:e.end_column||0})})});const c=[],l=Array.from(a).sort((e,t)=>e-t);let u=null;if(l.forEach(e=>{const t=Math.max(0,e-i),n=Math.min(s-1,e+i);u&&t<=u.end+1?(u.end=n,u.matchedLines.push(e)):(u&&c.push(u),u={start:t,end:n,matchedLines:[e]})}),null!==u){const e=u;c.push(e)}const d=new Set;c.forEach(e=>{for(let t=e.start;t<=e.end;t++)d.add(t)});const p=Array.from(d).sort((e,t)=>e-t),h=[];let f=-1;const m=p[0];if(m>0){const e=`<div class="context-expand-button" data-start-line="0" data-end-line="${m-1}" data-expand-id="${"expand-0-"+(m-1)}">\n        <span class="expand-text">展开前面 ${m} 行内容</span>\n        <i class="fa-solid fa-chevron-down expand-icon"></i>\n      </div>`;h.push(e)}p.forEach(e=>{if(-1!==f&&e>f+1){const t=`<div class="context-expand-button" data-start-line="${f+1}" data-end-line="${e-1}" data-expand-id="${`expand-${f+1}-${e-1}`}">\n          <span class="expand-text">展开 ${e-f-1} 行隐藏内容</span>\n          <i class="fa-solid fa-chevron-down expand-icon"></i>\n        </div>`;h.push(t)}let t=r[e];if(""===t.trim())return void(f=e);const n=a.has(e);if(n&&o.has(e)){const n=o.get(e);n.sort((e,t)=>t.start-e.start),n.forEach(e=>{const n=t.substring(0,e.start),i=t.substring(e.start,e.end),r=t.substring(e.end);t=n+'<span class="search-highlight">'+i+"</span>"+r})}n?h.push(`<div class="context-line-matched">${t}</div>`):h.push(t),f=e});const g=p[p.length-1];if(g<s-1){const e=`<div class="context-expand-button" data-start-line="${g+1}" data-end-line="${s-1}" data-expand-id="${`expand-${g+1}-${s-1}`}">\n        <span class="expand-text">展开剩余 ${s-1-g} 行内容</span>\n        <i class="fa-solid fa-chevron-down expand-icon"></i>\n      </div>`;h.push(e)}return h.join("\n")}(r,t,n,i);e.html(s),function(e,t){e.off("click.contextExpand click.contextCollapse"),e.on("click.contextExpand",".context-expand-button",function(e){e.stopPropagation();const n=$(this),i=parseInt(n.attr("data-start-line")||"0"),r=parseInt(n.attr("data-end-line")||"0");if(i<=r){const e=t.split(/\r?\n/),s=[];for(let t=i;t<=r;t++)if(t>=0&&t<e.length){const n=e[t];if(""===n.trim())continue;s.push(n)}const a=`<div class="context-collapse-button" data-start-line="${i}" data-end-line="${r}" data-expand-id="${n.attr("data-expand-id")||`expand-${i}-${r}`}">\n          <span class="collapse-text">收起内容</span>\n          <i class="fa-solid fa-chevron-up collapse-icon"></i>\n        </div>`,o=$('<div class="context-expanded-container">');s.forEach(e=>{o.append(document.createTextNode(e+"\n"))}),o.append($(a)),n.replaceWith(o)}}),e.on("click.contextCollapse",".context-collapse-button",function(e){e.stopPropagation();const t=$(this),n=parseInt(t.attr("data-start-line")||"0"),i=parseInt(t.attr("data-end-line")||"0"),r=t.closest(".context-expanded-container"),s=`<div class="context-expand-button" data-start-line="${n}" data-end-line="${i}" data-expand-id="${t.attr("data-expand-id")||`expand-${n}-${i}`}">\n        <span class="expand-text">展开 ${i-n+1} 行隐藏内容</span>\n        <i class="fa-solid fa-chevron-down expand-icon"></i>\n      </div>`;r.replaceWith($(s))})}(e,r)}(r,n,e,1):s(r,e,t)}else s(r,e,t);i.attr("data-search-visible",o.matches?"true":"false")})}function s(e,t,n){if(!e[0]||!t)return;e.addClass("search-highlighted");const i=Qn(e);try{const r=new(Kn())(e[0]);if(r.unmark(),e.html($("<div>").text(i).html()),n)try{const e=new RegExp(t,"gi");r.markRegExp(e,{className:"search-highlight"})}catch(e){Pt().warn("正则表达式错误:",e),r.mark(t,{className:"search-highlight",caseSensitive:!1})}else r.mark(t,{className:"search-highlight",caseSensitive:!1})}catch(t){Pt().warn("高亮关键词时发生错误",t),e.html($("<div>").text(i).html())}}function a(){const e=$("#prompt-search").val()?.trim()||"",t=new Set;$(".prompt-filter-checkbox:checked").each(function(){const e=$(this).attr("data-role");e&&t.add(e)});const n=e.startsWith("/")&&e.endsWith("/")&&e.length>2,s=n?e.slice(1,-1):e,a=$("#prompt-search-compact-mode").is(":checked");!function(e){$(".prompt-view-item").each(function(){const t=$(this),n=t.find(".prompt-item-role");if(0===n.length)return void Pt().warn("发现缺少role信息的消息项，跳过处理:",t[0]);const i=n.text().trim(),r=e.has(i);t.attr("data-role-visible",r?"true":"false")})}(t),r(s,n,a),function(e){let t=0,n=0,i=0;e.find(".prompt-view-item").each(function(){const e=$(this);n++;const r="true"===e.attr("data-role-visible"),s="true"===e.attr("data-search-visible");if(r&&s){e.show(),t++;const n=e.find(".prompt-item-token"),r=parseInt(n.text().trim())||0;i+=r}else e.hide()}),e.find(".prompt-count").text(`显示 ${t} / ${n} 条消息`),e.find(".prompt-total-tokens").text(`总Token数: ${i}`)}(i)}t.append(i),i.find("#prompt-view-status-fresh").on("click",function(){const e=$(this);e.addClass("rotating"),setTimeout(()=>{e.removeClass("rotating")},2e3),qn()}),function(e){e.find("#prompt-filter-icon").on("click",function(){e.find("#prompt-filter-options").slideToggle(300)}),e.find(".prompt-filter-checkbox").on("change",function(){a()}),e.find("#prompt-search-compact-mode").on("change",function(){a()})}(i),function(e){let t=null;e.find("#prompt-search").on("input",function(){t&&clearTimeout(t),t=setTimeout(()=>{a(),t=null},500)})}(i);const o=i.find(".prompt-empty");Gn(async(e,t)=>{const n=i.find(".prompt-list");if(i.find(".prompt-total-tokens").text(`总Token数: ${t}`),i.find(".prompt-count").text(`共 ${e.length} 条消息`),0===e.length)return n.empty(),"no_connection"===C?o.text("未连接到API，请检查网络连接").show():o.text("暂无提示词数据").show(),void Xn.clear();o.hide();const r=await Q(`${Yn}`,"prompt_view_item");n.empty(),Xn.clear(),e.forEach((e,t)=>{const i=$(r);i.find(".prompt-item-role").text(e.role),i.find(".prompt-item-token").text(e.token.toString());const s=i.find(".prompt-view-item-content");s.attr("data-prompt-index",t.toString()),Xn.set(t,e.content),s.html($("<div>").text(e.content).html()),i.attr("data-role-visible","true"),i.attr("data-search-visible","true"),n.append(i)}),function(e){e.find(".prompt-view-item-header").on("click",function(){const e=$(this),t=e.closest(".prompt-view-item"),n=t.find(".prompt-view-item-content"),i=t.find(".divider"),r=e.find(".prompt-view-item-header-icon");n.slideToggle(300),i.slideToggle(300),r.toggleClass("fa-circle-chevron-down fa-circle-chevron-up")})}(n),a()}),p.makeLast(h.CHAT_COMPLETION_PROMPT_READY,Zn),qn()}$(window).on("pagehide",()=>{p.removeListener(h.CHAT_COMPLETION_PROMPT_READY,Zn)});const ti=[{regex:/\{\{get_global_variable::(.*?)\}\}/gi,replace:(e,t,n)=>{const i=Y.variables.global,r=_.get(i,n,null);return"string"==typeof r?r:JSON.stringify(r)}},{regex:/\{\{get_chat_variable::(.*?)\}\}/gi,replace:(e,t,n)=>{const i=c.variables,r=_.get(i,n,null);return"string"==typeof r?r:JSON.stringify(r)}},{regex:/\{\{get_message_variable::(.*?)\}\}/gi,replace:(e,t,n)=>{const i=(void 0!==e.message_id?o.slice(0,e.message_id+1):o).map(e=>_.get(e,["variables",e.swipe_id??0])).findLast(e=>void 0!==e)??{},r=_.get(i,n,null);return"string"==typeof r?r:JSON.stringify(r)}}];function ni(e,t){ti.push({regex:e,replace:t})}function ii(e){if(!e.dryRun)for(const t of e.chat)for(const e of ti)t.content=t.content.replace(e.regex,(n,...i)=>e.replace({role:t.role},n,...i))}function ri(e){const t=$(`div.mes[mesid="${e}"]`),n=t.find(".mes_text");if(0===n.length||!ti.some(e=>e.regex.test(n.text())))return;const i=n=>{for(const i of ti)n=n.replace(i.regex,(n,...r)=>i.replace({message_id:Number(e),role:"true"===t.attr("is_user")?"user":"assistant"},n,...r));return n};n.html((e,t)=>i(t)),n.find("code").filter((e,t)=>ti.some(e=>e.regex.test($(t).text()))).text((e,t)=>i(t))}function si(){$("div.mes").each((e,t)=>{ri($(t).attr("mesid"))})}function ai(){si(),p.on(h.CHAT_CHANGED,si),p.on(h.CHAT_COMPLETION_PROMPT_READY,ii),p.on(h.CHARACTER_MESSAGE_RENDERED,ri),p.on(h.USER_MESSAGE_RENDERED,ri),p.on(h.MESSAGE_UPDATED,ri),p.on(h.MESSAGE_SWIPED,ri)}function oi(){!async function(){await j(),await D()}(),p.removeListener(h.CHAT_CHANGED,si),p.removeListener(h.CHAT_COMPLETION_PROMPT_READY,ii),p.removeListener(h.CHARACTER_MESSAGE_RENDERED,ri),p.removeListener(h.USER_MESSAGE_RENDERED,ri),p.removeListener(h.MESSAGE_UPDATED,ri),p.removeListener(h.MESSAGE_SWIPED,ri)}function ci(e,t,n,{depth:i,character_name:r}={}){let s=Ae(e,{user_input:Ne.USER_INPUT,ai_output:Ne.AI_OUTPUT,slash_command:Ne.SLASH_COMMAND,world_info:Ne.WORLD_INFO,reasoning:Ne.REASONING}[t],{characterOverride:r,isMarkdown:"display"===n,isPrompt:"prompt"===n,depth:i});return s=V(s,void 0,r,void 0,void 0),ti.forEach(e=>{s=s.replace(e.regex,(n,...r)=>e.replace({role:{user_input:"user",ai_output:"assistant",slash_command:"system",world_info:"system",reasoning:"system"}[t],message_id:void 0!==i?o.length-i-1:void 0},n,...r))}),s}function li(){return Y?.character_allowed_regex?.includes(a?.[H]?.avatar)}function ui(){return Y.regex??[]}function di(){return a[H]?.data?.extensions?.regex_scripts??[]}function pi(e,t){return{id:e.id,script_name:e.scriptName,enabled:!e.disabled,run_on_edit:e.runOnEdit,scope:t,find_regex:e.findRegex,replace_string:e.replaceString,source:{user_input:e.placement.includes(Ne.USER_INPUT),ai_output:e.placement.includes(Ne.AI_OUTPUT),slash_command:e.placement.includes(Ne.SLASH_COMMAND),world_info:e.placement.includes(Ne.WORLD_INFO)},destination:{display:e.markdownOnly,prompt:e.promptOnly},min_depth:"number"==typeof e.minDepth?e.minDepth:null,max_depth:"number"==typeof e.maxDepth?e.maxDepth:null}}function hi(e){return{id:e.id,scriptName:e.script_name,disabled:!e.enabled,runOnEdit:e.run_on_edit,findRegex:e.find_regex,replaceString:e.replace_string,trimStrings:[],placement:[...e.source.user_input?[Ne.USER_INPUT]:[],...e.source.ai_output?[Ne.AI_OUTPUT]:[],...e.source.slash_command?[Ne.SLASH_COMMAND]:[],...e.source.world_info?[Ne.WORLD_INFO]:[]],substituteRegex:0,minDepth:e.min_depth,maxDepth:e.max_depth,markdownOnly:e.destination.display,promptOnly:e.destination.prompt}}function fi(){const e=li();return Pt().info("查询到局部正则"+(e?"被启用":"被禁用")),e}function mi({scope:e="all",enable_state:t="all"}={}){if(!["all","enabled","disabled"].includes(t))throw Error(`提供的 enable_state 无效, 请提供 'all', 'enabled' 或 'disabled', 你提供的是: ${t}`);if(!["all","global","character"].includes(e))throw Error(`提供的 scope 无效, 请提供 'all', 'global' 或 'character', 你提供的是: ${e}`);let n=[];return"all"!==e&&"global"!==e||(n=[...n,...ui().map(e=>pi(e,"global"))]),"all"!==e&&"character"!==e||(n=[...n,...di().map(e=>pi(e,"character"))]),"all"!==t&&(n=n.filter(e=>e.enabled===("enabled"===t))),structuredClone(n)}async function gi(e,{scope:t="all"}){if(!["all","global","character"].includes(t))throw Error(`提供的 scope 无效, 请提供 'all', 'global' 或 'character', 你提供的是: ${t}`);const n=e.filter(e=>""==e.script_name);if(n.length>0)throw Error(`不能将酒馆正则的名称设置为空字符串:\n${JSON.stringify(n.map(e=>e.id))}`);const[i,r]=_.partition(e,e=>"global"===e.scope).map(e=>e.map(hi)),s=a[H];"all"!==t&&"global"!==t||(Y.regex=i),"all"!==t&&"character"!==t||s&&(a[H].data.extensions.regex_scripts=r,await te(H,"regex_scripts",r)),await U(),s&&await j(),await D(),Pt().info(`替换酒馆正则${"all"===t||"global"===t?`, 全局正则:\n${JSON.stringify(i)}`:""}${"all"===t||"character"===t?`, 局部正则:\n${JSON.stringify(r)}`:""}`)}async function vi(e,{scope:t="all"}={}){let n=mi({scope:t});return n=await e(n),Pt().info(`对${{all:"全部",global:"全局",character:"局部"}[t]}变量表进行更新`),await gi(n,{scope:t}),n}const yi=new Map;function _i(){0!==yi.size&&(Pt().info("[(deprecated)Script] 清理全局脚本..."),yi.forEach((e,t)=>{e.remove()}),yi.clear(),Pt().info("[(deprecated)Script] 全局脚本清理完成!"))}async function bi(){try{_i();const e=function(){const e=e=>e.scriptName.replace(/^【.*】/,"").startsWith("脚本-"),t=e=>!e.disabled,n=e=>e.scriptName.replace(/^【.*】/,"").replace("脚本-",""),i=[],r=ui().filter(e).filter(t);i.push(...r);const s=di().filter(e).filter(t).filter(e=>!!li()||e.runOnEdit);return i.push(...s),i.map(e=>({name:n(e),code:e.replaceString}))}();Pt().info(`[(deprecated)Script] 加载全局脚本: ${JSON.stringify(e.map(e=>e.name))}`);const t=[];e.forEach(e=>{const{iframe:n,load_promise:i}=function(e){const t=document.createElement("iframe");t.style.display="none",t.id=`script-iframe-${e.name}`;const n=`\n    <html>\n    <head>\n      ${bn}\n      <script src="${_n.get("iframe")}"><\/script>\n    </head>\n    <body>\n      ${e.code}\n    </body>\n    </html>\n  `;t.srcdoc=n;const i=new Promise(e=>{t.onload=()=>{Pt().info(`[(deprecated)Script](${t.id}) 加载完毕`),e()}});return document.body.appendChild(t),{iframe:t,load_promise:i}}(e);yi.set(e.name,n),t.push(i)}),await Promise.allSettled(t)}catch(e){throw Pt().error("[(deprecated)Script] 全局脚本加载失败:",e),e}}const wi=[h.CHAT_CHANGED];class $i{id;name;content;info;buttons;data;enabled;constructor(e){this.id=e?.id&&""!==e.id.trim()?e.id:fe(),this.name=e?.name||"",this.content=e?.content||"",this.info=e?.info||"",this.enabled=e?.enabled||!1,this.buttons=e?.buttons||[],this.data=e?.data||{}}}var ki;!function(e){e.GLOBAL="global",e.CHARACTER="character"}(ki||(ki={}));function Si(e){return e&&"object"==typeof e&&"type"in e&&"value"in e}function Ei(e){return e&&"object"==typeof e&&"id"in e&&"name"in e&&"content"in e}function Ii(e){const t=[];for(const n of e)if(Ei(n))t.push(n);else if(Si(n))if("script"===n.type)t.push(n.value);else if("folder"===n.type){const e=n.value;t.push(...e)}return t}function xi(e){return e===ki.GLOBAL?ki.CHARACTER:ki.GLOBAL}function Ti(e){return e===ki.GLOBAL?"#global-script-list":"#character-script-list"}function Oi(e){return e===ki.GLOBAL?"#global-batch-controls":"#character-batch-controls"}function Ai(e){return e===ki.GLOBAL?"#global-script-enable-toggle":"#character-script-enable-toggle"}class Ni{static instance;globalScripts=[];characterScripts=[];_isGlobalScriptEnabled=!1;_isCharacterScriptEnabled=!1;constructor(){this.loadScripts()}get isGlobalScriptEnabled(){return this._isGlobalScriptEnabled}get isCharacterScriptEnabled(){return this._isCharacterScriptEnabled}static getInstance(){return Ni.instance||(Ni.instance=new Ni),Ni.instance}static destroyInstance(){Ni.instance&&(Ni.instance=void 0)}checkCharacterScriptEnabled(){const e=Dt("script.characters_with_scripts")||[],t=a?.[H]?.avatar;return e?.includes(t)||!1}loadScripts(){const e=Dt("script.scriptsRepository")||[];this.globalScripts=this.migrateAndExtractScripts(e,ki.GLOBAL);const t=a[H]?.data?.extensions?.TavernHelper_scripts||[];this.characterScripts=this.migrateAndExtractScripts(t,ki.CHARACTER),this._isGlobalScriptEnabled=Dt("script.global_script_enabled")??!1,this._isCharacterScriptEnabled=this.checkCharacterScriptEnabled()}migrateAndExtractScripts(e,t){if(!Array.isArray(e))return[];let n=!1;const i=[];for(const t of e)Ei(t)?(n=!0,i.push({type:"script",value:new $i(t)})):Si(t)?"script"===t.type?i.push({type:"script",value:new $i(t.value)}):"folder"===t.type&&i.push({type:"folder",id:t.id,name:t.name,icon:t.icon||"fa-folder",color:t.color||document.documentElement.style.getPropertyValue("--SmartThemeBodyColor"),value:Array.isArray(t.value)?t.value.map(e=>new $i(e)):[]}):Pt().warn("[ScriptManager] 无法解析的脚本数据:",t);return n&&this.saveMigratedRepository(i,t),Ii(i)}async saveMigratedRepository(e,t){try{if(t===ki.GLOBAL)Lt("script.scriptsRepository",e);else{if(!H)return void Pt().warn("[ScriptManager] 无法保存角色脚本迁移数据：当前角色为空");await te(H,"TavernHelper_scripts",e)}Pt().info(`[ScriptManager] 成功迁移${t}脚本数据结构`)}catch(e){Pt().error(`[ScriptManager] 迁移${t}脚本数据失败:`,e)}}getGlobalScripts(){return this.globalScripts}getCharacterScripts(){const e=a[H]?.data?.extensions?.TavernHelper_scripts||[];return this.characterScripts=this.migrateAndExtractScripts(e,ki.CHARACTER),this.characterScripts}getScriptById(e){let t=this.globalScripts.find(t=>t.id===e);return t||(t=this.characterScripts.find(t=>t.id===e),t||void 0)}async saveScript(e,t){if(!e.name||""===e.name.trim())throw new Error("[ScriptManager] 保存失败，脚本名称为空");const n=t===ki.GLOBAL?Dt("script.scriptsRepository")||[]:a[H]?.data?.extensions?.TavernHelper_scripts||[],i=this.ensureRepositoryStructure(n);let r=-1,s=!1,o=-1;for(let t=0;t<i.length;t++){const n=i[t];if("script"===n.type&&n.value.id===e.id){r=t;break}if("folder"===n.type){const i=n.value.findIndex(t=>t.id===e.id);if(-1!==i){s=!0,o=t,r=i;break}}}if(s&&o>=0){i[o].value[r]=e}else r>=0?i[r].value=e:i.push({type:"script",value:e});t===ki.GLOBAL?await this.saveGlobalRepositoryItems(i):await this.saveCharacterRepositoryItems(i),this.loadScripts()}ensureRepositoryStructure(e){const t=[];for(const n of e)if(Ei(n))t.push({type:"script",value:new $i(n)});else if(Si(n))"script"===n.type?t.push({type:"script",value:new $i(n.value)}):"folder"===n.type&&(n.icon||(n.icon="fa-folder"),n.color||(n.color=document.documentElement.style.getPropertyValue("--SmartThemeBodyColor")),t.push({...n,value:Array.isArray(n.value)?n.value.map(e=>new $i(e)):[]}));else try{t.push({type:"script",value:new $i(n)})}catch(e){Pt().warn("[ScriptManager] 无法解析的脚本数据:",n,e)}return t}async saveGlobalScripts(e){Lt("script.scriptsRepository",e),this.globalScripts=e}async saveCharacterScripts(e){if(!H)throw new Error("[ScriptManager] 保存失败，当前角色为空");await te(H,"TavernHelper_scripts",e),this.characterScripts=e}async saveGlobalRepositoryItems(e){Lt("script.scriptsRepository",e),this.globalScripts=Ii(e)}async saveCharacterRepositoryItems(e){if(!H)throw new Error("[ScriptManager] 保存失败，当前角色为空");await te(H,"TavernHelper_scripts",e),this.characterScripts=Ii(e)}async deleteScript(e,t){const n=t===ki.GLOBAL?this.getGlobalRepositoryItems():this.getCharacterRepositoryItems();let i=!1;for(let t=0;t<n.length;t++){const r=n[t];if("script"===r.type&&r.value.id===e){n.splice(t,1),i=!0;break}if("folder"===r.type){const t=r.value,n=t.findIndex(t=>t.id===e);if(-1!==n){t.splice(n,1),i=!0;break}}}if(!i)throw new Error("[ScriptManager] 删除脚本失败，脚本不存在");t===ki.GLOBAL?await this.saveGlobalRepositoryItems(n):await this.saveCharacterRepositoryItems(n)}async updateScriptTypeEnableState(e,t){if(e===ki.GLOBAL)Lt("script.global_script_enabled",t),this._isGlobalScriptEnabled=t;else{const e=Dt("script.characters_with_scripts")||[],n=a?.[H]?.avatar;if(t)n&&!e.includes(n)&&e.push(n);else{const t=e.indexOf(n);-1!==t&&e.splice(t,1)}Lt("script.characters_with_scripts",e),this._isCharacterScriptEnabled=t}}getScriptType(e){return this.globalScripts.some(t=>t.id===e.id)?ki.GLOBAL:ki.CHARACTER}refreshCharacterScriptEnabledState(){this._isCharacterScriptEnabled=this.checkCharacterScriptEnabled()}getGlobalRepositoryItems(){const e=Dt("script.scriptsRepository")||[];return this.ensureRepositoryStructure(e)}getCharacterRepositoryItems(){const e=a[H]?.data?.extensions?.TavernHelper_scripts||[];return this.ensureRepositoryStructure(e)}async createFolder(e,t,n,i){if(!e||""===e.trim())throw new Error("[ScriptManager] 文件夹名称不能为空");const r=t===ki.GLOBAL?this.getGlobalRepositoryItems():this.getCharacterRepositoryItems();if(r.find(t=>"folder"===t.type&&t.name===e.trim()))throw new Error("[ScriptManager] 文件夹名称已存在");const s=fe(),a={type:"folder",id:s,name:e.trim(),icon:n||"fa-folder",color:i||document.documentElement.style.getPropertyValue("--SmartThemeBodyColor"),value:[]};return r.unshift(a),t===ki.GLOBAL?await this.saveGlobalRepositoryItems(r):await this.saveCharacterRepositoryItems(r),s}async editFolder(e,t,n,i,r){if(!t||""===t.trim())throw new Error("[ScriptManager] 文件夹名称不能为空");const s=n===ki.GLOBAL?this.getGlobalRepositoryItems():this.getCharacterRepositoryItems(),a=s.findIndex(t=>"folder"===t.type&&t.id===e);if(-1===a)throw new Error("[ScriptManager] 文件夹不存在");if(s.find(n=>"folder"===n.type&&n.name===t.trim()&&n.id!==e))throw new Error("[ScriptManager] 文件夹名称已存在");s[a].name=t.trim(),void 0!==i&&(s[a].icon=i),void 0!==r&&(s[a].color=r),n===ki.GLOBAL?await this.saveGlobalRepositoryItems(s):await this.saveCharacterRepositoryItems(s)}async deleteFolder(e,t){const n=t===ki.GLOBAL?this.getGlobalRepositoryItems():this.getCharacterRepositoryItems(),i=n.findIndex(t=>"folder"===t.type&&t.id===e);if(-1===i)throw new Error("[ScriptManager] 文件夹不存在");n.splice(i,1),t===ki.GLOBAL?await this.saveGlobalRepositoryItems(n):await this.saveCharacterRepositoryItems(n)}async moveItemToOtherType(e,t){const n=xi(t),i=t===ki.GLOBAL?this.getGlobalRepositoryItems():this.getCharacterRepositoryItems();let r=!1,s=null;if("script"===e.type){for(let t=0;t<i.length;t++){const n=i[t];if("script"===n.type&&n.value.id===e.id){s=n,i.splice(t,1),r=!0;break}if("folder"===n.type){const t=n.value,i=t.findIndex(t=>t.id===e.id);if(-1!==i){s={type:"script",value:t[i]},t.splice(i,1),r=!0;break}}}if(!r)throw new Error("[ScriptManager] 移动脚本失败，脚本不存在")}else if("folder"===e.type){const t=i.findIndex(t=>"folder"===t.type&&t.id===e.id);if(-1===t)throw new Error("[ScriptManager] 文件夹不存在");s=i[t],i.splice(t,1),r=!0}if(!r||!s)throw new Error("[ScriptManager] 移动失败，项目不存在");const a=n===ki.GLOBAL?this.getGlobalRepositoryItems():this.getCharacterRepositoryItems();if("folder"===s.type){if(a.find(e=>"folder"===e.type&&e.name===s.name))throw toastr.error("目标位置已存在同名文件夹"),new Error("[ScriptManager] 目标位置已存在同名文件夹");a.unshift(s)}else a.push(s);t===ki.GLOBAL?(await this.saveGlobalRepositoryItems(i),await this.saveCharacterRepositoryItems(a)):(await this.saveCharacterRepositoryItems(i),await this.saveGlobalRepositoryItems(a))}async moveScriptToFolder(e,t,n){const i=n===ki.GLOBAL?this.getGlobalRepositoryItems():this.getCharacterRepositoryItems();let r=null;for(let t=0;t<i.length;t++){const n=i[t];if("script"===n.type&&n.value.id===e){r=n.value,i.splice(t,1);break}if("folder"===n.type){const t=n.value,i=t.findIndex(t=>t.id===e);if(-1!==i){r=t[i],t.splice(i,1);break}}}if(!r)throw new Error("[ScriptManager] 脚本不存在");if(null===t)i.push({type:"script",value:r});else{const e=i.find(e=>"folder"===e.type&&e.id===t);if(!e)throw new Error("[ScriptManager] 目标文件夹不存在");const n=e.value;if(n.find(e=>e.name===r.name))throw new Error("[ScriptManager] 文件夹中已存在同名脚本");n.push(r)}n===ki.GLOBAL?await this.saveGlobalRepositoryItems(i):await this.saveCharacterRepositoryItems(i)}getFolderScripts(e,t){const n=(t===ki.GLOBAL?this.getGlobalRepositoryItems():this.getCharacterRepositoryItems()).find(t=>"folder"===t.type&&t.id===e);return n?n.value:[]}getRootScripts(e){return(e===ki.GLOBAL?this.getGlobalRepositoryItems():this.getCharacterRepositoryItems()).filter(e=>"script"===e.type).map(e=>e.value)}getFolders(e){return(e===ki.GLOBAL?this.getGlobalRepositoryItems():this.getCharacterRepositoryItems()).filter(e=>"folder"===e.type)}async toggleFolderScripts(e,t,n){const i=t===ki.GLOBAL?this.getGlobalRepositoryItems():this.getCharacterRepositoryItems(),r=i.find(t=>"folder"===t.type&&t.id===e);if(!r)throw new Error("[ScriptManager] 文件夹不存在");const s=r.value;let a=!1;for(const e of s)e.enabled!==n&&(e.enabled=n,a=!0);a&&(t===ki.GLOBAL?await this.saveGlobalRepositoryItems(i):await this.saveCharacterRepositoryItems(i))}getFolderScriptsState(e,t){const n=this.getFolderScripts(e,t);if(0===n.length)return"none";return 0===n.filter(e=>e.enabled).length?"none":"all"}}var Ci;!function(e){e.SCRIPT_TOGGLE="script_toggle",e.SCRIPT_RUN="script_run",e.SCRIPT_STOP="script_stop",e.SCRIPT_CREATE="script_create",e.SCRIPT_UPDATE="script_update",e.SCRIPT_DELETE="script_delete",e.SCRIPT_MOVE="script_move",e.SCRIPT_EDIT="script_edit",e.FOLDER_CREATE="folder_create",e.FOLDER_EDIT="folder_edit",e.FOLDER_DELETE="folder_delete",e.FOLDER_MOVE="folder_move",e.FOLDER_SCRIPTS_TOGGLE="folder_scripts_toggle",e.TYPE_TOGGLE="type_toggle",e.BUTTON_ADD="button_add",e.BUTTON_REMOVE="button_remove",e.SCRIPT_IMPORT="script_import",e.SCRIPT_EXPORT="script_export",e.ORDER_CHANGED="order_changed",e.UI_REFRESH="ui_refresh",e.UI_LOADED="ui_loaded"}(Ci||(Ci={}));class Di{static instance;EVENT_NAMESPACE="script_repository_";activeListeners=new Map;constructor(){}static getInstance(){return Di.instance||(Di.instance=new Di),Di.instance}getNamespacedEvent(e){return`${this.EVENT_NAMESPACE}${e}`}on(e,t){this.activeListeners.has(e)||this.activeListeners.set(e,new Set),this.activeListeners.get(e)?.add(t);const n=this.getNamespacedEvent(e);p.on(n,t)}off(e,t){const n=this.getNamespacedEvent(e);p.removeListener(n,t);const i=this.activeListeners.get(e);i&&(i.delete(t),0===i.size&&this.activeListeners.delete(e))}emit(e,t){const n=this.getNamespacedEvent(e);p.emit(n,t)}clear(){this.activeListeners.forEach((e,t)=>{const n=this.getNamespacedEvent(t);e.forEach(e=>{p.removeListener(n,e)})}),this.activeListeners.clear()}static destroyInstance(){Di.instance&&(Di.instance.clear(),Di.instance=void 0)}}const Li=Di.getInstance();class Ri{async runScript(e,t){const n=t===ki.GLOBAL?"全局":"局部";try{const t=$("iframe").filter((t,n)=>$(n).attr("script-id")===e.id)[0];t&&Nn(t);const i=this.createScriptHtml(e),r=$("<iframe>",{style:"display: none;",id:`tavern-helper-script-${e.name}`,srcdoc:i,"script-id":e.id});r.on("load",()=>{Pt().info(`[ScriptManager] 启用${n}脚本["${e.name}"]`)}),$("body").append(r)}catch(t){throw Pt().error(`[ScriptManager] ${n}脚本启用失败:["${e.name}"]`,t),toastr.error(`${n}脚本启用失败:["${e.name}"]`),t}}async stopScript(e,t){const n=t===ki.GLOBAL?"全局":"局部",i=$("iframe").filter((t,n)=>$(n).attr("script-id")===e.id)[0];i&&(Nn(i),Pt().info(`[ScriptManager] 禁用${n}脚本["${e.name}"]`))}createScriptHtml(e){return`\n      <html>\n      <head>\n        ${bn}\n        <script>\n          (function ($) {\n            var original$ = $;\n            window.$ = function (selector, context) {\n              if (context === undefined || context === null) {\n                if (window.parent && window.parent.document) {\n                  context = window.parent.document;\n                } else {\n                  log.warn('无法访问 window.parent.document，将使用当前 iframe 的 document 作为上下文。');\n                  context = window.document;\n                }\n              }\n              return original$(selector, context);\n            };\n          })(jQuery);\n        <\/script>\n        <script src="${_n.get("iframe")}"><\/script>\n      </head>\n      <body>\n        <script type="module">\n          ${e.content}\n        <\/script>\n      </body>\n      </html>\n    `}async clearAllScriptsIframe(){const e=$('iframe[id^="tavern-helper-script-"]');for(const t of e)Nn(t)}}class ji{static instance;scriptData;executor;constructor(){this.scriptData=Ni.getInstance(),this.executor=new Ri,this.registerEventListeners()}static getInstance(){return ji.instance||(ji.instance=new ji),ji.instance}static destroyInstance(){ji.instance&&(ji.instance=void 0)}registerEventListeners(){Li.on(Ci.SCRIPT_TOGGLE,async e=>{const{script:t,type:n,enable:i,userInput:r=!0}=e;await this.toggleScript(t,n,i,r)}),Li.on(Ci.TYPE_TOGGLE,async e=>{const{type:t,enable:n,userInput:i=!0}=e;await this.toggleScriptType(t,n,i)}),Li.on(Ci.SCRIPT_IMPORT,async e=>{const{file:t,type:n}=e;await this.importScript(t,n)}),Li.on(Ci.SCRIPT_DELETE,async e=>{const{scriptId:t,type:n}=e;await this.deleteScript(t,n)}),Li.on(Ci.SCRIPT_CREATE,async e=>{const{script:t,type:n}=e;await this.createScript(t,n)}),Li.on(Ci.SCRIPT_UPDATE,async e=>{const{script:t,type:n}=e;await this.updateScript(t,n)}),Li.on(Ci.SCRIPT_MOVE,async e=>{const{script:t,fromType:n}=e;await this.moveScript(t,n)}),Li.on(Ci.FOLDER_MOVE,async e=>{const{folderId:t,fromType:n}=e;await this.moveFolder(t,n)}),Li.on(Ci.ORDER_CHANGED,async e=>{const{data:t,type:n}=e;await this.saveOrder(t,n)}),Li.on(Ci.UI_LOADED,async()=>{if(!Dt("enabled_extension"))return;const e=this.scriptData.getGlobalScripts(),t=this.scriptData.getCharacterScripts();this.scriptData.isGlobalScriptEnabled?await this.runScriptsByType(e,ki.GLOBAL):Pt().info("[ScriptManager] 全局脚本类型未启用，跳过运行全局脚本"),this.scriptData.isCharacterScriptEnabled?await this.runScriptsByType(t,ki.CHARACTER):Pt().info("[ScriptManager] 角色脚本类型未启用，跳过运行角色脚本")})}async toggleScript(e,t,n,i=!0){i&&(e.enabled=n,await this.scriptData.saveScript(e,t));try{if(n){if(t===ki.GLOBAL&&!this.scriptData.isGlobalScriptEnabled)return void Pt().info(`[script_manager] 全局脚本类型未启用，跳过启用脚本["${e.name}"]`);if(t===ki.CHARACTER&&!this.scriptData.isCharacterScriptEnabled)return void Pt().info(`[script_manager] 角色脚本类型未启用，跳过启用脚本["${e.name}"]`);await this.runScript(e,t)}else await this.stopScript(e,t);Li.emit(Ci.UI_REFRESH,{action:"script_toggle",script:e,type:t,enable:n})}catch(t){Pt().error(`[ScriptManager] 切换脚本状态失败: ${e.name}`,t),toastr.error(`切换脚本状态失败: ${e.name}`)}}async toggleScriptType(e,t,n=!0){n&&await this.scriptData.updateScriptTypeEnableState(e,t);try{const n=e===ki.GLOBAL?this.scriptData.getGlobalScripts():this.scriptData.getCharacterScripts();t?await this.runScriptsByType(n,e):await this.stopScriptsByType(n,e),Li.emit(Ci.UI_REFRESH,{action:"type_toggle",type:e,enable:t})}catch(t){Pt().error(`[ScriptManager] 切换脚本类型状态失败: ${e}`,t),toastr.error(`切换脚本类型状态失败: ${e}`)}}async runScript(e,t){Dt("enabled_extension")?(t!==ki.GLOBAL||this.scriptData.isGlobalScriptEnabled)&&(t!==ki.CHARACTER||this.scriptData.isCharacterScriptEnabled)&&(await this.executor.runScript(e,t),e.buttons&&e.buttons.length>0&&Li.emit(Ci.BUTTON_ADD,{script:e})):toastr.error("[ScriptManager] 扩展未启用")}async stopScript(e,t){await this.executor.stopScript(e,t),e.buttons&&e.buttons.length>0&&Li.emit(Ci.BUTTON_REMOVE,{scriptId:e.id})}async runScriptsByType(e,t){if(!Dt("enabled_extension"))return void toastr.error("[ScriptManager] 酒馆助手未启用，无法运行脚本");if(t===ki.GLOBAL&&!this.scriptData.isGlobalScriptEnabled)return;if(t===ki.CHARACTER&&!this.scriptData.isCharacterScriptEnabled)return;const n=e.filter(e=>e.enabled);for(const e of n)await this.executor.runScript(e,t),e.buttons&&e.buttons.length>0&&Li.emit(Ci.BUTTON_ADD,{script:e})}async stopScriptsByType(e,t){const n=e.filter(e=>e.enabled);for(const e of n)await this.executor.stopScript(e,t),e.buttons&&e.buttons.length>0&&Li.emit(Ci.BUTTON_REMOVE,{scriptId:e.id})}async importScript(e,t){try{if(e.name.toLowerCase().endsWith(".zip"))await this.importFromZip(e,t);else{if(!e.name.toLowerCase().endsWith(".json"))throw new Error("不支持的文件格式，请选择 .json 或 .zip 文件");{const n=await this.readFileAsText(e),i=JSON.parse(n);Array.isArray(i)?await this.importMultipleItems(i,t):await this.importSingleScript(i,t)}}}catch(e){Pt().error("[ScriptManager] 导入失败:",e),toastr.error(`导入失败: ${e instanceof Error?e.message:"无效的文件格式"}`)}}async importFromZip(e,t){window.JSZip||(Pt().info("import jszip"),await Promise.resolve().then(ft.bind(ft,730)));const n=new JSZip,i=await n.loadAsync(e);let r=0,s=0;const a=new Set,o=[];for(const e in i.files){if(!i.files[e].dir&&e.endsWith(".json")){const t=e.split("/");1===t.length?o.push(e):2===t.length&&a.add(t[0])}}for(const e of o){const n=i.files[e],s=await n.async("string"),a=JSON.parse(s);if(a.name&&"content"in a){const e=new $i({...a,enabled:!1});await this.handleScriptImport(e,t),r++}}for(const e of a){r+=await this.importFolderFromZipNew(i,e,t),s++}Li.emit(Ci.UI_REFRESH,{action:t===ki.GLOBAL?"refresh_global_scripts":"refresh_charact_scripts"}),toastr.success(`成功导入 ${r} 个脚本和 ${s} 个文件夹`)}async importFolderFromZipNew(e,t,n){const i=n===ki.GLOBAL?this.scriptData.getGlobalRepositoryItems():this.scriptData.getCharacterRepositoryItems();let r=t,s=1;for(;i.some(e=>"folder"===e.type&&e.name===r);)r=`${t}_${s}`,s++;const a=await this.scriptData.createFolder(r,n);let o=0;for(const i in e.files){const r=e.files[i];if(!r.dir&&i.startsWith(`${t}/`)&&i.endsWith(".json")){const e=await r.async("string"),t=JSON.parse(e);if(t.name&&"content"in t){const e=new $i({...t,enabled:!1});await this.handleScriptImport(e,n),await this.scriptData.moveScriptToFolder(e.id,a,n),o++}}}return o}async importSingleScript(e,t){if(!e.name||!("content"in e))throw new Error("无效的脚本数据");const n=new $i({...e,enabled:!1});await this.handleScriptImport(n,t),toastr.success(`脚本 '${n.name}' 导入成功。`)}async importMultipleItems(e,t){for(const n of e)if("folder"===n.type)await this.importFolder(n,t);else if("script"===n.type){const e=new $i({...n.value,enabled:!1});await this.handleScriptImport(e,t)}else if(n.name&&"content"in n){const e=new $i({...n,enabled:!1});await this.handleScriptImport(e,t)}Li.emit(Ci.UI_REFRESH,{action:t===ki.GLOBAL?"refresh_global_scripts":"refresh_charact_scripts"}),toastr.success("导入成功")}async importFolder(e,t){if(!e.name||!Array.isArray(e.value))throw new Error("无效的文件夹数据");const n=t===ki.GLOBAL?this.scriptData.getGlobalRepositoryItems():this.scriptData.getCharacterRepositoryItems();let i=e.name,r=1;for(;n.some(e=>"folder"===e.type&&e.name===i);)i=`${e.name}_${r}`,r++;const s=await this.scriptData.createFolder(i,t);for(const n of e.value){const e=new $i({...n,enabled:!1});await this.handleScriptImport(e,t),await this.scriptData.moveScriptToFolder(e.id,s,t)}}async handleScriptImport(e,t){const n=this.scriptData.getGlobalScripts(),i=this.scriptData.getCharacterScripts(),r=n.find(t=>t.id===e.id),s=i.find(t=>t.id===e.id);let a,o;if(r?(a=r,o=ki.GLOBAL):s&&(a=s,o=ki.CHARACTER),a&&o){switch(await this.handleScriptIdConflict(e,a,t,"import")){case"new":e.id=fe(),await this.createScript(e,t);break;case"override":await this.deleteScript(a.id,o),await this.createScript(e,t);break;case"cancel":return}}else await this.createScript(e,t)}readFileAsText(e){return new Promise((t,n)=>{const i=new FileReader;i.onload=e=>t(e.target?.result),i.onerror=e=>n(e),i.readAsText(e)})}async createScript(e,t){await this.scriptData.saveScript(e,t),Li.emit(Ci.UI_REFRESH,{action:"script_create",script:e,type:t})}async updateScript(e,t){await this.scriptData.saveScript(e,t),Li.emit(Ci.UI_REFRESH,{action:"script_update",script:e,type:t})}async saveOrder(e,t){t===ki.GLOBAL?await this.scriptData.saveGlobalRepositoryItems(e):await this.scriptData.saveCharacterRepositoryItems(e),this.scriptData.loadScripts()}async deleteScript(e,t){const n=this.scriptData.getScriptById(e);if(!n)throw new Error("[ScriptManager] 脚本不存在");await this.stopScript(n,t),await this.scriptData.deleteScript(e,t),Li.emit(Ci.UI_REFRESH,{action:"script_delete",scriptId:e,type:t})}async moveScript(e,t){await this.stopScript(e,t);const n=xi(t),i=this.scriptData.getScriptById(e.id),r=i?this.scriptData.getScriptType(i):null;if(i&&r===n){switch(await this.handleScriptIdConflict(e,i,n,"move")){case"new":e.id=fe();break;case"override":await this.deleteScript(i.id,n);break;case"cancel":return}}await this.scriptData.moveItemToOtherType({type:"script",id:e.id,value:e},t),Li.emit(Ci.UI_REFRESH,{action:"script_move",script:e,fromType:t,targetType:n}),e.enabled&&(n===ki.GLOBAL&&this.scriptData.isGlobalScriptEnabled||n===ki.CHARACTER&&this.scriptData.isCharacterScriptEnabled)&&await this.runScript(e,n)}refreshCharacterScriptData(){this.scriptData.getCharacterScripts()}getGlobalScripts(){return this.scriptData.getGlobalScripts()}getCharacterScripts(){return this.scriptData.getCharacterScripts()}refreshCharacterScriptEnabledState(){this.scriptData.refreshCharacterScriptEnabledState()}get isGlobalScriptEnabled(){return this.scriptData.isGlobalScriptEnabled}get isCharacterScriptEnabled(){return this.scriptData.isCharacterScriptEnabled}getScriptById(e){return this.scriptData.getScriptById(e)}getGlobalRepositoryItems(){return this.scriptData.getGlobalRepositoryItems()}getCharacterRepositoryItems(){return this.scriptData.getCharacterRepositoryItems()}async createFolder(e,t,n,i){return await this.scriptData.createFolder(e,t,n,i)}async editFolder(e,t,n,i,r){await this.scriptData.editFolder(e,t,n,i,r)}async deleteFolder(e,t){await this.scriptData.deleteFolder(e,t)}async moveScriptToFolder(e,t,n){await this.scriptData.moveScriptToFolder(e,t,n)}async moveFolder(e,t){const n=xi(t);await this.scriptData.moveItemToOtherType({type:"folder",id:e},t),Li.emit(Ci.UI_REFRESH,{action:"folder_move",folderId:e,fromType:t,targetType:n})}getFolderScripts(e,t){return this.scriptData.getFolderScripts(e,t)}getRootScripts(e){return this.scriptData.getRootScripts(e)}getFolders(e){return this.scriptData.getFolders(e)}async toggleFolderScripts(e,t,n){try{await this.scriptData.toggleFolderScripts(e,t,n);const i=this.scriptData.getFolderScripts(e,t);if(t===ki.GLOBAL?this.scriptData.isGlobalScriptEnabled:this.scriptData.isCharacterScriptEnabled)for(const e of i)n&&e.enabled?await this.runScript(e,t):n||await this.stopScript(e,t);Li.emit(Ci.UI_REFRESH,{action:"folder_scripts_toggle",folderId:e,type:t,enable:n})}catch(t){Pt().error(`[ScriptManager] 批量切换文件夹脚本状态失败: ${e}`,t),toastr.error("批量切换文件夹脚本状态失败")}}getFolderScriptsState(e,t){return this.scriptData.getFolderScriptsState(e,t)}getScriptButton(e){const t=this.scriptData.getScriptById(e);return t?t.buttons:(Pt().warn(`[ScriptManager] 脚本不存在: ${e}`),[])}async setScriptButton(e,t){await this.scriptData.saveScript(e,t),e.enabled&&(Li.emit(Ci.BUTTON_REMOVE,{scriptId:e.id}),e.buttons&&e.buttons.length>0&&Li.emit(Ci.BUTTON_ADD,{script:e}))}getScriptVariables(e){const t=this.scriptData.getScriptById(e);return t?t.data||{}:(Pt().warn(`[ScriptManager] 脚本不存在: ${e}`),{})}async updateScriptVariables(e,t,n){const i=this.scriptData.getScriptById(e);return i?(i.data=t,await this.scriptData.saveScript(i,n),Pt().info(`[ScriptManager] 已更新脚本变量: ${i.name}`),!0):(Pt().warn(`[ScriptManager] 脚本不存在: ${e}`),!1)}getAllScriptVariables(e){const t=e===ki.GLOBAL?this.scriptData.getGlobalScripts():this.scriptData.getCharacterScripts(),n=new Map;return t.forEach(e=>{e.data&&Object.keys(e.data).length>0&&n.set(e.id,e.data)}),n}async cleanup(){await this.executor.clearAllScriptsIframe()}async handleScriptIdConflict(e,t,n,i="import"){const r=this.scriptData.getScriptType(t)===ki.GLOBAL?"全局脚本":"角色脚本",s=n===ki.GLOBAL?"全局脚本":"角色脚本";let a;a="import"===i?`要导入的脚本 '${e.name}' 与${r}库中的 '${t.name}' id 相同，是否要继续操作？`:`要移动到${s}库的脚本 '${e.name}' 与目标库中的 '${t.name}' id 相同，是否要继续操作？`;let o="cancel";switch(await ie(a,ne.TEXT,"",{okButton:"覆盖原脚本",cancelButton:"取消",customButtons:["新建脚本"]})){case 0:o="cancel";break;case 1:o="override";break;case 2:o="new"}return o}}let Pi=!1,Ui=!1;class Mi{id;name;visible;scriptId;constructor(e,t,n=!0){this.id=`${t}_${e}`,this.name=e,this.scriptId=t,this.visible=n}remove(){$(`#${this.id}`).remove()}}class zi extends Mi{constructor(e,t,n=!0){super(e,t,n)}render(){return`<div class="qr--button menu_button interactable" id="${this.id}">${this.name}</div>`}bindEvents(){$(`#${this.id}`).on("click",()=>{p.emit(this.id),Pt().info(`[ScriptManager] 点击按钮：${this.id}`)})}}class Fi{static createButton(e,t,n,i=!0){return new zi(t,n,i)}}class Bi{buttons=[];isUpdating=!1;migrateButtonsToNewContainer(e,t){const n=$(`#${e} .qr--button`),i=$(`#${t}`);n.length&&i.length&&(n.detach().appendTo(i),this.buttons.forEach(e=>{e.bindEvents()}))}getScriptContainerId(e){return`script_container_${e}`}createButtonsFromScripts(e,t,n,i){if(!this.isUpdating){this.isUpdating=!0;try{this.clearButtons();const r=n&&e.some(e=>e.enabled&&e.buttons&&e.buttons.length>0&&e.buttons.some(e=>e.visible)),s=i&&t.some(e=>e.enabled&&e.buttons&&e.buttons.length>0&&e.buttons.some(e=>e.visible));if(!r&&!s)return;n&&r&&this.addScriptButtons(e),i&&s&&this.addScriptButtons(t)}finally{setTimeout(()=>{this.isUpdating=!1},100)}}}addScriptButtons(e){e.forEach(e=>{if(e.enabled&&e.buttons&&e.buttons.length>0){const t=e.buttons.filter(e=>e.visible).map(t=>Fi.createButton("script",t.name,e.id,t.visible));t.length>0&&this.addButtonsGroup(t,e.id)}})}addButtonsGroup(e,t){if(0===e.length)return;const n=this.getScriptContainerId(t);$(`#${n}`).remove();let i=`<div id="${n}" class="qr--buttons th--button">`;e.forEach(e=>{this.buttons=this.buttons.filter(t=>t.id!==e.id),this.buttons.push(e),i+=e.render()}),i+="</div>";const r=$("#send_form").find("#qr--bar");if(0!==r.length){if(Ui){const e=r.find(".qr--buttons").first();e.length>0?(e.append(i),Pt().info(`[ScriptManager] 按钮添加到combined容器: ${t}`)):(r.append(i),Pt().info(`[ScriptManager] 按钮添加到qr--bar（无combined容器）: ${t}`))}else r.append(i),Pt().info(`[ScriptManager] 按钮添加到qr--bar: ${t}`);e.forEach(e=>e.bindEvents())}else Pt().warn("[ScriptManager] qr--bar容器不存在，无法添加按钮")}addButtonsForScript(e){if(!e.buttons||0===e.buttons.length)return;const t=e.buttons.filter(e=>e.visible).map(t=>Fi.createButton("script",t.name,e.id,t.visible));t.length>0&&this.addButtonsGroup(t,e.id)}removeButtonsByScriptId(e){const t=this.getScriptContainerId(e);$(`#${t}`).remove()}clearButtons(){this.buttons.forEach(e=>e.remove()),this.buttons=[]}cleanup(){this.clearButtons(),this.isUpdating=!1}}const Gi=new Bi;function Vi(){const e=$("#qr--isEnabled");Pi=e.length>0&&e.prop("checked");const t=$("#send_form");if(0===t.length)return;0===$("#send_form #qr--bar").length&&(t.find("#qr--bar").length||(t.append('<div class="flex-container flexGap5" id="qr--bar"></div>'),Pt().info("[ScriptManager] 创建qr--bar容器（qr未启用或不存在）")))}function Zi(){const e=$("#qr--isCombined");if(Ui=e.length>0&&e.prop("checked"),!Pi){const e=$("#send_form #qr--bar").first();if(e.length>0&&Ui){e.find(".qr--buttons").length>0||e.find(".qr--buttons").length||(e.append('<div class="qr--buttons"></div>'),Pt().info("[ScriptManager] 创建combined按钮容器"))}}}function qi(){Vi(),Zi(),function(){const e=ji.getInstance(),t=e.getGlobalScripts(),n=e.getCharacterScripts(),i=e.isGlobalScriptEnabled,r=e.isCharacterScriptEnabled;Gi.createButtonsFromScripts(t,n,i,r)}()}function Hi(e){try{return new URL(e),!0}catch(e){return!1}}const Wi={标签化:{name:"标签化: 随世界书、预设或链接配置自动开关正则、提示词条目",content:"https://testingcf.jsdelivr.net/gh/StageDog/tavern_resource/dist/酒馆助手/标签化/index.js",info:"https://testingcf.jsdelivr.net/gh/StageDog/tavern_resource/src/酒馆助手/标签化/README.md"},预设防误触:{name:"预设防误触",content:"https://testingcf.jsdelivr.net/gh/StageDog/tavern_resource/dist/酒馆助手/预设防误触/index.js",info:"https://testingcf.jsdelivr.net/gh/StageDog/tavern_resource/src/酒馆助手/预设防误触/README.md"},世界书强制自定义排序:{name:"世界书强制自定义排序",content:"https://testingcf.jsdelivr.net/gh/StageDog/tavern_resource/dist/酒馆助手/世界书强制自定义排序/index.js",info:"https://testingcf.jsdelivr.net/gh/StageDog/tavern_resource/src/酒馆助手/世界书强制自定义排序/README.md"},世界书强制用推荐的全局设置:{name:"世界书强制用推荐的全局设置",content:"https://testingcf.jsdelivr.net/gh/StageDog/tavern_resource/dist/酒馆助手/世界书强制用推荐的全局设置/index.js",info:"https://testingcf.jsdelivr.net/gh/StageDog/tavern_resource/src/酒馆助手/世界书强制用推荐的全局设置/README.md"},预设条目更多按钮:{name:"预设条目更多按钮: 一键新增预设条目",content:"https://testingcf.jsdelivr.net/gh/StageDog/tavern_resource/dist/酒馆助手/预设条目更多按钮/index.js",info:"https://testingcf.jsdelivr.net/gh/StageDog/tavern_resource/src/酒馆助手/预设条目更多按钮/README.md"},自动开启角色卡局部正则:{name:"自动开启角色卡局部正则",content:"https://testingcf.jsdelivr.net/gh/StageDog/tavern_resource/dist/酒馆助手/自动开启角色卡局部正则/index.js",info:"https://testingcf.jsdelivr.net/gh/StageDog/tavern_resource/src/酒馆助手/自动开启角色卡局部正则/README.md"}};async function Ji(e){return Hi(e)?(await fetch(e)).text():e}async function Ki(e){const t=Wi[e];if(!t)return Pt().error(`[ScriptManager] 未找到脚本配置: ${e}`),null;try{return{id:e,name:t.name,content:(n=t.content,Hi(n)?`import '${n}'`:n),info:await Ji(t.info),enabled:!1,buttons:[],data:{}}}catch(t){return Pt().error(`[ScriptManager] 创建默认脚本失败: ${e}:`,t),null}var n}function Yi(e){let t=L().makeHtml(e);return t=`<div style="text-align: left; max-height:80dvh; overflow-y: auto;">${t}</div>`,t}const Xi=Symbol.for("yaml.alias"),Qi=Symbol.for("yaml.document"),er=Symbol.for("yaml.map"),tr=Symbol.for("yaml.pair"),nr=Symbol.for("yaml.scalar"),ir=Symbol.for("yaml.seq"),rr=Symbol.for("yaml.node.type"),sr=e=>!!e&&"object"==typeof e&&e[rr]===Xi,ar=e=>!!e&&"object"==typeof e&&e[rr]===Qi,or=e=>!!e&&"object"==typeof e&&e[rr]===er,cr=e=>!!e&&"object"==typeof e&&e[rr]===tr,lr=e=>!!e&&"object"==typeof e&&e[rr]===nr,ur=e=>!!e&&"object"==typeof e&&e[rr]===ir;function dr(e){if(e&&"object"==typeof e)switch(e[rr]){case er:case ir:return!0}return!1}function pr(e){if(e&&"object"==typeof e)switch(e[rr]){case Xi:case er:case nr:case ir:return!0}return!1}const hr=e=>(lr(e)||dr(e))&&!!e.anchor,fr=Symbol("break visit"),mr=Symbol("skip children"),gr=Symbol("remove node");function vr(e,t){const n=wr(t);if(ar(e)){yr(null,e.contents,n,Object.freeze([e]))===gr&&(e.contents=null)}else yr(null,e,n,Object.freeze([]))}function yr(e,t,n,i){const r=$r(e,t,n,i);if(pr(r)||cr(r))return kr(e,i,r),yr(e,r,n,i);if("symbol"!=typeof r)if(dr(t)){i=Object.freeze(i.concat(t));for(let e=0;e<t.items.length;++e){const r=yr(e,t.items[e],n,i);if("number"==typeof r)e=r-1;else{if(r===fr)return fr;r===gr&&(t.items.splice(e,1),e-=1)}}}else if(cr(t)){i=Object.freeze(i.concat(t));const e=yr("key",t.key,n,i);if(e===fr)return fr;e===gr&&(t.key=null);const r=yr("value",t.value,n,i);if(r===fr)return fr;r===gr&&(t.value=null)}return r}async function _r(e,t){const n=wr(t);if(ar(e)){await br(null,e.contents,n,Object.freeze([e]))===gr&&(e.contents=null)}else await br(null,e,n,Object.freeze([]))}async function br(e,t,n,i){const r=await $r(e,t,n,i);if(pr(r)||cr(r))return kr(e,i,r),br(e,r,n,i);if("symbol"!=typeof r)if(dr(t)){i=Object.freeze(i.concat(t));for(let e=0;e<t.items.length;++e){const r=await br(e,t.items[e],n,i);if("number"==typeof r)e=r-1;else{if(r===fr)return fr;r===gr&&(t.items.splice(e,1),e-=1)}}}else if(cr(t)){i=Object.freeze(i.concat(t));const e=await br("key",t.key,n,i);if(e===fr)return fr;e===gr&&(t.key=null);const r=await br("value",t.value,n,i);if(r===fr)return fr;r===gr&&(t.value=null)}return r}function wr(e){return"object"==typeof e&&(e.Collection||e.Node||e.Value)?Object.assign({Alias:e.Node,Map:e.Node,Scalar:e.Node,Seq:e.Node},e.Value&&{Map:e.Value,Scalar:e.Value,Seq:e.Value},e.Collection&&{Map:e.Collection,Seq:e.Collection},e):e}function $r(e,t,n,i){return"function"==typeof n?n(e,t,i):or(t)?n.Map?.(e,t,i):ur(t)?n.Seq?.(e,t,i):cr(t)?n.Pair?.(e,t,i):lr(t)?n.Scalar?.(e,t,i):sr(t)?n.Alias?.(e,t,i):void 0}function kr(e,t,n){const i=t[t.length-1];if(dr(i))i.items[e]=n;else if(cr(i))"key"===e?i.key=n:i.value=n;else{if(!ar(i)){const e=sr(i)?"alias":"scalar";throw new Error(`Cannot replace node with ${e} parent`)}i.contents=n}}vr.BREAK=fr,vr.SKIP=mr,vr.REMOVE=gr,_r.BREAK=fr,_r.SKIP=mr,_r.REMOVE=gr;const Sr={"!":"%21",",":"%2C","[":"%5B","]":"%5D","{":"%7B","}":"%7D"},Er=e=>e.replace(/[!,[\]{}]/g,e=>Sr[e]);class Ir{constructor(e,t){this.docStart=null,this.docEnd=!1,this.yaml=Object.assign({},Ir.defaultYaml,e),this.tags=Object.assign({},Ir.defaultTags,t)}clone(){const e=new Ir(this.yaml,this.tags);return e.docStart=this.docStart,e}atDocument(){const e=new Ir(this.yaml,this.tags);switch(this.yaml.version){case"1.1":this.atNextDocument=!0;break;case"1.2":this.atNextDocument=!1,this.yaml={explicit:Ir.defaultYaml.explicit,version:"1.2"},this.tags=Object.assign({},Ir.defaultTags)}return e}add(e,t){this.atNextDocument&&(this.yaml={explicit:Ir.defaultYaml.explicit,version:"1.1"},this.tags=Object.assign({},Ir.defaultTags),this.atNextDocument=!1);const n=e.trim().split(/[ \t]+/),i=n.shift();switch(i){case"%TAG":{if(2!==n.length&&(t(0,"%TAG directive should contain exactly two parts"),n.length<2))return!1;const[e,i]=n;return this.tags[e]=i,!0}case"%YAML":{if(this.yaml.explicit=!0,1!==n.length)return t(0,"%YAML directive should contain exactly one part"),!1;const[e]=n;if("1.1"===e||"1.2"===e)return this.yaml.version=e,!0;return t(6,`Unsupported YAML version ${e}`,/^\d+\.\d+$/.test(e)),!1}default:return t(0,`Unknown directive ${i}`,!0),!1}}tagName(e,t){if("!"===e)return"!";if("!"!==e[0])return t(`Not a valid tag: ${e}`),null;if("<"===e[1]){const n=e.slice(2,-1);return"!"===n||"!!"===n?(t(`Verbatim tags aren't resolved, so ${e} is invalid.`),null):(">"!==e[e.length-1]&&t("Verbatim tags must end with a >"),n)}const[,n,i]=e.match(/^(.*!)([^!]*)$/s);i||t(`The ${e} tag has no suffix`);const r=this.tags[n];if(r)try{return r+decodeURIComponent(i)}catch(e){return t(String(e)),null}return"!"===n?e:(t(`Could not resolve tag: ${e}`),null)}tagString(e){for(const[t,n]of Object.entries(this.tags))if(e.startsWith(n))return t+Er(e.substring(n.length));return"!"===e[0]?e:`!<${e}>`}toString(e){const t=this.yaml.explicit?[`%YAML ${this.yaml.version||"1.2"}`]:[],n=Object.entries(this.tags);let i;if(e&&n.length>0&&pr(e.contents)){const t={};vr(e.contents,(e,n)=>{pr(n)&&n.tag&&(t[n.tag]=!0)}),i=Object.keys(t)}else i=[];for(const[r,s]of n)"!!"===r&&"tag:yaml.org,2002:"===s||e&&!i.some(e=>e.startsWith(s))||t.push(`%TAG ${r} ${s}`);return t.join("\n")}}function xr(e){if(/[\x00-\x19\s,[\]{}]/.test(e)){const t=JSON.stringify(e);throw new Error(`Anchor must not contain whitespace or control characters: ${t}`)}return!0}function Tr(e){const t=new Set;return vr(e,{Value(e,n){n.anchor&&t.add(n.anchor)}}),t}function Or(e,t){for(let n=1;;++n){const i=`${e}${n}`;if(!t.has(i))return i}}function Ar(e,t,n,i){if(i&&"object"==typeof i)if(Array.isArray(i))for(let t=0,n=i.length;t<n;++t){const n=i[t],r=Ar(e,i,String(t),n);void 0===r?delete i[t]:r!==n&&(i[t]=r)}else if(i instanceof Map)for(const t of Array.from(i.keys())){const n=i.get(t),r=Ar(e,i,t,n);void 0===r?i.delete(t):r!==n&&i.set(t,r)}else if(i instanceof Set)for(const t of Array.from(i)){const n=Ar(e,i,t,t);void 0===n?i.delete(t):n!==t&&(i.delete(t),i.add(n))}else for(const[t,n]of Object.entries(i)){const r=Ar(e,i,t,n);void 0===r?delete i[t]:r!==n&&(i[t]=r)}return e.call(t,n,i)}function Nr(e,t,n){if(Array.isArray(e))return e.map((e,t)=>Nr(e,String(t),n));if(e&&"function"==typeof e.toJSON){if(!n||!hr(e))return e.toJSON(t,n);const i={aliasCount:0,count:1,res:void 0};n.anchors.set(e,i),n.onCreate=e=>{i.res=e,delete n.onCreate};const r=e.toJSON(t,n);return n.onCreate&&n.onCreate(r),r}return"bigint"!=typeof e||n?.keep?e:Number(e)}Ir.defaultYaml={explicit:!1,version:"1.2"},Ir.defaultTags={"!!":"tag:yaml.org,2002:"};class Cr{constructor(e){Object.defineProperty(this,rr,{value:e})}clone(){const e=Object.create(Object.getPrototypeOf(this),Object.getOwnPropertyDescriptors(this));return this.range&&(e.range=this.range.slice()),e}toJS(e,{mapAsMap:t,maxAliasCount:n,onAnchor:i,reviver:r}={}){if(!ar(e))throw new TypeError("A document argument is required");const s={anchors:new Map,doc:e,keep:!0,mapAsMap:!0===t,mapKeyWarned:!1,maxAliasCount:"number"==typeof n?n:100},a=Nr(this,"",s);if("function"==typeof i)for(const{count:e,res:t}of s.anchors.values())i(t,e);return"function"==typeof r?Ar(r,{"":a},"",a):a}}class Dr extends Cr{constructor(e){super(Xi),this.source=e,Object.defineProperty(this,"tag",{set(){throw new Error("Alias nodes cannot have tags")}})}resolve(e,t){let n,i;t?.aliasResolveCache?n=t.aliasResolveCache:(n=[],vr(e,{Node:(e,t)=>{(sr(t)||hr(t))&&n.push(t)}}),t&&(t.aliasResolveCache=n));for(const e of n){if(e===this)break;e.anchor===this.source&&(i=e)}return i}toJSON(e,t){if(!t)return{source:this.source};const{anchors:n,doc:i,maxAliasCount:r}=t,s=this.resolve(i,t);if(!s){const e=`Unresolved alias (the anchor must be set before the alias): ${this.source}`;throw new ReferenceError(e)}let a=n.get(s);if(a||(Nr(s,null,t),a=n.get(s)),!a||void 0===a.res){throw new ReferenceError("This should not happen: Alias anchor was not resolved?")}if(r>=0&&(a.count+=1,0===a.aliasCount&&(a.aliasCount=Lr(i,s,n)),a.count*a.aliasCount>r)){throw new ReferenceError("Excessive alias count indicates a resource exhaustion attack")}return a.res}toString(e,t,n){const i=`*${this.source}`;if(e){if(xr(this.source),e.options.verifyAliasOrder&&!e.anchors.has(this.source)){const e=`Unresolved alias (the anchor must be set before the alias): ${this.source}`;throw new Error(e)}if(e.implicitKey)return`${i} `}return i}}function Lr(e,t,n){if(sr(t)){const i=t.resolve(e),r=n&&i&&n.get(i);return r?r.count*r.aliasCount:0}if(dr(t)){let i=0;for(const r of t.items){const t=Lr(e,r,n);t>i&&(i=t)}return i}if(cr(t)){const i=Lr(e,t.key,n),r=Lr(e,t.value,n);return Math.max(i,r)}return 1}const Rr=e=>!e||"function"!=typeof e&&"object"!=typeof e;class jr extends Cr{constructor(e){super(nr),this.value=e}toJSON(e,t){return t?.keep?this.value:Nr(this.value,e,t)}toString(){return String(this.value)}}jr.BLOCK_FOLDED="BLOCK_FOLDED",jr.BLOCK_LITERAL="BLOCK_LITERAL",jr.PLAIN="PLAIN",jr.QUOTE_DOUBLE="QUOTE_DOUBLE",jr.QUOTE_SINGLE="QUOTE_SINGLE";function Pr(e,t,n){if(ar(e)&&(e=e.contents),pr(e))return e;if(cr(e)){const t=n.schema[er].createNode?.(n.schema,null,n);return t.items.push(e),t}(e instanceof String||e instanceof Number||e instanceof Boolean||"undefined"!=typeof BigInt&&e instanceof BigInt)&&(e=e.valueOf());const{aliasDuplicateObjects:i,onAnchor:r,onTagObj:s,schema:a,sourceObjects:o}=n;let c;if(i&&e&&"object"==typeof e){if(c=o.get(e),c)return c.anchor??(c.anchor=r(e)),new Dr(c.anchor);c={anchor:null,node:null},o.set(e,c)}t?.startsWith("!!")&&(t="tag:yaml.org,2002:"+t.slice(2));let l=function(e,t,n){if(t){const e=n.filter(e=>e.tag===t),i=e.find(e=>!e.format)??e[0];if(!i)throw new Error(`Tag ${t} not found`);return i}return n.find(t=>t.identify?.(e)&&!t.format)}(e,t,a.tags);if(!l){if(e&&"function"==typeof e.toJSON&&(e=e.toJSON()),!e||"object"!=typeof e){const t=new jr(e);return c&&(c.node=t),t}l=e instanceof Map?a[er]:Symbol.iterator in Object(e)?a[ir]:a[er]}s&&(s(l),delete n.onTagObj);const u=l?.createNode?l.createNode(n.schema,e,n):"function"==typeof l?.nodeClass?.from?l.nodeClass.from(n.schema,e,n):new jr(e);return t?u.tag=t:l.default||(u.tag=l.tag),c&&(c.node=u),u}function Ur(e,t,n){let i=n;for(let e=t.length-1;e>=0;--e){const n=t[e];if("number"==typeof n&&Number.isInteger(n)&&n>=0){const e=[];e[n]=i,i=e}else i=new Map([[n,i]])}return Pr(i,void 0,{aliasDuplicateObjects:!1,keepUndefined:!1,onAnchor:()=>{throw new Error("This should not happen, please report a bug.")},schema:e,sourceObjects:new Map})}const Mr=e=>null==e||"object"==typeof e&&!!e[Symbol.iterator]().next().done;class zr extends Cr{constructor(e,t){super(e),Object.defineProperty(this,"schema",{value:t,configurable:!0,enumerable:!1,writable:!0})}clone(e){const t=Object.create(Object.getPrototypeOf(this),Object.getOwnPropertyDescriptors(this));return e&&(t.schema=e),t.items=t.items.map(t=>pr(t)||cr(t)?t.clone(e):t),this.range&&(t.range=this.range.slice()),t}addIn(e,t){if(Mr(e))this.add(t);else{const[n,...i]=e,r=this.get(n,!0);if(dr(r))r.addIn(i,t);else{if(void 0!==r||!this.schema)throw new Error(`Expected YAML collection at ${n}. Remaining path: ${i}`);this.set(n,Ur(this.schema,i,t))}}}deleteIn(e){const[t,...n]=e;if(0===n.length)return this.delete(t);const i=this.get(t,!0);if(dr(i))return i.deleteIn(n);throw new Error(`Expected YAML collection at ${t}. Remaining path: ${n}`)}getIn(e,t){const[n,...i]=e,r=this.get(n,!0);return 0===i.length?!t&&lr(r)?r.value:r:dr(r)?r.getIn(i,t):void 0}hasAllNullValues(e){return this.items.every(t=>{if(!cr(t))return!1;const n=t.value;return null==n||e&&lr(n)&&null==n.value&&!n.commentBefore&&!n.comment&&!n.tag})}hasIn(e){const[t,...n]=e;if(0===n.length)return this.has(t);const i=this.get(t,!0);return!!dr(i)&&i.hasIn(n)}setIn(e,t){const[n,...i]=e;if(0===i.length)this.set(n,t);else{const e=this.get(n,!0);if(dr(e))e.setIn(i,t);else{if(void 0!==e||!this.schema)throw new Error(`Expected YAML collection at ${n}. Remaining path: ${i}`);this.set(n,Ur(this.schema,i,t))}}}}const Fr=e=>e.replace(/^(?!$)(?: $)?/gm,"#");function Br(e,t){return/^\n+$/.test(e)?e.substring(1):t?e.replace(/^(?! *$)/gm,t):e}const Gr=(e,t,n)=>e.endsWith("\n")?Br(n,t):n.includes("\n")?"\n"+Br(n,t):(e.endsWith(" ")?"":" ")+n,Vr="flow",Zr="block",qr="quoted";function Hr(e,t,n="flow",{indentAtStart:i,lineWidth:r=80,minContentWidth:s=20,onFold:a,onOverflow:o}={}){if(!r||r<0)return e;r<s&&(s=0);const c=Math.max(1+s,1+r-t.length);if(e.length<=c)return e;const l=[],u={};let d,p,h=r-t.length;"number"==typeof i&&(i>r-Math.max(2,s)?l.push(0):h=r-i);let f=!1,m=-1,g=-1,v=-1;n===Zr&&(m=Wr(e,m,t.length),-1!==m&&(h=m+c));for(let i;i=e[m+=1];){if(n===qr&&"\\"===i){switch(g=m,e[m+1]){case"x":m+=3;break;case"u":m+=5;break;case"U":m+=9;break;default:m+=1}v=m}if("\n"===i)n===Zr&&(m=Wr(e,m,t.length)),h=m+t.length+c,d=void 0;else{if(" "===i&&p&&" "!==p&&"\n"!==p&&"\t"!==p){const t=e[m+1];t&&" "!==t&&"\n"!==t&&"\t"!==t&&(d=m)}if(m>=h)if(d)l.push(d),h=d+c,d=void 0;else if(n===qr){for(;" "===p||"\t"===p;)p=i,i=e[m+=1],f=!0;const t=m>v+1?m-2:g-1;if(u[t])return e;l.push(t),u[t]=!0,h=t+c,d=void 0}else f=!0}p=i}if(f&&o&&o(),0===l.length)return e;a&&a();let y=e.slice(0,l[0]);for(let i=0;i<l.length;++i){const r=l[i],s=l[i+1]||e.length;0===r?y=`\n${t}${e.slice(0,s)}`:(n===qr&&u[r]&&(y+=`${e[r]}\\`),y+=`\n${t}${e.slice(r+1,s)}`)}return y}function Wr(e,t,n){let i=t,r=t+1,s=e[r];for(;" "===s||"\t"===s;)if(t<r+n)s=e[++t];else{do{s=e[++t]}while(s&&"\n"!==s);i=t,r=t+1,s=e[r]}return i}const Jr=(e,t)=>({indentAtStart:t?e.indent.length:e.indentAtStart,lineWidth:e.options.lineWidth,minContentWidth:e.options.minContentWidth}),Kr=e=>/^(%|---|\.\.\.)/m.test(e);function Yr(e,t){const n=JSON.stringify(e);if(t.options.doubleQuotedAsJSON)return n;const{implicitKey:i}=t,r=t.options.doubleQuotedMinMultiLineLength,s=t.indent||(Kr(e)?"  ":"");let a="",o=0;for(let e=0,t=n[e];t;t=n[++e])if(" "===t&&"\\"===n[e+1]&&"n"===n[e+2]&&(a+=n.slice(o,e)+"\\ ",e+=1,o=e,t="\\"),"\\"===t)switch(n[e+1]){case"u":{a+=n.slice(o,e);const t=n.substr(e+2,4);switch(t){case"0000":a+="\\0";break;case"0007":a+="\\a";break;case"000b":a+="\\v";break;case"001b":a+="\\e";break;case"0085":a+="\\N";break;case"00a0":a+="\\_";break;case"2028":a+="\\L";break;case"2029":a+="\\P";break;default:"00"===t.substr(0,2)?a+="\\x"+t.substr(2):a+=n.substr(e,6)}e+=5,o=e+1}break;case"n":if(i||'"'===n[e+2]||n.length<r)e+=1;else{for(a+=n.slice(o,e)+"\n\n";"\\"===n[e+2]&&"n"===n[e+3]&&'"'!==n[e+4];)a+="\n",e+=2;a+=s," "===n[e+2]&&(a+="\\"),e+=1,o=e+1}break;default:e+=1}return a=o?a+n.slice(o):n,i?a:Hr(a,s,qr,Jr(t,!1))}function Xr(e,t){if(!1===t.options.singleQuote||t.implicitKey&&e.includes("\n")||/[ \t]\n|\n[ \t]/.test(e))return Yr(e,t);const n=t.indent||(Kr(e)?"  ":""),i="'"+e.replace(/'/g,"''").replace(/\n+/g,`$&\n${n}`)+"'";return t.implicitKey?i:Hr(i,n,Vr,Jr(t,!1))}function Qr(e,t){const{singleQuote:n}=t.options;let i;if(!1===n)i=Yr;else{const t=e.includes('"'),r=e.includes("'");i=t&&!r?Xr:r&&!t?Yr:n?Xr:Yr}return i(e,t)}let es;try{es=new RegExp("(^|(?<!\n))\n+(?!\n|$)","g")}catch{es=/\n+(?!\n|$)/g}function ts({comment:e,type:t,value:n},i,r,s){const{blockQuote:a,commentString:o,lineWidth:c}=i.options;if(!a||/\n[\t ]+$/.test(n))return Qr(n,i);const l=i.indent||(i.forceBlockIndent||Kr(n)?"  ":""),u="literal"===a||"folded"!==a&&t!==jr.BLOCK_FOLDED&&(t===jr.BLOCK_LITERAL||!function(e,t,n){if(!t||t<0)return!1;const i=t-n,r=e.length;if(r<=i)return!1;for(let t=0,n=0;t<r;++t)if("\n"===e[t]){if(t-n>i)return!0;if(n=t+1,r-n<=i)return!1}return!0}(n,c,l.length));if(!n)return u?"|\n":">\n";let d,p;for(p=n.length;p>0;--p){const e=n[p-1];if("\n"!==e&&"\t"!==e&&" "!==e)break}let h=n.substring(p);const f=h.indexOf("\n");-1===f?d="-":n===h||f!==h.length-1?(d="+",s&&s()):d="",h&&(n=n.slice(0,-h.length),"\n"===h[h.length-1]&&(h=h.slice(0,-1)),h=h.replace(es,`$&${l}`));let m,g=!1,v=-1;for(m=0;m<n.length;++m){const e=n[m];if(" "===e)g=!0;else{if("\n"!==e)break;v=m}}let y=n.substring(0,v<m?v+1:m);y&&(n=n.substring(y.length),y=y.replace(/\n+/g,`$&${l}`));let _=(g?l?"2":"1":"")+d;if(e&&(_+=" "+o(e.replace(/ ?[\r\n]+/g," ")),r&&r()),!u){const e=n.replace(/\n+/g,"\n$&").replace(/(?:^|\n)([\t ].*)(?:([\n\t ]*)\n(?![\n\t ]))?/g,"$1$2").replace(/\n+/g,`$&${l}`);let r=!1;const s=Jr(i,!0);"folded"!==a&&t!==jr.BLOCK_FOLDED&&(s.onOverflow=()=>{r=!0});const o=Hr(`${y}${e}${h}`,l,Zr,s);if(!r)return`>${_}\n${l}${o}`}return`|${_}\n${l}${y}${n=n.replace(/\n+/g,`$&${l}`)}${h}`}function ns(e,t,n,i){const{implicitKey:r,inFlow:s}=t,a="string"==typeof e.value?e:Object.assign({},e,{value:String(e.value)});let{type:o}=e;o!==jr.QUOTE_DOUBLE&&/[\x00-\x08\x0b-\x1f\x7f-\x9f\u{D800}-\u{DFFF}]/u.test(a.value)&&(o=jr.QUOTE_DOUBLE);const c=e=>{switch(e){case jr.BLOCK_FOLDED:case jr.BLOCK_LITERAL:return r||s?Qr(a.value,t):ts(a,t,n,i);case jr.QUOTE_DOUBLE:return Yr(a.value,t);case jr.QUOTE_SINGLE:return Xr(a.value,t);case jr.PLAIN:return function(e,t,n,i){const{type:r,value:s}=e,{actualString:a,implicitKey:o,indent:c,indentStep:l,inFlow:u}=t;if(o&&s.includes("\n")||u&&/[[\]{},]/.test(s))return Qr(s,t);if(/^[\n\t ,[\]{}#&*!|>'"%@`]|^[?-]$|^[?-][ \t]|[\n:][ \t]|[ \t]\n|[\n\t ]#|[\n\t :]$/.test(s))return o||u||!s.includes("\n")?Qr(s,t):ts(e,t,n,i);if(!o&&!u&&r!==jr.PLAIN&&s.includes("\n"))return ts(e,t,n,i);if(Kr(s)){if(""===c)return t.forceBlockIndent=!0,ts(e,t,n,i);if(o&&c===l)return Qr(s,t)}const d=s.replace(/\n+/g,`$&\n${c}`);if(a){const e=e=>e.default&&"tag:yaml.org,2002:str"!==e.tag&&e.test?.test(d),{compat:n,tags:i}=t.doc.schema;if(i.some(e)||n?.some(e))return Qr(s,t)}return o?d:Hr(d,c,Vr,Jr(t,!1))}(a,t,n,i);default:return null}};let l=c(o);if(null===l){const{defaultKeyType:e,defaultStringType:n}=t.options,i=r&&e||n;if(l=c(i),null===l)throw new Error(`Unsupported default string type ${i}`)}return l}function is(e,t){const n=Object.assign({blockQuote:!0,commentString:Fr,defaultKeyType:null,defaultStringType:"PLAIN",directives:null,doubleQuotedAsJSON:!1,doubleQuotedMinMultiLineLength:40,falseStr:"false",flowCollectionPadding:!0,indentSeq:!0,lineWidth:80,minContentWidth:20,nullStr:"null",simpleKeys:!1,singleQuote:null,trueStr:"true",verifyAliasOrder:!0},e.schema.toStringOptions,t);let i;switch(n.collectionStyle){case"block":i=!1;break;case"flow":i=!0;break;default:i=null}return{anchors:new Set,doc:e,flowCollectionPadding:n.flowCollectionPadding?" ":"",indent:"",indentStep:"number"==typeof n.indent?" ".repeat(n.indent):"  ",inFlow:i,options:n}}function rs(e,t,n,i){if(cr(e))return e.toString(t,n,i);if(sr(e)){if(t.doc.directives)return e.toString(t);if(t.resolvedAliases?.has(e))throw new TypeError("Cannot stringify circular structure without alias nodes");t.resolvedAliases?t.resolvedAliases.add(e):t.resolvedAliases=new Set([e]),e=e.resolve(t.doc)}let r;const s=pr(e)?e:t.doc.createNode(e,{onTagObj:e=>r=e});r??(r=function(e,t){if(t.tag){const n=e.filter(e=>e.tag===t.tag);if(n.length>0)return n.find(e=>e.format===t.format)??n[0]}let n,i;if(lr(t)){i=t.value;let r=e.filter(e=>e.identify?.(i));if(r.length>1){const e=r.filter(e=>e.test);e.length>0&&(r=e)}n=r.find(e=>e.format===t.format)??r.find(e=>!e.format)}else i=t,n=e.find(e=>e.nodeClass&&i instanceof e.nodeClass);if(!n)throw new Error(`Tag not resolved for ${i?.constructor?.name??(null===i?"null":typeof i)} value`);return n}(t.doc.schema.tags,s));const a=function(e,t,{anchors:n,doc:i}){if(!i.directives)return"";const r=[],s=(lr(e)||dr(e))&&e.anchor;s&&xr(s)&&(n.add(s),r.push(`&${s}`));const a=e.tag??(t.default?null:t.tag);return a&&r.push(i.directives.tagString(a)),r.join(" ")}(s,r,t);a.length>0&&(t.indentAtStart=(t.indentAtStart??0)+a.length+1);const o="function"==typeof r.stringify?r.stringify(s,t,n,i):lr(s)?ns(s,t,n,i):s.toString(t,n,i);return a?lr(s)||"{"===o[0]||"["===o[0]?`${a} ${o}`:`${a}\n${t.indent}${o}`:o}function ss(e,t){"debug"!==e&&"warn"!==e||console.warn(t)}const as="<<",os={identify:e=>e===as||"symbol"==typeof e&&e.description===as,default:"key",tag:"tag:yaml.org,2002:merge",test:/^<<$/,resolve:()=>Object.assign(new jr(Symbol(as)),{addToJSMap:cs}),stringify:()=>as};function cs(e,t,n){if(n=e&&sr(n)?n.resolve(e.doc):n,ur(n))for(const i of n.items)ls(e,t,i);else if(Array.isArray(n))for(const i of n)ls(e,t,i);else ls(e,t,n)}function ls(e,t,n){const i=e&&sr(n)?n.resolve(e.doc):n;if(!or(i))throw new Error("Merge sources must be maps or map aliases");const r=i.toJSON(null,e,Map);for(const[e,n]of r)t instanceof Map?t.has(e)||t.set(e,n):t instanceof Set?t.add(e):Object.prototype.hasOwnProperty.call(t,e)||Object.defineProperty(t,e,{value:n,writable:!0,enumerable:!0,configurable:!0});return t}function us(e,t,{key:n,value:i}){if(pr(n)&&n.addToJSMap)n.addToJSMap(e,t,i);else if(((e,t)=>(os.identify(t)||lr(t)&&(!t.type||t.type===jr.PLAIN)&&os.identify(t.value))&&e?.doc.schema.tags.some(e=>e.tag===os.tag&&e.default))(e,n))cs(e,t,i);else{const r=Nr(n,"",e);if(t instanceof Map)t.set(r,Nr(i,r,e));else if(t instanceof Set)t.add(r);else{const s=function(e,t,n){if(null===t)return"";if("object"!=typeof t)return String(t);if(pr(e)&&n?.doc){const t=is(n.doc,{});t.anchors=new Set;for(const e of n.anchors.keys())t.anchors.add(e.anchor);t.inFlow=!0,t.inStringifyKey=!0;const i=e.toString(t);if(!n.mapKeyWarned){let e=JSON.stringify(i);e.length>40&&(e=e.substring(0,36)+'..."'),ss(n.doc.options.logLevel,`Keys with collection values will be stringified due to JS Object restrictions: ${e}. Set mapAsMap: true to use object keys.`),n.mapKeyWarned=!0}return i}return JSON.stringify(t)}(n,r,e),a=Nr(i,s,e);s in t?Object.defineProperty(t,s,{value:a,writable:!0,enumerable:!0,configurable:!0}):t[s]=a}}return t}function ds(e,t,n){const i=Pr(e,void 0,n),r=Pr(t,void 0,n);return new ps(i,r)}class ps{constructor(e,t=null){Object.defineProperty(this,rr,{value:tr}),this.key=e,this.value=t}clone(e){let{key:t,value:n}=this;return pr(t)&&(t=t.clone(e)),pr(n)&&(n=n.clone(e)),new ps(t,n)}toJSON(e,t){return us(t,t?.mapAsMap?new Map:{},this)}toString(e,t,n){return e?.doc?function({key:e,value:t},n,i,r){const{allNullValues:s,doc:a,indent:o,indentStep:c,options:{commentString:l,indentSeq:u,simpleKeys:d}}=n;let p=pr(e)&&e.comment||null;if(d){if(p)throw new Error("With simple keys, key nodes cannot have comments");if(dr(e)||!pr(e)&&"object"==typeof e)throw new Error("With simple keys, collection cannot be used as a key value")}let h=!d&&(!e||p&&null==t&&!n.inFlow||dr(e)||(lr(e)?e.type===jr.BLOCK_FOLDED||e.type===jr.BLOCK_LITERAL:"object"==typeof e));n=Object.assign({},n,{allNullValues:!1,implicitKey:!h&&(d||!s),indent:o+c});let f,m,g,v=!1,y=!1,_=rs(e,n,()=>v=!0,()=>y=!0);if(!h&&!n.inFlow&&_.length>1024){if(d)throw new Error("With simple keys, single line scalar must not span more than 1024 characters");h=!0}if(n.inFlow){if(s||null==t)return v&&i&&i(),""===_?"?":h?`? ${_}`:_}else if(s&&!d||null==t&&h)return _=`? ${_}`,p&&!v?_+=Gr(_,n.indent,l(p)):y&&r&&r(),_;v&&(p=null),h?(p&&(_+=Gr(_,n.indent,l(p))),_=`? ${_}\n${o}:`):(_=`${_}:`,p&&(_+=Gr(_,n.indent,l(p)))),pr(t)?(f=!!t.spaceBefore,m=t.commentBefore,g=t.comment):(f=!1,m=null,g=null,t&&"object"==typeof t&&(t=a.createNode(t))),n.implicitKey=!1,h||p||!lr(t)||(n.indentAtStart=_.length+1),y=!1,u||!(c.length>=2)||n.inFlow||h||!ur(t)||t.flow||t.tag||t.anchor||(n.indent=n.indent.substring(2));let b=!1;const w=rs(t,n,()=>b=!0,()=>y=!0);let $=" ";if(p||f||m)$=f?"\n":"",m&&($+=`\n${Br(l(m),n.indent)}`),""!==w||n.inFlow?$+=`\n${n.indent}`:"\n"===$&&($="\n\n");else if(!h&&dr(t)){const e=w[0],i=w.indexOf("\n"),r=-1!==i,s=n.inFlow??t.flow??0===t.items.length;if(r||!s){let t=!1;if(r&&("&"===e||"!"===e)){let n=w.indexOf(" ");"&"===e&&-1!==n&&n<i&&"!"===w[n+1]&&(n=w.indexOf(" ",n+1)),(-1===n||i<n)&&(t=!0)}t||($=`\n${n.indent}`)}}else""!==w&&"\n"!==w[0]||($="");return _+=$+w,n.inFlow?b&&i&&i():g&&!b?_+=Gr(_,n.indent,l(g)):y&&r&&r(),_}(this,e,t,n):JSON.stringify(this)}}function hs(e,t,n){return(t.inFlow??e.flow?ms:fs)(e,t,n)}function fs({comment:e,items:t},n,{blockItemPrefix:i,flowChars:r,itemIndent:s,onChompKeep:a,onComment:o}){const{indent:c,options:{commentString:l}}=n,u=Object.assign({},n,{indent:s,type:null});let d=!1;const p=[];for(let e=0;e<t.length;++e){const r=t[e];let a=null;if(pr(r))!d&&r.spaceBefore&&p.push(""),gs(n,p,r.commentBefore,d),r.comment&&(a=r.comment);else if(cr(r)){const e=pr(r.key)?r.key:null;e&&(!d&&e.spaceBefore&&p.push(""),gs(n,p,e.commentBefore,d))}d=!1;let o=rs(r,u,()=>a=null,()=>d=!0);a&&(o+=Gr(o,s,l(a))),d&&a&&(d=!1),p.push(i+o)}let h;if(0===p.length)h=r.start+r.end;else{h=p[0];for(let e=1;e<p.length;++e){const t=p[e];h+=t?`\n${c}${t}`:"\n"}}return e?(h+="\n"+Br(l(e),c),o&&o()):d&&a&&a(),h}function ms({items:e},t,{flowChars:n,itemIndent:i}){const{indent:r,indentStep:s,flowCollectionPadding:a,options:{commentString:o}}=t;i+=s;const c=Object.assign({},t,{indent:i,inFlow:!0,type:null});let l=!1,u=0;const d=[];for(let n=0;n<e.length;++n){const r=e[n];let s=null;if(pr(r))r.spaceBefore&&d.push(""),gs(t,d,r.commentBefore,!1),r.comment&&(s=r.comment);else if(cr(r)){const e=pr(r.key)?r.key:null;e&&(e.spaceBefore&&d.push(""),gs(t,d,e.commentBefore,!1),e.comment&&(l=!0));const n=pr(r.value)?r.value:null;n?(n.comment&&(s=n.comment),n.commentBefore&&(l=!0)):null==r.value&&e?.comment&&(s=e.comment)}s&&(l=!0);let a=rs(r,c,()=>s=null);n<e.length-1&&(a+=","),s&&(a+=Gr(a,i,o(s))),!l&&(d.length>u||a.includes("\n"))&&(l=!0),d.push(a),u=d.length}const{start:p,end:h}=n;if(0===d.length)return p+h;if(!l){const e=d.reduce((e,t)=>e+t.length+2,2);l=t.options.lineWidth>0&&e>t.options.lineWidth}if(l){let e=p;for(const t of d)e+=t?`\n${s}${r}${t}`:"\n";return`${e}\n${r}${h}`}return`${p}${a}${d.join(" ")}${a}${h}`}function gs({indent:e,options:{commentString:t}},n,i,r){if(i&&r&&(i=i.replace(/^\n+/,"")),i){const r=Br(t(i),e);n.push(r.trimStart())}}function vs(e,t){const n=lr(t)?t.value:t;for(const i of e)if(cr(i)){if(i.key===t||i.key===n)return i;if(lr(i.key)&&i.key.value===n)return i}}class ys extends zr{static get tagName(){return"tag:yaml.org,2002:map"}constructor(e){super(er,e),this.items=[]}static from(e,t,n){const{keepUndefined:i,replacer:r}=n,s=new this(e),a=(e,a)=>{if("function"==typeof r)a=r.call(t,e,a);else if(Array.isArray(r)&&!r.includes(e))return;(void 0!==a||i)&&s.items.push(ds(e,a,n))};if(t instanceof Map)for(const[e,n]of t)a(e,n);else if(t&&"object"==typeof t)for(const e of Object.keys(t))a(e,t[e]);return"function"==typeof e.sortMapEntries&&s.items.sort(e.sortMapEntries),s}add(e,t){let n;n=cr(e)?e:e&&"object"==typeof e&&"key"in e?new ps(e.key,e.value):new ps(e,e?.value);const i=vs(this.items,n.key),r=this.schema?.sortMapEntries;if(i){if(!t)throw new Error(`Key ${n.key} already set`);lr(i.value)&&Rr(n.value)?i.value.value=n.value:i.value=n.value}else if(r){const e=this.items.findIndex(e=>r(n,e)<0);-1===e?this.items.push(n):this.items.splice(e,0,n)}else this.items.push(n)}delete(e){const t=vs(this.items,e);if(!t)return!1;return this.items.splice(this.items.indexOf(t),1).length>0}get(e,t){const n=vs(this.items,e),i=n?.value;return(!t&&lr(i)?i.value:i)??void 0}has(e){return!!vs(this.items,e)}set(e,t){this.add(new ps(e,t),!0)}toJSON(e,t,n){const i=n?new n:t?.mapAsMap?new Map:{};t?.onCreate&&t.onCreate(i);for(const e of this.items)us(t,i,e);return i}toString(e,t,n){if(!e)return JSON.stringify(this);for(const e of this.items)if(!cr(e))throw new Error(`Map items must all be pairs; found ${JSON.stringify(e)} instead`);return!e.allNullValues&&this.hasAllNullValues(!1)&&(e=Object.assign({},e,{allNullValues:!0})),hs(this,e,{blockItemPrefix:"",flowChars:{start:"{",end:"}"},itemIndent:e.indent||"",onChompKeep:n,onComment:t})}}const _s={collection:"map",default:!0,nodeClass:ys,tag:"tag:yaml.org,2002:map",resolve:(e,t)=>(or(e)||t("Expected a mapping for this tag"),e),createNode:(e,t,n)=>ys.from(e,t,n)};class bs extends zr{static get tagName(){return"tag:yaml.org,2002:seq"}constructor(e){super(ir,e),this.items=[]}add(e){this.items.push(e)}delete(e){const t=ws(e);if("number"!=typeof t)return!1;return this.items.splice(t,1).length>0}get(e,t){const n=ws(e);if("number"!=typeof n)return;const i=this.items[n];return!t&&lr(i)?i.value:i}has(e){const t=ws(e);return"number"==typeof t&&t<this.items.length}set(e,t){const n=ws(e);if("number"!=typeof n)throw new Error(`Expected a valid index, not ${e}.`);const i=this.items[n];lr(i)&&Rr(t)?i.value=t:this.items[n]=t}toJSON(e,t){const n=[];t?.onCreate&&t.onCreate(n);let i=0;for(const e of this.items)n.push(Nr(e,String(i++),t));return n}toString(e,t,n){return e?hs(this,e,{blockItemPrefix:"- ",flowChars:{start:"[",end:"]"},itemIndent:(e.indent||"")+"  ",onChompKeep:n,onComment:t}):JSON.stringify(this)}static from(e,t,n){const{replacer:i}=n,r=new this(e);if(t&&Symbol.iterator in Object(t)){let e=0;for(let s of t){if("function"==typeof i){const n=t instanceof Set?s:String(e++);s=i.call(t,n,s)}r.items.push(Pr(s,void 0,n))}}return r}}function ws(e){let t=lr(e)?e.value:e;return t&&"string"==typeof t&&(t=Number(t)),"number"==typeof t&&Number.isInteger(t)&&t>=0?t:null}const $s={collection:"seq",default:!0,nodeClass:bs,tag:"tag:yaml.org,2002:seq",resolve:(e,t)=>(ur(e)||t("Expected a sequence for this tag"),e),createNode:(e,t,n)=>bs.from(e,t,n)},ks={identify:e=>"string"==typeof e,default:!0,tag:"tag:yaml.org,2002:str",resolve:e=>e,stringify:(e,t,n,i)=>ns(e,t=Object.assign({actualString:!0},t),n,i)},Ss={identify:e=>null==e,createNode:()=>new jr(null),default:!0,tag:"tag:yaml.org,2002:null",test:/^(?:~|[Nn]ull|NULL)?$/,resolve:()=>new jr(null),stringify:({source:e},t)=>"string"==typeof e&&Ss.test.test(e)?e:t.options.nullStr},Es={identify:e=>"boolean"==typeof e,default:!0,tag:"tag:yaml.org,2002:bool",test:/^(?:[Tt]rue|TRUE|[Ff]alse|FALSE)$/,resolve:e=>new jr("t"===e[0]||"T"===e[0]),stringify({source:e,value:t},n){if(e&&Es.test.test(e)){if(t===("t"===e[0]||"T"===e[0]))return e}return t?n.options.trueStr:n.options.falseStr}};function Is({format:e,minFractionDigits:t,tag:n,value:i}){if("bigint"==typeof i)return String(i);const r="number"==typeof i?i:Number(i);if(!isFinite(r))return isNaN(r)?".nan":r<0?"-.inf":".inf";let s=JSON.stringify(i);if(!e&&t&&(!n||"tag:yaml.org,2002:float"===n)&&/^\d/.test(s)){let e=s.indexOf(".");e<0&&(e=s.length,s+=".");let n=t-(s.length-e-1);for(;n-- >0;)s+="0"}return s}const xs={identify:e=>"number"==typeof e,default:!0,tag:"tag:yaml.org,2002:float",test:/^(?:[-+]?\.(?:inf|Inf|INF)|\.nan|\.NaN|\.NAN)$/,resolve:e=>"nan"===e.slice(-3).toLowerCase()?NaN:"-"===e[0]?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY,stringify:Is},Ts={identify:e=>"number"==typeof e,default:!0,tag:"tag:yaml.org,2002:float",format:"EXP",test:/^[-+]?(?:\.[0-9]+|[0-9]+(?:\.[0-9]*)?)[eE][-+]?[0-9]+$/,resolve:e=>parseFloat(e),stringify(e){const t=Number(e.value);return isFinite(t)?t.toExponential():Is(e)}},Os={identify:e=>"number"==typeof e,default:!0,tag:"tag:yaml.org,2002:float",test:/^[-+]?(?:\.[0-9]+|[0-9]+\.[0-9]*)$/,resolve(e){const t=new jr(parseFloat(e)),n=e.indexOf(".");return-1!==n&&"0"===e[e.length-1]&&(t.minFractionDigits=e.length-n-1),t},stringify:Is},As=e=>"bigint"==typeof e||Number.isInteger(e),Ns=(e,t,n,{intAsBigInt:i})=>i?BigInt(e):parseInt(e.substring(t),n);function Cs(e,t,n){const{value:i}=e;return As(i)&&i>=0?n+i.toString(t):Is(e)}const Ds={identify:e=>As(e)&&e>=0,default:!0,tag:"tag:yaml.org,2002:int",format:"OCT",test:/^0o[0-7]+$/,resolve:(e,t,n)=>Ns(e,2,8,n),stringify:e=>Cs(e,8,"0o")},Ls={identify:As,default:!0,tag:"tag:yaml.org,2002:int",test:/^[-+]?[0-9]+$/,resolve:(e,t,n)=>Ns(e,0,10,n),stringify:Is},Rs={identify:e=>As(e)&&e>=0,default:!0,tag:"tag:yaml.org,2002:int",format:"HEX",test:/^0x[0-9a-fA-F]+$/,resolve:(e,t,n)=>Ns(e,2,16,n),stringify:e=>Cs(e,16,"0x")},js=[_s,$s,ks,Ss,Es,Ds,Ls,Rs,xs,Ts,Os];function Ps(e){return"bigint"==typeof e||Number.isInteger(e)}const Us=({value:e})=>JSON.stringify(e),Ms=[{identify:e=>"string"==typeof e,default:!0,tag:"tag:yaml.org,2002:str",resolve:e=>e,stringify:Us},{identify:e=>null==e,createNode:()=>new jr(null),default:!0,tag:"tag:yaml.org,2002:null",test:/^null$/,resolve:()=>null,stringify:Us},{identify:e=>"boolean"==typeof e,default:!0,tag:"tag:yaml.org,2002:bool",test:/^true$|^false$/,resolve:e=>"true"===e,stringify:Us},{identify:Ps,default:!0,tag:"tag:yaml.org,2002:int",test:/^-?(?:0|[1-9][0-9]*)$/,resolve:(e,t,{intAsBigInt:n})=>n?BigInt(e):parseInt(e,10),stringify:({value:e})=>Ps(e)?e.toString():JSON.stringify(e)},{identify:e=>"number"==typeof e,default:!0,tag:"tag:yaml.org,2002:float",test:/^-?(?:0|[1-9][0-9]*)(?:\.[0-9]*)?(?:[eE][-+]?[0-9]+)?$/,resolve:e=>parseFloat(e),stringify:Us}],zs=[_s,$s].concat(Ms,{default:!0,tag:"",test:/^/,resolve:(e,t)=>(t(`Unresolved plain scalar ${JSON.stringify(e)}`),e)}),Fs={identify:e=>e instanceof Uint8Array,default:!1,tag:"tag:yaml.org,2002:binary",resolve(e,t){if("function"==typeof atob){const t=atob(e.replace(/[\n\r]/g,"")),n=new Uint8Array(t.length);for(let e=0;e<t.length;++e)n[e]=t.charCodeAt(e);return n}return t("This environment does not support reading binary tags; either Buffer or atob is required"),e},stringify({comment:e,type:t,value:n},i,r,s){if(!n)return"";const a=n;let o;if("function"!=typeof btoa)throw new Error("This environment does not support writing binary tags; either Buffer or btoa is required");{let e="";for(let t=0;t<a.length;++t)e+=String.fromCharCode(a[t]);o=btoa(e)}if(t??(t=jr.BLOCK_LITERAL),t!==jr.QUOTE_DOUBLE){const e=Math.max(i.options.lineWidth-i.indent.length,i.options.minContentWidth),n=Math.ceil(o.length/e),r=new Array(n);for(let t=0,i=0;t<n;++t,i+=e)r[t]=o.substr(i,e);o=r.join(t===jr.BLOCK_LITERAL?"\n":" ")}return ns({comment:e,type:t,value:o},i,r,s)}};function Bs(e,t){if(ur(e))for(let n=0;n<e.items.length;++n){let i=e.items[n];if(!cr(i)){if(or(i)){i.items.length>1&&t("Each pair must have its own sequence indicator");const e=i.items[0]||new ps(new jr(null));if(i.commentBefore&&(e.key.commentBefore=e.key.commentBefore?`${i.commentBefore}\n${e.key.commentBefore}`:i.commentBefore),i.comment){const t=e.value??e.key;t.comment=t.comment?`${i.comment}\n${t.comment}`:i.comment}i=e}e.items[n]=cr(i)?i:new ps(i)}}else t("Expected a sequence for this tag");return e}function Gs(e,t,n){const{replacer:i}=n,r=new bs(e);r.tag="tag:yaml.org,2002:pairs";let s=0;if(t&&Symbol.iterator in Object(t))for(let e of t){let a,o;if("function"==typeof i&&(e=i.call(t,String(s++),e)),Array.isArray(e)){if(2!==e.length)throw new TypeError(`Expected [key, value] tuple: ${e}`);a=e[0],o=e[1]}else if(e&&e instanceof Object){const t=Object.keys(e);if(1!==t.length)throw new TypeError(`Expected tuple with one key, not ${t.length} keys`);a=t[0],o=e[a]}else a=e;r.items.push(ds(a,o,n))}return r}const Vs={collection:"seq",default:!1,tag:"tag:yaml.org,2002:pairs",resolve:Bs,createNode:Gs};class Zs extends bs{constructor(){super(),this.add=ys.prototype.add.bind(this),this.delete=ys.prototype.delete.bind(this),this.get=ys.prototype.get.bind(this),this.has=ys.prototype.has.bind(this),this.set=ys.prototype.set.bind(this),this.tag=Zs.tag}toJSON(e,t){if(!t)return super.toJSON(e);const n=new Map;t?.onCreate&&t.onCreate(n);for(const e of this.items){let i,r;if(cr(e)?(i=Nr(e.key,"",t),r=Nr(e.value,i,t)):i=Nr(e,"",t),n.has(i))throw new Error("Ordered maps must not include duplicate keys");n.set(i,r)}return n}static from(e,t,n){const i=Gs(e,t,n),r=new this;return r.items=i.items,r}}Zs.tag="tag:yaml.org,2002:omap";const qs={collection:"seq",identify:e=>e instanceof Map,nodeClass:Zs,default:!1,tag:"tag:yaml.org,2002:omap",resolve(e,t){const n=Bs(e,t),i=[];for(const{key:e}of n.items)lr(e)&&(i.includes(e.value)?t(`Ordered maps must not include duplicate keys: ${e.value}`):i.push(e.value));return Object.assign(new Zs,n)},createNode:(e,t,n)=>Zs.from(e,t,n)};function Hs({value:e,source:t},n){return t&&(e?Ws:Js).test.test(t)?t:e?n.options.trueStr:n.options.falseStr}const Ws={identify:e=>!0===e,default:!0,tag:"tag:yaml.org,2002:bool",test:/^(?:Y|y|[Yy]es|YES|[Tt]rue|TRUE|[Oo]n|ON)$/,resolve:()=>new jr(!0),stringify:Hs},Js={identify:e=>!1===e,default:!0,tag:"tag:yaml.org,2002:bool",test:/^(?:N|n|[Nn]o|NO|[Ff]alse|FALSE|[Oo]ff|OFF)$/,resolve:()=>new jr(!1),stringify:Hs},Ks={identify:e=>"number"==typeof e,default:!0,tag:"tag:yaml.org,2002:float",test:/^(?:[-+]?\.(?:inf|Inf|INF)|\.nan|\.NaN|\.NAN)$/,resolve:e=>"nan"===e.slice(-3).toLowerCase()?NaN:"-"===e[0]?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY,stringify:Is},Ys={identify:e=>"number"==typeof e,default:!0,tag:"tag:yaml.org,2002:float",format:"EXP",test:/^[-+]?(?:[0-9][0-9_]*)?(?:\.[0-9_]*)?[eE][-+]?[0-9]+$/,resolve:e=>parseFloat(e.replace(/_/g,"")),stringify(e){const t=Number(e.value);return isFinite(t)?t.toExponential():Is(e)}},Xs={identify:e=>"number"==typeof e,default:!0,tag:"tag:yaml.org,2002:float",test:/^[-+]?(?:[0-9][0-9_]*)?\.[0-9_]*$/,resolve(e){const t=new jr(parseFloat(e.replace(/_/g,""))),n=e.indexOf(".");if(-1!==n){const i=e.substring(n+1).replace(/_/g,"");"0"===i[i.length-1]&&(t.minFractionDigits=i.length)}return t},stringify:Is},Qs=e=>"bigint"==typeof e||Number.isInteger(e);function ea(e,t,n,{intAsBigInt:i}){const r=e[0];if("-"!==r&&"+"!==r||(t+=1),e=e.substring(t).replace(/_/g,""),i){switch(n){case 2:e=`0b${e}`;break;case 8:e=`0o${e}`;break;case 16:e=`0x${e}`}const t=BigInt(e);return"-"===r?BigInt(-1)*t:t}const s=parseInt(e,n);return"-"===r?-1*s:s}function ta(e,t,n){const{value:i}=e;if(Qs(i)){const e=i.toString(t);return i<0?"-"+n+e.substr(1):n+e}return Is(e)}const na={identify:Qs,default:!0,tag:"tag:yaml.org,2002:int",format:"BIN",test:/^[-+]?0b[0-1_]+$/,resolve:(e,t,n)=>ea(e,2,2,n),stringify:e=>ta(e,2,"0b")},ia={identify:Qs,default:!0,tag:"tag:yaml.org,2002:int",format:"OCT",test:/^[-+]?0[0-7_]+$/,resolve:(e,t,n)=>ea(e,1,8,n),stringify:e=>ta(e,8,"0")},ra={identify:Qs,default:!0,tag:"tag:yaml.org,2002:int",test:/^[-+]?[0-9][0-9_]*$/,resolve:(e,t,n)=>ea(e,0,10,n),stringify:Is},sa={identify:Qs,default:!0,tag:"tag:yaml.org,2002:int",format:"HEX",test:/^[-+]?0x[0-9a-fA-F_]+$/,resolve:(e,t,n)=>ea(e,2,16,n),stringify:e=>ta(e,16,"0x")};class aa extends ys{constructor(e){super(e),this.tag=aa.tag}add(e){let t;t=cr(e)?e:e&&"object"==typeof e&&"key"in e&&"value"in e&&null===e.value?new ps(e.key,null):new ps(e,null);vs(this.items,t.key)||this.items.push(t)}get(e,t){const n=vs(this.items,e);return!t&&cr(n)?lr(n.key)?n.key.value:n.key:n}set(e,t){if("boolean"!=typeof t)throw new Error("Expected boolean value for set(key, value) in a YAML set, not "+typeof t);const n=vs(this.items,e);n&&!t?this.items.splice(this.items.indexOf(n),1):!n&&t&&this.items.push(new ps(e))}toJSON(e,t){return super.toJSON(e,t,Set)}toString(e,t,n){if(!e)return JSON.stringify(this);if(this.hasAllNullValues(!0))return super.toString(Object.assign({},e,{allNullValues:!0}),t,n);throw new Error("Set items must all have null values")}static from(e,t,n){const{replacer:i}=n,r=new this(e);if(t&&Symbol.iterator in Object(t))for(let e of t)"function"==typeof i&&(e=i.call(t,e,e)),r.items.push(ds(e,null,n));return r}}aa.tag="tag:yaml.org,2002:set";const oa={collection:"map",identify:e=>e instanceof Set,nodeClass:aa,default:!1,tag:"tag:yaml.org,2002:set",createNode:(e,t,n)=>aa.from(e,t,n),resolve(e,t){if(or(e)){if(e.hasAllNullValues(!0))return Object.assign(new aa,e);t("Set items must all have null values")}else t("Expected a mapping for this tag");return e}};function ca(e,t){const n=e[0],i="-"===n||"+"===n?e.substring(1):e,r=e=>t?BigInt(e):Number(e),s=i.replace(/_/g,"").split(":").reduce((e,t)=>e*r(60)+r(t),r(0));return"-"===n?r(-1)*s:s}function la(e){let{value:t}=e,n=e=>e;if("bigint"==typeof t)n=e=>BigInt(e);else if(isNaN(t)||!isFinite(t))return Is(e);let i="";t<0&&(i="-",t*=n(-1));const r=n(60),s=[t%r];return t<60?s.unshift(0):(t=(t-s[0])/r,s.unshift(t%r),t>=60&&(t=(t-s[0])/r,s.unshift(t))),i+s.map(e=>String(e).padStart(2,"0")).join(":").replace(/000000\d*$/,"")}const ua={identify:e=>"bigint"==typeof e||Number.isInteger(e),default:!0,tag:"tag:yaml.org,2002:int",format:"TIME",test:/^[-+]?[0-9][0-9_]*(?::[0-5]?[0-9])+$/,resolve:(e,t,{intAsBigInt:n})=>ca(e,n),stringify:la},da={identify:e=>"number"==typeof e,default:!0,tag:"tag:yaml.org,2002:float",format:"TIME",test:/^[-+]?[0-9][0-9_]*(?::[0-5]?[0-9])+\.[0-9_]*$/,resolve:e=>ca(e,!1),stringify:la},pa={identify:e=>e instanceof Date,default:!0,tag:"tag:yaml.org,2002:timestamp",test:RegExp("^([0-9]{4})-([0-9]{1,2})-([0-9]{1,2})(?:(?:t|T|[ \\t]+)([0-9]{1,2}):([0-9]{1,2}):([0-9]{1,2}(\\.[0-9]+)?)(?:[ \\t]*(Z|[-+][012]?[0-9](?::[0-9]{2})?))?)?$"),resolve(e){const t=e.match(pa.test);if(!t)throw new Error("!!timestamp expects a date, starting with yyyy-mm-dd");const[,n,i,r,s,a,o]=t.map(Number),c=t[7]?Number((t[7]+"00").substr(1,3)):0;let l=Date.UTC(n,i-1,r,s||0,a||0,o||0,c);const u=t[8];if(u&&"Z"!==u){let e=ca(u,!1);Math.abs(e)<30&&(e*=60),l-=6e4*e}return new Date(l)},stringify:({value:e})=>e?.toISOString().replace(/(T00:00:00)?\.000Z$/,"")??""},ha=[_s,$s,ks,Ss,Ws,Js,na,ia,ra,sa,Ks,Ys,Xs,Fs,os,qs,Vs,oa,ua,da,pa],fa=new Map([["core",js],["failsafe",[_s,$s,ks]],["json",zs],["yaml11",ha],["yaml-1.1",ha]]),ma={binary:Fs,bool:Es,float:Os,floatExp:Ts,floatNaN:xs,floatTime:da,int:Ls,intHex:Rs,intOct:Ds,intTime:ua,map:_s,merge:os,null:Ss,omap:qs,pairs:Vs,seq:$s,set:oa,timestamp:pa},ga={"tag:yaml.org,2002:binary":Fs,"tag:yaml.org,2002:merge":os,"tag:yaml.org,2002:omap":qs,"tag:yaml.org,2002:pairs":Vs,"tag:yaml.org,2002:set":oa,"tag:yaml.org,2002:timestamp":pa};function va(e,t,n){const i=fa.get(t);if(i&&!e)return n&&!i.includes(os)?i.concat(os):i.slice();let r=i;if(!r){if(!Array.isArray(e)){const e=Array.from(fa.keys()).filter(e=>"yaml11"!==e).map(e=>JSON.stringify(e)).join(", ");throw new Error(`Unknown schema "${t}"; use one of ${e} or define customTags array`)}r=[]}if(Array.isArray(e))for(const t of e)r=r.concat(t);else"function"==typeof e&&(r=e(r.slice()));return n&&(r=r.concat(os)),r.reduce((e,t)=>{const n="string"==typeof t?ma[t]:t;if(!n){const e=JSON.stringify(t),n=Object.keys(ma).map(e=>JSON.stringify(e)).join(", ");throw new Error(`Unknown custom tag ${e}; use one of ${n}`)}return e.includes(n)||e.push(n),e},[])}const ya=(e,t)=>e.key<t.key?-1:e.key>t.key?1:0;class _a{constructor({compat:e,customTags:t,merge:n,resolveKnownTags:i,schema:r,sortMapEntries:s,toStringDefaults:a}){this.compat=Array.isArray(e)?va(e,"compat"):e?va(null,e):null,this.name="string"==typeof r&&r||"core",this.knownTags=i?ga:{},this.tags=va(t,this.name,n),this.toStringOptions=a??null,Object.defineProperty(this,er,{value:_s}),Object.defineProperty(this,nr,{value:ks}),Object.defineProperty(this,ir,{value:$s}),this.sortMapEntries="function"==typeof s?s:!0===s?ya:null}clone(){const e=Object.create(_a.prototype,Object.getOwnPropertyDescriptors(this));return e.tags=this.tags.slice(),e}}class ba{constructor(e,t,n){this.commentBefore=null,this.comment=null,this.errors=[],this.warnings=[],Object.defineProperty(this,rr,{value:Qi});let i=null;"function"==typeof t||Array.isArray(t)?i=t:void 0===n&&t&&(n=t,t=void 0);const r=Object.assign({intAsBigInt:!1,keepSourceTokens:!1,logLevel:"warn",prettyErrors:!0,strict:!0,stringKeys:!1,uniqueKeys:!0,version:"1.2"},n);this.options=r;let{version:s}=r;n?._directives?(this.directives=n._directives.atDocument(),this.directives.yaml.explicit&&(s=this.directives.yaml.version)):this.directives=new Ir({version:s}),this.setSchema(s,n),this.contents=void 0===e?null:this.createNode(e,i,n)}clone(){const e=Object.create(ba.prototype,{[rr]:{value:Qi}});return e.commentBefore=this.commentBefore,e.comment=this.comment,e.errors=this.errors.slice(),e.warnings=this.warnings.slice(),e.options=Object.assign({},this.options),this.directives&&(e.directives=this.directives.clone()),e.schema=this.schema.clone(),e.contents=pr(this.contents)?this.contents.clone(e.schema):this.contents,this.range&&(e.range=this.range.slice()),e}add(e){wa(this.contents)&&this.contents.add(e)}addIn(e,t){wa(this.contents)&&this.contents.addIn(e,t)}createAlias(e,t){if(!e.anchor){const n=Tr(this);e.anchor=!t||n.has(t)?Or(t||"a",n):t}return new Dr(e.anchor)}createNode(e,t,n){let i;if("function"==typeof t)e=t.call({"":e},"",e),i=t;else if(Array.isArray(t)){const e=e=>"number"==typeof e||e instanceof String||e instanceof Number,n=t.filter(e).map(String);n.length>0&&(t=t.concat(n)),i=t}else void 0===n&&t&&(n=t,t=void 0);const{aliasDuplicateObjects:r,anchorPrefix:s,flow:a,keepUndefined:o,onTagObj:c,tag:l}=n??{},{onAnchor:u,setAnchors:d,sourceObjects:p}=function(e,t){const n=[],i=new Map;let r=null;return{onAnchor:i=>{n.push(i),r??(r=Tr(e));const s=Or(t,r);return r.add(s),s},setAnchors:()=>{for(const e of n){const t=i.get(e);if("object"!=typeof t||!t.anchor||!lr(t.node)&&!dr(t.node)){const t=new Error("Failed to resolve repeated object (this should not happen)");throw t.source=e,t}t.node.anchor=t.anchor}},sourceObjects:i}}(this,s||"a"),h=Pr(e,l,{aliasDuplicateObjects:r??!0,keepUndefined:o??!1,onAnchor:u,onTagObj:c,replacer:i,schema:this.schema,sourceObjects:p});return a&&dr(h)&&(h.flow=!0),d(),h}createPair(e,t,n={}){const i=this.createNode(e,null,n),r=this.createNode(t,null,n);return new ps(i,r)}delete(e){return!!wa(this.contents)&&this.contents.delete(e)}deleteIn(e){return Mr(e)?null!=this.contents&&(this.contents=null,!0):!!wa(this.contents)&&this.contents.deleteIn(e)}get(e,t){return dr(this.contents)?this.contents.get(e,t):void 0}getIn(e,t){return Mr(e)?!t&&lr(this.contents)?this.contents.value:this.contents:dr(this.contents)?this.contents.getIn(e,t):void 0}has(e){return!!dr(this.contents)&&this.contents.has(e)}hasIn(e){return Mr(e)?void 0!==this.contents:!!dr(this.contents)&&this.contents.hasIn(e)}set(e,t){null==this.contents?this.contents=Ur(this.schema,[e],t):wa(this.contents)&&this.contents.set(e,t)}setIn(e,t){Mr(e)?this.contents=t:null==this.contents?this.contents=Ur(this.schema,Array.from(e),t):wa(this.contents)&&this.contents.setIn(e,t)}setSchema(e,t={}){let n;switch("number"==typeof e&&(e=String(e)),e){case"1.1":this.directives?this.directives.yaml.version="1.1":this.directives=new Ir({version:"1.1"}),n={resolveKnownTags:!1,schema:"yaml-1.1"};break;case"1.2":case"next":this.directives?this.directives.yaml.version=e:this.directives=new Ir({version:e}),n={resolveKnownTags:!0,schema:"core"};break;case null:this.directives&&delete this.directives,n=null;break;default:{const t=JSON.stringify(e);throw new Error(`Expected '1.1', '1.2' or null as first argument, but found: ${t}`)}}if(t.schema instanceof Object)this.schema=t.schema;else{if(!n)throw new Error("With a null YAML version, the { schema: Schema } option is required");this.schema=new _a(Object.assign(n,t))}}toJS({json:e,jsonArg:t,mapAsMap:n,maxAliasCount:i,onAnchor:r,reviver:s}={}){const a={anchors:new Map,doc:this,keep:!e,mapAsMap:!0===n,mapKeyWarned:!1,maxAliasCount:"number"==typeof i?i:100},o=Nr(this.contents,t??"",a);if("function"==typeof r)for(const{count:e,res:t}of a.anchors.values())r(t,e);return"function"==typeof s?Ar(s,{"":o},"",o):o}toJSON(e,t){return this.toJS({json:!0,jsonArg:e,mapAsMap:!1,onAnchor:t})}toString(e={}){if(this.errors.length>0)throw new Error("Document with errors cannot be stringified");if("indent"in e&&(!Number.isInteger(e.indent)||Number(e.indent)<=0)){const t=JSON.stringify(e.indent);throw new Error(`"indent" option must be a positive integer, not ${t}`)}return function(e,t){const n=[];let i=!0===t.directives;if(!1!==t.directives&&e.directives){const t=e.directives.toString(e);t?(n.push(t),i=!0):e.directives.docStart&&(i=!0)}i&&n.push("---");const r=is(e,t),{commentString:s}=r.options;if(e.commentBefore){1!==n.length&&n.unshift("");const t=s(e.commentBefore);n.unshift(Br(t,""))}let a=!1,o=null;if(e.contents){if(pr(e.contents)){if(e.contents.spaceBefore&&i&&n.push(""),e.contents.commentBefore){const t=s(e.contents.commentBefore);n.push(Br(t,""))}r.forceBlockIndent=!!e.comment,o=e.contents.comment}const t=o?void 0:()=>a=!0;let c=rs(e.contents,r,()=>o=null,t);o&&(c+=Gr(c,"",s(o))),"|"!==c[0]&&">"!==c[0]||"---"!==n[n.length-1]?n.push(c):n[n.length-1]=`--- ${c}`}else n.push(rs(e.contents,r));if(e.directives?.docEnd)if(e.comment){const t=s(e.comment);t.includes("\n")?(n.push("..."),n.push(Br(t,""))):n.push(`... ${t}`)}else n.push("...");else{let t=e.comment;t&&a&&(t=t.replace(/^\n+/,"")),t&&(a&&!o||""===n[n.length-1]||n.push(""),n.push(Br(s(t),"")))}return n.join("\n")+"\n"}(this,e)}}function wa(e){if(dr(e))return!0;throw new Error("Expected a YAML collection as document contents")}class $a extends Error{constructor(e,t,n,i){super(),this.name=e,this.code=n,this.message=i,this.pos=t}}class ka extends $a{constructor(e,t,n){super("YAMLParseError",e,t,n)}}class Sa extends $a{constructor(e,t,n){super("YAMLWarning",e,t,n)}}const Ea=(e,t)=>n=>{if(-1===n.pos[0])return;n.linePos=n.pos.map(e=>t.linePos(e));const{line:i,col:r}=n.linePos[0];n.message+=` at line ${i}, column ${r}`;let s=r-1,a=e.substring(t.lineStarts[i-1],t.lineStarts[i]).replace(/[\n\r]+$/,"");if(s>=60&&a.length>80){const e=Math.min(s-39,a.length-79);a="…"+a.substring(e),s-=e-1}if(a.length>80&&(a=a.substring(0,79)+"…"),i>1&&/^ *$/.test(a.substring(0,s))){let n=e.substring(t.lineStarts[i-2],t.lineStarts[i-1]);n.length>80&&(n=n.substring(0,79)+"…\n"),a=n+a}if(/[^ ]/.test(a)){let e=1;const t=n.linePos[1];t&&t.line===i&&t.col>r&&(e=Math.max(1,Math.min(t.col-r,80-s)));const o=" ".repeat(s)+"^".repeat(e);n.message+=`:\n\n${a}\n${o}\n`}};function Ia(e,{flow:t,indicator:n,next:i,offset:r,onError:s,parentIndent:a,startOnNewline:o}){let c=!1,l=o,u=o,d="",p="",h=!1,f=!1,m=null,g=null,v=null,y=null,_=null,b=null,w=null;for(const r of e)switch(f&&("space"!==r.type&&"newline"!==r.type&&"comma"!==r.type&&s(r.offset,"MISSING_CHAR","Tags and anchors must be separated from the next token by white space"),f=!1),m&&(l&&"comment"!==r.type&&"newline"!==r.type&&s(m,"TAB_AS_INDENT","Tabs are not allowed as indentation"),m=null),r.type){case"space":t||"doc-start"===n&&"flow-collection"===i?.type||!r.source.includes("\t")||(m=r),u=!0;break;case"comment":{u||s(r,"MISSING_CHAR","Comments must be separated from other tokens by white space characters");const e=r.source.substring(1)||" ";d?d+=p+e:d=e,p="",l=!1;break}case"newline":l?d?d+=r.source:b&&"seq-item-ind"===n||(c=!0):p+=r.source,l=!0,h=!0,(g||v)&&(y=r),u=!0;break;case"anchor":g&&s(r,"MULTIPLE_ANCHORS","A node can have at most one anchor"),r.source.endsWith(":")&&s(r.offset+r.source.length-1,"BAD_ALIAS","Anchor ending in : is ambiguous",!0),g=r,w??(w=r.offset),l=!1,u=!1,f=!0;break;case"tag":v&&s(r,"MULTIPLE_TAGS","A node can have at most one tag"),v=r,w??(w=r.offset),l=!1,u=!1,f=!0;break;case n:(g||v)&&s(r,"BAD_PROP_ORDER",`Anchors and tags must be after the ${r.source} indicator`),b&&s(r,"UNEXPECTED_TOKEN",`Unexpected ${r.source} in ${t??"collection"}`),b=r,l="seq-item-ind"===n||"explicit-key-ind"===n,u=!1;break;case"comma":if(t){_&&s(r,"UNEXPECTED_TOKEN",`Unexpected , in ${t}`),_=r,l=!1,u=!1;break}default:s(r,"UNEXPECTED_TOKEN",`Unexpected ${r.type} token`),l=!1,u=!1}const $=e[e.length-1],k=$?$.offset+$.source.length:r;return f&&i&&"space"!==i.type&&"newline"!==i.type&&"comma"!==i.type&&("scalar"!==i.type||""!==i.source)&&s(i.offset,"MISSING_CHAR","Tags and anchors must be separated from the next token by white space"),m&&(l&&m.indent<=a||"block-map"===i?.type||"block-seq"===i?.type)&&s(m,"TAB_AS_INDENT","Tabs are not allowed as indentation"),{comma:_,found:b,spaceBefore:c,comment:d,hasNewline:h,anchor:g,tag:v,newlineAfterProp:y,end:k,start:w??k}}function xa(e){if(!e)return null;switch(e.type){case"alias":case"scalar":case"double-quoted-scalar":case"single-quoted-scalar":if(e.source.includes("\n"))return!0;if(e.end)for(const t of e.end)if("newline"===t.type)return!0;return!1;case"flow-collection":for(const t of e.items){for(const e of t.start)if("newline"===e.type)return!0;if(t.sep)for(const e of t.sep)if("newline"===e.type)return!0;if(xa(t.key)||xa(t.value))return!0}return!1;default:return!0}}function Ta(e,t,n){if("flow-collection"===t?.type){const i=t.end[0];if(i.indent===e&&("]"===i.source||"}"===i.source)&&xa(t)){n(i,"BAD_INDENT","Flow end indicator should be more indented than parent",!0)}}}function Oa(e,t,n){const{uniqueKeys:i}=e.options;if(!1===i)return!1;const r="function"==typeof i?i:(e,t)=>e===t||lr(e)&&lr(t)&&e.value===t.value;return t.some(e=>r(e.key,n))}const Aa="All mapping items must start at the same column";function Na(e,t,n,i){let r="";if(e){let s=!1,a="";for(const o of e){const{source:e,type:c}=o;switch(c){case"space":s=!0;break;case"comment":{n&&!s&&i(o,"MISSING_CHAR","Comments must be separated from other tokens by white space characters");const t=e.substring(1)||" ";r?r+=a+t:r=t,a="";break}case"newline":r&&(a+=e),s=!0;break;default:i(o,"UNEXPECTED_TOKEN",`Unexpected ${c} at node end`)}t+=e.length}}return{comment:r,offset:t}}const Ca="Block collections are not allowed within flow collections",Da=e=>e&&("block-map"===e.type||"block-seq"===e.type);function La(e,t,n,i,r,s){const a="block-map"===n.type?function({composeNode:e,composeEmptyNode:t},n,i,r,s){const a=new(s?.nodeClass??ys)(n.schema);n.atRoot&&(n.atRoot=!1);let o=i.offset,c=null;for(const s of i.items){const{start:l,key:u,sep:d,value:p}=s,h=Ia(l,{indicator:"explicit-key-ind",next:u??d?.[0],offset:o,onError:r,parentIndent:i.indent,startOnNewline:!0}),f=!h.found;if(f){if(u&&("block-seq"===u.type?r(o,"BLOCK_AS_IMPLICIT_KEY","A block sequence may not be used as an implicit map key"):"indent"in u&&u.indent!==i.indent&&r(o,"BAD_INDENT",Aa)),!h.anchor&&!h.tag&&!d){c=h.end,h.comment&&(a.comment?a.comment+="\n"+h.comment:a.comment=h.comment);continue}(h.newlineAfterProp||xa(u))&&r(u??l[l.length-1],"MULTILINE_IMPLICIT_KEY","Implicit keys need to be on a single line")}else h.found?.indent!==i.indent&&r(o,"BAD_INDENT",Aa);n.atKey=!0;const m=h.end,g=u?e(n,u,h,r):t(n,m,l,null,h,r);n.schema.compat&&Ta(i.indent,u,r),n.atKey=!1,Oa(n,a.items,g)&&r(m,"DUPLICATE_KEY","Map keys must be unique");const v=Ia(d??[],{indicator:"map-value-ind",next:p,offset:g.range[2],onError:r,parentIndent:i.indent,startOnNewline:!u||"block-scalar"===u.type});if(o=v.end,v.found){f&&("block-map"!==p?.type||v.hasNewline||r(o,"BLOCK_AS_IMPLICIT_KEY","Nested mappings are not allowed in compact mappings"),n.options.strict&&h.start<v.found.offset-1024&&r(g.range,"KEY_OVER_1024_CHARS","The : indicator must be at most 1024 chars after the start of an implicit block mapping key"));const c=p?e(n,p,v,r):t(n,o,d,null,v,r);n.schema.compat&&Ta(i.indent,p,r),o=c.range[2];const l=new ps(g,c);n.options.keepSourceTokens&&(l.srcToken=s),a.items.push(l)}else{f&&r(g.range,"MISSING_CHAR","Implicit map keys need to be followed by map values"),v.comment&&(g.comment?g.comment+="\n"+v.comment:g.comment=v.comment);const e=new ps(g);n.options.keepSourceTokens&&(e.srcToken=s),a.items.push(e)}}return c&&c<o&&r(c,"IMPOSSIBLE","Map comment with trailing content"),a.range=[i.offset,o,c??o],a}(e,t,n,i,s):"block-seq"===n.type?function({composeNode:e,composeEmptyNode:t},n,i,r,s){const a=new(s?.nodeClass??bs)(n.schema);n.atRoot&&(n.atRoot=!1),n.atKey&&(n.atKey=!1);let o=i.offset,c=null;for(const{start:s,value:l}of i.items){const u=Ia(s,{indicator:"seq-item-ind",next:l,offset:o,onError:r,parentIndent:i.indent,startOnNewline:!0});if(!u.found){if(!(u.anchor||u.tag||l)){c=u.end,u.comment&&(a.comment=u.comment);continue}l&&"block-seq"===l.type?r(u.end,"BAD_INDENT","All sequence items must start at the same column"):r(o,"MISSING_CHAR","Sequence item without - indicator")}const d=l?e(n,l,u,r):t(n,u.end,s,null,u,r);n.schema.compat&&Ta(i.indent,l,r),o=d.range[2],a.items.push(d)}return a.range=[i.offset,o,c??o],a}(e,t,n,i,s):function({composeNode:e,composeEmptyNode:t},n,i,r,s){const a="{"===i.start.source,o=a?"flow map":"flow sequence",c=new(s?.nodeClass??(a?ys:bs))(n.schema);c.flow=!0;const l=n.atRoot;l&&(n.atRoot=!1),n.atKey&&(n.atKey=!1);let u=i.offset+i.start.source.length;for(let s=0;s<i.items.length;++s){const l=i.items[s],{start:d,key:p,sep:h,value:f}=l,m=Ia(d,{flow:o,indicator:"explicit-key-ind",next:p??h?.[0],offset:u,onError:r,parentIndent:i.indent,startOnNewline:!1});if(!m.found){if(!(m.anchor||m.tag||h||f)){0===s&&m.comma?r(m.comma,"UNEXPECTED_TOKEN",`Unexpected , in ${o}`):s<i.items.length-1&&r(m.start,"UNEXPECTED_TOKEN",`Unexpected empty item in ${o}`),m.comment&&(c.comment?c.comment+="\n"+m.comment:c.comment=m.comment),u=m.end;continue}!a&&n.options.strict&&xa(p)&&r(p,"MULTILINE_IMPLICIT_KEY","Implicit keys of flow sequence pairs need to be on a single line")}if(0===s)m.comma&&r(m.comma,"UNEXPECTED_TOKEN",`Unexpected , in ${o}`);else if(m.comma||r(m.start,"MISSING_CHAR",`Missing , between ${o} items`),m.comment){let e="";e:for(const t of d)switch(t.type){case"comma":case"space":break;case"comment":e=t.source.substring(1);break e;default:break e}if(e){let t=c.items[c.items.length-1];cr(t)&&(t=t.value??t.key),t.comment?t.comment+="\n"+e:t.comment=e,m.comment=m.comment.substring(e.length+1)}}if(a||h||m.found){n.atKey=!0;const s=m.end,g=p?e(n,p,m,r):t(n,s,d,null,m,r);Da(p)&&r(g.range,"BLOCK_IN_FLOW",Ca),n.atKey=!1;const v=Ia(h??[],{flow:o,indicator:"map-value-ind",next:f,offset:g.range[2],onError:r,parentIndent:i.indent,startOnNewline:!1});if(v.found){if(!a&&!m.found&&n.options.strict){if(h)for(const e of h){if(e===v.found)break;if("newline"===e.type){r(e,"MULTILINE_IMPLICIT_KEY","Implicit keys of flow sequence pairs need to be on a single line");break}}m.start<v.found.offset-1024&&r(v.found,"KEY_OVER_1024_CHARS","The : indicator must be at most 1024 chars after the start of an implicit flow sequence key")}}else f&&("source"in f&&f.source&&":"===f.source[0]?r(f,"MISSING_CHAR",`Missing space after : in ${o}`):r(v.start,"MISSING_CHAR",`Missing , or : between ${o} items`));const y=f?e(n,f,v,r):v.found?t(n,v.end,h,null,v,r):null;y?Da(f)&&r(y.range,"BLOCK_IN_FLOW",Ca):v.comment&&(g.comment?g.comment+="\n"+v.comment:g.comment=v.comment);const _=new ps(g,y);if(n.options.keepSourceTokens&&(_.srcToken=l),a){const e=c;Oa(n,e.items,g)&&r(s,"DUPLICATE_KEY","Map keys must be unique"),e.items.push(_)}else{const e=new ys(n.schema);e.flow=!0,e.items.push(_);const t=(y??g).range;e.range=[g.range[0],t[1],t[2]],c.items.push(e)}u=y?y.range[2]:v.end}else{const i=f?e(n,f,m,r):t(n,m.end,h,null,m,r);c.items.push(i),u=i.range[2],Da(f)&&r(i.range,"BLOCK_IN_FLOW",Ca)}}const d=a?"}":"]",[p,...h]=i.end;let f=u;if(p&&p.source===d)f=p.offset+p.source.length;else{const e=o[0].toUpperCase()+o.substring(1);r(u,l?"MISSING_CHAR":"BAD_INDENT",l?`${e} must end with a ${d}`:`${e} in block collection must be sufficiently indented and end with a ${d}`),p&&1!==p.source.length&&h.unshift(p)}if(h.length>0){const e=Na(h,f,n.options.strict,r);e.comment&&(c.comment?c.comment+="\n"+e.comment:c.comment=e.comment),c.range=[i.offset,f,e.offset]}else c.range=[i.offset,f,f];return c}(e,t,n,i,s),o=a.constructor;return"!"===r||r===o.tagName?(a.tag=o.tagName,a):(r&&(a.tag=r),a)}function Ra(e,t,n){const i=t.offset,r=function({offset:e,props:t},n,i){if("block-scalar-header"!==t[0].type)return i(t[0],"IMPOSSIBLE","Block scalar header not found"),null;const{source:r}=t[0],s=r[0];let a=0,o="",c=-1;for(let t=1;t<r.length;++t){const n=r[t];if(o||"-"!==n&&"+"!==n){const i=Number(n);!a&&i?a=i:-1===c&&(c=e+t)}else o=n}-1!==c&&i(c,"UNEXPECTED_TOKEN",`Block scalar header includes extra characters: ${r}`);let l=!1,u="",d=r.length;for(let e=1;e<t.length;++e){const r=t[e];switch(r.type){case"space":l=!0;case"newline":d+=r.source.length;break;case"comment":if(n&&!l){i(r,"MISSING_CHAR","Comments must be separated from other tokens by white space characters")}d+=r.source.length,u=r.source.substring(1);break;case"error":i(r,"UNEXPECTED_TOKEN",r.message),d+=r.source.length;break;default:{i(r,"UNEXPECTED_TOKEN",`Unexpected token in block scalar header: ${r.type}`);const e=r.source;e&&"string"==typeof e&&(d+=e.length)}}}return{mode:s,indent:a,chomp:o,comment:u,length:d}}(t,e.options.strict,n);if(!r)return{value:"",type:null,comment:"",range:[i,i,i]};const s=">"===r.mode?jr.BLOCK_FOLDED:jr.BLOCK_LITERAL,a=t.source?function(e){const t=e.split(/\n( *)/),n=t[0],i=n.match(/^( *)/),r=[i?.[1]?[i[1],n.slice(i[1].length)]:["",n]];for(let e=1;e<t.length;e+=2)r.push([t[e],t[e+1]]);return r}(t.source):[];let o=a.length;for(let e=a.length-1;e>=0;--e){const t=a[e][1];if(""!==t&&"\r"!==t)break;o=e}if(0===o){const e="+"===r.chomp&&a.length>0?"\n".repeat(Math.max(1,a.length-1)):"";let n=i+r.length;return t.source&&(n+=t.source.length),{value:e,type:s,comment:r.comment,range:[i,n,n]}}let c=t.indent+r.indent,l=t.offset+r.length,u=0;for(let t=0;t<o;++t){const[i,s]=a[t];if(""!==s&&"\r"!==s){if(i.length<c){const e="Block scalars with more-indented leading empty lines must use an explicit indentation indicator";n(l+i.length,"MISSING_CHAR",e)}if(0===r.indent&&(c=i.length),u=t,0===c&&!e.atRoot){n(l,"BAD_INDENT","Block scalar values in collections must be indented")}break}0===r.indent&&i.length>c&&(c=i.length),l+=i.length+s.length+1}for(let e=a.length-1;e>=o;--e)a[e][0].length>c&&(o=e+1);let d="",p="",h=!1;for(let e=0;e<u;++e)d+=a[e][0].slice(c)+"\n";for(let e=u;e<o;++e){let[t,i]=a[e];l+=t.length+i.length+1;const o="\r"===i[i.length-1];if(o&&(i=i.slice(0,-1)),i&&t.length<c){const e=`Block scalar lines must not be less indented than their ${r.indent?"explicit indentation indicator":"first line"}`;n(l-i.length-(o?2:1),"BAD_INDENT",e),t=""}s===jr.BLOCK_LITERAL?(d+=p+t.slice(c)+i,p="\n"):t.length>c||"\t"===i[0]?(" "===p?p="\n":h||"\n"!==p||(p="\n\n"),d+=p+t.slice(c)+i,p="\n",h=!0):""===i?"\n"===p?d+="\n":p="\n":(d+=p+i,p=" ",h=!1)}switch(r.chomp){case"-":break;case"+":for(let e=o;e<a.length;++e)d+="\n"+a[e][0].slice(c);"\n"!==d[d.length-1]&&(d+="\n");break;default:d+="\n"}const f=i+r.length+t.source.length;return{value:d,type:s,comment:r.comment,range:[i,f,f]}}function ja(e,t,n){const{offset:i,type:r,source:s,end:a}=e;let o,c;const l=(e,t,r)=>n(i+e,t,r);switch(r){case"scalar":o=jr.PLAIN,c=function(e,t){let n="";switch(e[0]){case"\t":n="a tab character";break;case",":n="flow indicator character ,";break;case"%":n="directive indicator character %";break;case"|":case">":n=`block scalar indicator ${e[0]}`;break;case"@":case"`":n=`reserved character ${e[0]}`}n&&t(0,"BAD_SCALAR_START",`Plain value cannot start with ${n}`);return Pa(e)}(s,l);break;case"single-quoted-scalar":o=jr.QUOTE_SINGLE,c=function(e,t){"'"===e[e.length-1]&&1!==e.length||t(e.length,"MISSING_CHAR","Missing closing 'quote");return Pa(e.slice(1,-1)).replace(/''/g,"'")}(s,l);break;case"double-quoted-scalar":o=jr.QUOTE_DOUBLE,c=function(e,t){let n="";for(let i=1;i<e.length-1;++i){const r=e[i];if("\r"!==r||"\n"!==e[i+1])if("\n"===r){const{fold:t,offset:r}=Ua(e,i);n+=t,i=r}else if("\\"===r){let r=e[++i];const s=Ma[r];if(s)n+=s;else if("\n"===r)for(r=e[i+1];" "===r||"\t"===r;)r=e[1+ ++i];else if("\r"===r&&"\n"===e[i+1])for(r=e[1+ ++i];" "===r||"\t"===r;)r=e[1+ ++i];else if("x"===r||"u"===r||"U"===r){const s={x:2,u:4,U:8}[r];n+=za(e,i+1,s,t),i+=s}else{const r=e.substr(i-1,2);t(i-1,"BAD_DQ_ESCAPE",`Invalid escape sequence ${r}`),n+=r}}else if(" "===r||"\t"===r){const t=i;let s=e[i+1];for(;" "===s||"\t"===s;)s=e[1+ ++i];"\n"===s||"\r"===s&&"\n"===e[i+2]||(n+=i>t?e.slice(t,i+1):r)}else n+=r}'"'===e[e.length-1]&&1!==e.length||t(e.length,"MISSING_CHAR",'Missing closing "quote');return n}(s,l);break;default:return n(e,"UNEXPECTED_TOKEN",`Expected a flow scalar value, but found: ${r}`),{value:"",type:null,comment:"",range:[i,i+s.length,i+s.length]}}const u=i+s.length,d=Na(a,u,t,n);return{value:c,type:o,comment:d.comment,range:[i,u,d.offset]}}function Pa(e){let t,n;try{t=new RegExp("(.*?)(?<![ \t])[ \t]*\r?\n","sy"),n=new RegExp("[ \t]*(.*?)(?:(?<![ \t])[ \t]*)?\r?\n","sy")}catch{t=/(.*?)[ \t]*\r?\n/sy,n=/[ \t]*(.*?)[ \t]*\r?\n/sy}let i=t.exec(e);if(!i)return e;let r=i[1],s=" ",a=t.lastIndex;for(n.lastIndex=a;i=n.exec(e);)""===i[1]?"\n"===s?r+=s:s="\n":(r+=s+i[1],s=" "),a=n.lastIndex;const o=/[ \t]*(.*)/sy;return o.lastIndex=a,i=o.exec(e),r+s+(i?.[1]??"")}function Ua(e,t){let n="",i=e[t+1];for(;!(" "!==i&&"\t"!==i&&"\n"!==i&&"\r"!==i||"\r"===i&&"\n"!==e[t+2]);)"\n"===i&&(n+="\n"),i=e[(t+=1)+1];return n||(n=" "),{fold:n,offset:t}}const Ma={0:"\0",a:"",b:"\b",e:"",f:"\f",n:"\n",r:"\r",t:"\t",v:"\v",N:"",_:" ",L:"\u2028",P:"\u2029"," ":" ",'"':'"',"/":"/","\\":"\\","\t":"\t"};function za(e,t,n,i){const r=e.substr(t,n),s=r.length===n&&/^[0-9a-fA-F]+$/.test(r)?parseInt(r,16):NaN;if(isNaN(s)){const r=e.substr(t-2,n+2);return i(t-2,"BAD_DQ_ESCAPE",`Invalid escape sequence ${r}`),r}return String.fromCodePoint(s)}function Fa(e,t,n,i){const{value:r,type:s,comment:a,range:o}="block-scalar"===t.type?Ra(e,t,i):ja(t,e.options.strict,i),c=n?e.directives.tagName(n.source,e=>i(n,"TAG_RESOLVE_FAILED",e)):null;let l,u;l=e.options.stringKeys&&e.atKey?e.schema[nr]:c?function(e,t,n,i,r){if("!"===n)return e[nr];const s=[];for(const t of e.tags)if(!t.collection&&t.tag===n){if(!t.default||!t.test)return t;s.push(t)}for(const e of s)if(e.test?.test(t))return e;const a=e.knownTags[n];if(a&&!a.collection)return e.tags.push(Object.assign({},a,{default:!1,test:void 0})),a;return r(i,"TAG_RESOLVE_FAILED",`Unresolved tag: ${n}`,"tag:yaml.org,2002:str"!==n),e[nr]}(e.schema,r,c,n,i):"scalar"===t.type?function({atKey:e,directives:t,schema:n},i,r,s){const a=n.tags.find(t=>(!0===t.default||e&&"key"===t.default)&&t.test?.test(i))||n[nr];if(n.compat){const e=n.compat.find(e=>e.default&&e.test?.test(i))??n[nr];if(a.tag!==e.tag){s(r,"TAG_RESOLVE_FAILED",`Value may be parsed as either ${t.tagString(a.tag)} or ${t.tagString(e.tag)}`,!0)}}return a}(e,r,t,i):e.schema[nr];try{const s=l.resolve(r,e=>i(n??t,"TAG_RESOLVE_FAILED",e),e.options);u=lr(s)?s:new jr(s)}catch(e){const s=e instanceof Error?e.message:String(e);i(n??t,"TAG_RESOLVE_FAILED",s),u=new jr(r)}return u.range=o,u.source=r,s&&(u.type=s),c&&(u.tag=c),l.format&&(u.format=l.format),a&&(u.comment=a),u}function Ba(e,t,n){if(t){n??(n=t.length);for(let i=n-1;i>=0;--i){let n=t[i];switch(n.type){case"space":case"comment":case"newline":e-=n.source.length;continue}for(n=t[++i];"space"===n?.type;)e+=n.source.length,n=t[++i];break}}return e}const Ga={composeNode:Va,composeEmptyNode:Za};function Va(e,t,n,i){const r=e.atKey,{spaceBefore:s,comment:a,anchor:o,tag:c}=n;let l,u=!0;switch(t.type){case"alias":l=function({options:e},{offset:t,source:n,end:i},r){const s=new Dr(n.substring(1));""===s.source&&r(t,"BAD_ALIAS","Alias cannot be an empty string");s.source.endsWith(":")&&r(t+n.length-1,"BAD_ALIAS","Alias ending in : is ambiguous",!0);const a=t+n.length,o=Na(i,a,e.strict,r);s.range=[t,a,o.offset],o.comment&&(s.comment=o.comment);return s}(e,t,i),(o||c)&&i(t,"ALIAS_PROPS","An alias node must not specify any properties");break;case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":case"block-scalar":l=Fa(e,t,c,i),o&&(l.anchor=o.source.substring(1));break;case"block-map":case"block-seq":case"flow-collection":l=function(e,t,n,i,r){const s=i.tag,a=s?t.directives.tagName(s.source,e=>r(s,"TAG_RESOLVE_FAILED",e)):null;if("block-seq"===n.type){const{anchor:e,newlineAfterProp:t}=i,n=e&&s?e.offset>s.offset?e:s:e??s;n&&(!t||t.offset<n.offset)&&r(n,"MISSING_CHAR","Missing newline after block sequence props")}const o="block-map"===n.type?"map":"block-seq"===n.type?"seq":"{"===n.start.source?"map":"seq";if(!s||!a||"!"===a||a===ys.tagName&&"map"===o||a===bs.tagName&&"seq"===o)return La(e,t,n,r,a);let c=t.schema.tags.find(e=>e.tag===a&&e.collection===o);if(!c){const i=t.schema.knownTags[a];if(!i||i.collection!==o)return i?r(s,"BAD_COLLECTION_TYPE",`${i.tag} used for ${o} collection, but expects ${i.collection??"scalar"}`,!0):r(s,"TAG_RESOLVE_FAILED",`Unresolved tag: ${a}`,!0),La(e,t,n,r,a);t.schema.tags.push(Object.assign({},i,{default:!1})),c=i}const l=La(e,t,n,r,a,c),u=c.resolve?.(l,e=>r(s,"TAG_RESOLVE_FAILED",e),t.options)??l,d=pr(u)?u:new jr(u);return d.range=l.range,d.tag=a,c?.format&&(d.format=c.format),d}(Ga,e,t,n,i),o&&(l.anchor=o.source.substring(1));break;default:i(t,"UNEXPECTED_TOKEN","error"===t.type?t.message:`Unsupported token (type: ${t.type})`),l=Za(e,t.offset,void 0,null,n,i),u=!1}if(o&&""===l.anchor&&i(o,"BAD_ALIAS","Anchor cannot be an empty string"),r&&e.options.stringKeys&&(!lr(l)||"string"!=typeof l.value||l.tag&&"tag:yaml.org,2002:str"!==l.tag)){i(c??t,"NON_STRING_KEY","With stringKeys, all keys must be strings")}return s&&(l.spaceBefore=!0),a&&("scalar"===t.type&&""===t.source?l.comment=a:l.commentBefore=a),e.options.keepSourceTokens&&u&&(l.srcToken=t),l}function Za(e,t,n,i,{spaceBefore:r,comment:s,anchor:a,tag:o,end:c},l){const u=Fa(e,{type:"scalar",offset:Ba(t,n,i),indent:-1,source:""},o,l);return a&&(u.anchor=a.source.substring(1),""===u.anchor&&l(a,"BAD_ALIAS","Anchor cannot be an empty string")),r&&(u.spaceBefore=!0),s&&(u.comment=s,u.range[2]=c),u}function qa(e){if("number"==typeof e)return[e,e+1];if(Array.isArray(e))return 2===e.length?e:[e[0],e[1]];const{offset:t,source:n}=e;return[t,t+("string"==typeof n?n.length:1)]}function Ha(e){let t="",n=!1,i=!1;for(let r=0;r<e.length;++r){const s=e[r];switch(s[0]){case"#":t+=(""===t?"":i?"\n\n":"\n")+(s.substring(1)||" "),n=!0,i=!1;break;case"%":"#"!==e[r+1]?.[0]&&(r+=1),n=!1;break;default:n||(i=!0),n=!1}}return{comment:t,afterEmptyLine:i}}class Wa{constructor(e={}){this.doc=null,this.atDirectives=!1,this.prelude=[],this.errors=[],this.warnings=[],this.onError=(e,t,n,i)=>{const r=qa(e);i?this.warnings.push(new Sa(r,t,n)):this.errors.push(new ka(r,t,n))},this.directives=new Ir({version:e.version||"1.2"}),this.options=e}decorate(e,t){const{comment:n,afterEmptyLine:i}=Ha(this.prelude);if(n){const r=e.contents;if(t)e.comment=e.comment?`${e.comment}\n${n}`:n;else if(i||e.directives.docStart||!r)e.commentBefore=n;else if(dr(r)&&!r.flow&&r.items.length>0){let e=r.items[0];cr(e)&&(e=e.key);const t=e.commentBefore;e.commentBefore=t?`${n}\n${t}`:n}else{const e=r.commentBefore;r.commentBefore=e?`${n}\n${e}`:n}}t?(Array.prototype.push.apply(e.errors,this.errors),Array.prototype.push.apply(e.warnings,this.warnings)):(e.errors=this.errors,e.warnings=this.warnings),this.prelude=[],this.errors=[],this.warnings=[]}streamInfo(){return{comment:Ha(this.prelude).comment,directives:this.directives,errors:this.errors,warnings:this.warnings}}*compose(e,t=!1,n=-1){for(const t of e)yield*this.next(t);yield*this.end(t,n)}*next(e){switch(e.type){case"directive":this.directives.add(e.source,(t,n,i)=>{const r=qa(e);r[0]+=t,this.onError(r,"BAD_DIRECTIVE",n,i)}),this.prelude.push(e.source),this.atDirectives=!0;break;case"document":{const t=function(e,t,{offset:n,start:i,value:r,end:s},a){const o=Object.assign({_directives:t},e),c=new ba(void 0,o),l={atKey:!1,atRoot:!0,directives:c.directives,options:c.options,schema:c.schema},u=Ia(i,{indicator:"doc-start",next:r??s?.[0],offset:n,onError:a,parentIndent:0,startOnNewline:!0});u.found&&(c.directives.docStart=!0,!r||"block-map"!==r.type&&"block-seq"!==r.type||u.hasNewline||a(u.end,"MISSING_CHAR","Block collection cannot start on same line with directives-end marker")),c.contents=r?Va(l,r,u,a):Za(l,u.end,i,null,u,a);const d=c.contents.range[2],p=Na(s,d,!1,a);return p.comment&&(c.comment=p.comment),c.range=[n,d,p.offset],c}(this.options,this.directives,e,this.onError);this.atDirectives&&!t.directives.docStart&&this.onError(e,"MISSING_CHAR","Missing directives-end/doc-start indicator line"),this.decorate(t,!1),this.doc&&(yield this.doc),this.doc=t,this.atDirectives=!1;break}case"byte-order-mark":case"space":break;case"comment":case"newline":this.prelude.push(e.source);break;case"error":{const t=e.source?`${e.message}: ${JSON.stringify(e.source)}`:e.message,n=new ka(qa(e),"UNEXPECTED_TOKEN",t);this.atDirectives||!this.doc?this.errors.push(n):this.doc.errors.push(n);break}case"doc-end":{if(!this.doc){const t="Unexpected doc-end without preceding document";this.errors.push(new ka(qa(e),"UNEXPECTED_TOKEN",t));break}this.doc.directives.docEnd=!0;const t=Na(e.end,e.offset+e.source.length,this.doc.options.strict,this.onError);if(this.decorate(this.doc,!0),t.comment){const e=this.doc.comment;this.doc.comment=e?`${e}\n${t.comment}`:t.comment}this.doc.range[2]=t.offset;break}default:this.errors.push(new ka(qa(e),"UNEXPECTED_TOKEN",`Unsupported token ${e.type}`))}}*end(e=!1,t=-1){if(this.doc)this.decorate(this.doc,!0),yield this.doc,this.doc=null;else if(e){const e=Object.assign({_directives:this.directives},this.options),n=new ba(void 0,e);this.atDirectives&&this.onError(t,"MISSING_CHAR","Missing directives-end indicator line"),n.range=[0,t,t],this.decorate(n,!1),yield n}}}function Ja(e,t=!0,n){if(e){const i=(e,t,i)=>{const r="number"==typeof e?e:Array.isArray(e)?e[0]:e.offset;if(!n)throw new ka([r,r+1],t,i);n(r,t,i)};switch(e.type){case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":return ja(e,t,i);case"block-scalar":return Ra({options:{strict:t}},e,i)}}return null}function Ka(e,t){const{implicitKey:n=!1,indent:i,inFlow:r=!1,offset:s=-1,type:a="PLAIN"}=t,o=ns({type:a,value:e},{implicitKey:n,indent:i>0?" ".repeat(i):"",inFlow:r,options:{blockQuote:!0,lineWidth:-1}}),c=t.end??[{type:"newline",offset:-1,indent:i,source:"\n"}];switch(o[0]){case"|":case">":{const e=o.indexOf("\n"),t=o.substring(0,e),n=o.substring(e+1)+"\n",r=[{type:"block-scalar-header",offset:s,indent:i,source:t}];return Xa(r,c)||r.push({type:"newline",offset:-1,indent:i,source:"\n"}),{type:"block-scalar",offset:s,indent:i,props:r,source:n}}case'"':return{type:"double-quoted-scalar",offset:s,indent:i,source:o,end:c};case"'":return{type:"single-quoted-scalar",offset:s,indent:i,source:o,end:c};default:return{type:"scalar",offset:s,indent:i,source:o,end:c}}}function Ya(e,t,n={}){let{afterKey:i=!1,implicitKey:r=!1,inFlow:s=!1,type:a}=n,o="indent"in e?e.indent:null;if(i&&"number"==typeof o&&(o+=2),!a)switch(e.type){case"single-quoted-scalar":a="QUOTE_SINGLE";break;case"double-quoted-scalar":a="QUOTE_DOUBLE";break;case"block-scalar":{const t=e.props[0];if("block-scalar-header"!==t.type)throw new Error("Invalid block scalar header");a=">"===t.source[0]?"BLOCK_FOLDED":"BLOCK_LITERAL";break}default:a="PLAIN"}const c=ns({type:a,value:t},{implicitKey:r||null===o,indent:null!==o&&o>0?" ".repeat(o):"",inFlow:s,options:{blockQuote:!0,lineWidth:-1}});switch(c[0]){case"|":case">":!function(e,t){const n=t.indexOf("\n"),i=t.substring(0,n),r=t.substring(n+1)+"\n";if("block-scalar"===e.type){const t=e.props[0];if("block-scalar-header"!==t.type)throw new Error("Invalid block scalar header");t.source=i,e.source=r}else{const{offset:t}=e,n="indent"in e?e.indent:-1,s=[{type:"block-scalar-header",offset:t,indent:n,source:i}];Xa(s,"end"in e?e.end:void 0)||s.push({type:"newline",offset:-1,indent:n,source:"\n"});for(const t of Object.keys(e))"type"!==t&&"offset"!==t&&delete e[t];Object.assign(e,{type:"block-scalar",indent:n,props:s,source:r})}}(e,c);break;case'"':Qa(e,c,"double-quoted-scalar");break;case"'":Qa(e,c,"single-quoted-scalar");break;default:Qa(e,c,"scalar")}}function Xa(e,t){if(t)for(const n of t)switch(n.type){case"space":case"comment":e.push(n);break;case"newline":return e.push(n),!0}return!1}function Qa(e,t,n){switch(e.type){case"scalar":case"double-quoted-scalar":case"single-quoted-scalar":e.type=n,e.source=t;break;case"block-scalar":{const i=e.props.slice(1);let r=t.length;"block-scalar-header"===e.props[0].type&&(r-=e.props[0].source.length);for(const e of i)e.offset+=r;delete e.props,Object.assign(e,{type:n,source:t,end:i});break}case"block-map":case"block-seq":{const i={type:"newline",offset:e.offset+t.length,indent:e.indent,source:"\n"};delete e.items,Object.assign(e,{type:n,source:t,end:[i]});break}default:{const i="indent"in e?e.indent:-1,r="end"in e&&Array.isArray(e.end)?e.end.filter(e=>"space"===e.type||"comment"===e.type||"newline"===e.type):[];for(const t of Object.keys(e))"type"!==t&&"offset"!==t&&delete e[t];Object.assign(e,{type:n,indent:i,source:t,end:r})}}}const eo=e=>"type"in e?to(e):no(e);function to(e){switch(e.type){case"block-scalar":{let t="";for(const n of e.props)t+=to(n);return t+e.source}case"block-map":case"block-seq":{let t="";for(const n of e.items)t+=no(n);return t}case"flow-collection":{let t=e.start.source;for(const n of e.items)t+=no(n);for(const n of e.end)t+=n.source;return t}case"document":{let t=no(e);if(e.end)for(const n of e.end)t+=n.source;return t}default:{let t=e.source;if("end"in e&&e.end)for(const n of e.end)t+=n.source;return t}}}function no({start:e,key:t,sep:n,value:i}){let r="";for(const t of e)r+=t.source;if(t&&(r+=to(t)),n)for(const e of n)r+=e.source;return i&&(r+=to(i)),r}const io=Symbol("break visit"),ro=Symbol("skip children"),so=Symbol("remove item");function ao(e,t){"type"in e&&"document"===e.type&&(e={start:e.start,value:e.value}),oo(Object.freeze([]),e,t)}function oo(e,t,n){let i=n(t,e);if("symbol"==typeof i)return i;for(const r of["key","value"]){const s=t[r];if(s&&"items"in s){for(let t=0;t<s.items.length;++t){const i=oo(Object.freeze(e.concat([[r,t]])),s.items[t],n);if("number"==typeof i)t=i-1;else{if(i===io)return io;i===so&&(s.items.splice(t,1),t-=1)}}"function"==typeof i&&"key"===r&&(i=i(t,e))}}return"function"==typeof i?i(t,e):i}ao.BREAK=io,ao.SKIP=ro,ao.REMOVE=so,ao.itemAtPath=(e,t)=>{let n=e;for(const[e,i]of t){const t=n?.[e];if(!t||!("items"in t))return;n=t.items[i]}return n},ao.parentCollection=(e,t)=>{const n=ao.itemAtPath(e,t.slice(0,-1)),i=t[t.length-1][0],r=n?.[i];if(r&&"items"in r)return r;throw new Error("Parent collection not found")};const co="\ufeff",lo="",uo="",po="",ho=e=>!!e&&"items"in e,fo=e=>!!e&&("scalar"===e.type||"single-quoted-scalar"===e.type||"double-quoted-scalar"===e.type||"block-scalar"===e.type);function mo(e){switch(e){case co:return"<BOM>";case lo:return"<DOC>";case uo:return"<FLOW_END>";case po:return"<SCALAR>";default:return JSON.stringify(e)}}function go(e){switch(e){case co:return"byte-order-mark";case lo:return"doc-mode";case uo:return"flow-error-end";case po:return"scalar";case"---":return"doc-start";case"...":return"doc-end";case"":case"\n":case"\r\n":return"newline";case"-":return"seq-item-ind";case"?":return"explicit-key-ind";case":":return"map-value-ind";case"{":return"flow-map-start";case"}":return"flow-map-end";case"[":return"flow-seq-start";case"]":return"flow-seq-end";case",":return"comma"}switch(e[0]){case" ":case"\t":return"space";case"#":return"comment";case"%":return"directive-line";case"*":return"alias";case"&":return"anchor";case"!":return"tag";case"'":return"single-quoted-scalar";case'"':return"double-quoted-scalar";case"|":case">":return"block-scalar-header"}return null}function vo(e){switch(e){case void 0:case" ":case"\n":case"\r":case"\t":return!0;default:return!1}}const yo=new Set("0123456789ABCDEFabcdef"),_o=new Set("0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-#;/?:@&=+$_.!~*'()"),bo=new Set(",[]{}"),wo=new Set(" ,[]{}\n\r\t"),$o=e=>!e||wo.has(e);class ko{constructor(){this.atEnd=!1,this.blockScalarIndent=-1,this.blockScalarKeep=!1,this.buffer="",this.flowKey=!1,this.flowLevel=0,this.indentNext=0,this.indentValue=0,this.lineEndPos=null,this.next=null,this.pos=0}*lex(e,t=!1){if(e){if("string"!=typeof e)throw TypeError("source is not a string");this.buffer=this.buffer?this.buffer+e:e,this.lineEndPos=null}this.atEnd=!t;let n=this.next??"stream";for(;n&&(t||this.hasChars(1));)n=yield*this.parseNext(n)}atLineEnd(){let e=this.pos,t=this.buffer[e];for(;" "===t||"\t"===t;)t=this.buffer[++e];return!t||"#"===t||"\n"===t||"\r"===t&&"\n"===this.buffer[e+1]}charAt(e){return this.buffer[this.pos+e]}continueScalar(e){let t=this.buffer[e];if(this.indentNext>0){let n=0;for(;" "===t;)t=this.buffer[++n+e];if("\r"===t){const t=this.buffer[n+e+1];if("\n"===t||!t&&!this.atEnd)return e+n+1}return"\n"===t||n>=this.indentNext||!t&&!this.atEnd?e+n:-1}if("-"===t||"."===t){const t=this.buffer.substr(e,3);if(("---"===t||"..."===t)&&vo(this.buffer[e+3]))return-1}return e}getLine(){let e=this.lineEndPos;return("number"!=typeof e||-1!==e&&e<this.pos)&&(e=this.buffer.indexOf("\n",this.pos),this.lineEndPos=e),-1===e?this.atEnd?this.buffer.substring(this.pos):null:("\r"===this.buffer[e-1]&&(e-=1),this.buffer.substring(this.pos,e))}hasChars(e){return this.pos+e<=this.buffer.length}setNext(e){return this.buffer=this.buffer.substring(this.pos),this.pos=0,this.lineEndPos=null,this.next=e,null}peek(e){return this.buffer.substr(this.pos,e)}*parseNext(e){switch(e){case"stream":return yield*this.parseStream();case"line-start":return yield*this.parseLineStart();case"block-start":return yield*this.parseBlockStart();case"doc":return yield*this.parseDocument();case"flow":return yield*this.parseFlowCollection();case"quoted-scalar":return yield*this.parseQuotedScalar();case"block-scalar":return yield*this.parseBlockScalar();case"plain-scalar":return yield*this.parsePlainScalar()}}*parseStream(){let e=this.getLine();if(null===e)return this.setNext("stream");if(e[0]===co&&(yield*this.pushCount(1),e=e.substring(1)),"%"===e[0]){let t=e.length,n=e.indexOf("#");for(;-1!==n;){const i=e[n-1];if(" "===i||"\t"===i){t=n-1;break}n=e.indexOf("#",n+1)}for(;;){const n=e[t-1];if(" "!==n&&"\t"!==n)break;t-=1}const i=(yield*this.pushCount(t))+(yield*this.pushSpaces(!0));return yield*this.pushCount(e.length-i),this.pushNewline(),"stream"}if(this.atLineEnd()){const t=yield*this.pushSpaces(!0);return yield*this.pushCount(e.length-t),yield*this.pushNewline(),"stream"}return yield lo,yield*this.parseLineStart()}*parseLineStart(){const e=this.charAt(0);if(!e&&!this.atEnd)return this.setNext("line-start");if("-"===e||"."===e){if(!this.atEnd&&!this.hasChars(4))return this.setNext("line-start");const e=this.peek(3);if(("---"===e||"..."===e)&&vo(this.charAt(3)))return yield*this.pushCount(3),this.indentValue=0,this.indentNext=0,"---"===e?"doc":"stream"}return this.indentValue=yield*this.pushSpaces(!1),this.indentNext>this.indentValue&&!vo(this.charAt(1))&&(this.indentNext=this.indentValue),yield*this.parseBlockStart()}*parseBlockStart(){const[e,t]=this.peek(2);if(!t&&!this.atEnd)return this.setNext("block-start");if(("-"===e||"?"===e||":"===e)&&vo(t)){const e=(yield*this.pushCount(1))+(yield*this.pushSpaces(!0));return this.indentNext=this.indentValue+1,this.indentValue+=e,yield*this.parseBlockStart()}return"doc"}*parseDocument(){yield*this.pushSpaces(!0);const e=this.getLine();if(null===e)return this.setNext("doc");let t=yield*this.pushIndicators();switch(e[t]){case"#":yield*this.pushCount(e.length-t);case void 0:return yield*this.pushNewline(),yield*this.parseLineStart();case"{":case"[":return yield*this.pushCount(1),this.flowKey=!1,this.flowLevel=1,"flow";case"}":case"]":return yield*this.pushCount(1),"doc";case"*":return yield*this.pushUntil($o),"doc";case'"':case"'":return yield*this.parseQuotedScalar();case"|":case">":return t+=(yield*this.parseBlockScalarHeader()),t+=(yield*this.pushSpaces(!0)),yield*this.pushCount(e.length-t),yield*this.pushNewline(),yield*this.parseBlockScalar();default:return yield*this.parsePlainScalar()}}*parseFlowCollection(){let e,t,n=-1;do{e=yield*this.pushNewline(),e>0?(t=yield*this.pushSpaces(!1),this.indentValue=n=t):t=0,t+=(yield*this.pushSpaces(!0))}while(e+t>0);const i=this.getLine();if(null===i)return this.setNext("flow");if(-1!==n&&n<this.indentNext&&"#"!==i[0]||0===n&&(i.startsWith("---")||i.startsWith("..."))&&vo(i[3])){if(!(n===this.indentNext-1&&1===this.flowLevel&&("]"===i[0]||"}"===i[0])))return this.flowLevel=0,yield uo,yield*this.parseLineStart()}let r=0;for(;","===i[r];)r+=(yield*this.pushCount(1)),r+=(yield*this.pushSpaces(!0)),this.flowKey=!1;switch(r+=(yield*this.pushIndicators()),i[r]){case void 0:return"flow";case"#":return yield*this.pushCount(i.length-r),"flow";case"{":case"[":return yield*this.pushCount(1),this.flowKey=!1,this.flowLevel+=1,"flow";case"}":case"]":return yield*this.pushCount(1),this.flowKey=!0,this.flowLevel-=1,this.flowLevel?"flow":"doc";case"*":return yield*this.pushUntil($o),"flow";case'"':case"'":return this.flowKey=!0,yield*this.parseQuotedScalar();case":":{const e=this.charAt(1);if(this.flowKey||vo(e)||","===e)return this.flowKey=!1,yield*this.pushCount(1),yield*this.pushSpaces(!0),"flow"}default:return this.flowKey=!1,yield*this.parsePlainScalar()}}*parseQuotedScalar(){const e=this.charAt(0);let t=this.buffer.indexOf(e,this.pos+1);if("'"===e)for(;-1!==t&&"'"===this.buffer[t+1];)t=this.buffer.indexOf("'",t+2);else for(;-1!==t;){let e=0;for(;"\\"===this.buffer[t-1-e];)e+=1;if(e%2==0)break;t=this.buffer.indexOf('"',t+1)}const n=this.buffer.substring(0,t);let i=n.indexOf("\n",this.pos);if(-1!==i){for(;-1!==i;){const e=this.continueScalar(i+1);if(-1===e)break;i=n.indexOf("\n",e)}-1!==i&&(t=i-("\r"===n[i-1]?2:1))}if(-1===t){if(!this.atEnd)return this.setNext("quoted-scalar");t=this.buffer.length}return yield*this.pushToIndex(t+1,!1),this.flowLevel?"flow":"doc"}*parseBlockScalarHeader(){this.blockScalarIndent=-1,this.blockScalarKeep=!1;let e=this.pos;for(;;){const t=this.buffer[++e];if("+"===t)this.blockScalarKeep=!0;else if(t>"0"&&t<="9")this.blockScalarIndent=Number(t)-1;else if("-"!==t)break}return yield*this.pushUntil(e=>vo(e)||"#"===e)}*parseBlockScalar(){let e,t=this.pos-1,n=0;e:for(let i=this.pos;e=this.buffer[i];++i)switch(e){case" ":n+=1;break;case"\n":t=i,n=0;break;case"\r":{const e=this.buffer[i+1];if(!e&&!this.atEnd)return this.setNext("block-scalar");if("\n"===e)break}default:break e}if(!e&&!this.atEnd)return this.setNext("block-scalar");if(n>=this.indentNext){-1===this.blockScalarIndent?this.indentNext=n:this.indentNext=this.blockScalarIndent+(0===this.indentNext?1:this.indentNext);do{const e=this.continueScalar(t+1);if(-1===e)break;t=this.buffer.indexOf("\n",e)}while(-1!==t);if(-1===t){if(!this.atEnd)return this.setNext("block-scalar");t=this.buffer.length}}let i=t+1;for(e=this.buffer[i];" "===e;)e=this.buffer[++i];if("\t"===e){for(;"\t"===e||" "===e||"\r"===e||"\n"===e;)e=this.buffer[++i];t=i-1}else if(!this.blockScalarKeep)for(;;){let e=t-1,i=this.buffer[e];"\r"===i&&(i=this.buffer[--e]);const r=e;for(;" "===i;)i=this.buffer[--e];if(!("\n"===i&&e>=this.pos&&e+1+n>r))break;t=e}return yield po,yield*this.pushToIndex(t+1,!0),yield*this.parseLineStart()}*parsePlainScalar(){const e=this.flowLevel>0;let t,n=this.pos-1,i=this.pos-1;for(;t=this.buffer[++i];)if(":"===t){const t=this.buffer[i+1];if(vo(t)||e&&bo.has(t))break;n=i}else if(vo(t)){let r=this.buffer[i+1];if("\r"===t&&("\n"===r?(i+=1,t="\n",r=this.buffer[i+1]):n=i),"#"===r||e&&bo.has(r))break;if("\n"===t){const e=this.continueScalar(i+1);if(-1===e)break;i=Math.max(i,e-2)}}else{if(e&&bo.has(t))break;n=i}return t||this.atEnd?(yield po,yield*this.pushToIndex(n+1,!0),e?"flow":"doc"):this.setNext("plain-scalar")}*pushCount(e){return e>0?(yield this.buffer.substr(this.pos,e),this.pos+=e,e):0}*pushToIndex(e,t){const n=this.buffer.slice(this.pos,e);return n?(yield n,this.pos+=n.length,n.length):(t&&(yield""),0)}*pushIndicators(){switch(this.charAt(0)){case"!":return(yield*this.pushTag())+(yield*this.pushSpaces(!0))+(yield*this.pushIndicators());case"&":return(yield*this.pushUntil($o))+(yield*this.pushSpaces(!0))+(yield*this.pushIndicators());case"-":case"?":case":":{const e=this.flowLevel>0,t=this.charAt(1);if(vo(t)||e&&bo.has(t))return e?this.flowKey&&(this.flowKey=!1):this.indentNext=this.indentValue+1,(yield*this.pushCount(1))+(yield*this.pushSpaces(!0))+(yield*this.pushIndicators())}}return 0}*pushTag(){if("<"===this.charAt(1)){let e=this.pos+2,t=this.buffer[e];for(;!vo(t)&&">"!==t;)t=this.buffer[++e];return yield*this.pushToIndex(">"===t?e+1:e,!1)}{let e=this.pos+1,t=this.buffer[e];for(;t;)if(_o.has(t))t=this.buffer[++e];else{if("%"!==t||!yo.has(this.buffer[e+1])||!yo.has(this.buffer[e+2]))break;t=this.buffer[e+=3]}return yield*this.pushToIndex(e,!1)}}*pushNewline(){const e=this.buffer[this.pos];return"\n"===e?yield*this.pushCount(1):"\r"===e&&"\n"===this.charAt(1)?yield*this.pushCount(2):0}*pushSpaces(e){let t,n=this.pos-1;do{t=this.buffer[++n]}while(" "===t||e&&"\t"===t);const i=n-this.pos;return i>0&&(yield this.buffer.substr(this.pos,i),this.pos=n),i}*pushUntil(e){let t=this.pos,n=this.buffer[t];for(;!e(n);)n=this.buffer[++t];return yield*this.pushToIndex(t,!1)}}class So{constructor(){this.lineStarts=[],this.addNewLine=e=>this.lineStarts.push(e),this.linePos=e=>{let t=0,n=this.lineStarts.length;for(;t<n;){const i=t+n>>1;this.lineStarts[i]<e?t=i+1:n=i}if(this.lineStarts[t]===e)return{line:t+1,col:1};if(0===t)return{line:0,col:e};return{line:t,col:e-this.lineStarts[t-1]+1}}}}function Eo(e,t){for(let n=0;n<e.length;++n)if(e[n].type===t)return!0;return!1}function Io(e){for(let t=0;t<e.length;++t)switch(e[t].type){case"space":case"comment":case"newline":break;default:return t}return-1}function xo(e){switch(e?.type){case"alias":case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":case"flow-collection":return!0;default:return!1}}function To(e){switch(e.type){case"document":return e.start;case"block-map":{const t=e.items[e.items.length-1];return t.sep??t.start}case"block-seq":return e.items[e.items.length-1].start;default:return[]}}function Oo(e){if(0===e.length)return[];let t=e.length;e:for(;--t>=0;)switch(e[t].type){case"doc-start":case"explicit-key-ind":case"map-value-ind":case"seq-item-ind":case"newline":break e}for(;"space"===e[++t]?.type;);return e.splice(t,e.length)}function Ao(e){if("flow-seq-start"===e.start.type)for(const t of e.items)!t.sep||t.value||Eo(t.start,"explicit-key-ind")||Eo(t.sep,"map-value-ind")||(t.key&&(t.value=t.key),delete t.key,xo(t.value)?t.value.end?Array.prototype.push.apply(t.value.end,t.sep):t.value.end=t.sep:Array.prototype.push.apply(t.start,t.sep),delete t.sep)}class No{constructor(e){this.atNewLine=!0,this.atScalar=!1,this.indent=0,this.offset=0,this.onKeyLine=!1,this.stack=[],this.source="",this.type="",this.lexer=new ko,this.onNewLine=e}*parse(e,t=!1){this.onNewLine&&0===this.offset&&this.onNewLine(0);for(const n of this.lexer.lex(e,t))yield*this.next(n);t||(yield*this.end())}*next(e){if(this.source=e,this.atScalar)return this.atScalar=!1,yield*this.step(),void(this.offset+=e.length);const t=go(e);if(t)if("scalar"===t)this.atNewLine=!1,this.atScalar=!0,this.type="scalar";else{switch(this.type=t,yield*this.step(),t){case"newline":this.atNewLine=!0,this.indent=0,this.onNewLine&&this.onNewLine(this.offset+e.length);break;case"space":this.atNewLine&&" "===e[0]&&(this.indent+=e.length);break;case"explicit-key-ind":case"map-value-ind":case"seq-item-ind":this.atNewLine&&(this.indent+=e.length);break;case"doc-mode":case"flow-error-end":return;default:this.atNewLine=!1}this.offset+=e.length}else{const t=`Not a YAML token: ${e}`;yield*this.pop({type:"error",offset:this.offset,message:t,source:e}),this.offset+=e.length}}*end(){for(;this.stack.length>0;)yield*this.pop()}get sourceToken(){return{type:this.type,offset:this.offset,indent:this.indent,source:this.source}}*step(){const e=this.peek(1);if("doc-end"!==this.type||e&&"doc-end"===e.type){if(!e)return yield*this.stream();switch(e.type){case"document":return yield*this.document(e);case"alias":case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":return yield*this.scalar(e);case"block-scalar":return yield*this.blockScalar(e);case"block-map":return yield*this.blockMap(e);case"block-seq":return yield*this.blockSequence(e);case"flow-collection":return yield*this.flowCollection(e);case"doc-end":return yield*this.documentEnd(e)}yield*this.pop()}else{for(;this.stack.length>0;)yield*this.pop();this.stack.push({type:"doc-end",offset:this.offset,source:this.source})}}peek(e){return this.stack[this.stack.length-e]}*pop(e){const t=e??this.stack.pop();if(t)if(0===this.stack.length)yield t;else{const e=this.peek(1);switch("block-scalar"===t.type?t.indent="indent"in e?e.indent:0:"flow-collection"===t.type&&"document"===e.type&&(t.indent=0),"flow-collection"===t.type&&Ao(t),e.type){case"document":e.value=t;break;case"block-scalar":e.props.push(t);break;case"block-map":{const n=e.items[e.items.length-1];if(n.value)return e.items.push({start:[],key:t,sep:[]}),void(this.onKeyLine=!0);if(!n.sep)return Object.assign(n,{key:t,sep:[]}),void(this.onKeyLine=!n.explicitKey);n.value=t;break}case"block-seq":{const n=e.items[e.items.length-1];n.value?e.items.push({start:[],value:t}):n.value=t;break}case"flow-collection":{const n=e.items[e.items.length-1];return void(!n||n.value?e.items.push({start:[],key:t,sep:[]}):n.sep?n.value=t:Object.assign(n,{key:t,sep:[]}))}default:yield*this.pop(),yield*this.pop(t)}if(!("document"!==e.type&&"block-map"!==e.type&&"block-seq"!==e.type||"block-map"!==t.type&&"block-seq"!==t.type)){const n=t.items[t.items.length-1];n&&!n.sep&&!n.value&&n.start.length>0&&-1===Io(n.start)&&(0===t.indent||n.start.every(e=>"comment"!==e.type||e.indent<t.indent))&&("document"===e.type?e.end=n.start:e.items.push({start:n.start}),t.items.splice(-1,1))}}else{const e="Tried to pop an empty stack";yield{type:"error",offset:this.offset,source:"",message:e}}}*stream(){switch(this.type){case"directive-line":return void(yield{type:"directive",offset:this.offset,source:this.source});case"byte-order-mark":case"space":case"comment":case"newline":return void(yield this.sourceToken);case"doc-mode":case"doc-start":{const e={type:"document",offset:this.offset,start:[]};return"doc-start"===this.type&&e.start.push(this.sourceToken),void this.stack.push(e)}}yield{type:"error",offset:this.offset,message:`Unexpected ${this.type} token in YAML stream`,source:this.source}}*document(e){if(e.value)return yield*this.lineEnd(e);switch(this.type){case"doc-start":return void(-1!==Io(e.start)?(yield*this.pop(),yield*this.step()):e.start.push(this.sourceToken));case"anchor":case"tag":case"space":case"comment":case"newline":return void e.start.push(this.sourceToken)}const t=this.startBlockValue(e);t?this.stack.push(t):yield{type:"error",offset:this.offset,message:`Unexpected ${this.type} token in YAML document`,source:this.source}}*scalar(e){if("map-value-ind"===this.type){const t=Oo(To(this.peek(2)));let n;e.end?(n=e.end,n.push(this.sourceToken),delete e.end):n=[this.sourceToken];const i={type:"block-map",offset:e.offset,indent:e.indent,items:[{start:t,key:e,sep:n}]};this.onKeyLine=!0,this.stack[this.stack.length-1]=i}else yield*this.lineEnd(e)}*blockScalar(e){switch(this.type){case"space":case"comment":case"newline":return void e.props.push(this.sourceToken);case"scalar":if(e.source=this.source,this.atNewLine=!0,this.indent=0,this.onNewLine){let e=this.source.indexOf("\n")+1;for(;0!==e;)this.onNewLine(this.offset+e),e=this.source.indexOf("\n",e)+1}yield*this.pop();break;default:yield*this.pop(),yield*this.step()}}*blockMap(e){const t=e.items[e.items.length-1];switch(this.type){case"newline":if(this.onKeyLine=!1,t.value){const n="end"in t.value?t.value.end:void 0,i=Array.isArray(n)?n[n.length-1]:void 0;"comment"===i?.type?n?.push(this.sourceToken):e.items.push({start:[this.sourceToken]})}else t.sep?t.sep.push(this.sourceToken):t.start.push(this.sourceToken);return;case"space":case"comment":if(t.value)e.items.push({start:[this.sourceToken]});else if(t.sep)t.sep.push(this.sourceToken);else{if(this.atIndentedComment(t.start,e.indent)){const n=e.items[e.items.length-2],i=n?.value?.end;if(Array.isArray(i))return Array.prototype.push.apply(i,t.start),i.push(this.sourceToken),void e.items.pop()}t.start.push(this.sourceToken)}return}if(this.indent>=e.indent){const n=!this.onKeyLine&&this.indent===e.indent,i=n&&(t.sep||t.explicitKey)&&"seq-item-ind"!==this.type;let r=[];if(i&&t.sep&&!t.value){const n=[];for(let i=0;i<t.sep.length;++i){const r=t.sep[i];switch(r.type){case"newline":n.push(i);break;case"space":break;case"comment":r.indent>e.indent&&(n.length=0);break;default:n.length=0}}n.length>=2&&(r=t.sep.splice(n[1]))}switch(this.type){case"anchor":case"tag":return void(i||t.value?(r.push(this.sourceToken),e.items.push({start:r}),this.onKeyLine=!0):t.sep?t.sep.push(this.sourceToken):t.start.push(this.sourceToken));case"explicit-key-ind":return t.sep||t.explicitKey?i||t.value?(r.push(this.sourceToken),e.items.push({start:r,explicitKey:!0})):this.stack.push({type:"block-map",offset:this.offset,indent:this.indent,items:[{start:[this.sourceToken],explicitKey:!0}]}):(t.start.push(this.sourceToken),t.explicitKey=!0),void(this.onKeyLine=!0);case"map-value-ind":if(t.explicitKey)if(t.sep)if(t.value)e.items.push({start:[],key:null,sep:[this.sourceToken]});else if(Eo(t.sep,"map-value-ind"))this.stack.push({type:"block-map",offset:this.offset,indent:this.indent,items:[{start:r,key:null,sep:[this.sourceToken]}]});else if(xo(t.key)&&!Eo(t.sep,"newline")){const e=Oo(t.start),n=t.key,i=t.sep;i.push(this.sourceToken),delete t.key,delete t.sep,this.stack.push({type:"block-map",offset:this.offset,indent:this.indent,items:[{start:e,key:n,sep:i}]})}else r.length>0?t.sep=t.sep.concat(r,this.sourceToken):t.sep.push(this.sourceToken);else if(Eo(t.start,"newline"))Object.assign(t,{key:null,sep:[this.sourceToken]});else{const e=Oo(t.start);this.stack.push({type:"block-map",offset:this.offset,indent:this.indent,items:[{start:e,key:null,sep:[this.sourceToken]}]})}else t.sep?t.value||i?e.items.push({start:r,key:null,sep:[this.sourceToken]}):Eo(t.sep,"map-value-ind")?this.stack.push({type:"block-map",offset:this.offset,indent:this.indent,items:[{start:[],key:null,sep:[this.sourceToken]}]}):t.sep.push(this.sourceToken):Object.assign(t,{key:null,sep:[this.sourceToken]});return void(this.onKeyLine=!0);case"alias":case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":{const n=this.flowScalar(this.type);return void(i||t.value?(e.items.push({start:r,key:n,sep:[]}),this.onKeyLine=!0):t.sep?this.stack.push(n):(Object.assign(t,{key:n,sep:[]}),this.onKeyLine=!0))}default:{const i=this.startBlockValue(e);if(i){if("block-seq"===i.type){if(!t.explicitKey&&t.sep&&!Eo(t.sep,"newline"))return void(yield*this.pop({type:"error",offset:this.offset,message:"Unexpected block-seq-ind on same line with key",source:this.source}))}else n&&e.items.push({start:r});return void this.stack.push(i)}}}}yield*this.pop(),yield*this.step()}*blockSequence(e){const t=e.items[e.items.length-1];switch(this.type){case"newline":if(t.value){const n="end"in t.value?t.value.end:void 0,i=Array.isArray(n)?n[n.length-1]:void 0;"comment"===i?.type?n?.push(this.sourceToken):e.items.push({start:[this.sourceToken]})}else t.start.push(this.sourceToken);return;case"space":case"comment":if(t.value)e.items.push({start:[this.sourceToken]});else{if(this.atIndentedComment(t.start,e.indent)){const n=e.items[e.items.length-2],i=n?.value?.end;if(Array.isArray(i))return Array.prototype.push.apply(i,t.start),i.push(this.sourceToken),void e.items.pop()}t.start.push(this.sourceToken)}return;case"anchor":case"tag":if(t.value||this.indent<=e.indent)break;return void t.start.push(this.sourceToken);case"seq-item-ind":if(this.indent!==e.indent)break;return void(t.value||Eo(t.start,"seq-item-ind")?e.items.push({start:[this.sourceToken]}):t.start.push(this.sourceToken))}if(this.indent>e.indent){const t=this.startBlockValue(e);if(t)return void this.stack.push(t)}yield*this.pop(),yield*this.step()}*flowCollection(e){const t=e.items[e.items.length-1];if("flow-error-end"===this.type){let e;do{yield*this.pop(),e=this.peek(1)}while(e&&"flow-collection"===e.type)}else if(0===e.end.length){switch(this.type){case"comma":case"explicit-key-ind":return void(!t||t.sep?e.items.push({start:[this.sourceToken]}):t.start.push(this.sourceToken));case"map-value-ind":return void(!t||t.value?e.items.push({start:[],key:null,sep:[this.sourceToken]}):t.sep?t.sep.push(this.sourceToken):Object.assign(t,{key:null,sep:[this.sourceToken]}));case"space":case"comment":case"newline":case"anchor":case"tag":return void(!t||t.value?e.items.push({start:[this.sourceToken]}):t.sep?t.sep.push(this.sourceToken):t.start.push(this.sourceToken));case"alias":case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":{const n=this.flowScalar(this.type);return void(!t||t.value?e.items.push({start:[],key:n,sep:[]}):t.sep?this.stack.push(n):Object.assign(t,{key:n,sep:[]}))}case"flow-map-end":case"flow-seq-end":return void e.end.push(this.sourceToken)}const n=this.startBlockValue(e);n?this.stack.push(n):(yield*this.pop(),yield*this.step())}else{const t=this.peek(2);if("block-map"===t.type&&("map-value-ind"===this.type&&t.indent===e.indent||"newline"===this.type&&!t.items[t.items.length-1].sep))yield*this.pop(),yield*this.step();else if("map-value-ind"===this.type&&"flow-collection"!==t.type){const n=Oo(To(t));Ao(e);const i=e.end.splice(1,e.end.length);i.push(this.sourceToken);const r={type:"block-map",offset:e.offset,indent:e.indent,items:[{start:n,key:e,sep:i}]};this.onKeyLine=!0,this.stack[this.stack.length-1]=r}else yield*this.lineEnd(e)}}flowScalar(e){if(this.onNewLine){let e=this.source.indexOf("\n")+1;for(;0!==e;)this.onNewLine(this.offset+e),e=this.source.indexOf("\n",e)+1}return{type:e,offset:this.offset,indent:this.indent,source:this.source}}startBlockValue(e){switch(this.type){case"alias":case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":return this.flowScalar(this.type);case"block-scalar-header":return{type:"block-scalar",offset:this.offset,indent:this.indent,props:[this.sourceToken],source:""};case"flow-map-start":case"flow-seq-start":return{type:"flow-collection",offset:this.offset,indent:this.indent,start:this.sourceToken,items:[],end:[]};case"seq-item-ind":return{type:"block-seq",offset:this.offset,indent:this.indent,items:[{start:[this.sourceToken]}]};case"explicit-key-ind":{this.onKeyLine=!0;const t=Oo(To(e));return t.push(this.sourceToken),{type:"block-map",offset:this.offset,indent:this.indent,items:[{start:t,explicitKey:!0}]}}case"map-value-ind":{this.onKeyLine=!0;const t=Oo(To(e));return{type:"block-map",offset:this.offset,indent:this.indent,items:[{start:t,key:null,sep:[this.sourceToken]}]}}}return null}atIndentedComment(e,t){return"comment"===this.type&&(!(this.indent<=t)&&e.every(e=>"newline"===e.type||"space"===e.type))}*documentEnd(e){"doc-mode"!==this.type&&(e.end?e.end.push(this.sourceToken):e.end=[this.sourceToken],"newline"===this.type&&(yield*this.pop()))}*lineEnd(e){switch(this.type){case"comma":case"doc-start":case"doc-end":case"flow-seq-end":case"flow-map-end":case"map-value-ind":yield*this.pop(),yield*this.step();break;case"newline":this.onKeyLine=!1;default:e.end?e.end.push(this.sourceToken):e.end=[this.sourceToken],"newline"===this.type&&(yield*this.pop())}}}function Co(e){const t=!1!==e.prettyErrors;return{lineCounter:e.lineCounter||t&&new So||null,prettyErrors:t}}function Do(e,t={}){const{lineCounter:n,prettyErrors:i}=Co(t),r=new No(n?.addNewLine),s=new Wa(t),a=Array.from(s.compose(r.parse(e)));if(i&&n)for(const t of a)t.errors.forEach(Ea(e,n)),t.warnings.forEach(Ea(e,n));return a.length>0?a:Object.assign([],{empty:!0},s.streamInfo())}function Lo(e,t={}){const{lineCounter:n,prettyErrors:i}=Co(t),r=new No(n?.addNewLine),s=new Wa(t);let a=null;for(const t of s.compose(r.parse(e),!0,e.length))if(a){if("silent"!==a.options.logLevel){a.errors.push(new ka(t.range.slice(0,2),"MULTIPLE_DOCS","Source contains multiple documents; please use YAML.parseAllDocuments()"));break}}else a=t;return i&&n&&(a.errors.forEach(Ea(e,n)),a.warnings.forEach(Ea(e,n))),a}function Ro(e,t,n){let i;"function"==typeof t?i=t:void 0===n&&t&&"object"==typeof t&&(n=t);const r=Lo(e,n);if(!r)return null;if(r.warnings.forEach(e=>ss(r.options.logLevel,e)),r.errors.length>0){if("silent"!==r.options.logLevel)throw r.errors[0];r.errors=[]}return r.toJS(Object.assign({reviver:i},n))}function jo(e,t,n){let i=null;if("function"==typeof t||Array.isArray(t)?i=t:void 0===n&&t&&(n=t),"string"==typeof n&&(n=n.length),"number"==typeof n){const e=Math.round(n);n=e<1?void 0:e>8?{indent:8}:{indent:e}}if(void 0===e){const{keepUndefined:e}=n??t??{};if(!e)return}return ar(e)&&!i?e.toString(n):new ba(e,i,n).toString(n)}const Po=gt;class Uo{static instance;scriptManager;buttonManager;templatePath;baseTemplate=null;defaultScriptTemplate=null;folderTemplate=null;batchModeGlobal=!1;batchModeCharacter=!1;constructor(){this.scriptManager=ji.getInstance(),this.buttonManager=new Bi,this.templatePath=`${Ot}/src/component/script_repository/public`}static getInstance(){return Uo.instance||(Uo.instance=new Uo),Uo.instance}static destroyInstance(){Uo.instance&&(Uo.instance.cleanup(),Uo.instance=void 0)}cleanup(){this.buttonManager.clearButtons(),this.baseTemplate=null,this.defaultScriptTemplate=null,this.folderTemplate=null}async initialize(){await this.initializeTemplates(),this.setupScriptRepositoryEvents(),this.registerEventListeners(),await this.renderScriptLists(),Vi(),Zi(),Li.emit(Ci.UI_LOADED)}async initializeTemplates(){this.baseTemplate=$(await Q(this.templatePath,"script_item_template",{scriptName:"",id:"",moveTo:"",faIcon:""})),this.defaultScriptTemplate=$(await Q(this.templatePath,"script_default_repository",{scriptName:"",id:""})),this.folderTemplate=$(await Q(this.templatePath,"folder_template",{folderId:"",folderName:"",folderIcon:"fa-folder",folderColor:document.documentElement.style.getPropertyValue("--SmartThemeBodyColor")}))}setupScriptRepositoryEvents(){$("#global-script-enable-toggle").prop("checked",this.scriptManager.isGlobalScriptEnabled).on("click",e=>{Li.emit(Ci.TYPE_TOGGLE,{type:ki.GLOBAL,enable:e.target.checked,userInput:!0})}),$("#character-script-enable-toggle").prop("checked",this.scriptManager.isCharacterScriptEnabled).on("click",e=>{Li.emit(Ci.TYPE_TOGGLE,{type:ki.CHARACTER,enable:e.target.checked,userInput:!0})}),$("#create-script").on("click",async()=>{await this.showCreateScriptDialog()}),$("#import-script-file").on("change",async function(){let e="global";const t=$(await Q(`${Ot}/src/component/script_repository/public`,"script_target_selector",{title:"导入到:",prefix:"script-import",globalLabel:"全局脚本",characterLabel:"局部脚本"}));t.find("#script-import-target-global").on("input",()=>e="global"),t.find("#script-import-target-character").on("input",()=>e="character");if(await ie(t,ne.CONFIRM,"",{okButton:"确认",cancelButton:"取消"})){const t=this instanceof HTMLInputElement&&this;if(t&&t.files){for(const n of t.files)Li.emit(Ci.SCRIPT_IMPORT,{file:n,type:"global"===e?ki.GLOBAL:ki.CHARACTER});t.value=""}}}),$("#import-script").on("click",function(){$("#import-script-file").trigger("click")}),$("#create-folder").on("click",()=>{this.showCreateFolderDialog()}),$("#default-script").on("click",()=>{Li.emit(Ci.UI_REFRESH,{action:"load_default_scripts"})}),$("#extensions_settings").css("min-width","0"),this.setupSearchEvents(),this.setupBatchOperationEvents()}registerEventListeners(){Li.on(Ci.UI_REFRESH,async e=>{const{action:t}=e;switch(t){case"script_toggle":await this.refreshScriptState(e.script,e.enable),this.updateParentFolderToggle(e.script.id,e.type);break;case"type_toggle":await this.refreshTypeState(e.type,e.enable);break;case"script_import":case"script_create":await this.addScriptToContainer(e.script,e.type);break;case"script_update":this.updateScriptUI(e.script,e.type);break;case"script_delete":this.removeScriptElement(e.scriptId);break;case"script_move":this.handleScriptMoved(e.script,e.fromType,e.targetType);break;case"folder_move":await this.renderScriptLists();break;case"folder_scripts_toggle":this.updateFolderAndScriptsUI(e.folderId,e.type,e.enable);break;case"load_default_scripts":await this.loadDefaultScriptsRepository();break;case"refresh_global_scripts":await this.refreshScriptList(ki.GLOBAL);break;case"refresh_charact_scripts":await this.refreshScriptList(ki.CHARACTER);break;default:Pt().warn(`[ScriptManager] 未处理的UI刷新事件: ${t}`)}}),Li.on(Ci.BUTTON_ADD,e=>{const{script:t}=e;this.addButton(t)}),Li.on(Ci.BUTTON_REMOVE,e=>{const{scriptId:t}=e;this.buttonManager.removeButtonsByScriptId(t)}),Li.on(Ci.SCRIPT_EDIT,async e=>{const{type:t,scriptId:n}=e;await this.openScriptEditor(t,n)}),Li.on(Ci.FOLDER_CREATE,async e=>{const{name:t,type:n,icon:i,color:r}=e;await this.handleFolderCreate(t,n,i,r)}),Li.on(Ci.FOLDER_EDIT,async e=>{const{folderId:t,newName:n,type:i,newIcon:r,newColor:s}=e;await this.handleFolderEdit(t,n,i,r,s)}),Li.on(Ci.FOLDER_DELETE,async e=>{const{folderId:t,type:n}=e;await this.handleFolderDelete(t,n)}),Li.on(Ci.FOLDER_SCRIPTS_TOGGLE,async e=>{const{folderId:t,type:n,enable:i}=e;await this.handleFolderScriptsToggle(t,n,i)})}addButton(e){e.buttons&&e.buttons.length>0&&this.buttonManager.addButtonsForScript(e)}async renderScriptLists(){this.clearScriptList(ki.GLOBAL),this.clearScriptList(ki.CHARACTER),await this.renderRepository(ki.GLOBAL),await this.renderRepository(ki.CHARACTER)}async renderRepository(e){const t=e===ki.GLOBAL?this.scriptManager.getGlobalRepositoryItems():this.scriptManager.getCharacterRepositoryItems();if(t.length>0)for(const n of t)"folder"===n.type?await this.renderFolder(n,e):await this.addScriptToContainer(n.value,e);else this.showEmptyScriptListTip(e);this.setupDraggable(e)}clearScriptList(e){$(Ti(e)).empty()}async refreshScriptList(e){this.clearScriptList(e),await this.renderRepository(e);const t=e===ki.GLOBAL?this.scriptManager.isGlobalScriptEnabled:this.scriptManager.isCharacterScriptEnabled,n=Ai(e);$(n).prop("checked",t)}showEmptyScriptListTip(e){const t=$(Ti(e));0===t.find("small").length&&t.append("<small>暂无脚本</small>")}async refreshScriptState(e,t){const n=$(`#${e.id}`);n.length>0&&(t?(n.find(".script-toggle").addClass("enabled"),n.find(".script-toggle i.fa-toggle-off").hide(),n.find(".script-toggle i.fa-toggle-on").show()):(n.find(".script-toggle").removeClass("enabled"),n.find(".script-toggle i.fa-toggle-off").show(),n.find(".script-toggle i.fa-toggle-on").hide()))}async refreshTypeState(e,t){$(Ai(e)).prop("checked",t)}updateFolderAndScriptsUI(e,t,n){const i=$(`#${e}`);if(i.length>0){this.updateFolderToggleState(i,e,t);i.find(".folder-content").find(".script-item").each((e,t)=>{const i=$(t).find(".script-toggle");n?(i.addClass("enabled"),i.find("i.fa-toggle-off").hide(),i.find("i.fa-toggle-on").show()):(i.removeClass("enabled"),i.find("i.fa-toggle-off").show(),i.find("i.fa-toggle-on").hide())})}}updateScriptUI(e,t){const n=$(`#${CSS.escape(e.id)}`);if(0===n.length)return void this.addScriptToContainer(e,t);n.find(".script-item-name").text(e.name);const i=n.find(".script-toggle");e.enabled?(i.addClass("enabled"),i.find("i.fa-toggle-off").hide(),i.find("i.fa-toggle-on").show()):(i.removeClass("enabled"),i.find("i.fa-toggle-off").show(),i.find("i.fa-toggle-on").hide());const r=n.find(".script-storage-location");r.removeClass("move-to-character move-to-global"),r.addClass("global"===t?"move-to-character":"move-to-global");const s=r.find("i");s.removeClass("fa-arrow-down fa-arrow-up"),s.addClass("global"===t?"fa-arrow-down":"fa-arrow-up"),this.rebindScriptEvents(n,e,t)}rebindScriptEvents(e,t,n){e.find(".script-toggle").off("click.scriptToggle"),e.find(".script-info").off("click.scriptInfo"),e.find(".edit-script").off("click.scriptEdit"),e.find(".script-storage-location").off("click.scriptMove"),e.find(".export-script").off("click.scriptExport"),e.find(".delete-script").off("click.scriptDelete");e.find(".script-toggle").on("click.scriptToggle",function(){const e=!$(this).hasClass("enabled");e?($(this).addClass("enabled"),$(this).find("i.fa-toggle-off").hide(),$(this).find("i.fa-toggle-on").show()):($(this).removeClass("enabled"),$(this).find("i.fa-toggle-off").show(),$(this).find("i.fa-toggle-on").hide()),t.enabled=e,Li.emit(Ci.SCRIPT_TOGGLE,{script:t,type:n,enable:e,userInput:!0})}),e.find(".script-info").on("click.scriptInfo",()=>{const e=Yi(t.info||"");ie(e,ne.DISPLAY,void 0,{wide:!0})}),e.find(".edit-script").on("click.scriptEdit",e=>{e.preventDefault(),e.stopPropagation(),Li.emit(Ci.SCRIPT_EDIT,{type:n,scriptId:t.id})}),e.find(".script-storage-location").on("click.scriptMove",()=>{Li.emit(Ci.SCRIPT_MOVE,{script:t,fromType:n})}),e.find(".export-script").on("click.scriptExport",async()=>{const e=`${t.name.replace(/[\s.<>:"/\\|?*\x00-\x1F\x7F]/g,"_").toLowerCase()}.json`,n=await this.checkScriptDataAndGetExportData(t);if(null===n)return;const i=JSON.stringify(n,null,2);ae(i,e,"application/json")}),e.find(".delete-script").on("click.scriptDelete",async()=>{await ie("确定要删除这个脚本吗？",ne.CONFIRM)&&(Li.emit(Ci.SCRIPT_DELETE,{scriptId:t.id,type:n}),e.remove())})}removeScriptElement(e){$(`#${e}`).remove()}handleScriptMoved(e,t,n){$(`#${e.id}`).remove();0===(t===ki.GLOBAL?$("#global-script-list"):$("#character-script-list")).children().length&&this.showEmptyScriptListTip(t),Li.emit(Ci.UI_REFRESH,{action:"script_import",script:e,type:n})}async addScriptToContainer(e,t){const n=await this.createScriptElement(e,t),i=$(Ti(t)),r=i.find("small");r.length>0&&r.remove(),i.append(n)}setupDraggable(e){$(Ti(e)).sortable({delay:ue(),items:".script-item, .script-folder",handle:".drag-handle",cursor:"move",tolerance:"pointer",placeholder:"sortable-placeholder",connectWith:".folder-content",stop:async t=>{await this.handleDragStop(e)}}),this.setupFolderDropZones(e)}setupFolderDraggable(e){$(Ti(e)).find(".folder-content").sortable({delay:ue(),items:".script-item",handle:".drag-handle",cursor:"move",tolerance:"pointer",placeholder:"sortable-placeholder",connectWith:`${Ti(e)}, .folder-content`,stop:async t=>{await this.handleDragStop(e)}})}setupFolderDropZones(e){$(Ti(e)).find(".script-folder").each((t,n)=>{this.setupSingleFolderDropZone($(n),e)})}setupSingleFolderDropZone(e,t){const n=e.find(".folder-content");e.off(".dragdrop"),e.on("dragover dragenter dragleave drop",function(e){return e.preventDefault(),e.stopPropagation(),!1}),e.droppable({accept:'.script-item[data-script-repository="true"]',tolerance:"pointer",greedy:!0,over:(t,i)=>{if(!i.draggable.hasClass("script-item")||!i.draggable.attr("data-script-repository"))return;i.draggable.closest(".script-folder").attr("id")===e.attr("id")||(e.addClass("folder-drag-target"),n.is(":visible")||(n.slideDown(200),e.find(".folder-toggle").addClass("expanded")))},out:(t,n)=>{if(!n.draggable.hasClass("script-item")||!n.draggable.attr("data-script-repository"))return;n.draggable.closest(".script-folder").attr("id")===e.attr("id")||e.removeClass("folder-drag-target")},drop:async(n,i)=>{if(n.originalEvent&&(n.originalEvent.preventDefault(),n.originalEvent.stopPropagation()),n.preventDefault(),n.stopImmediatePropagation(),!i.draggable.hasClass("script-item")||!i.draggable.attr("data-script-repository"))return;const r=i.draggable.attr("id"),s=e.attr("id");if(i.draggable.closest(".script-folder").attr("id")===s)return e.removeClass("folder-drag-target"),!1;if(r&&s)try{if(!await this.handleScriptDropToFolder(r,s,t,i.draggable))return e.removeClass("folder-drag-target"),setTimeout(async()=>{await this.renderScriptLists()},100),!1}catch(t){return Pt().error("[ScriptManager] 拖拽脚本到文件夹失败:",t),toastr.error(`移动脚本失败: ${t instanceof Error?t.message:String(t)}`),e.removeClass("folder-drag-target"),setTimeout(async()=>{await this.renderScriptLists()},100),!1}return e.removeClass("folder-drag-target"),!1}})}async handleScriptDropToFolder(e,t,n,i){try{const r=(n===ki.GLOBAL?this.scriptManager.getGlobalRepositoryItems():this.scriptManager.getCharacterRepositoryItems()).find(e=>"folder"===e.type&&e.id===t);if(r){const t=r.value;if(t.some(t=>t.id===e))return toastr.info("脚本已经在该文件夹中"),!1}await this.scriptManager.moveScriptToFolder(e,t,n);const s=$(`#${t}`),a=s.find(".folder-content");return a.is(":visible")||(a.show(),s.find(".folder-toggle").addClass("expanded")),i.detach().prependTo(a),!0}catch(e){throw Pt().error("[ScriptManager] 移动脚本到文件夹失败:",e),e}}async handleDragStop(e){try{const t=await this.buildRepositoryFromDOM(e);Li.emit(Ci.ORDER_CHANGED,{data:t,type:e})}catch(e){Pt().error("[ScriptManager] handleDragStop: 处理拖拽结束失败:",e)}}async buildRepositoryFromDOM(e){const t=$(Ti(e)),n=[];for(const e of t.children().get()){const t=$(e);if(t.hasClass("script-folder")){const e=t.attr("id"),i=t.find(".folder-name").text(),r=t.find(".folder-icon i").attr("class")?.split(" ").find(e=>e.startsWith("fa-"))||"fa-folder",s=t.find(".folder-icon").css("color")||document.documentElement.style.getPropertyValue("--SmartThemeBodyColor"),a=[],o=t.find(".folder-content");for(const e of o.children(".script-item").get()){const t=$(e).attr("id"),n=this.scriptManager.getScriptById(t);n&&a.push(n)}n.push({type:"folder",id:e,name:i,icon:r,color:s,value:a})}else if(t.hasClass("script-item")){const e=t.attr("id"),i=this.scriptManager.getScriptById(e);i&&n.push({type:"script",value:i})}}return n}async cloneDefaultScriptTemplate(e){this.defaultScriptTemplate||await this.initializeTemplates();const t=this.defaultScriptTemplate.clone(),n=`default_lib_${e.id}`;return t.attr("id",n),t.find(".script-item-name").text(e.name),t.find(".script-info").on("click",()=>{const t=Yi(e.info);ie(t,ne.DISPLAY,void 0,{wide:!0})}),t.find(".add-script").on("click",async()=>{let t=ki.GLOBAL;const n=$(await Q(this.templatePath,"script_target_selector",{title:"添加到:",prefix:"script-add",globalLabel:"全局脚本库",characterLabel:"角色脚本库"}));n.find("#script-add-target-global").on("input",()=>t=ki.GLOBAL),n.find("#script-add-target-character").on("input",()=>t=ki.CHARACTER);if(!await ie(n,ne.CONFIRM,"",{okButton:"确认",cancelButton:"取消"}))return;const i=new $i({...e,enabled:!1});let r="new";const s=this.scriptManager.getScriptById(e.id);if(s){switch(await ie(`要导入的脚本 '${e.name}' 与脚本库中的 '${s.name}' id 相同，是否要导入？`,ne.TEXT,"",{okButton:"覆盖原脚本",cancelButton:"取消",customButtons:["新建脚本"]})){case 0:r="cancel";break;case 1:r="override";break;case 2:r="new"}}switch(r){case"new":s&&(i.id=fe());break;case"override":if(!s)return;$(`#${s.id}`).remove(),s.enabled&&(await this.scriptManager.stopScript(s,t),this.buttonManager.removeButtonsByScriptId(s.id));break;case"cancel":return}Li.emit(Ci.SCRIPT_CREATE,{script:i,type:t}),toastr.success(`脚本"${i.name}"已添加到${t===ki.GLOBAL?"全局":"角色"}脚本库`)}),t}createDefaultScriptContainer(){return $('<div class="default-script-repository-container"></div>')}async loadDefaultScriptsRepository(){const e=this.createDefaultScriptContainer(),t=await async function(){toastr.info("正在加载默认脚本...");const e=await Promise.all(Object.keys(Wi).map(e=>Ki(e)));return e.some(e=>null===e)?toastr.error("创建默认脚本失败"):toastr.success("创建默认脚本成功"),e}();for(const n of t){if(!n)continue;const t=await this.cloneDefaultScriptTemplate(n);e.append(t)}await ie(e,ne.DISPLAY,"",{wide:!0})}async openScriptEditor(e,t){const n=$(await Q(this.templatePath,"script_editor"));let i;this.updateVariableListVisibility(n),t&&(i=this.scriptManager.getScriptById(t),i&&(n.find("#script-name-input").val(i.name),n.find("#script-content-textarea").val(i.content),n.find("#script-info-textarea").val(i.info),i.data&&Object.keys(i.data).length>0&&this.loadVariablesToEditor(n,i.data),i.buttons&&i.buttons.length>0&&i.buttons.forEach((e,t)=>{const i=$(`\n              <div class="button-item" id="button-${t}">\n                <span class="drag-handle menu-handle">☰</span>\n                <input type="checkbox" id="checkbox-button-${t}" class="button-visible" ${e.visible?"checked":""}>\n                <input class="text_pole button-name" type="text" id="text-button-${t}" value="${e.name}" placeholder="按钮名称">\n                <div class="delete-button menu_button interactable" data-index="${t}">\n                  <i class="fa-solid fa-trash"></i>\n                </div>\n              </div>\n            `);n.find(".button-list").append(i)}))),n.find("#add-variable-trigger").on("click",()=>{this.addVariableToEditor(n)}),n.find("#add-button-trigger").on("click",()=>{const e=n.find(".button-list .button-item").length,t=`button-${e}`,i=$(`<div class="button-item" id="${t}">\n        <span class="drag-handle menu-handle">☰</span>\n        <input type="checkbox" id="checkbox-${t}" class="button-visible" checked>\n        <input class="text_pole button-name" type="text" id="text-${t}" placeholder="按钮名称">\n        <div class="delete-button menu_button interactable" data-index="${e}">\n          <i class="fa-solid fa-trash"></i>\n        </div>\n      </div>`);n.find(".button-list").append(i)}),n.find("#script-button-content .button-list").sortable({handle:".drag-handle",items:".button-item"}),n.on("click",".delete-button",e=>{$(e.currentTarget).closest(".button-item").remove()}),n.on("click",".delete-variable",e=>{$(e.currentTarget).closest(".variable-item").remove(),this.updateVariableListVisibility(n)});if(!await ie(n,ne.CONFIRM,"",{wide:!0,okButton:"保存",cancelButton:"取消"}))return;const r=String(n.find("#script-name-input").val()),s=String(n.find("#script-content-textarea").val()),a=String(n.find("#script-info-textarea").val()),o=this.collectVariablesFromEditor(n),c=[];if(n.find(".button-list .button-item").each(function(){const e=$(this).find(".button-name").val(),t=$(this).find(".button-visible").prop("checked");e&&""!==e.trim()&&c.push({name:e,visible:t})}),i){const t=i.enabled;if(Li.emit(Ci.BUTTON_REMOVE,{scriptId:i.id}),i.name=r,i.content=s,i.info=a,i.buttons=c,i.data=o,Li.emit(Ci.SCRIPT_UPDATE,{script:i,type:e}),t)try{await this.scriptManager.stopScript(i,e),await this.scriptManager.runScript(i,e)}catch(e){Pt().error(`[ScriptManager] 重启脚本失败: ${i.name}`,e),toastr.error(`重启脚本失败: ${i.name}`)}}else i=new $i({id:fe(),name:r,content:s,info:a,enabled:!1,buttons:c,data:o}),Li.emit(Ci.SCRIPT_CREATE,{script:i,type:e})}loadVariablesToEditor(e,t){const n=e.find("#variable-list");for(const[e,i]of Object.entries(t)){const t=this.createVariableItem(e,i);n.append(t)}this.updateVariableListVisibility(e)}addVariableToEditor(e){const t=e.find("#variable-list"),n=this.createVariableItem("","");t.append(n),this.updateVariableListVisibility(e)}updateVariableListVisibility(e){const t=e.find("#variable-list");0===t.find(".variable-item").length?t.hide():t.show()}createVariableItem(e,t){const n="string"==typeof t?t:Po.stringify(t);return $(`\n      <div class="variable-item flex-container flexFlowColumn width100p">\n        <div class="flex flexFlowColumn">\n        <div class="flex-container alignitemscenter spaceBetween wide100p">\n          <div>名称:</div>\n          <div class="menu_button interactable delete-variable" title="删除变量">\n            <i class="fa-solid fa-trash"></i>\n          </div>\n          </div>\n          <input type="text" class="text_pole variable-key" value="${this.escapeHtml(e)}" placeholder="变量名">\n        </div>\n        <div class="flex flexFlowColumn" style="align-items: flex-start;">\n          <div>值:</div>\n          <textarea class="text_pole variable-value" style="min-height: 12px;" rows="1" placeholder="请以纯文本或YAML格式输入变量值">${this.escapeHtml(n)}</textarea>\n        </div>\n      <hr>\n      </div>\n    `)}collectVariablesFromEditor(e){const t={};return e.find("#variable-list .variable-item").each(function(){const e=$(this).find(".variable-key").val(),n=$(this).find(".variable-value").val();if(e&&""!==e.trim()){let i;try{i=Po.parse(n)}catch{i=n}t[e.trim()]=i}}),t}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}async checkEmbeddedScripts(e){const t=Dt("script.characters_with_scripts")||[],n=a[e]?.avatar;if(t.includes(n))return;const i=`AlertScript_${n}`;if(!localStorage.getItem(i)){localStorage.setItem(i,"true");const e=await Q(`${Ot}/src/component/script_repository/public`,"script_allow_popup");await ie(e,ne.CONFIRM,"",{okButton:"确认",cancelButton:"取消"})?(n&&!t.includes(n)&&(t.push(n),Lt("script.characters_with_scripts",t)),$("#character-script-enable-toggle").prop("checked",!0),Li.emit(Ci.TYPE_TOGGLE,{type:ki.CHARACTER,enable:!0,userInput:!1})):($("#character-script-enable-toggle").prop("checked",!1),Li.emit(Ci.TYPE_TOGGLE,{type:ki.CHARACTER,enable:!1,userInput:!1}))}}async renderFolder(e,t){const n=$(Ti(t));this.folderTemplate||await this.initializeTemplates();const i=e.id,r=e.name,s=e.icon||"fa-folder",a=e.color||document.documentElement.style.getPropertyValue("--SmartThemeBodyColor"),o="global"===t?"fa-arrow-down":"fa-arrow-up",c="global"===t?"move-to-character":"move-to-global",l="global"===t?"移动到角色脚本库":"移动到全局脚本库",u=$(await Q(this.templatePath,"folder_template",{folderId:i,folderName:r,folderIcon:s,folderColor:a,moveIcon:o,moveClass:c,moveTitle:l}));this.bindFolderEvents(u,i,a,t);const d=e.value,p=u.find(".folder-content");for(const e of d){const n=await this.createScriptElement(e,t);p.append(n)}n.append(u),this.setupFolderDraggable(t),this.setupSingleFolderDropZone(u,t)}bindFolderEvents(e,t,n,i){e.find(".folder-header").on("click",t=>{if($(t.target).closest(".folder-control").length>0)return;if($(t.target).closest(".folder-checkbox").length>0||$(t.target).hasClass("folder-checkbox"))return;const n=e.find(".folder-content"),i=e.find(".folder-toggle");n.is(":visible")?(n.slideUp(),i.removeClass("expanded")):(n.slideDown(),i.addClass("expanded"))});const r=e.find(".folder-script-toggle");r.on("click",e=>{e.stopPropagation();const n=!r.hasClass("enabled");n?(r.addClass("enabled"),r.find("i.fa-toggle-off").hide(),r.find("i.fa-toggle-on").show()):(r.removeClass("enabled"),r.find("i.fa-toggle-off").show(),r.find("i.fa-toggle-on").hide()),Li.emit(Ci.FOLDER_SCRIPTS_TOGGLE,{folderId:t,type:i,enable:n})}),e.find(".folder-edit").on("click",e=>{e.stopPropagation(),this.showEditFolderDialog(t,i)}),e.find(".folder-export").on("click",e=>{e.stopPropagation(),this.exportFolder(t,i)}),e.find(".folder-move").on("click",e=>{e.stopPropagation(),Li.emit(Ci.FOLDER_MOVE,{folderId:t,fromType:i})}),e.find(".folder-delete").on("click",e=>{e.stopPropagation(),this.showDeleteFolderDialog(t,i)}),e.find(".folder-icon").css("color",n),this.updateFolderToggleState(e,t,i)}updateFolderToggleState(e,t,n){const i=this.scriptManager.getFolderScriptsState(t,n),r=e.find(".folder-script-toggle");r.removeClass("enabled"),"all"===i?(r.addClass("enabled"),r.find("i.fa-toggle-off").hide(),r.find("i.fa-toggle-on").show()):(r.find("i.fa-toggle-off").show(),r.find("i.fa-toggle-on").hide())}updateParentFolderToggle(e,t){const n=t===ki.GLOBAL?this.scriptManager.getGlobalRepositoryItems():this.scriptManager.getCharacterRepositoryItems();for(const i of n)if("folder"===i.type){if(i.value.some(t=>t.id===e)){const e=$(`#${i.id}`);e.length>0&&this.updateFolderToggleState(e,i.id,t);break}}}async createScriptElement(e,t){this.baseTemplate||await this.initializeTemplates();const n=this.baseTemplate.clone();n.attr("id",e.id),n.attr("data-script-repository","true"),n.find(".script-item-name").text(e.name),n.find(".script-storage-location").addClass("global"===t?"move-to-character":"move-to-global"),n.find(".script-storage-location i").addClass("global"===t?"fa-arrow-down":"fa-arrow-up");const i=n.find(".script-toggle");return e.enabled?(i.addClass("enabled"),i.find("i.fa-toggle-off").hide(),i.find("i.fa-toggle-on").show()):(i.removeClass("enabled"),i.find("i.fa-toggle-off").show(),i.find("i.fa-toggle-on").hide()),this.bindScriptEvents(n,e,t),n}async checkScriptDataAndGetExportData(e){const{enabled:t,...n}=e;if(e.data&&Object.keys(e.data).length>0)try{switch(await ie(`脚本 "${e.name}" 包含数据，导出时如何处理？如有API-KEY等敏感数据，注意清除`,ne.TEXT,"",{okButton:"直接导出（包含数据）",cancelButton:"取消",customButtons:["清除数据后导出"]})){case 0:default:return null;case 1:return n;case 2:return{...n,data:{}}}}catch(e){return Pt().error("[ScriptManager] 导出脚本数据选择对话框出错:",e),n}return n}bindScriptEvents(e,t,n){e.find(".script-toggle").on("click.scriptToggle",function(){const e=!$(this).hasClass("enabled");e?($(this).addClass("enabled"),$(this).find("i.fa-toggle-off").hide(),$(this).find("i.fa-toggle-on").show()):($(this).removeClass("enabled"),$(this).find("i.fa-toggle-off").show(),$(this).find("i.fa-toggle-on").hide()),t.enabled=e,Li.emit(Ci.SCRIPT_TOGGLE,{script:t,type:n,enable:e,userInput:!0})}),e.find(".script-info").on("click.scriptInfo",()=>{const e=Yi(t.info||"");ie(e,ne.DISPLAY,void 0,{wide:!0})}),e.find(".edit-script").on("click.scriptEdit",e=>{e.preventDefault(),e.stopPropagation(),Li.emit(Ci.SCRIPT_EDIT,{type:n,scriptId:t.id})}),e.find(".script-storage-location").on("click.scriptMove",()=>{Li.emit(Ci.SCRIPT_MOVE,{script:t,fromType:n})}),e.find(".export-script").on("click.scriptExport",async()=>{const e=`${t.name.replace(/[\s.<>:"/\\|?*\x00-\x1F\x7F]/g,"_").toLowerCase()}.json`,n=await this.checkScriptDataAndGetExportData(t);if(null===n)return;const i=JSON.stringify(n,null,2);ae(i,e,"application/json")}),e.find(".delete-script").on("click.scriptDelete",async()=>{await ie("确定要删除这个脚本吗？",ne.CONFIRM)&&(Li.emit(Ci.SCRIPT_DELETE,{scriptId:t.id,type:n}),e.remove())})}async showCreateScriptDialog(){let e=ki.GLOBAL;const t=$(await Q(this.templatePath,"script_target_selector",{title:"新建脚本到:",prefix:"script-create",globalLabel:"全局脚本库",characterLabel:"角色脚本库"}));t.find("#script-create-target-global").on("input",()=>e=ki.GLOBAL),t.find("#script-create-target-character").on("input",()=>e=ki.CHARACTER);await ie(t,ne.CONFIRM,"",{okButton:"确认",cancelButton:"取消"})&&Li.emit(Ci.SCRIPT_EDIT,{type:e})}async showCreateFolderDialog(){const e=document.documentElement.style.getPropertyValue("--SmartThemeBodyColor"),t=$(await Q(this.templatePath,"folder_create",{defaultColor:e},!1));let n;t.find("#folder-icon-preview").on("click",async()=>{try{const e=await he();e&&""!==e.trim()&&(t.find("#folder-icon-preview").removeClass().addClass(`fa ${e}`),t.find("#folder-icon-value").val(e))}catch(e){Pt().error("[ScriptManager] 图标选择失败:",e)}}),t.find("#folder-color-picker").on("change",e=>{n=e.detail?.rgba});if(!await ie(t,ne.CONFIRM,"",{okButton:"创建",cancelButton:"取消"}))return;const i=t.find("#folder-name-input").val(),r=t.find("#folder-icon-value").val(),s=t.find("#folder-target-global").prop("checked")?ki.GLOBAL:ki.CHARACTER;if(i&&""!==i.trim())try{const e=s===ki.GLOBAL?this.scriptManager.getGlobalRepositoryItems():this.scriptManager.getCharacterRepositoryItems();if(e.some(e=>"folder"===e.type&&e.name===i.trim()))return void toastr.error(`${s===ki.GLOBAL?"全局":"角色"}脚本库中已存在名为 "${i.trim()}" 的文件夹`);Li.emit(Ci.FOLDER_CREATE,{name:i.trim(),type:s,icon:r,color:n})}catch(e){Pt().error("[ScriptManager] 创建文件夹失败:",e),toastr.error(`创建文件夹失败: ${e instanceof Error?e.message:String(e)}`)}else toastr.error("请输入文件夹名称")}async showEditFolderDialog(e,t){const n=$(`#${e} .folder-name`).text(),i=(t===ki.GLOBAL?this.scriptManager.getGlobalRepositoryItems():this.scriptManager.getCharacterRepositoryItems()).find(t=>"folder"===t.type&&t.id===e),r=i?.icon||"fa-folder",s=i?.color||document.documentElement.style.getPropertyValue("--SmartThemeBodyColor");let a;const o=$(`\n      <div class="folder-edit-dialog">\n      <h3>编辑文件夹</h3>\n      <div class="flex-container flexFlowColumn wide100p padding10 justifyLeft">\n        <div>\n          <h4>文件夹名称:</h4>\n          <input type="text" id="folder-name-input" class="text_pole" value="${n}" />\n        </div>\n        <div>\n          <h4>文件夹图标:</h4>\n          <div class="flex" style="gap: 20px; margin: 5px 0; width: 100%;">\n            <div class="flex alignItemsCenter">\n            <label>选择颜色</label>\n            <toolcool-color-picker id="folder-color-picker" color="${s}"></toolcool-color-picker>\n            </div>\n            <div class="flex-container alignItemsCenter">\n             <label>选择图标</label>\n              <i id="folder-icon-preview" class="fa ${r} marginRight10" style="cursor: pointer; font-size: 12px; padding: 4px; border: 1px solid #ccc; border-radius: 4px;" title="点击选择图标"></i>\n              <input type="hidden" id="folder-icon-value" value="${r}" />\n            </div>\n          </div>\n        </div>\n      </div>\n    `);o.find("#folder-icon-preview").on("click",async()=>{try{const e=await he();e&&""!==e.trim()&&(o.find("#folder-icon-preview").removeClass().addClass(`fa ${e}`),o.find("#folder-icon-value").val(e))}catch(e){Pt().error("[ScriptManager] 图标选择失败:",e)}}),o.find("#folder-color-picker").on("change",e=>{a=e.detail?.rgba});if(!await ie(o,ne.CONFIRM,"",{okButton:"保存",cancelButton:"取消"}))return;const c=o.find("#folder-name-input").val(),l=o.find("#folder-icon-value").val();Li.emit(Ci.FOLDER_EDIT,{folderId:e,newName:c?.trim()||n,type:t,newIcon:l,newColor:a})}async exportFolder(e,t){try{const n=(t===ki.GLOBAL?this.scriptManager.getGlobalRepositoryItems():this.scriptManager.getCharacterRepositoryItems()).find(t=>"folder"===t.type&&t.id===e);if(!n)return void toastr.error("未找到指定的文件夹");window.JSZip||await Promise.resolve().then(ft.bind(ft,730));const i=new JSZip,r=(n.name||"folder").replace(/[<>:"/\\|?*]/g,"_");if(Array.isArray(n.value)){let e=!1;for(const t of n.value){const n=await this.checkScriptDataAndGetExportData(t);if(null===n){e=!0;break}const s=`${t.name.replace(/[<>:"/\\|?*]/g,"_")}.json`;i.file(`${r}/${s}`,JSON.stringify(n,null,2))}if(e)return}const s=await i.generateAsync({type:"blob"}),a=(new Date).toISOString().slice(0,19).replace(/:/g,"-"),o=`folder_${r}_${t===ki.GLOBAL?"global":"character"}_${a}.zip`,c=URL.createObjectURL(s),l=document.createElement("a");l.href=c,l.download=o,document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(c),toastr.success(`文件夹 "${n.name}" 导出成功`)}catch(e){Pt().error("[ScriptManager] 导出文件夹失败:",e),toastr.error(`导出文件夹失败: ${e instanceof Error?e.message:String(e)}`)}}async showDeleteFolderDialog(e,t){const n=(t===ki.GLOBAL?this.scriptManager.getGlobalRepositoryItems():this.scriptManager.getCharacterRepositoryItems()).find(t=>"folder"===t.type&&t.id===e),i=n?.name||"未知文件夹";await ie(`确定要删除文件夹 "${i}" 及其中的所有脚本吗？此操作不可撤销。`,ne.CONFIRM,"",{okButton:"删除",cancelButton:"取消"})&&Li.emit(Ci.FOLDER_DELETE,{folderId:e,type:t})}setupSearchEvents(){const e=$("#script-search-input");e.on("input",e=>{const t=e.target.value.trim();t?this.performSearch(t):this.clearSearch()}),e.on("keypress",t=>{if(13===t.which){const t=e.val();t&&t.trim()&&this.performSearch(t.trim())}})}performSearch(e){if(!e)return void this.clearSearch();const t=this.scriptManager.getGlobalScripts(),n=this.scriptManager.getCharacterScripts(),i=this.searchScripts(t,e),r=this.searchScripts(n,e);this.displaySearchResults(i,r)}searchScripts(e,t){const n=t.toLowerCase();return e.filter(e=>e.name.toLowerCase().includes(n))}async displaySearchResults(e,t){this.clearScriptList(ki.GLOBAL),this.clearScriptList(ki.CHARACTER);const n=$("#global-script-list");if(e.length>0)for(const t of e)await this.addScriptToContainer(t,ki.GLOBAL);else n.append("<small>无匹配的全局脚本</small>");const i=$("#character-script-list");if(t.length>0)for(const e of t)await this.addScriptToContainer(e,ki.CHARACTER);else i.append("<small>无匹配的角色脚本</small>")}clearSearch(){this.renderScriptLists()}setupBatchOperationEvents(){$("#global-batch-manager").on("click",()=>{this.toggleBatchMode(ki.GLOBAL)}),$("#character-batch-manager").on("click",()=>{this.toggleBatchMode(ki.CHARACTER)}),$("#global-batch-delete").on("click",()=>{this.performBatchDelete(ki.GLOBAL)}),$("#global-batch-export").on("click",()=>{this.performBatchExport(ki.GLOBAL)}),$("#global-batch-move").on("click",()=>{this.performBatchMove(ki.GLOBAL)}),$("#global-batch-cancel").on("click",()=>{this.exitBatchMode(ki.GLOBAL)}),$("#character-batch-delete").on("click",()=>{this.performBatchDelete(ki.CHARACTER)}),$("#character-batch-export").on("click",()=>{this.performBatchExport(ki.CHARACTER)}),$("#character-batch-move").on("click",()=>{this.performBatchMove(ki.CHARACTER)}),$("#character-batch-cancel").on("click",()=>{this.exitBatchMode(ki.CHARACTER)})}toggleBatchMode(e){(e===ki.GLOBAL?this.batchModeGlobal:this.batchModeCharacter)?this.exitBatchMode(e):this.enterBatchMode(e)}enterBatchMode(e){const t=Ti(e),n=Oi(e);e===ki.GLOBAL?this.batchModeGlobal=!0:this.batchModeCharacter=!0,$(n).show();const i=$(t);i.find(".script-item").each((e,t)=>{const n=$(t);n.addClass("batch-mode"),n.find(".script-checkbox").show(),n.find(".drag-handle").hide(),n.find(".script-item-control").hide(),n.find(".script-checkbox").off("change.batch").on("change.batch",()=>{this.handleCheckboxChange(n)})}),i.find(".script-folder").each((e,t)=>{const n=$(t);n.addClass("batch-mode"),n.find(".folder-checkbox").show(),n.find(".drag-handle").hide(),n.find(".folder-control .folder-script-toggle").hide(),n.find(".folder-control .folder-edit").hide(),n.find(".folder-control .folder-export").hide(),n.find(".folder-control .folder-move").hide(),n.find(".folder-control .folder-delete").hide(),n.find(".folder-checkbox").off("change.batch").on("change.batch",()=>{this.handleCheckboxChange(n)})})}exitBatchMode(e){const t=Ti(e),n=Oi(e);e===ki.GLOBAL?this.batchModeGlobal=!1:this.batchModeCharacter=!1,$(n).hide();$(t).find(".script-item, .script-folder").each((e,t)=>{const n=$(t);n.removeClass("batch-mode selected"),n.find(".script-checkbox, .folder-checkbox").hide().prop("checked",!1),n.find(".script-item-control").show(),n.find(".drag-handle").show(),n.find(".script-controls").show(),n.find(".folder-control .folder-script-toggle").show(),n.find(".folder-control .folder-edit").show(),n.find(".folder-control .folder-export").show(),n.find(".folder-control .folder-move").show(),n.find(".folder-control .folder-delete").show(),n.find(".script-checkbox, .folder-checkbox").off("change.batch")})}handleCheckboxChange(e){e.find(".script-checkbox, .folder-checkbox").prop("checked")?e.addClass("selected"):e.removeClass("selected")}getSelectedItems(e){const t=Ti(e),n=[],i=[];return $(t).find(".script-item.selected").each((e,t)=>{const i=$(t).attr("id");i&&n.push(i)}),$(t).find(".script-folder.selected").each((e,t)=>{const n=$(t).attr("id");n&&i.push(n)}),{scriptIds:n,folderIds:i}}async performBatchDelete(e){const{scriptIds:t,folderIds:n}=this.getSelectedItems(e);if(0===t.length&&0===n.length)return void toastr.warning("请至少选择一个项目进行删除");const i=t.length+n.length;if(await ie(`确定要删除选中的 ${i} 个项目吗？此操作不可撤销。`,ne.CONFIRM,"",{okButton:"删除",cancelButton:"取消"}))try{for(const n of t)await this.scriptManager.deleteScript(n,e);for(const t of n)await this.handleFolderDelete(t,e,!0);toastr.success(`成功删除 ${i} 个项目`),this.exitBatchMode(e),await this.renderScriptLists()}catch(e){Pt().error("[ScriptManager] 批量删除失败:",e),toastr.error(`批量删除失败: ${e instanceof Error?e.message:String(e)}`)}}async performBatchExport(e){const{scriptIds:t,folderIds:n}=this.getSelectedItems(e);if(0!==t.length||0!==n.length)try{window.JSZip||await Promise.resolve().then(ft.bind(ft,730));const i=new JSZip;let r=0,s=!1;for(const e of t){const t=this.scriptManager.getScriptById(e);if(t){const e=await this.checkScriptDataAndGetExportData(t);if(null===e){s=!0;break}const n=`${t.name.replace(/[<>:"/\\|?*]/g,"_")}.json`;i.file(n,JSON.stringify(e,null,2)),r++}}if(s)return;const a=e===ki.GLOBAL?this.scriptManager.getGlobalRepositoryItems():this.scriptManager.getCharacterRepositoryItems();for(const e of n){const t=a.find(t=>"folder"===t.type&&t.id===e);if(t){const e=(t.name||"folder").replace(/[<>:"/\\|?*]/g,"_");if(Array.isArray(t.value)){for(const n of t.value){const t=await this.checkScriptDataAndGetExportData(n);if(null===t){s=!0;break}const r=`${n.name.replace(/[<>:"/\\|?*]/g,"_")}.json`;i.file(`${e}/${r}`,JSON.stringify(t,null,2))}if(s)break}r++}}if(s)return;if(0===r)return void toastr.error("没有找到有效的导出数据");const o=await i.generateAsync({type:"blob"}),c=(new Date).toISOString().slice(0,19).replace(/:/g,"-"),l=`batch_export_${e===ki.GLOBAL?"global":"character"}_${c}.zip`,u=URL.createObjectURL(o),d=document.createElement("a");d.href=u,d.download=l,document.body.appendChild(d),d.click(),document.body.removeChild(d),URL.revokeObjectURL(u),toastr.success(`成功导出 ${r} 个项目`)}catch(e){Pt().error("[ScriptManager] 批量导出失败:",e),toastr.error(`批量导出失败: ${e instanceof Error?e.message:String(e)}`)}else toastr.warning("请至少选择一个项目进行导出")}async performBatchMove(e){const{scriptIds:t,folderIds:n}=this.getSelectedItems(e);if(n.length>0)toastr.error("不能移动文件夹，请只选择脚本进行移动操作");else if(0!==t.length)try{const n=(e===ki.GLOBAL?this.scriptManager.getGlobalRepositoryItems():this.scriptManager.getCharacterRepositoryItems()).filter(e=>"folder"===e.type);if(0===n.length)return void toastr.error("没有可用的文件夹，请先创建一个文件夹");const i=n.map(e=>`<option value="${e.id}">${e.name}</option>`).join(""),r=$(`\n        <div>\n          <p>选择要移动到的文件夹：</p>\n          <select id="target-folder-select" class="text_pole" style="width: 100%;">\n            <option value="">根目录</option>\n            ${i}\n          </select>\n        </div>\n      `);if(!await ie(r,ne.CONFIRM,"",{okButton:"移动",cancelButton:"取消"}))return;const s=r.find("#target-folder-select").val()||null;for(const n of t)await this.scriptManager.moveScriptToFolder(n,s,e);const a=s?n.find(e=>e.id===s)?.name||"未知文件夹":"根目录";toastr.success(`成功将 ${t.length} 个脚本移动到"${a}"`),this.exitBatchMode(e),await this.renderScriptLists()}catch(e){Pt().error("[ScriptManager] 批量移动失败:",e),toastr.error(`批量移动失败: ${e instanceof Error?e.message:String(e)}`)}else toastr.warning("请至少选择一个脚本进行移动")}async handleFolderCreate(e,t,n,i){try{await this.scriptManager.createFolder(e,t,n,i),await this.renderScriptLists(),toastr.success(`文件夹 "${e}" 创建成功`)}catch(e){Pt().error("[ScriptManager] 创建文件夹失败:",e),toastr.error(`创建文件夹失败: ${e instanceof Error?e.message:String(e)}`)}}async handleFolderEdit(e,t,n,i,r){try{await this.scriptManager.editFolder(e,t,n,i,r),t&&$(`#${e} .folder-name`).text(t),i&&$(`#${e} .folder-icon`).removeClass().addClass(`fa ${i} folder-icon marginLeft5`),r&&($(`#${e} .folder-icon`).css("color",r),$(`#${e} .folder-header`).css("border-left-color",r)),toastr.success("文件夹更新成功")}catch(e){Pt().error("[ScriptManager] 更新文件夹失败:",e),toastr.error(`更新文件夹失败: ${e instanceof Error?e.message:String(e)}`)}}async handleFolderDelete(e,t,n=!1){try{await this.scriptManager.deleteFolder(e,t),n||(await this.renderScriptLists(),toastr.success("文件夹删除成功"))}catch(e){throw Pt().error("[ScriptManager] 删除文件夹失败:",e),n||toastr.error(`删除文件夹失败: ${e instanceof Error?e.message:String(e)}`),e}}async handleFolderScriptsToggle(e,t,n){try{await this.scriptManager.toggleFolderScripts(e,t,n),this.updateFolderAndScriptsUI(e,t,n)}catch(e){Pt().error("[ScriptManager] 批量切换文件夹脚本状态失败:",e),toastr.error(`批量切换脚本状态失败: ${e instanceof Error?e.message:"未知错误"}`)}}}const Mo=[h.CHAT_CHANGED],zo=[h.CHARACTER_DELETED];class Fo{static instance;scriptManager;uiManager;initialized=!1;sendFormObserver=null;isUpdatingButtons=!1;constructor(){this.scriptManager=ji.getInstance(),this.uiManager=Uo.getInstance(),this.registerEvents(),this.setupSendFormObserver(),this.setupQrCombinedObserver()}static getInstance(){return Fo.instance||(Fo.instance=new Fo),Fo.instance}static destroyInstance(){Fo.instance&&(Fo.instance.cleanup(),Fo.instance=void 0,ji.destroyInstance(),Uo.destroyInstance(),Ni.destroyInstance())}setupSendFormObserver(){this.sendFormObserver=new MutationObserver(e=>{if(this.isUpdatingButtons)return;let t=!1;e.forEach(e=>{"childList"===e.type&&(e.addedNodes.forEach(e=>{if(e.nodeType===Node.ELEMENT_NODE){const n=e;"qr--bar"===n.id&&n.children.length>0&&(t=!0),(n.classList?.contains("qr--button")||n.classList?.contains("qr--buttons"))&&(t=!0)}}),e.removedNodes.forEach(e=>{if(e.nodeType===Node.ELEMENT_NODE){const n=e;(n.classList?.contains("qr--buttons")||"qr--bar"===n.id)&&(t=!0)}}))}),t&&(this.sendFormObserver?.debounceTimer&&clearTimeout(this.sendFormObserver.debounceTimer),this.sendFormObserver.debounceTimer=setTimeout(()=>{this.handleSendFormChange()},500))}),this.startObservingSendForm()}setupQrCombinedObserver(){this.startObservingQrCombined()}startObservingQrCombined(){$(document).off("change.qrCombined","#qr--isCombined"),$(document).on("change.qrCombined","#qr--isCombined",()=>{this.handleSendFormChange()})}startObservingSendForm(){const e=document.getElementById("send_form");e&&this.sendFormObserver?this.sendFormObserver.observe(e,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["checked","disabled"]}):e||setTimeout(()=>{this.startObservingSendForm()},1e3)}handleSendFormChange(){if(this.initialized&&!this.isUpdatingButtons)try{this.isUpdatingButtons=!0,qi()}catch(e){Pt().error("[ScriptManager] 处理send_form变化时出错:",e)}finally{setTimeout(()=>{this.isUpdatingButtons=!1},100)}}async initialize(){if(!this.initialized)try{await pe(`/scripts/extensions/${Ot}/src/component/script_repository/public/style.css`,"css"),await this.uiManager.initialize(),this.initialized=!0}catch(e){Pt().error("[ScriptManager] 初始化失败:",e),this.initialized=!1}}registerEvents(){Mo.forEach(e=>{p.makeFirst(e,this.refreshCharacterRepository.bind(this))}),zo.forEach(e=>{p.makeFirst(e,e=>async function({character:e}){const t=e?.character?.avatar,n=Dt("script.characters_with_scripts")||[];if(t&&(localStorage.removeItem(`AlertScript_${t}`),n?.includes(t))){const e=n.indexOf(t);-1!==e&&(n.splice(e,1),Lt("script.characters_with_scripts",n))}}({character:e}))})}async refreshCharacterRepository(){if(!this.initialized)return;const e=[];$("#character-script-list").find(".script-item").each((t,n)=>{const i=$(n).attr("id");if(i){const t=this.scriptManager.getScriptById(i);t&&e.push(t)}}),this.scriptManager.stopScriptsByType(e,ki.CHARACTER);const t=Ni.getInstance(),n=this.scriptManager.getGlobalScripts(),i=this.scriptManager.getCharacterScripts();this.scriptManager.refreshCharacterScriptEnabledState(),Pt().info("[ScriptManager] 刷新角色脚本库"),H&&i.length>0&&await this.uiManager.checkEmbeddedScripts(H);const r=i.filter(e=>n.some(t=>t.id===e.id));if(r.length>0){Pt().info(`[ScriptManager] 发现${r.length}个脚本ID冲突`);for(const e of r){const r=n.find(t=>t.id===e.id),s=await ie(`全局脚本中已存在 "${r.name}" 脚本，是否关闭冲突脚本？`,ne.TEXT,"",{okButton:"关闭全局",cancelButton:"关闭局部"});e.id=fe(),s?r.enabled&&(await this.scriptManager.stopScript(r,ki.GLOBAL),r.enabled=!1,Pt().info(`[ScriptManager] 关闭全局脚本: ${r.name}`),Li.emit(Ci.UI_REFRESH,{action:"script_toggle",script:r,type:ki.GLOBAL,enable:!1}),t.saveGlobalScripts(n)):e.enabled&&(e.enabled=!1,await t.saveCharacterScripts(i),Pt().info(`[ScriptManager] 关闭局部脚本: ${e.name}`))}}Li.emit(Ci.UI_REFRESH,{action:"refresh_charact_scripts"}),await this.scriptManager.runScriptsByType(i,ki.CHARACTER)}async cleanup(){try{this.sendFormObserver&&(this.sendFormObserver.disconnect(),this.sendFormObserver.debounceTimer&&clearTimeout(this.sendFormObserver.debounceTimer),this.sendFormObserver=null),$(document).off("change.qrCombined","#qr--isCombined"),this.isUpdatingButtons=!1,Mo.forEach(e=>{p.removeListener(e,this.refreshCharacterRepository.bind(this))}),await this.scriptManager.cleanup(),this.uiManager.cleanup(),this.initialized=!1,Pt().info("[ScriptManager] 清理完成")}catch(e){Pt().error("[ScriptManager] 清理失败:",e)}}}async function Bo(){const e=Fo.getInstance();await e.initialize()}function Go(){!async function(){Fo.destroyInstance()}()}class Vo{static inferDataType(e){return Array.isArray(e)?"array":"boolean"==typeof e?"boolean":"number"==typeof e?"number":"object"==typeof e&&null!==e?"object":"string"}static getDefaultValueForType(e){switch(e){case"string":default:return"";case"number":return 0;case"boolean":return!1;case"array":return[];case"object":return{}}}static generateUniqueKey(e,t="newKey"){let n=t,i=1;for(;e.has(n);)n=`${t}${i}`,i++;return n}}class Zo{model;view;syncService;cardFactory;constructor(e,t,n,i){this.model=e,this.view=t,this.syncService=n,this.cardFactory=i}async init(e){this.view.initUI(),this.bindEvents(e),await this.syncService.initCurrentType(),await this.syncService.setCurrentType("global"),await this.loadVariables("global")}bindEvents(e){e.find(".tab-item").on("click",this.handleTabChange.bind(this)),e.on("click",".add-list-item",this.handleAddListItem.bind(this)),e.on("click",".list-item-delete",this.handleDeleteListItem.bind(this)),e.on("click",".delete-btn",this.handleDeleteVariableCard.bind(this)),e.on("click",".save-btn",this.handleSaveVariableCard.bind(this)),e.on("click","#add-variable",this.handleAddVariable.bind(this)),e.on("click","#clear-all",this.handleClearAll.bind(this)),e.on("click","#filter-icon",this.handleFilterIconClick.bind(this)),e.on("change",".filter-checkbox",this.handleFilterOptionChange.bind(this)),e.on("input","#variable-search",this.handleVariableSearch.bind(this)),e.on("click","#floor-filter-btn",this.handleFloorRangeFilter.bind(this)),e.on("nested-card:changed",".variable-card",this.handleNestedCardChanged.bind(this))}async loadVariables(e){const t=await this.model.loadFromTavern(e);if(0!==t.length){if("message"===e){this.view.container.find("#floor-filter-container").show();const[e,t]=this.model.getFloorRange();this.view.updateFloorRangeInputs(e,t)}else this.view.container.find("#floor-filter-container").hide();this.view.refreshVariableCards(e,t),this.applyFilters()}}async handleTabChange(e){const t=$(e.currentTarget).attr("id");if(!t)return;const n=t.replace("-tab","");n!==this.model.getActiveVariableType()&&(this.view.setActiveTab(n),await this.syncService.setCurrentType(n),await this.loadVariables(n))}handleAddListItem(e){const t=$(e.currentTarget).siblings(".list-items-container"),n=$('\n      <div class="list-item">\n        <span class="drag-handle">☰</span>\n        <textarea class="variable-content-input" placeholder="输入变量内容"></textarea>\n        <button class="list-item-delete"><i class="fa-solid fa-times"></i></button>\n      </div>\n    ');t.append(n),n.find("textarea").focus()}handleDeleteListItem(e){const t=$(e.currentTarget).closest(".list-item");t.css({"background-color":"rgba(255, 0, 0, 0.2)",transition:"all 0.3s ease"}),setTimeout(()=>{t.css({transform:"scale(0.9)",opacity:"0.7"}),setTimeout(()=>{t.remove()},200)},50)}async handleDeleteVariableCard(e){const t=$(e.currentTarget),n=t.closest(".variable-card").attr("data-variable-id")||"",i=this.model.getActiveVariableType();t.hasClass("object-delete-btn")||this.view.showConfirmDialog("确定要删除变量吗？此操作无法撤销。",async e=>{if(e)try{this.model.removeFromMap(n)&&(await this.model.saveAllVariables(i),this.view.removeVariableCard(n))}catch(e){Pt().error("[VariableManager] 删除变量失败:",e)}})}async handleAddVariable(){const e=this.model.getActiveVariableType();this.view.showAddVariableDialog((t,n)=>{this.view.addNewVariableCard(e,t,n),this.applyFilters()})}async handleSaveVariableCard(e){const t=$(e.currentTarget).closest(".variable-card"),n=this.model.getActiveVariableType(),i=Vo.inferDataType(this.cardFactory.getVariableFromCard(t));let r;if("object"==i&&this.syncObjectCardData(t),"message"===n){const e=t.attr("data-floor-id");e&&(r=parseInt(e))}let s,a={name:this.view.getVariableCardName(t),value:this.cardFactory.getVariableFromCard(t)?.value,dataType:i,id:t.attr("data-variable-id")||"",...void 0!==r&&{message_id:r}};if(null==a.name||""===a.name.trim())return void toastr.error("变量名不能为空");s="message"===n&&void 0!==r?this.model.getVariablesByMessageId(r).filter(e=>e.name===a.name):this.model.getVariablesByName(a.name);if(s.filter(e=>e.id!==a.id).length>0)toastr.error("变量名重复");else try{if(a.id&&this.model.getVariableById(a.id))this.model.updateInMap(a.id,a.name,a.value,r);else{const e=this.model.addToMap(a.name,a.value,r);a.id=e.id,t.attr("data-variable-id",a.id)}"message"===n&&void 0!==r?await this.model.saveAllVariables(n,r):await this.model.saveAllVariables(n),this.view.addAnimation(t,"variable-changed",()=>{})}catch(e){Pt().error("[VariableManager] 保存变量失败:",e),toastr.error(`保存变量失败: ${e instanceof Error?e.message:"未知错误"}`)}}async handleClearAll(){const e=this.model.getActiveVariableType();this.view.showConfirmDialog(`确定要清除所有${this.getVariableTypeName(e)}变量吗？此操作不可撤销。`,async t=>{if(t)try{await this.model.clearAllVariables(e);if(this.view.container.find(`#${e}-content .variable-list`).empty(),"message"==e){this.view.container.find(`#${e}-content .floor-variables-container`).empty()}toastr.success(`已清除所有${this.getVariableTypeName(e)}变量`)}catch(t){Pt().error(`[VariableManager] 清除${e}变量失败:`,t),toastr.error(`清除${this.getVariableTypeName(e)}变量时出错: ${t.message||"未知错误"}`)}})}handleFilterIconClick(){this.view.container.find(".filter-options").toggle()}handleFilterOptionChange(e){const t=$(e.currentTarget),n=t.data("type"),i=t.is(":checked");this.model.updateFilterState(n,i),this.applyFilters()}handleVariableSearch(e){const t=$(e.currentTarget).val();this.model.updateSearchKeyword(t),this.applyFilters()}applyFilters(){const e=this.model.getFilterState(),t=this.model.getSearchKeyword();this.view.applyClientSideFilters(e,t)}handleFloorRangeFilter(){const e=this.view.container.find("#floor-min"),t=this.view.container.find("#floor-max"),n=e.val(),i=t.val(),r=n.trim()?parseInt(n,10):null,s=i.trim()?parseInt(i,10):null;if(n.trim()&&isNaN(r)||i.trim()&&isNaN(s))return void this.view.showFloorFilterError("请输入有效的数字");if(null!==r&&r<0)return void this.view.showFloorFilterError("最小楼层不能小于0");if(null!==s&&s<0)return void this.view.showFloorFilterError("最大楼层不能小于0");if(null!==r&&null!==s&&r>s)return void this.view.showFloorFilterError("最小值不能大于最大值");if(null===r&&null===s)return void this.view.showFloorFilterError("请至少设置最小楼层或最大楼层");this.view.hideFloorFilterError();const a=r??0,o=s??9999;this.applyFloorRangeAndReload(a,o)}async applyFloorRangeAndReload(e,t){try{this.model.updateFloorRange(e,t),this.view.updateFloorRangeInputs(e,t),await this.loadVariables("message")}catch(e){Pt().error("[VariableManager] 应用楼层范围并重新加载变量失败:",e)}}cleanup(){try{this.syncService.cleanup()}catch(e){Pt().error("[VariableManager] 清理资源失败:",e)}}syncObjectCardData(e){if("card"===(e.attr("data-view-mode")||"card")){const t=this.cardFactory.getVariableFromCard(e);e.find(".yaml-input").val(Po.stringify(t?.value,null,2))}}async handleNestedCardChanged(e){const t=$(e.currentTarget).find(".variable-action-btn.save-btn");t.length>0&&t.trigger("click")}getVariableTypeName(e){switch(e){case"global":return"全局";case"character":return"角色";case"chat":return"聊天";case"message":return"消息";default:return e}}}function qo(e,{role:t="all",hide_state:n="all",include_swipes:i=!1}={}){const r=function(e,t,n){let i,r;if(e.match(/^(-?\d+)$/)){const t=Number(e);i=r=t<0?n+t+1:t}else{const t=e.match(/^(-?\d+)-(-?\d+)$/);if(!t)return null;[i,r]=_.sortBy([t[1],t[2]].map(e=>Number(e)).map(e=>e<0?n+e+1:e))}return isNaN(i)||isNaN(r)||i>r||i<t||r>n?null:{start:i,end:r}}(Z(e.toString()),0,o.length-1);if(!r)throw Error(`提供的消息范围 range 无效: ${e}`);if(!["all","system","assistant","user"].includes(t))throw Error(`提供的 role 无效, 请提供 'all', 'system', 'assistant' 或 'user', 你提供的是: ${t}`);if(!["all","hidden","unhidden"].includes(n))throw Error(`提供的 hide_state 无效, 请提供 'all', 'hidden' 或 'unhidden', 你提供的是: ${n}`);const{start:s,end:a}=r,c=e=>{const r=o[e];if(!r)return Pt().warn(`没找到第 ${e} 楼的消息`),null;const s=(a=r,a.extra?.type===q.NARRATOR?a.is_user?"unknown":"system":a.is_user?"user":"assistant");var a;if("all"!==t&&s!==t)return Pt().debug(`筛去了第 ${e} 楼的消息因为它的身份不是 ${t}`),null;if("all"!==n&&"hidden"===n!==r.is_system)return Pt().debug(`筛去了第 ${e} 楼的消息因为它${"hidden"===n?"":"没"} 被隐藏`),null;const c=r?.swipe_id??0,l=r?.swipes??[r.mes],u=r?.variables??[{}],d=r?.swipes_info??[r?.extra??{}],p=d[c],h=u[c];return i?{message_id:e,name:r.name,role:s,is_hidden:r.is_system,swipe_id:c,swipes:l,swipes_data:u,swipes_info:d}:{message_id:e,name:r.name,role:s,is_hidden:r.is_system,message:r.mes,data:h,extra:p,swipe_id:c,swipes:l,swipes_data:u}},l=_.range(s,a+1).map(e=>c(e)).filter(e=>null!==e);return Pt().info(`获取${s==a?`第 ${s} `:` ${s}-${a} `}楼的消息, 选项: ${JSON.stringify({role:t,hide_state:n,include_swipes:i})} `),structuredClone(l)}async function Ho(e,{refresh:t="affected"}={}){await Promise.all(e.map(async e=>{const t=o[e.message_id];if(void 0!==t)if(void 0!==e?.name&&_.set(t,"name",e.name),void 0!==e?.role&&_.set(t,"is_user","user"===e.role),void 0!==e?.is_hidden&&_.set(t,"is_system",e.is_hidden),(e=>_.has(e,"message")||_.has(e,"data"))(e))void 0!==e?.message&&(_.set(t,"mes",e.message),void 0!==t?.swipes&&_.set(t,["swipes",t.swipe_id],e.message)),void 0!==e?.data&&(void 0===t?.variables&&_.set(t,"variables",_.times(t.swipes?.length??1,_.constant({}))),_.set(t,["variables",t.swipe_id??0],e.data),p.emit("message_variables_changed",{message_id:e.message_id,variables:e.data})),void 0!==e?.extra&&(void 0===t?.swipes_info&&_.set(t,"swipes_info",_.times(t.swipes?.length??1,_.constant({}))),_.set(t,"extra",e?.extra),_.set(t,["swipes_info",t.swipe_id??0],e?.extra));else if(void 0!==e?.swipe_id||void 0!==e?.swipes||void 0!==e?.swipes_data||void 0!==e?.swipes_info){_.set(e,"swipe_id",e.swipe_id??t.swipe_id??0),_.set(e,"swipes",e.swipes??t.swipes??[t.mes]),_.set(e,"swipes_data",e.swipes_data??t.variables??[{}]),_.set(e,"swipes_info",e.swipes_info??t.swipes_info??[{}]);const n=_.max([e.swipes?.length,e.swipes_data?.length,e.swipes_info?.length])??1;e.swipes.length=n,e.swipes_data.length=n,e.swipes_info.length=n,_.set(t,"swipes",e.swipes),_.set(t,"variables",e.swipes_data),_.set(t,"swipes_info",e.swipes_info),_.set(t,"swipe_id",e.swipe_id),_.set(t,"mes",t.swipes[t.swipe_id]),_.set(t,"extra",t.swipes_info[t.swipe_id]),p.emit("message_variables_changed",{message_id:e.message_id,variables:e.swipes_data[e.swipe_id]})}})),await j(),"all"===t?await D():"affected"===t&&await Promise.all(e.map(e=>(async e=>{const t=$(`div.mes[mesid = "${e}"]`);if(!t)return;const n=o[e];n.swipes&&t.find(".swipes-counter").text(`${n.swipe_id+1}​/​${n.swipes.length}`),t.find(".mes_text").empty().append(O(n.mes,n.name,n.is_system,n.is_user,e)),await p.emit(n.is_user?h.USER_MESSAGE_RENDERED:h.CHARACTER_MESSAGE_RENDERED,e)})(e.message_id))),Pt().info(`修改第 '${e.map(e=>e.message_id).join(", ")}' 楼的消息, 选项: ${JSON.stringify({refresh:t})}`)}async function Wo(e,{insert_at:t="end",refresh:n="affected"}={}){if("end"!==t&&((t=t<0?o.length+t:t)<0||t>o.length))throw Error(`提供的 insert_at 无效, 请提供一个在 '0' 到 '${o.length}' 之间的整数, 你提供的是: '${t}'`);const i=await Promise.all(e.map(async e=>{const t={};return void 0!==e?.name?_.set(t,"name",e.name):"user"===e.role?_.set(t,"name",A):_.set(t,"name",N),_.set(t,"is_user","user"===e.role),_.set(t,"is_system",e.is_hidden??!1),_.set(t,"mes",e.message),_.set(t,["variables",0],e.data??{}),t}));"end"===t?o.push(...i):o.splice(t,0,...i),await j(),"affected"===n&&"end"===t?i.forEach(e=>r(e)):await D(),Pt().info(`在${"end"===t?"最后":`第 ${t} 楼前`}创建 ${e.length} 条消息, 选项: ${JSON.stringify({insert_at:t,refresh:n})}`)}async function Jo(e,{refresh:t="all"}={}){e=e.map(e=>e<0?o.length+e:e).filter(e=>e>=0&&e<o.length),_.pullAt(o,e),await j(),"all"===t&&await D(),Pt().info(`删除第 '${e.join(", ")}' 楼的消息, 选项: ${JSON.stringify({refresh:t})}`)}async function Ko(e,t,n,{refresh:i="all"}={}){const r=o.splice(t,n-t);o.splice(e,0,...r),await j(),"all"===i&&await D(),Pt().info(`旋转第 '[${e}, ${t}) [${t}, ${n})' 楼的消息, 选项: ${JSON.stringify({refresh:i})}`)}async function Yo(e,t,{swipe_id:n="current",refresh:i="display_and_render_current"}={}){if(e="string"==typeof e?{message:e}:e,"number"!=typeof n&&"current"!==n)throw Error(`提供的 swipe_id 无效, 请提供 'current' 或序号, 你提供的是: ${n} `);if(!["none","display_current","display_and_render_current","all"].includes(i))throw Error(`提供的 refresh 无效, 请提供 'none', 'display_current', 'display_and_render_current' 或 'all', 你提供的是: ${i} `);const r=o.at(t);if(!r)return void Pt().warn(`未找到第 ${t} 楼的消息`);const s=r.swipe_id??0,a="current"==n?s:n,c="none"!=i?a:s,l=e.message??(r.swipes?r.swipes[a]:void 0)??r.mes,u=(()=>{if("current"===n)return!1;if(0==n||r.swipes&&n<r.swipes.length)return!0;r.swipes||(r.swipe_id=0,r.swipes=[r.mes],r.variables=[{}]);for(let e=r.swipes.length;e<=n;++e)r.swipes.push(""),r.variables.push({});return!0})();(()=>{const t=Z(l);e.data&&(r.variables||(r.variables=[]),r.variables[a]=e.data),r.swipes&&(r.swipes[a]=t,r.swipe_id=c),c===a&&(r.mes=t)})(),await j(),"all"==i?await D():await(async e=>{const n=$(`div.mes[mesid = "${t}"]`);n&&(e&&n.find(".swipes-counter").text(`${c+1}​/​${r.swipes.length}`),"none"!=i&&(n.find(".mes_text").empty().append(O(l,r.name,r.is_system,r.is_user,t)),"display_and_render_current"===i&&await p.emit(r.is_user?h.USER_MESSAGE_RENDERED:h.CHARACTER_MESSAGE_RENDERED,t)))})(u),Pt().info(`设置第 ${t} 楼消息, 选项: ${JSON.stringify({swipe_id:n,refresh:i})}, 设置前使用的消息页: ${s}, 设置的消息页: ${a}, 现在使用的消息页: ${c} `)}function Xo(e){const t=Z(e);return Pt().info(`替换字符串中的宏, 字符串: '${e}', 结果: '${t}'`),t}function Qo(){return Number(Xo("{{lastMessageId}}"))}function ec(e){const t=e=>{throw toastr.error(`${e.stack?e.stack:e.name+": "+e.message}`),e};return(...n)=>{try{const i=e(...n);return i instanceof Promise?i.catch(e=>{t(e)}):i}catch(e){return t(e)}}}function tc(){return this.frameElement.id}function nc(){return $(this.frameElement).attr("script-id")??"unknown_script"}function ic(){return rc(tc.call(this))}function rc(e){const t=e.match(/^message-iframe-(\d+)-\d+$/);if(!t)throw Error(`获取 ${e} 所在楼层 id 时出错: 不要对全局脚本 iframe 调用 getMessageId!`);return parseInt(t[1].toString())}const sc=_;var ac=ft.n(sc);function oc({type:e="chat",message_id:t="latest",script_id:n}={}){const i=function({type:e="chat",message_id:t="latest",script_id:n}){switch(e){case"message":if("latest"!==t&&(t<-o.length||t>=o.length))throw Error(`提供的 message_id(${t}) 超出了聊天消息楼层号范围`);return qo(t="latest"===t?-1:t)[0].data;case"chat":{const e=c;return e.variables||(e.variables={}),e.variables}case"character":return a[H]?.data?.extensions?.TavernHelper_characterScriptVariables||{};case"global":return Y.variables.global;case"script":{if(!n)throw Error("获取脚本变量失败, 未指定 script_id");const e=ji.getInstance();if(!e.getScriptById(n))throw Error(`获取脚本变量失败, '${n}' 脚本不存在`);return e.getScriptVariables(n)}}}({type:e,message_id:t,script_id:n});return Pt().info(`获取${"message"===e?`'${t}' 消息`:"chat"===e?"聊天":"character"===e?"角色":"script"===e?`'${n}' 脚本`:"全局"}变量表:\n${JSON.stringify(i)}`),structuredClone(i)}function cc(){const e=tc.call(this).startsWith("message-iframe");let t=ac().merge({},Y.variables.global,a[H]?.data?.extensions?.TavernHelper_characterScriptVariables);return e||(t=ac().merge(t,oc({type:"script",script_id:nc.call(this)}))),t=ac().merge(t,c.variables),e&&(t=ac().merge(t,...o.slice(0,ic.call(this)).map(e=>e?.variables?.[e?.swipe_id??0]))),structuredClone(t)}async function lc(e,{type:t="chat",message_id:n="latest",script_id:i}={}){switch(t){case"message":if("latest"!==n&&(n<-o.length||n>=o.length))throw Error(`提供的 message_id(${n}) 超出了聊天消息楼层号范围`);n="latest"===n?o.length-1:n<0?o.length+n:n,await Ho([{message_id:n,data:e}],{refresh:"none"});break;case"chat":ac().set(c,"variables",e),await P();break;case"character":if(!H)throw new Error("保存变量失败，当前角色为空");await te(H,"TavernHelper_characterScriptVariables",e),p.emit("character_variables_changed",{variables:e});break;case"global":ac().set(Y.variables,"global",e),await U();break;case"script":if(!i)throw Error("保存变量失败, 未指定 script_id");{const t=ji.getInstance(),n=t.getScriptById(i);if(!n)throw Error(`保存变量失败, '${i}' 脚本不存在`);const r=t.scriptData.getScriptType(n);await t.updateScriptVariables(i,e,r)}}Pt().info(`将${"message"===t?`'${n}' 消息`:"chat"===t?"聊天":"character"===t?"角色":"script"===t?`'${i}' 脚本`:"全局"}变量表替换为:\n${JSON.stringify(e)}`)}async function uc(e,{type:t="chat",message_id:n="latest",script_id:i}={}){let r=oc({type:t,message_id:n,script_id:i});return r=await e(r),Pt().info(`对${"message"===t?`'${n}' 消息`:"chat"===t?"聊天":"character"===t?"角色":"script"===t?`'${i}' 脚本`:"全局"}变量表进行更新`),await lc(r,{type:t,message_id:n,script_id:i}),r}async function dc(e,{type:t="chat",message_id:n="latest",script_id:i}={}){return await uc(t=>ac().merge(t,e),{type:t,message_id:n,script_id:i})}async function pc(e,{type:t="chat",message_id:n="latest",script_id:i}={}){return await uc(t=>ac().defaultsDeep(t,e),{type:t,message_id:n,script_id:i})}async function hc(e,{type:t="chat",message_id:n="latest",script_id:i}={}){let r=!1;return{variables:await uc(t=>(r=ac().unset(t,e),t),{type:t,message_id:n,script_id:i}),delete_occurred:r}}class fc{currentVariables=null;variableIdMap=new Map;activeVariableType="global";filterState={string:!0,array:!0,boolean:!0,number:!0,object:!0};searchKeyword="";floorMinRange=null;floorMaxRange=null;constructor(){}createVariableItem(e,t,n){const i=fe(),r={name:e,value:t,dataType:Vo.inferDataType(t),id:i,...void 0!==n&&{message_id:n}};return this.variableIdMap.set(i,r),r}getCurrentMapVariables(){return this.currentVariables?[...this.currentVariables]:[]}addToMap(e,t,n){const i=this.createVariableItem(e,t,n);return this.currentVariables||(this.currentVariables=[]),this.currentVariables.push(i),i}removeFromMap(e){if(!this.currentVariables)return!1;const t=this.currentVariables.findIndex(t=>t.id===e);return t>=0&&(this.currentVariables.splice(t,1),this.variableIdMap.delete(e),!0)}updateInMap(e,t,n,i){if(!this.currentVariables)return!1;const r=this.currentVariables.find(t=>t.id===e);return!!r&&(r.name=t,r.value=n,r.dataType=Vo.inferDataType(n),void 0!==i&&(r.message_id=i),this.variableIdMap.set(e,r),!0)}clearVariableIdMap(){this.variableIdMap.clear()}getVariableById(e){return this.variableIdMap.get(e)}convertTavernVariablesToItems(e,t){return Object.entries(e).map(([e,n])=>this.createVariableItem(e,n,t))}convertItemsToTavernVariables(e,t){const n={};for(const i of e)void 0!==t?i.message_id===t&&(n[i.name]=i.value):n[i.name]=i.value;return n}async loadFromTavern(e){this.clearVariableIdMap();try{if(this.activeVariableType=e,"message"===e){this.currentVariables=[];const[e,t]=this.getFloorRange();if(null!==e||null!==t){const n=t??e??0;for(let t=e??0;t<=n;t++)try{const e=this.getFloorVariables(t),n=this.convertTavernVariablesToItems(e,t);this.currentVariables.push(...n)}catch(e){Pt().warn(`[VariableModel] 加载第${t}层变量失败:`,e)}}}else{const t=oc({type:e});this.currentVariables=this.convertTavernVariablesToItems(t)}return this.currentVariables}catch(t){return Pt().error(`[VariableManager] 加载${e}变量失败:`,t),[]}}async saveAllVariables(e,t){if(this.currentVariables){if("message"===e){const[e,n]=this.getFloorRange();if(null===e||null===n)return void Pt().warn("[VariableModel] 保存message变量失败: 未设置有效的楼层范围");if(void 0!==t&&t>=e&&t<=n){const e=this.currentVariables.filter(e=>e.message_id===t),n=this.convertItemsToTavernVariables(e,t);try{await lc(n,{type:"message",message_id:t}),Pt().info(`[VariableManager] 成功保存第${t}层变量`)}catch(e){Pt().error(`[VariableManager] 保存第${t}层变量失败:`,e)}}else for(let t=e;t<=n;t++){const e=this.currentVariables.filter(e=>e.message_id===t),n=this.convertItemsToTavernVariables(e,t);try{await lc(n,{type:"message",message_id:t})}catch(e){Pt().error(`[VariableManager] 保存第${t}层变量失败:`,e)}}}else{const t=this.convertItemsToTavernVariables(this.currentVariables);await lc(t,{type:e})}Pt().info("[VariableManager] 保存变量成功")}else Pt().warn("[VariableModel] 当前没有变量数据，跳过保存")}getActiveVariableType(){return this.activeVariableType}async updateListOrder(e,t,n,i){if(e===this.activeVariableType&&this.currentVariables){const r=this.currentVariables.find(e=>e.name===t);if(r&&Array.isArray(r.value)){if(r.value=n,i){const e=this.variableIdMap.get(i);e&&(e.value=n,this.variableIdMap.set(i,e))}await this.saveAllVariables(e,r.message_id)}}}async clearAllVariables(e){if(e===this.activeVariableType&&(this.currentVariables=[],this.clearVariableIdMap()),"message"===e){const[e,t]=this.getFloorRange();if(null===e||null===t)return void Pt().warn("[VariableModel] 清除message变量失败: 未设置有效的楼层范围");for(let n=e;n<=t;n++)try{const e={};await lc(e,{type:"message",message_id:n})}catch(e){Pt().error(`[VariableModel] 清除第${n}层变量失败:`,e)}}else{const t={};await lc(t,{type:e})}}updateFilterState(e,t){this.filterState[e]=t}getFilterState(){return this.filterState}updateSearchKeyword(e){this.searchKeyword=e}getSearchKeyword(){return this.searchKeyword}updateFloorRange(e,t){null!==e&&(e=Math.max(0,e)),null!==t&&(t=Math.max(0,t)),null!==e&&null!==t&&e>t&&([e,t]=[t,e]),this.floorMinRange=e,this.floorMaxRange=t,"message"===this.activeVariableType&&(this.currentVariables=null)}getFloorRange(){return[this.floorMinRange,this.floorMaxRange]}getFloorVariables(e){try{return oc({type:"message",message_id:e})||{}}catch(t){return Pt().error(`获取第${e}层变量失败:`,t),{}}}findVariableId(e,t){for(const n of this.variableIdMap.keys()){const i=this.variableIdMap.get(n);if(i&&i.name===e){if(void 0===t)return n;if(i.message_id===t)return n}}}getVariablesByMessageId(e){return this.currentVariables?this.currentVariables.filter(t=>t.message_id===e):[]}getVariablesWithoutMessageId(){return this.currentVariables?this.currentVariables.filter(e=>void 0===e.message_id):[]}getVariablesByName(e){return this.currentVariables?this.currentVariables.filter(t=>t.name===e):[]}findVariableByName(e,t){if(this.currentVariables)for(const n of this.currentVariables)if(n.name===e){if(void 0===t)return n;if(n.message_id===t)return n}}syncCurrentVariables(e,t,n){this.currentVariables||(this.currentVariables=[]),t.forEach(e=>{const t=this.currentVariables.findIndex(t=>t.id===e);t>=0&&(this.currentVariables.splice(t,1),this.variableIdMap.delete(e))}),e.forEach(e=>{this.currentVariables.push(e),this.variableIdMap.set(e.id,e)}),n.forEach(e=>{const t=this.currentVariables.findIndex(t=>t.id===e.id);t>=0&&(this.currentVariables[t]=e,this.variableIdMap.set(e.id,e))})}}const mc={GLOBAL:"settings_updated",CHARACTER:"character_variables_changed",MESSAGE:"message_variables_changed",CHAT:""};class gc{domUpdater;model;currentType=null;_boundListeners={global:{bound:!1,handler:this._handleVariableUpdate.bind(this,"global")},character:{bound:!1,handler:this._handleVariableUpdate.bind(this,"character")},chat:{bound:!1,handler:this._handleVariableUpdate.bind(this,"chat")},message:{bound:!1,handler:this._handleVariableUpdate.bind(this,"message")}};_chatPollingInterval=null;constructor(e,t){this.domUpdater=e,this.model=t}async cleanup(){this._unbindAllEventListeners(),this._stopChatPolling(),this.currentType=null}async initCurrentType(){this.currentType="global",this._activateCurrentListeners()}async setCurrentType(e){this.currentType!==e&&(this._deactivateCurrentListeners(),this.currentType=e,this._activateCurrentListeners())}reactivateListeners(){this._deactivateCurrentListeners(),this._activateCurrentListeners()}deactivateListeners(){this._deactivateCurrentListeners()}_activateCurrentListeners(){this.currentType&&("chat"===this.currentType?this._startChatPolling():this._bindVariableListener(this.currentType))}_deactivateCurrentListeners(){this._unbindAllEventListeners(),this._stopChatPolling()}_bindVariableListener(e){if("chat"===e)return;const t=mc[e.toUpperCase()],n=this._boundListeners[e];if(!n.bound&&t)try{p.on(t,n.handler),this._boundListeners[e].bound=!0,Pt().info(`[VariableManager]：开始同步监听${e}变量`)}catch(t){Pt().error(`[VariableManager]：绑定${e}变量事件监听器时出错:`,t),this._boundListeners[e].bound=!1}}_unbindAllEventListeners(){for(const e of Object.keys(this._boundListeners)){if("chat"===e)continue;const t=mc[e.toUpperCase()],n=this._boundListeners[e];if(n.bound&&t)try{p.removeListener(t,n.handler),this._boundListeners[e].bound=!1}catch(t){Pt().error(`[VariableManager]：解绑${e}变量事件监听器时出错:`,t),this._boundListeners[e].bound=!1}}}_startChatPolling(){if(this._stopChatPolling(),"chat"===this.currentType)try{this._chatPollingInterval=window.setInterval(async()=>{await this._handleVariableUpdate("chat")},2e3)}catch(e){Pt().error("[VariableManager]：启动聊天变量轮询时出错:",e),this._chatPollingInterval=null}}_stopChatPolling(){if(null!==this._chatPollingInterval)try{window.clearInterval(this._chatPollingInterval),this._chatPollingInterval=null}catch(e){Pt().error("[VariableManager]：停止聊天变量轮询时出错:",e)}}async _handleVariableUpdate(e,t){if(this.currentType&&this.currentType===e)try{let n,i;("character"===e||"message"===e)&&t&&t.variables?(n=t.variables,i=t.message_id):n=oc({type:e});const r=this.model.getCurrentMapVariables(),{added:s,removed:a,updated:o}=this._compareTavernVariables(r,n,i);this._processDiff(s,a,o,n,i)}catch(t){Pt().error(`[VariableManager]：处理${e}变量更新时出错:`,t)}}_compareTavernVariables(e,t,n){const i=new Map;e.forEach(e=>{void 0!==n?e.message_id===n&&i.set(e.name,e.value):void 0===e.message_id&&i.set(e.name,e.value)});const r=new Set(i.keys()),s=new Set(Object.keys(t));return{added:[...s].filter(e=>!r.has(e)),removed:[...r].filter(e=>!s.has(e)),updated:[...s].filter(e=>r.has(e)&&!_.isEqual(i.get(e),t[e]))}}_processDiff(e,t,n,i,r){const s=[],a=[],o=[];e.forEach(e=>{const t=this.model.createVariableItem(e,i[e],r);this.domUpdater.addVariableCard(t),s.push(t)}),t.forEach(e=>{const t=this.model.findVariableByName(e,r);t&&(this.domUpdater.removeVariableCard(t.id),a.push(t.id))}),n.forEach(e=>{const t=this.model.findVariableByName(e,r);t&&(t.value=i[e],t.dataType=Vo.inferDataType(t.value),this.domUpdater.updateVariableCard(t),o.push(t))}),this.model.syncCurrentVariables(s,a,o)}}class vc{defaultTypeDialogCallback;constructor(e){this.defaultTypeDialogCallback=e,this.setupGlobalEventDelegation()}setupGlobalEventDelegation(){$(document).on("click",".variable-action-btn.object-save-btn",e=>{e.stopPropagation(),e.stopImmediatePropagation();const t=$(e.currentTarget).closest(".variable-card"),n=this.findTopLevelCard(t);n&&this.saveNestedCardValue(n)}),$(document).on("click",".variable-action-btn.object-delete-btn",e=>{e.stopPropagation(),e.stopImmediatePropagation();const t=$(e.currentTarget).closest(".variable-card"),n=this.findTopLevelCard(t);n&&this.deleteNestedCardValue(n,t)}),$(document).on("click",".variable-action-btn.add-nested-key-btn",async e=>{e.stopPropagation(),e.stopImmediatePropagation();const t=$(e.currentTarget).closest(".variable-card"),n=this.defaultTypeDialogCallback;n?await n(e=>{this.addObjectKey(t,e,this.defaultTypeDialogCallback)}):(Pt().error("添加卡片出错"),toastr.error("添加卡片出错"))}),$(document).on("click",".variable-action-btn.add-key-btn",async e=>{e.stopPropagation(),e.stopImmediatePropagation();const t=$(e.currentTarget).closest(".variable-card"),n=this.defaultTypeDialogCallback;n?await n(e=>{this.addObjectKey(t,e,this.defaultTypeDialogCallback)}):(Pt().error("未提供类型选择对话框回调函数"),toastr.error("未提供类型选择对话框回调函数"))})}createCard(e,t,n){let i;const{name:r,value:s,dataType:a,id:o}=e;switch(i=$(`\n      <div class="variable-card" data-type="${a}" data-variable-id="${o}">\n        <div class="variable-card-header">\n          <div class="variable-title-container">\n            <i></i>\n            <input type="text" class="variable-title" value="${r}" placeholder="变量名称">\n          </div>\n          <div class="variable-actions">\n            <div class="variable-action-btn save-btn" title="保存">\n              <i class="fa-regular fa-save"></i>\n            </div>\n            <div class="variable-action-btn delete-btn" title="删除">\n              <i class="fa-regular fa-trash-can"></i>\n            </div>\n          </div>\n        </div>\n        <div class="variable-card-content">\n        </div>\n      </div>\n    `),t&&(i.removeAttr("data-variable-id"),i.find(".variable-action-btn.save-btn").removeClass("save-btn").addClass("object-save-btn").end().find(".variable-action-btn.delete-btn").removeClass("delete-btn").addClass("object-delete-btn")),a){case"array":i.find(".variable-title-container i").addClass("fa-solid fa-list").end().find(".variable-card-content").append('<div class="list-items-container"></div><div class="add-list-item"><i class="fa-solid fa-plus"></i> 添加项目</div>'),this.populateArrayItems(i,s);i.find(".list-items-container").sortable({delay:ue(),handle:".drag-handle"});break;case"object":i.find(".variable-title-container i").addClass("fa-regular fa-code"),this.setupObjectCard(i,e,t,n);break;case"boolean":i.find(".variable-title-container i").addClass("fa-regular fa-toggle-on").end().find(".variable-card-content").append(`\n              <div class="boolean-input-container">\n                <div class="boolean-buttons-container">\n                  <div class="boolean-btn ${s?"active":""}" data-value="true">True</div>\n                  <div class="boolean-btn ${s?"":"active"}" data-value="false">False</div>\n                </div>\n              </div>\n            `).find(".boolean-btn").on("click",function(){i.find(".boolean-btn").removeClass("active"),$(this).addClass("active")});break;case"number":i.find(".variable-title-container i").addClass("fa-solid fa-hashtag").end().find(".variable-card-content").append(`<input type="number" class="number-input variable-content-input" value="${s}" step="any">`);break;case"string":i.find(".variable-title-container i").addClass("fa-solid fa-font").end().find(".variable-card-content").append(`<textarea class="string-input variable-content-input" placeholder="输入字符串值">${s}</textarea>`)}return i}getVariableFromCard(e){const t=e.attr("data-variable-id")||"",n=e.find(".variable-title").val(),i=e.attr("data-type");return{id:t,name:n,dataType:i,value:this.extractValueFromCard(e,i)}}extractValueFromCard(e,t){switch(t){case"string":return e.find(".string-input").val();case"number":{const t=e.find(".number-input").val();return t?parseFloat(t):0}case"boolean":return"true"===e.find(".boolean-btn.active").attr("data-value");case"array":{const t=[];return e.find(".list-item").each((e,n)=>{const i=$(n).find(".variable-content-input").val();try{t.push(Po.parse(i))}catch{t.push(i)}}),t}case"object":{if("card"===(e.attr("data-view-mode")||"card")){return this.extractObjectFromNestedCards(e)}const t=e.find(".yaml-input").val();if(!t||!t.trim()){return this.extractObjectFromNestedCards(e)}try{return Po.parse(t)}catch(e){return Pt().error("YAML解析错误:",e),toastr.error("YAML解析错误"),{}}}default:return e.find(".variable-content-input").val()}}extractObjectFromNestedCards(e){const t={};let n=e.find("> .variable-card-content > .object-card-view > .nested-cards-container");return 0===n.length&&(n=e.find("> .variable-card-content > .nested-object-container > .nested-cards-container")),0===n.length&&(n=e.find(".nested-cards-container").first()),n.children(".variable-card").each((e,n)=>{const i=$(n),r=i.find(".variable-title").val(),s=i.attr("data-type");if(Pt().info("[VariableManager] 处理嵌套卡片:",{index:e,key:r,dataType:s,cardHtml:i[0].outerHTML.substring(0,200)+"..."}),r){const e=this.extractValueFromCard(i,s);t[r]=e}else Pt().warn("[VariableManager] 跳过空键的嵌套卡片:",e)}),Pt().info("[VariableManager] 最终提取结果:",t),t}renderObjectCardView(e,t,n){const i=e.find(".nested-cards-container");i.empty(),t.value&&"object"==typeof t.value&&Object.entries(t.value).forEach(([e,t])=>{const r={name:e,dataType:Vo.inferDataType(t),value:t,id:""},s=this.createCard(r,!0,n);i.append(s)})}saveNestedCardValue(e){this.syncCardViewToYamlInput(e);const t=this.findTopLevelCard(e);t&&t.trigger("nested-card:changed")}findTopLevelCard(e){if(e.attr("data-variable-id"))return e;const t=e.closest("[data-variable-id]");return t.length>0?t:null}deleteNestedCardValue(e,t){t.remove(),this.syncCardViewToYamlInput(e);const n=this.findTopLevelCard(e);n&&n.trigger("nested-card:changed")}addObjectKey(e,t,n){const i=Vo.getDefaultValueForType(t),r=new Set,s=e.closest(".variable-card");s.find(".nested-cards-container").first().children(".variable-card").each((e,t)=>{const n=$(t).find(".variable-title").val();n&&r.add(n)});const a={name:Vo.generateUniqueKey(r),dataType:t,value:i,id:""},o=this.createCard(a,!0,n);s.find(".variable-card-header").first().siblings(".variable-card-content").first().find(".nested-cards-container").first().prepend(o),o.find(".variable-title").focus().select();const c=this.findTopLevelCard(s);c&&c.is(s)&&this.syncCardViewToYamlInput(s)}setupObjectCard(e,t,n,i){n?(e.find(".variable-card-content").append('\n        <div class="nested-object-container">\n          <div class="nested-cards-container"></div>\n        </div>\n      '),e.find(".variable-actions .object-save-btn").before('\n        <div class="variable-action-btn add-nested-key-btn" title="添加键值对">\n          <i class="fa-regular fa-plus"></i>\n        </div>\n      ')):(e.find(".variable-card-content").append('\n        <textarea class="yaml-input variable-content-input" placeholder="输入YAML对象" style="display: none;"></textarea>\n            <div class="object-card-view">\n              <div class="nested-cards-container"></div>\n            </div>\n      '),e.find(".variable-actions .save-btn").before('\n        <div class="variable-action-btn toggle-view-btn" title="切换到YAML视图">\n          <i class="fa-regular fa-list"></i>\n        </div>\n        <div class="variable-action-btn add-key-btn" title="添加键值对">\n          <i class="fa-regular fa-plus"></i>\n        </div>\n      '),e.find(".variable-actions .delete-btn").after('\n        <div class="variable-action-btn collapse-btn flex" title="折叠">\n          <i class="fa-solid fa-chevron-down"></i>\n        </div>\n      '),e.find(".variable-card-content").addClass("expanded"),e.find(".collapse-btn").addClass("expanded"),e.find(".collapse-btn").on("click",()=>{const t=e.find(".collapse-btn"),n=e.children(".variable-card-content");t.toggleClass("expanded"),n.toggleClass("expanded")}),e.find(".yaml-input").val(Po.stringify(t.value,null,2)).end().attr("data-view-mode","card"),e.find(".yaml-input").on("blur change",()=>{"card"===(e.attr("data-view-mode")||"card")&&this.syncYamlInputToCardView(e,i)}),e.find(".toggle-view-btn").on("click",()=>{const t=e,n="yaml"===(t.attr("data-view-mode")||"card")?"card":"yaml";t.attr("data-view-mode",n),"yaml"===n?(t.find(".toggle-view-btn i").removeClass("fa-list").addClass("fa-eye").end().attr("title","切换到卡片视图"),t.find(".variable-action-btn.add-key-btn").hide(),t.find(".yaml-input").show().end().find(".object-card-view").hide(),this.syncCardViewToYamlInput(t)):(t.find(".toggle-view-btn i").removeClass("fa-eye").addClass("fa-list").end().attr("title","切换到YAML视图"),t.find(".variable-action-btn.add-key-btn").show(),t.find(".yaml-input").hide().end().find(".object-card-view").show(),this.syncYamlInputToCardView(t,i))}));try{this.renderObjectCardView(e,t,i)}catch(e){Pt().error("渲染初始对象卡片视图错误:",e),toastr.error("渲染对象卡片视图错误")}}syncCardViewToYamlInput(e){const t=this.extractObjectFromNestedCards(e);e.find(".yaml-input").val(Po.stringify(t,null,2))}syncYamlInputToCardView(e,t){try{const n=e.find(".yaml-input").val();if(n&&n.trim()){const i=Po.parse(n),r={id:e.attr("data-variable-id")||"",name:e.find(".variable-title").val(),dataType:"object",value:i};this.renderObjectCardView(e,r,t)}}catch(e){Pt().error("YAML解析错误:",e),toastr.error("YAML格式错误，无法同步到卡片视图")}}populateArrayItems(e,t){if(!t||0===t.length)return;const n=e.find(".list-items-container");n.empty(),t.forEach(e=>{const t="object"==typeof e?Po.stringify(e):String(e),i=$(`\n        <div class="list-item">\n          <span class="drag-handle">☰</span>\n          <textarea class="variable-content-input">${t}</textarea>\n          <div class="list-item-delete"><i class="fa-solid fa-times"></i></div>\n        </div>\n      `);n.append(i)})}}class yc{static DIALOG_ID="variable-manager";container;cardFactory;dialog=null;controller=null;constructor(e){this.container=e,this.cardFactory=new vc(this.showVariableTypeDialog.bind(this))}setController(e){this.controller=e}initUI(){this.container.find("#global-tab").addClass("active"),this.container.find("#global-content").addClass("active"),this.container.find("#floor-filter-container").hide(),this.initSortable(),this.initFloorFilter()}initSortable(){this.container.find(".list-items-container").sortable({delay:ue(),handle:".drag-handle",stop:function(e,t){const n=$(t.item).closest(".list-items-container"),i=[];n.find(".variable-content-input").each(function(){i.push($(this).val())});const r=ac().uniqBy(i,e=>e.trim().toLowerCase());ac().isEqual(i,r)||(n.empty(),r.forEach(e=>{const t=`\n              <div class="list-item">\n                <span class="drag-handle">☰</span>\n                <textarea class="variable-content-input">${e}</textarea>\n                <button class="list-item-delete"><i class="fa-solid fa-times"></i></button>\n              </div>\n            `;n.append(t)})),n.trigger("sortupdate")}})}initFloorFilter(){this.container.find("#floor-filter-btn").on("click",()=>{const e=this.container.find("#floor-min").val(),t=this.container.find("#floor-max").val(),n=e.trim()?parseInt(e,10):null,i=t.trim()?parseInt(t,10):null;e.trim()&&isNaN(n)||t.trim()&&isNaN(i)?this.showFloorFilterError("请输入有效的楼层数值"):null!==n&&n<0?this.showFloorFilterError("最小楼层不能小于0"):null!==i&&i<0?this.showFloorFilterError("最大楼层不能小于0"):null!==n&&null!==i&&i<n?this.showFloorFilterError("最大楼层不能小于最小楼层"):null!==n||null!==i?this.hideFloorFilterError():this.showFloorFilterError("请至少设置最小楼层或最大楼层")}),this.container.find("#floor-min, #floor-max").on("input",()=>{const e=this.container.find("#floor-min").val(),t=this.container.find("#floor-max").val(),n=e.trim()?parseInt(e,10):null,i=t.trim()?parseInt(t,10):null;null!==n&&n<0?this.showFloorFilterError("最小楼层不能小于0"):null!==i&&i<0?this.showFloorFilterError("最大楼层不能小于0"):null!==n&&null!==i&&!isNaN(n)&&!isNaN(i)&&i<n?this.showFloorFilterError("最大楼层不能小于最小楼层"):this.hideFloorFilterError()})}showFloorFilterError(e){this.container.find("#floor-filter-error").text(e).show()}hideFloorFilterError(){this.container.find("#floor-filter-error").hide()}updateFloorRangeInputs(e,t){this.container.find("#floor-min").val(null!==e?e.toString():""),this.container.find("#floor-max").val(null!==t?t.toString():""),this.hideFloorFilterError()}getActiveVariableType(){return this.container.find(".tab-item.active").attr("id")?.replace("-tab","")||"chat"}setActiveTab(e){this.container.find(".tab-item").removeClass("active"),this.container.find(".tab-content").removeClass("active"),this.container.find(`#${e}-tab`).addClass("active"),this.container.find(`#${e}-content`).addClass("active");const t=this.container.find("#floor-filter-container");if("message"===e){t.show();const[e,n]=this.getFloorRange();if(null===e&&null===n){const e=Qo(),t=Math.max(0,e-4),n=e;this.controller.model.updateFloorRange(t,n),this.updateFloorRangeInputs(t,n)}}else t.hide()}getFloorRange(){const e=this.container.find("#floor-min").val(),t=this.container.find("#floor-max").val();let n=e&&e.trim()?parseInt(e,10):null,i=t&&t.trim()?parseInt(t,10):null;return null!==n&&(n=Math.max(0,n)),null!==i&&(i=Math.max(0,i)),[null===n||isNaN(n)?null:n,null===i||isNaN(i)?null:i]}refreshVariableCards(e,t){this.container.find(".variable-type-label").text(`${e}变量`);const n=this.container.find(`#${e}-content`).find(".variable-list"),i=n.scrollTop()||0;if(n.empty(),0!==t.length)if("message"===e)this.renderMessageVariablesByFloor(n,t),n.scrollTop(i);else{for(const e of t){const t=this.cardFactory.createCard(e);n.append(t)}n.scrollTop(i)}else n.html('<div class="empty-state"><p>暂无变量</p></div>')}applyClientSideFilters(e,t){const n=this.getActiveVariableType(),i=this.container.find(`#${n}-content .variable-card`);let r=0;i.each((n,i)=>{const s=$(i),a=s.attr("data-type"),o=s.find(".variable-title").val()||"",c=e[a],l=!t||o.toLowerCase().includes(t.toLowerCase());c&&l?(s.show(),r++):s.hide()}),this.updateFilterEmptyState(n,r)}updateFilterEmptyState(e,t){const n=this.container.find(`#${e}-content .variable-list`),i=n.find(".filter-empty-state");if(0===t){n.find(".variable-card").length>0&&0===i.length&&n.append('<div class="filter-empty-state"><p>没有符合筛选条件的变量</p></div>')}else i.remove()}renderMessageVariablesByFloor(e,t){const n=new Map;for(const e of t)void 0!==e.message_id&&(n.has(e.message_id)||n.set(e.message_id,[]),n.get(e.message_id).push(e));const i=Array.from(n.keys()).sort((e,t)=>t-e);for(let t=0;t<i.length;t++){const r=i[t],s=n.get(r),a=0===t,o=this.createFloorPanel(r,a),c=o.find(".floor-panel-body");for(const e of s){const t=this.cardFactory.createCard(e);t.attr("data-floor-id",r.toString()),c.append(t)}e.append(o)}}createFloorPanel(e,t){const n=$(`\n      <div class="floor-panel" data-floor="${e}">\n        <div class="floor-panel-header flex spaceBetween alignItemsCenter">\n          <div class="floor-panel-title">${`# ${e} 楼`}</div>\n          <div class="floor-panel-icon ${t?"expanded":""}">\n            <i class="fa-solid fa-chevron-down"></i>\n          </div>\n        </div>\n        <div class="floor-panel-body ${t?"expanded":""}"></div>\n      </div>\n    `);return n.find(".floor-panel-header").on("click",function(){const e=$(this),t=e.find(".floor-panel-icon"),n=e.closest(".floor-panel").find(".floor-panel-body");t.toggleClass("expanded"),n.toggleClass("expanded")}),n}addNewVariableCard(e,t,n){const i=this.container.find(`#${e}-content`).find(".variable-list");i.find(".empty-state").remove();const r={name:"new_variable",value:Vo.getDefaultValueForType(t),dataType:t,id:fe()},s=this.cardFactory.createCard(r);s.attr("data-type",t),"message"===e&&void 0!==n?this.addCardToFloorPanel(i,s,n):(i.prepend(s),this.addAnimation(s,"variable-added",()=>{}))}addCardToFloorPanel(e,t,n){let i=e.find(`.floor-panel[data-floor="${n}"]`);if(0===i.length){const t=this.createFloorPanel(n,!0);this.insertFloorPanelInOrder(e,t,n),i=t}const r=i.find(".floor-panel-body");r.hasClass("expanded")||(i.find(".floor-panel-icon").addClass("expanded"),r.addClass("expanded")),t.attr("data-floor-id",n.toString()),r.prepend(t),this.addAnimation(t,"variable-added",()=>{})}insertFloorPanelInOrder(e,t,n){let i=!1;e.find(".floor-panel").each(function(){const e=parseInt($(this).attr("data-floor")||"0");if(n>e)return $(this).before(t),i=!0,!1}),i||e.prepend(t)}getVariableFromCard(e){return this.cardFactory.getVariableFromCard(e)}getVariableCardName(e){const t=this.getVariableFromCard(e);return t?.name||""}async showAddVariableDialog(e){"message"!==this.getActiveVariableType()?await this.showVariableTypeDialog(t=>{e(t)}):await this.showFloorInputDialog(async t=>{null!==t&&await this.showVariableTypeDialog(n=>{e(n,t)})})}async showFloorInputDialog(e){const t=$('\n      <div>\n        <h3>输入楼层号码</h3>\n        <div class="floor-input-dialog">\n          <input type="number" id="floor-input" min="0" placeholder="请输入楼层号码" />\n          <div id="floor-input-error" class="floor-filter-error" style="display: none">请输入有效的楼层号码</div>\n        </div>\n      </div>\n    '),n=t.find("#floor-input"),i=t.find("#floor-input-error"),r=Qo();r>=0&&n.val(r),n.on("input",function(){const e=parseInt($(this).val(),10);$(this).val()&&(isNaN(e)||e<0)?i.text("楼层号码不能小于0").show():i.hide()});if(!await ie(t,ne.CONFIRM,"",{okButton:"确认",cancelButton:"取消"}))return void e(null);const s=n.val(),a=parseInt(s,10);return!s.trim()||isNaN(a)?(i.text("请输入有效的楼层号码").show(),void setTimeout(()=>this.showFloorInputDialog(e),100)):a<0?(i.text("楼层号码不能小于0").show(),void setTimeout(()=>this.showFloorInputDialog(e),100)):void e(a)}async showVariableTypeDialog(e){const t=$('\n      <div>\n        <h3>选择变量类型</h3>\n        <div class="variable-type-options">\n          <div data-type="string"><i class="fa-regular fa-font"></i> 字符串</div>\n          <div data-type="number"><i class="fa-regular fa-hashtag"></i> 数字</div>\n          <div data-type="boolean"><i class="fa-regular fa-toggle-on"></i> 布尔值</div>\n          <div data-type="array"><i class="fa-regular fa-list"></i> 数组</div>\n          <div data-type="object"><i class="fa-regular fa-code"></i> 对象</div>\n        </div>\n      </div>\n    ');t.find(".variable-type-options div").on("click",function(){const t=$(this).attr("data-type");e(t),$(".popup").find(".popup-button-close").trigger("click")}),await ie(t,ne.DISPLAY)}async showConfirmDialog(e,t){t(!!await ie(e,ne.CONFIRM,"",{okButton:"确认",cancelButton:"取消"}))}render(){this.unrender();const e=Wn.getInstance(yc.DIALOG_ID);if(e)e.focus();else if(this.dialog=Wn.create({id:yc.DIALOG_ID,title:"变量管理器",width:"50vw",height:"70vh",mobileWidth:"80vw",mobileHeight:"70vh",minWidth:"15vw",minHeight:"30vh",mobileMinWidth:"70vw",mobileMinHeight:"30vh",onClose:()=>{this.cleanup()}}),this.dialog){this.dialog.render().append(this.container),this.container.show()}}unrender(){this.dialog&&(this.container.detach(),this.dialog.close(),this.dialog=null)}cleanup(){this.controller&&this.controller.cleanup(),this.dialog=null}addVariableCard(e){try{const t=this.cardFactory.createCard(e);t.attr("data-type",e.dataType);const n=this.getActiveVariableType(),i=this.container.find(`#${n}-content .variable-list`);"message"===n&&void 0!==e.message_id?this.addCardToFloorPanel(i,t,e.message_id):(i.find(".empty-state").remove(),i.append(t),this.addAnimation(t,"variable-added",()=>{}))}catch(t){Pt().error(`[VariableManager] 添加卡片"${e.name}"失败:`,t)}}removeVariableCard(e){try{if(!e)return void Pt().warn("[VariableManager] 变量ID为空，无法移除卡片");const t=this.container.find(`.variable-card[data-variable-id="${e}"]`);if(0===t.length)return void Pt().warn(`[VariableManager] 未找到ID为"${e}"的卡片`);this.addAnimation(t,"variable-deleted",()=>{t.remove(),this.checkAndShowEmptyState()})}catch(e){Pt().error("[VariableManager] 移除卡片失败:",e)}}checkAndShowEmptyState(){const e=this.getActiveVariableType(),t=this.container.find(`#${e}-content .variable-list`);0===t.find(".variable-card").length&&t.html('<div class="empty-state"><p>暂无变量</p></div>')}updateVariableCard(e){try{const t=this.container.find(`.variable-card[data-variable-id="${e.id}"]`);if(0===t.length)return void Pt().warn(`[VariableManager] 未找到ID为"${e.id}"的卡片`);const n=this.cardFactory.createCard(e);n.attr("data-type",e.dataType),void 0!==e.message_id&&n.attr("data-floor-id",e.message_id.toString()),t.replaceWith(n),this.addAnimation(n,"variable-changed",()=>{})}catch(e){Pt().error("[VariableManager] 更新卡片失败:",e)}}async showKeyNameInputDialog(e){const t=$('\n      <div>\n        <h3>输入键名</h3>\n        <div class="key-input-dialog">\n          <input type="text" id="key-input" placeholder="请输入键名" />\n          <div id="key-input-error" class="input-error" style="display: none">请输入有效的键名</div>\n        </div>\n      </div>\n    '),n=t.find("#key-input"),i=t.find("#key-input-error");if(!await ie(t,ne.CONFIRM,"",{okButton:"确认",cancelButton:"取消"}))return void e(null);const r=n.val();if(!r||""===r.trim())return i.show(),void setTimeout(()=>this.showKeyNameInputDialog(e),10);e(r.trim())}addAnimation(e,t,n){const i=`animation.${t}`;e.addClass(t),e[0].offsetHeight,e.off(`animationend.${i}`),e.on(`animationend.${i}`,function(){$(this).off(`animationend.${i}`),$(this).removeClass(t),n()})}}const _c=`${Ot}/src/component/variable_manager/public`;let bc=null,wc=null,$c=null,kc=null;async function Sc(){await pe(`/scripts/extensions/${_c}/style.css`,"css");const e=$(await Q(`${_c}`,"index"));$c=new fc,bc=new yc(e),kc=new gc(bc,$c),wc=new Zo($c,bc,kc,bc.cardFactory),bc.setController(wc),await wc.init(e),bc?bc.render():Pt().error("[VariableManager] 变量管理器未初始化")}const Ec=async()=>{await On(),fn()},Ic=e=>{An(parseInt(e,10))},xc=e=>{!function(e){const t=X(),n=parseInt($("#render-depth").val(),10),i=t.chat.length,r=e-1,s=e=>t.chat[e]??{},a=e=>{const t=$('[id^="message-iframe-'+e+'-"]');return t.length>0?t.get(0):null},o=e=>/```[\s\S]*?```/.test(e.mes);if(0===n){const e=s(r),t=o(e),n=a(r);if(!t&&!n)return;Nn(n),W(r,e),An(r)}else{let e=i-n;e<0&&(e=0);for(let t=e;t<=r;t++){const e=s(t),n=o(e),i=a(t);(n||i)&&(Nn(i),W(t,e),An(t))}}}(parseInt(e,10)),Dt("render.render_hide_style")&&fn()};function Tc(){!function(){const e=$(`\n  <div id="tavern-helper-render-container" class="list-group-item flex-container flexGap5 interactable tavern-helper-shortcut-item">\n      <div class="fa-solid fa-puzzle-piece extensionsMenuExtensionButton" /></div>\n      <span id="tavern-helper-render-text">${Dt("render.render_enabled")?"关闭前端渲染":"开启前端渲染"}</span>\n  </div>`);e.css("display","flex"),0===$("#tavern-helper-render-container").length&&$("#extensionsMenu").append(e),$("#tavern-helper-render-container").off("click").on("click",async function(){const e=Dt("render.render_enabled")??jn.render_enabled;await Un(!e,!0)})}(),function(){const e=$('\n  <div id="tavern-helper-prompt-view-container" class="list-group-item flex-container flexGap5 interactable tavern-helper-shortcut-item">\n      <div class="fa-solid fa-magnifying-glass extensionsMenuExtensionButton" /></div>\n      <span id="tavern-helper-variable-text">提示词查看器</span>\n  </div>');e.css("display","flex"),0===$("#tavern-helper-prompt-view-container").length&&$("#extensionsMenu").append(e),$("#tavern-helper-prompt-view-container").off("click").on("click",async function(){await ei()})}(),function(){const e=$('\n  <div id="tavern-helper-variable-container" class="list-group-item flex-container flexGap5 interactable tavern-helper-shortcut-item">\n      <div class="fa-solid fa-square-root-variable extensionsMenuExtensionButton" /></div>\n      <span id="tavern-helper-variable-text">变量管理器</span>\n  </div>');e.css("display","flex"),0===$("#tavern-helper-variable-container").length&&$("#extensionsMenu").append(e),$("#tavern-helper-variable-container").off("click").on("click",async function(){await Sc()})}()}async function Oc(e=!0,t=!0){e&&Lt("enabled_extension",t),t?($("#extension-status-icon").css("color","green").next().text("扩展已启用"),_n.set("iframe","\"use strict\";\nlet result = _(window);\nresult = result.set('SillyTavern', _.get(window.parent, 'SillyTavern').getContext());\nresult = result.set('TavernHelper', _.get(window.parent, 'TavernHelper'));\nresult = result.set('toastr', _.get(window.parent, 'toastr'));\nresult = result.set('log', _.get(window.parent, 'log'));\nresult = result.set('YAML', _.get(window.parent, 'YAML'));\nresult = result.set('z', _.get(window.parent, 'z'));\nresult = result.set('EjsTemplate', _.get(window.parent, 'EjsTemplate'));\nresult = result.set('Mvu', _.get(window.parent, 'Mvu'));\nresult = result.merge(result.get('TavernHelper'));\nresult = result.merge(...Object.entries(result.get('TavernHelper')._bind).map(([key, value]) => ({\n    [key.replace('_', '')]: value.bind(window),\n})));\nresult.value();\n$(window).on('pagehide', eventClearAll);\n"),_n.set("viewport_adjust_script",'\n$(window).on("message", function (event) {\n    if (event.originalEvent.data.request === "updateViewportHeight") {\n        const newHeight = event.originalEvent.data.newHeight;\n        $("html").css("--viewport-height", newHeight + "px");\n    }\n});\n'),function(){for(const[e,t]of pn.entries())me.registerMacro(e,t),Pt().info(`[Macro] 宏 "${e}" 注册成功`)}(),globalThis.toastr=toastr,bi(),wi.forEach(e=>{p.makeFirst(e,bi)}),async function(){await Bo()}(),Tc(),e&&Dt("render.rendering_optimize")&&Ln(),e&&Dt("render.render_hide_style")&&mn(),p.on("chatLoaded",Ec),xn.forEach(e=>{p.on(e,Ic)}),p.on(h.MESSAGE_DELETED,xc),e&&void 0!==H&&await D()):($("#extension-status-icon").css("color","red").next().text("扩展已禁用"),_n.delete("iframe"),_n.delete("viewport_adjust_script"),function(){for(const e of pn.keys())me.unregisterMacro(e),Pt().info(`[Macro] 宏 "${e}" 注销成功`)}(),wi.forEach(e=>{p.removeListener(e,bi)}),_i(),Go(),$("#extensionsMenu").find(".tavern-helper-shortcut-item").remove(),Dt("render.rendering_optimize")&&Rn(),Dt("render.render_hide_style")&&gn(),p.removeListener("chatLoaded",Ec),xn.forEach(e=>{p.removeListener(e,Ic)}),p.removeListener(h.MESSAGE_DELETED,xc),e&&void 0!==H&&await D()),M()}const Ac=Object.create(null);Ac.open="0",Ac.close="1",Ac.ping="2",Ac.pong="3",Ac.message="4",Ac.upgrade="5",Ac.noop="6";const Nc=Object.create(null);Object.keys(Ac).forEach(e=>{Nc[Ac[e]]=e});const Cc={type:"error",data:"parser error"},Dc="function"==typeof Blob||"undefined"!=typeof Blob&&"[object BlobConstructor]"===Object.prototype.toString.call(Blob),Lc="function"==typeof ArrayBuffer,Rc=e=>"function"==typeof ArrayBuffer.isView?ArrayBuffer.isView(e):e&&e.buffer instanceof ArrayBuffer,jc=({type:e,data:t},n,i)=>Dc&&t instanceof Blob?n?i(t):Pc(t,i):Lc&&(t instanceof ArrayBuffer||Rc(t))?n?i(t):Pc(new Blob([t]),i):i(Ac[e]+(t||"")),Pc=(e,t)=>{const n=new FileReader;return n.onload=function(){const e=n.result.split(",")[1];t("b"+(e||""))},n.readAsDataURL(e)};function Uc(e){return e instanceof Uint8Array?e:e instanceof ArrayBuffer?new Uint8Array(e):new Uint8Array(e.buffer,e.byteOffset,e.byteLength)}let Mc;const zc="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Fc="undefined"==typeof Uint8Array?[]:new Uint8Array(256);for(let e=0;e<64;e++)Fc[zc.charCodeAt(e)]=e;const Bc="function"==typeof ArrayBuffer,Gc=(e,t)=>{if("string"!=typeof e)return{type:"message",data:Zc(e,t)};const n=e.charAt(0);if("b"===n)return{type:"message",data:Vc(e.substring(1),t)};return Nc[n]?e.length>1?{type:Nc[n],data:e.substring(1)}:{type:Nc[n]}:Cc},Vc=(e,t)=>{if(Bc){const n=(e=>{let t,n,i,r,s,a=.75*e.length,o=e.length,c=0;"="===e[e.length-1]&&(a--,"="===e[e.length-2]&&a--);const l=new ArrayBuffer(a),u=new Uint8Array(l);for(t=0;t<o;t+=4)n=Fc[e.charCodeAt(t)],i=Fc[e.charCodeAt(t+1)],r=Fc[e.charCodeAt(t+2)],s=Fc[e.charCodeAt(t+3)],u[c++]=n<<2|i>>4,u[c++]=(15&i)<<4|r>>2,u[c++]=(3&r)<<6|63&s;return l})(e);return Zc(n,t)}return{base64:!0,data:e}},Zc=(e,t)=>"blob"===t?e instanceof Blob?e:new Blob([e]):e instanceof ArrayBuffer?e:e.buffer,qc=String.fromCharCode(30);function Hc(){return new TransformStream({transform(e,t){!function(e,t){Dc&&e.data instanceof Blob?e.data.arrayBuffer().then(Uc).then(t):Lc&&(e.data instanceof ArrayBuffer||Rc(e.data))?t(Uc(e.data)):jc(e,!1,e=>{Mc||(Mc=new TextEncoder),t(Mc.encode(e))})}(e,n=>{const i=n.length;let r;if(i<126)r=new Uint8Array(1),new DataView(r.buffer).setUint8(0,i);else if(i<65536){r=new Uint8Array(3);const e=new DataView(r.buffer);e.setUint8(0,126),e.setUint16(1,i)}else{r=new Uint8Array(9);const e=new DataView(r.buffer);e.setUint8(0,127),e.setBigUint64(1,BigInt(i))}e.data&&"string"!=typeof e.data&&(r[0]|=128),t.enqueue(r),t.enqueue(n)})}})}let Wc;function Jc(e){return e.reduce((e,t)=>e+t.length,0)}function Kc(e,t){if(e[0].length===t)return e.shift();const n=new Uint8Array(t);let i=0;for(let r=0;r<t;r++)n[r]=e[0][i++],i===e[0].length&&(e.shift(),i=0);return e.length&&i<e[0].length&&(e[0]=e[0].slice(i)),n}function Yc(e){if(e)return function(e){for(var t in Yc.prototype)e[t]=Yc.prototype[t];return e}(e)}Yc.prototype.on=Yc.prototype.addEventListener=function(e,t){return this._callbacks=this._callbacks||{},(this._callbacks["$"+e]=this._callbacks["$"+e]||[]).push(t),this},Yc.prototype.once=function(e,t){function n(){this.off(e,n),t.apply(this,arguments)}return n.fn=t,this.on(e,n),this},Yc.prototype.off=Yc.prototype.removeListener=Yc.prototype.removeAllListeners=Yc.prototype.removeEventListener=function(e,t){if(this._callbacks=this._callbacks||{},0==arguments.length)return this._callbacks={},this;var n,i=this._callbacks["$"+e];if(!i)return this;if(1==arguments.length)return delete this._callbacks["$"+e],this;for(var r=0;r<i.length;r++)if((n=i[r])===t||n.fn===t){i.splice(r,1);break}return 0===i.length&&delete this._callbacks["$"+e],this},Yc.prototype.emit=function(e){this._callbacks=this._callbacks||{};for(var t=new Array(arguments.length-1),n=this._callbacks["$"+e],i=1;i<arguments.length;i++)t[i-1]=arguments[i];if(n){i=0;for(var r=(n=n.slice(0)).length;i<r;++i)n[i].apply(this,t)}return this},Yc.prototype.emitReserved=Yc.prototype.emit,Yc.prototype.listeners=function(e){return this._callbacks=this._callbacks||{},this._callbacks["$"+e]||[]},Yc.prototype.hasListeners=function(e){return!!this.listeners(e).length};const Xc="function"==typeof Promise&&"function"==typeof Promise.resolve?e=>Promise.resolve().then(e):(e,t)=>t(e,0),Qc="undefined"!=typeof self?self:"undefined"!=typeof window?window:Function("return this")();function el(e,...t){return t.reduce((t,n)=>(e.hasOwnProperty(n)&&(t[n]=e[n]),t),{})}const tl=Qc.setTimeout,nl=Qc.clearTimeout;function il(e,t){t.useNativeTimers?(e.setTimeoutFn=tl.bind(Qc),e.clearTimeoutFn=nl.bind(Qc)):(e.setTimeoutFn=Qc.setTimeout.bind(Qc),e.clearTimeoutFn=Qc.clearTimeout.bind(Qc))}function rl(e){return"string"==typeof e?function(e){let t=0,n=0;for(let i=0,r=e.length;i<r;i++)t=e.charCodeAt(i),t<128?n+=1:t<2048?n+=2:t<55296||t>=57344?n+=3:(i++,n+=4);return n}(e):Math.ceil(1.33*(e.byteLength||e.size))}function sl(){return Date.now().toString(36).substring(3)+Math.random().toString(36).substring(2,5)}class al extends Error{constructor(e,t,n){super(e),this.description=t,this.context=n,this.type="TransportError"}}class ol extends Yc{constructor(e){super(),this.writable=!1,il(this,e),this.opts=e,this.query=e.query,this.socket=e.socket,this.supportsBinary=!e.forceBase64}onError(e,t,n){return super.emitReserved("error",new al(e,t,n)),this}open(){return this.readyState="opening",this.doOpen(),this}close(){return"opening"!==this.readyState&&"open"!==this.readyState||(this.doClose(),this.onClose()),this}send(e){"open"===this.readyState&&this.write(e)}onOpen(){this.readyState="open",this.writable=!0,super.emitReserved("open")}onData(e){const t=Gc(e,this.socket.binaryType);this.onPacket(t)}onPacket(e){super.emitReserved("packet",e)}onClose(e){this.readyState="closed",super.emitReserved("close",e)}pause(e){}createUri(e,t={}){return e+"://"+this._hostname()+this._port()+this.opts.path+this._query(t)}_hostname(){const e=this.opts.hostname;return-1===e.indexOf(":")?e:"["+e+"]"}_port(){return this.opts.port&&(this.opts.secure&&Number(443!==this.opts.port)||!this.opts.secure&&80!==Number(this.opts.port))?":"+this.opts.port:""}_query(e){const t=function(e){let t="";for(let n in e)e.hasOwnProperty(n)&&(t.length&&(t+="&"),t+=encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t}(e);return t.length?"?"+t:""}}class cl extends ol{constructor(){super(...arguments),this._polling=!1}get name(){return"polling"}doOpen(){this._poll()}pause(e){this.readyState="pausing";const t=()=>{this.readyState="paused",e()};if(this._polling||!this.writable){let e=0;this._polling&&(e++,this.once("pollComplete",function(){--e||t()})),this.writable||(e++,this.once("drain",function(){--e||t()}))}else t()}_poll(){this._polling=!0,this.doPoll(),this.emitReserved("poll")}onData(e){((e,t)=>{const n=e.split(qc),i=[];for(let e=0;e<n.length;e++){const r=Gc(n[e],t);if(i.push(r),"error"===r.type)break}return i})(e,this.socket.binaryType).forEach(e=>{if("opening"===this.readyState&&"open"===e.type&&this.onOpen(),"close"===e.type)return this.onClose({description:"transport closed by the server"}),!1;this.onPacket(e)}),"closed"!==this.readyState&&(this._polling=!1,this.emitReserved("pollComplete"),"open"===this.readyState&&this._poll())}doClose(){const e=()=>{this.write([{type:"close"}])};"open"===this.readyState?e():this.once("open",e)}write(e){this.writable=!1,((e,t)=>{const n=e.length,i=new Array(n);let r=0;e.forEach((e,s)=>{jc(e,!1,e=>{i[s]=e,++r===n&&t(i.join(qc))})})})(e,e=>{this.doWrite(e,()=>{this.writable=!0,this.emitReserved("drain")})})}uri(){const e=this.opts.secure?"https":"http",t=this.query||{};return!1!==this.opts.timestampRequests&&(t[this.opts.timestampParam]=sl()),this.supportsBinary||t.sid||(t.b64=1),this.createUri(e,t)}}let ll=!1;try{ll="undefined"!=typeof XMLHttpRequest&&"withCredentials"in new XMLHttpRequest}catch(e){}const ul=ll;function dl(){}class pl extends cl{constructor(e){if(super(e),"undefined"!=typeof location){const t="https:"===location.protocol;let n=location.port;n||(n=t?"443":"80"),this.xd="undefined"!=typeof location&&e.hostname!==location.hostname||n!==e.port}}doWrite(e,t){const n=this.request({method:"POST",data:e});n.on("success",t),n.on("error",(e,t)=>{this.onError("xhr post error",e,t)})}doPoll(){const e=this.request();e.on("data",this.onData.bind(this)),e.on("error",(e,t)=>{this.onError("xhr poll error",e,t)}),this.pollXhr=e}}class hl extends Yc{constructor(e,t,n){super(),this.createRequest=e,il(this,n),this._opts=n,this._method=n.method||"GET",this._uri=t,this._data=void 0!==n.data?n.data:null,this._create()}_create(){var e;const t=el(this._opts,"agent","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","autoUnref");t.xdomain=!!this._opts.xd;const n=this._xhr=this.createRequest(t);try{n.open(this._method,this._uri,!0);try{if(this._opts.extraHeaders){n.setDisableHeaderCheck&&n.setDisableHeaderCheck(!0);for(let e in this._opts.extraHeaders)this._opts.extraHeaders.hasOwnProperty(e)&&n.setRequestHeader(e,this._opts.extraHeaders[e])}}catch(e){}if("POST"===this._method)try{n.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch(e){}try{n.setRequestHeader("Accept","*/*")}catch(e){}null===(e=this._opts.cookieJar)||void 0===e||e.addCookies(n),"withCredentials"in n&&(n.withCredentials=this._opts.withCredentials),this._opts.requestTimeout&&(n.timeout=this._opts.requestTimeout),n.onreadystatechange=()=>{var e;3===n.readyState&&(null===(e=this._opts.cookieJar)||void 0===e||e.parseCookies(n.getResponseHeader("set-cookie"))),4===n.readyState&&(200===n.status||1223===n.status?this._onLoad():this.setTimeoutFn(()=>{this._onError("number"==typeof n.status?n.status:0)},0))},n.send(this._data)}catch(e){return void this.setTimeoutFn(()=>{this._onError(e)},0)}"undefined"!=typeof document&&(this._index=hl.requestsCount++,hl.requests[this._index]=this)}_onError(e){this.emitReserved("error",e,this._xhr),this._cleanup(!0)}_cleanup(e){if(void 0!==this._xhr&&null!==this._xhr){if(this._xhr.onreadystatechange=dl,e)try{this._xhr.abort()}catch(e){}"undefined"!=typeof document&&delete hl.requests[this._index],this._xhr=null}}_onLoad(){const e=this._xhr.responseText;null!==e&&(this.emitReserved("data",e),this.emitReserved("success"),this._cleanup())}abort(){this._cleanup()}}if(hl.requestsCount=0,hl.requests={},"undefined"!=typeof document)if("function"==typeof attachEvent)attachEvent("onunload",fl);else if("function"==typeof addEventListener){addEventListener("onpagehide"in Qc?"pagehide":"unload",fl,!1)}function fl(){for(let e in hl.requests)hl.requests.hasOwnProperty(e)&&hl.requests[e].abort()}const ml=function(){const e=gl({xdomain:!1});return e&&null!==e.responseType}();function gl(e){const t=e.xdomain;try{if("undefined"!=typeof XMLHttpRequest&&(!t||ul))return new XMLHttpRequest}catch(e){}if(!t)try{return new(Qc[["Active"].concat("Object").join("X")])("Microsoft.XMLHTTP")}catch(e){}}const vl="undefined"!=typeof navigator&&"string"==typeof navigator.product&&"reactnative"===navigator.product.toLowerCase();class yl extends ol{get name(){return"websocket"}doOpen(){const e=this.uri(),t=this.opts.protocols,n=vl?{}:el(this.opts,"agent","perMessageDeflate","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","localAddress","protocolVersion","origin","maxPayload","family","checkServerIdentity");this.opts.extraHeaders&&(n.headers=this.opts.extraHeaders);try{this.ws=this.createSocket(e,t,n)}catch(e){return this.emitReserved("error",e)}this.ws.binaryType=this.socket.binaryType,this.addEventListeners()}addEventListeners(){this.ws.onopen=()=>{this.opts.autoUnref&&this.ws._socket.unref(),this.onOpen()},this.ws.onclose=e=>this.onClose({description:"websocket connection closed",context:e}),this.ws.onmessage=e=>this.onData(e.data),this.ws.onerror=e=>this.onError("websocket error",e)}write(e){this.writable=!1;for(let t=0;t<e.length;t++){const n=e[t],i=t===e.length-1;jc(n,this.supportsBinary,e=>{try{this.doWrite(n,e)}catch(e){}i&&Xc(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){void 0!==this.ws&&(this.ws.onerror=()=>{},this.ws.close(),this.ws=null)}uri(){const e=this.opts.secure?"wss":"ws",t=this.query||{};return this.opts.timestampRequests&&(t[this.opts.timestampParam]=sl()),this.supportsBinary||(t.b64=1),this.createUri(e,t)}}const _l=Qc.WebSocket||Qc.MozWebSocket;const bl={websocket:class extends yl{createSocket(e,t,n){return vl?new _l(e,t,n):t?new _l(e,t):new _l(e)}doWrite(e,t){this.ws.send(t)}},webtransport:class extends ol{get name(){return"webtransport"}doOpen(){try{this._transport=new WebTransport(this.createUri("https"),this.opts.transportOptions[this.name])}catch(e){return this.emitReserved("error",e)}this._transport.closed.then(()=>{this.onClose()}).catch(e=>{this.onError("webtransport error",e)}),this._transport.ready.then(()=>{this._transport.createBidirectionalStream().then(e=>{const t=function(e,t){Wc||(Wc=new TextDecoder);const n=[];let i=0,r=-1,s=!1;return new TransformStream({transform(a,o){for(n.push(a);;){if(0===i){if(Jc(n)<1)break;const e=Kc(n,1);s=!(128&~e[0]),r=127&e[0],i=r<126?3:126===r?1:2}else if(1===i){if(Jc(n)<2)break;const e=Kc(n,2);r=new DataView(e.buffer,e.byteOffset,e.length).getUint16(0),i=3}else if(2===i){if(Jc(n)<8)break;const e=Kc(n,8),t=new DataView(e.buffer,e.byteOffset,e.length),s=t.getUint32(0);if(s>Math.pow(2,21)-1){o.enqueue(Cc);break}r=s*Math.pow(2,32)+t.getUint32(4),i=3}else{if(Jc(n)<r)break;const e=Kc(n,r);o.enqueue(Gc(s?e:Wc.decode(e),t)),i=0}if(0===r||r>e){o.enqueue(Cc);break}}}})}(Number.MAX_SAFE_INTEGER,this.socket.binaryType),n=e.readable.pipeThrough(t).getReader(),i=Hc();i.readable.pipeTo(e.writable),this._writer=i.writable.getWriter();const r=()=>{n.read().then(({done:e,value:t})=>{e||(this.onPacket(t),r())}).catch(e=>{})};r();const s={type:"open"};this.query.sid&&(s.data=`{"sid":"${this.query.sid}"}`),this._writer.write(s).then(()=>this.onOpen())})})}write(e){this.writable=!1;for(let t=0;t<e.length;t++){const n=e[t],i=t===e.length-1;this._writer.write(n).then(()=>{i&&Xc(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){var e;null===(e=this._transport)||void 0===e||e.close()}},polling:class extends pl{constructor(e){super(e);const t=e&&e.forceBase64;this.supportsBinary=ml&&!t}request(e={}){return Object.assign(e,{xd:this.xd},this.opts),new hl(gl,this.uri(),e)}}},wl=/^(?:(?![^:@\/?#]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@\/?#]*)(?::([^:@\/?#]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,$l=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];function kl(e){if(e.length>8e3)throw"URI too long";const t=e,n=e.indexOf("["),i=e.indexOf("]");-1!=n&&-1!=i&&(e=e.substring(0,n)+e.substring(n,i).replace(/:/g,";")+e.substring(i,e.length));let r=wl.exec(e||""),s={},a=14;for(;a--;)s[$l[a]]=r[a]||"";return-1!=n&&-1!=i&&(s.source=t,s.host=s.host.substring(1,s.host.length-1).replace(/;/g,":"),s.authority=s.authority.replace("[","").replace("]","").replace(/;/g,":"),s.ipv6uri=!0),s.pathNames=function(e,t){const n=/\/{2,9}/g,i=t.replace(n,"/").split("/");"/"!=t.slice(0,1)&&0!==t.length||i.splice(0,1);"/"==t.slice(-1)&&i.splice(i.length-1,1);return i}(0,s.path),s.queryKey=function(e,t){const n={};return t.replace(/(?:^|&)([^&=]*)=?([^&]*)/g,function(e,t,i){t&&(n[t]=i)}),n}(0,s.query),s}const Sl="function"==typeof addEventListener&&"function"==typeof removeEventListener,El=[];Sl&&addEventListener("offline",()=>{El.forEach(e=>e())},!1);class Il extends Yc{constructor(e,t){if(super(),this.binaryType="arraybuffer",this.writeBuffer=[],this._prevBufferLen=0,this._pingInterval=-1,this._pingTimeout=-1,this._maxPayload=-1,this._pingTimeoutTime=1/0,e&&"object"==typeof e&&(t=e,e=null),e){const n=kl(e);t.hostname=n.host,t.secure="https"===n.protocol||"wss"===n.protocol,t.port=n.port,n.query&&(t.query=n.query)}else t.host&&(t.hostname=kl(t.host).host);il(this,t),this.secure=null!=t.secure?t.secure:"undefined"!=typeof location&&"https:"===location.protocol,t.hostname&&!t.port&&(t.port=this.secure?"443":"80"),this.hostname=t.hostname||("undefined"!=typeof location?location.hostname:"localhost"),this.port=t.port||("undefined"!=typeof location&&location.port?location.port:this.secure?"443":"80"),this.transports=[],this._transportsByName={},t.transports.forEach(e=>{const t=e.prototype.name;this.transports.push(t),this._transportsByName[t]=e}),this.opts=Object.assign({path:"/engine.io",agent:!1,withCredentials:!1,upgrade:!0,timestampParam:"t",rememberUpgrade:!1,addTrailingSlash:!0,rejectUnauthorized:!0,perMessageDeflate:{threshold:1024},transportOptions:{},closeOnBeforeunload:!1},t),this.opts.path=this.opts.path.replace(/\/$/,"")+(this.opts.addTrailingSlash?"/":""),"string"==typeof this.opts.query&&(this.opts.query=function(e){let t={},n=e.split("&");for(let e=0,i=n.length;e<i;e++){let i=n[e].split("=");t[decodeURIComponent(i[0])]=decodeURIComponent(i[1])}return t}(this.opts.query)),Sl&&(this.opts.closeOnBeforeunload&&(this._beforeunloadEventListener=()=>{this.transport&&(this.transport.removeAllListeners(),this.transport.close())},addEventListener("beforeunload",this._beforeunloadEventListener,!1)),"localhost"!==this.hostname&&(this._offlineEventListener=()=>{this._onClose("transport close",{description:"network connection lost"})},El.push(this._offlineEventListener))),this.opts.withCredentials&&(this._cookieJar=void 0),this._open()}createTransport(e){const t=Object.assign({},this.opts.query);t.EIO=4,t.transport=e,this.id&&(t.sid=this.id);const n=Object.assign({},this.opts,{query:t,socket:this,hostname:this.hostname,secure:this.secure,port:this.port},this.opts.transportOptions[e]);return new this._transportsByName[e](n)}_open(){if(0===this.transports.length)return void this.setTimeoutFn(()=>{this.emitReserved("error","No transports available")},0);const e=this.opts.rememberUpgrade&&Il.priorWebsocketSuccess&&-1!==this.transports.indexOf("websocket")?"websocket":this.transports[0];this.readyState="opening";const t=this.createTransport(e);t.open(),this.setTransport(t)}setTransport(e){this.transport&&this.transport.removeAllListeners(),this.transport=e,e.on("drain",this._onDrain.bind(this)).on("packet",this._onPacket.bind(this)).on("error",this._onError.bind(this)).on("close",e=>this._onClose("transport close",e))}onOpen(){this.readyState="open",Il.priorWebsocketSuccess="websocket"===this.transport.name,this.emitReserved("open"),this.flush()}_onPacket(e){if("opening"===this.readyState||"open"===this.readyState||"closing"===this.readyState)switch(this.emitReserved("packet",e),this.emitReserved("heartbeat"),e.type){case"open":this.onHandshake(JSON.parse(e.data));break;case"ping":this._sendPacket("pong"),this.emitReserved("ping"),this.emitReserved("pong"),this._resetPingTimeout();break;case"error":const t=new Error("server error");t.code=e.data,this._onError(t);break;case"message":this.emitReserved("data",e.data),this.emitReserved("message",e.data)}}onHandshake(e){this.emitReserved("handshake",e),this.id=e.sid,this.transport.query.sid=e.sid,this._pingInterval=e.pingInterval,this._pingTimeout=e.pingTimeout,this._maxPayload=e.maxPayload,this.onOpen(),"closed"!==this.readyState&&this._resetPingTimeout()}_resetPingTimeout(){this.clearTimeoutFn(this._pingTimeoutTimer);const e=this._pingInterval+this._pingTimeout;this._pingTimeoutTime=Date.now()+e,this._pingTimeoutTimer=this.setTimeoutFn(()=>{this._onClose("ping timeout")},e),this.opts.autoUnref&&this._pingTimeoutTimer.unref()}_onDrain(){this.writeBuffer.splice(0,this._prevBufferLen),this._prevBufferLen=0,0===this.writeBuffer.length?this.emitReserved("drain"):this.flush()}flush(){if("closed"!==this.readyState&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length){const e=this._getWritablePackets();this.transport.send(e),this._prevBufferLen=e.length,this.emitReserved("flush")}}_getWritablePackets(){if(!(this._maxPayload&&"polling"===this.transport.name&&this.writeBuffer.length>1))return this.writeBuffer;let e=1;for(let t=0;t<this.writeBuffer.length;t++){const n=this.writeBuffer[t].data;if(n&&(e+=rl(n)),t>0&&e>this._maxPayload)return this.writeBuffer.slice(0,t);e+=2}return this.writeBuffer}_hasPingExpired(){if(!this._pingTimeoutTime)return!0;const e=Date.now()>this._pingTimeoutTime;return e&&(this._pingTimeoutTime=0,Xc(()=>{this._onClose("ping timeout")},this.setTimeoutFn)),e}write(e,t,n){return this._sendPacket("message",e,t,n),this}send(e,t,n){return this._sendPacket("message",e,t,n),this}_sendPacket(e,t,n,i){if("function"==typeof t&&(i=t,t=void 0),"function"==typeof n&&(i=n,n=null),"closing"===this.readyState||"closed"===this.readyState)return;(n=n||{}).compress=!1!==n.compress;const r={type:e,data:t,options:n};this.emitReserved("packetCreate",r),this.writeBuffer.push(r),i&&this.once("flush",i),this.flush()}close(){const e=()=>{this._onClose("forced close"),this.transport.close()},t=()=>{this.off("upgrade",t),this.off("upgradeError",t),e()},n=()=>{this.once("upgrade",t),this.once("upgradeError",t)};return"opening"!==this.readyState&&"open"!==this.readyState||(this.readyState="closing",this.writeBuffer.length?this.once("drain",()=>{this.upgrading?n():e()}):this.upgrading?n():e()),this}_onError(e){if(Il.priorWebsocketSuccess=!1,this.opts.tryAllTransports&&this.transports.length>1&&"opening"===this.readyState)return this.transports.shift(),this._open();this.emitReserved("error",e),this._onClose("transport error",e)}_onClose(e,t){if("opening"===this.readyState||"open"===this.readyState||"closing"===this.readyState){if(this.clearTimeoutFn(this._pingTimeoutTimer),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),Sl&&(this._beforeunloadEventListener&&removeEventListener("beforeunload",this._beforeunloadEventListener,!1),this._offlineEventListener)){const e=El.indexOf(this._offlineEventListener);-1!==e&&El.splice(e,1)}this.readyState="closed",this.id=null,this.emitReserved("close",e,t),this.writeBuffer=[],this._prevBufferLen=0}}}Il.protocol=4;class xl extends Il{constructor(){super(...arguments),this._upgrades=[]}onOpen(){if(super.onOpen(),"open"===this.readyState&&this.opts.upgrade)for(let e=0;e<this._upgrades.length;e++)this._probe(this._upgrades[e])}_probe(e){let t=this.createTransport(e),n=!1;Il.priorWebsocketSuccess=!1;const i=()=>{n||(t.send([{type:"ping",data:"probe"}]),t.once("packet",e=>{if(!n)if("pong"===e.type&&"probe"===e.data){if(this.upgrading=!0,this.emitReserved("upgrading",t),!t)return;Il.priorWebsocketSuccess="websocket"===t.name,this.transport.pause(()=>{n||"closed"!==this.readyState&&(l(),this.setTransport(t),t.send([{type:"upgrade"}]),this.emitReserved("upgrade",t),t=null,this.upgrading=!1,this.flush())})}else{const e=new Error("probe error");e.transport=t.name,this.emitReserved("upgradeError",e)}}))};function r(){n||(n=!0,l(),t.close(),t=null)}const s=e=>{const n=new Error("probe error: "+e);n.transport=t.name,r(),this.emitReserved("upgradeError",n)};function a(){s("transport closed")}function o(){s("socket closed")}function c(e){t&&e.name!==t.name&&r()}const l=()=>{t.removeListener("open",i),t.removeListener("error",s),t.removeListener("close",a),this.off("close",o),this.off("upgrading",c)};t.once("open",i),t.once("error",s),t.once("close",a),this.once("close",o),this.once("upgrading",c),-1!==this._upgrades.indexOf("webtransport")&&"webtransport"!==e?this.setTimeoutFn(()=>{n||t.open()},200):t.open()}onHandshake(e){this._upgrades=this._filterUpgrades(e.upgrades),super.onHandshake(e)}_filterUpgrades(e){const t=[];for(let n=0;n<e.length;n++)~this.transports.indexOf(e[n])&&t.push(e[n]);return t}}class Tl extends xl{constructor(e,t={}){const n="object"==typeof e?e:t;(!n.transports||n.transports&&"string"==typeof n.transports[0])&&(n.transports=(n.transports||["polling","websocket","webtransport"]).map(e=>bl[e]).filter(e=>!!e)),super(e,n)}}const Ol="function"==typeof ArrayBuffer,Al=Object.prototype.toString,Nl="function"==typeof Blob||"undefined"!=typeof Blob&&"[object BlobConstructor]"===Al.call(Blob),Cl="function"==typeof File||"undefined"!=typeof File&&"[object FileConstructor]"===Al.call(File);function Dl(e){return Ol&&(e instanceof ArrayBuffer||(e=>"function"==typeof ArrayBuffer.isView?ArrayBuffer.isView(e):e.buffer instanceof ArrayBuffer)(e))||Nl&&e instanceof Blob||Cl&&e instanceof File}function Ll(e,t){if(!e||"object"!=typeof e)return!1;if(Array.isArray(e)){for(let t=0,n=e.length;t<n;t++)if(Ll(e[t]))return!0;return!1}if(Dl(e))return!0;if(e.toJSON&&"function"==typeof e.toJSON&&1===arguments.length)return Ll(e.toJSON(),!0);for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t)&&Ll(e[t]))return!0;return!1}function Rl(e){const t=[],n=e.data,i=e;return i.data=jl(n,t),i.attachments=t.length,{packet:i,buffers:t}}function jl(e,t){if(!e)return e;if(Dl(e)){const n={_placeholder:!0,num:t.length};return t.push(e),n}if(Array.isArray(e)){const n=new Array(e.length);for(let i=0;i<e.length;i++)n[i]=jl(e[i],t);return n}if("object"==typeof e&&!(e instanceof Date)){const n={};for(const i in e)Object.prototype.hasOwnProperty.call(e,i)&&(n[i]=jl(e[i],t));return n}return e}function Pl(e,t){return e.data=Ul(e.data,t),delete e.attachments,e}function Ul(e,t){if(!e)return e;if(e&&!0===e._placeholder){if("number"==typeof e.num&&e.num>=0&&e.num<t.length)return t[e.num];throw new Error("illegal attachments")}if(Array.isArray(e))for(let n=0;n<e.length;n++)e[n]=Ul(e[n],t);else if("object"==typeof e)for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&(e[n]=Ul(e[n],t));return e}const Ml=["connect","connect_error","disconnect","disconnecting","newListener","removeListener"],zl=5;var Fl;!function(e){e[e.CONNECT=0]="CONNECT",e[e.DISCONNECT=1]="DISCONNECT",e[e.EVENT=2]="EVENT",e[e.ACK=3]="ACK",e[e.CONNECT_ERROR=4]="CONNECT_ERROR",e[e.BINARY_EVENT=5]="BINARY_EVENT",e[e.BINARY_ACK=6]="BINARY_ACK"}(Fl||(Fl={}));class Bl{constructor(e){this.replacer=e}encode(e){return e.type!==Fl.EVENT&&e.type!==Fl.ACK||!Ll(e)?[this.encodeAsString(e)]:this.encodeAsBinary({type:e.type===Fl.EVENT?Fl.BINARY_EVENT:Fl.BINARY_ACK,nsp:e.nsp,data:e.data,id:e.id})}encodeAsString(e){let t=""+e.type;return e.type!==Fl.BINARY_EVENT&&e.type!==Fl.BINARY_ACK||(t+=e.attachments+"-"),e.nsp&&"/"!==e.nsp&&(t+=e.nsp+","),null!=e.id&&(t+=e.id),null!=e.data&&(t+=JSON.stringify(e.data,this.replacer)),t}encodeAsBinary(e){const t=Rl(e),n=this.encodeAsString(t.packet),i=t.buffers;return i.unshift(n),i}}function Gl(e){return"[object Object]"===Object.prototype.toString.call(e)}class Vl extends Yc{constructor(e){super(),this.reviver=e}add(e){let t;if("string"==typeof e){if(this.reconstructor)throw new Error("got plaintext data when reconstructing a packet");t=this.decodeString(e);const n=t.type===Fl.BINARY_EVENT;n||t.type===Fl.BINARY_ACK?(t.type=n?Fl.EVENT:Fl.ACK,this.reconstructor=new Zl(t),0===t.attachments&&super.emitReserved("decoded",t)):super.emitReserved("decoded",t)}else{if(!Dl(e)&&!e.base64)throw new Error("Unknown type: "+e);if(!this.reconstructor)throw new Error("got binary data when not reconstructing a packet");t=this.reconstructor.takeBinaryData(e),t&&(this.reconstructor=null,super.emitReserved("decoded",t))}}decodeString(e){let t=0;const n={type:Number(e.charAt(0))};if(void 0===Fl[n.type])throw new Error("unknown packet type "+n.type);if(n.type===Fl.BINARY_EVENT||n.type===Fl.BINARY_ACK){const i=t+1;for(;"-"!==e.charAt(++t)&&t!=e.length;);const r=e.substring(i,t);if(r!=Number(r)||"-"!==e.charAt(t))throw new Error("Illegal attachments");n.attachments=Number(r)}if("/"===e.charAt(t+1)){const i=t+1;for(;++t;){if(","===e.charAt(t))break;if(t===e.length)break}n.nsp=e.substring(i,t)}else n.nsp="/";const i=e.charAt(t+1);if(""!==i&&Number(i)==i){const i=t+1;for(;++t;){const n=e.charAt(t);if(null==n||Number(n)!=n){--t;break}if(t===e.length)break}n.id=Number(e.substring(i,t+1))}if(e.charAt(++t)){const i=this.tryParse(e.substr(t));if(!Vl.isPayloadValid(n.type,i))throw new Error("invalid payload");n.data=i}return n}tryParse(e){try{return JSON.parse(e,this.reviver)}catch(e){return!1}}static isPayloadValid(e,t){switch(e){case Fl.CONNECT:return Gl(t);case Fl.DISCONNECT:return void 0===t;case Fl.CONNECT_ERROR:return"string"==typeof t||Gl(t);case Fl.EVENT:case Fl.BINARY_EVENT:return Array.isArray(t)&&("number"==typeof t[0]||"string"==typeof t[0]&&-1===Ml.indexOf(t[0]));case Fl.ACK:case Fl.BINARY_ACK:return Array.isArray(t)}}destroy(){this.reconstructor&&(this.reconstructor.finishedReconstruction(),this.reconstructor=null)}}class Zl{constructor(e){this.packet=e,this.buffers=[],this.reconPack=e}takeBinaryData(e){if(this.buffers.push(e),this.buffers.length===this.reconPack.attachments){const e=Pl(this.reconPack,this.buffers);return this.finishedReconstruction(),e}return null}finishedReconstruction(){this.reconPack=null,this.buffers=[]}}function ql(e,t,n){return e.on(t,n),function(){e.off(t,n)}}const Hl=Object.freeze({connect:1,connect_error:1,disconnect:1,disconnecting:1,newListener:1,removeListener:1});class Wl extends Yc{constructor(e,t,n){super(),this.connected=!1,this.recovered=!1,this.receiveBuffer=[],this.sendBuffer=[],this._queue=[],this._queueSeq=0,this.ids=0,this.acks={},this.flags={},this.io=e,this.nsp=t,n&&n.auth&&(this.auth=n.auth),this._opts=Object.assign({},n),this.io._autoConnect&&this.open()}get disconnected(){return!this.connected}subEvents(){if(this.subs)return;const e=this.io;this.subs=[ql(e,"open",this.onopen.bind(this)),ql(e,"packet",this.onpacket.bind(this)),ql(e,"error",this.onerror.bind(this)),ql(e,"close",this.onclose.bind(this))]}get active(){return!!this.subs}connect(){return this.connected||(this.subEvents(),this.io._reconnecting||this.io.open(),"open"===this.io._readyState&&this.onopen()),this}open(){return this.connect()}send(...e){return e.unshift("message"),this.emit.apply(this,e),this}emit(e,...t){var n,i,r;if(Hl.hasOwnProperty(e))throw new Error('"'+e.toString()+'" is a reserved event name');if(t.unshift(e),this._opts.retries&&!this.flags.fromQueue&&!this.flags.volatile)return this._addToQueue(t),this;const s={type:Fl.EVENT,data:t,options:{}};if(s.options.compress=!1!==this.flags.compress,"function"==typeof t[t.length-1]){const e=this.ids++,n=t.pop();this._registerAckCallback(e,n),s.id=e}const a=null===(i=null===(n=this.io.engine)||void 0===n?void 0:n.transport)||void 0===i?void 0:i.writable,o=this.connected&&!(null===(r=this.io.engine)||void 0===r?void 0:r._hasPingExpired());return this.flags.volatile&&!a||(o?(this.notifyOutgoingListeners(s),this.packet(s)):this.sendBuffer.push(s)),this.flags={},this}_registerAckCallback(e,t){var n;const i=null!==(n=this.flags.timeout)&&void 0!==n?n:this._opts.ackTimeout;if(void 0===i)return void(this.acks[e]=t);const r=this.io.setTimeoutFn(()=>{delete this.acks[e];for(let t=0;t<this.sendBuffer.length;t++)this.sendBuffer[t].id===e&&this.sendBuffer.splice(t,1);t.call(this,new Error("operation has timed out"))},i),s=(...e)=>{this.io.clearTimeoutFn(r),t.apply(this,e)};s.withError=!0,this.acks[e]=s}emitWithAck(e,...t){return new Promise((n,i)=>{const r=(e,t)=>e?i(e):n(t);r.withError=!0,t.push(r),this.emit(e,...t)})}_addToQueue(e){let t;"function"==typeof e[e.length-1]&&(t=e.pop());const n={id:this._queueSeq++,tryCount:0,pending:!1,args:e,flags:Object.assign({fromQueue:!0},this.flags)};e.push((e,...i)=>{if(n!==this._queue[0])return;return null!==e?n.tryCount>this._opts.retries&&(this._queue.shift(),t&&t(e)):(this._queue.shift(),t&&t(null,...i)),n.pending=!1,this._drainQueue()}),this._queue.push(n),this._drainQueue()}_drainQueue(e=!1){if(!this.connected||0===this._queue.length)return;const t=this._queue[0];t.pending&&!e||(t.pending=!0,t.tryCount++,this.flags=t.flags,this.emit.apply(this,t.args))}packet(e){e.nsp=this.nsp,this.io._packet(e)}onopen(){"function"==typeof this.auth?this.auth(e=>{this._sendConnectPacket(e)}):this._sendConnectPacket(this.auth)}_sendConnectPacket(e){this.packet({type:Fl.CONNECT,data:this._pid?Object.assign({pid:this._pid,offset:this._lastOffset},e):e})}onerror(e){this.connected||this.emitReserved("connect_error",e)}onclose(e,t){this.connected=!1,delete this.id,this.emitReserved("disconnect",e,t),this._clearAcks()}_clearAcks(){Object.keys(this.acks).forEach(e=>{if(!this.sendBuffer.some(t=>String(t.id)===e)){const t=this.acks[e];delete this.acks[e],t.withError&&t.call(this,new Error("socket has been disconnected"))}})}onpacket(e){if(e.nsp===this.nsp)switch(e.type){case Fl.CONNECT:e.data&&e.data.sid?this.onconnect(e.data.sid,e.data.pid):this.emitReserved("connect_error",new Error("It seems you are trying to reach a Socket.IO server in v2.x with a v3.x client, but they are not compatible (more information here: https://socket.io/docs/v3/migrating-from-2-x-to-3-0/)"));break;case Fl.EVENT:case Fl.BINARY_EVENT:this.onevent(e);break;case Fl.ACK:case Fl.BINARY_ACK:this.onack(e);break;case Fl.DISCONNECT:this.ondisconnect();break;case Fl.CONNECT_ERROR:this.destroy();const t=new Error(e.data.message);t.data=e.data.data,this.emitReserved("connect_error",t)}}onevent(e){const t=e.data||[];null!=e.id&&t.push(this.ack(e.id)),this.connected?this.emitEvent(t):this.receiveBuffer.push(Object.freeze(t))}emitEvent(e){if(this._anyListeners&&this._anyListeners.length){const t=this._anyListeners.slice();for(const n of t)n.apply(this,e)}super.emit.apply(this,e),this._pid&&e.length&&"string"==typeof e[e.length-1]&&(this._lastOffset=e[e.length-1])}ack(e){const t=this;let n=!1;return function(...i){n||(n=!0,t.packet({type:Fl.ACK,id:e,data:i}))}}onack(e){const t=this.acks[e.id];"function"==typeof t&&(delete this.acks[e.id],t.withError&&e.data.unshift(null),t.apply(this,e.data))}onconnect(e,t){this.id=e,this.recovered=t&&this._pid===t,this._pid=t,this.connected=!0,this.emitBuffered(),this.emitReserved("connect"),this._drainQueue(!0)}emitBuffered(){this.receiveBuffer.forEach(e=>this.emitEvent(e)),this.receiveBuffer=[],this.sendBuffer.forEach(e=>{this.notifyOutgoingListeners(e),this.packet(e)}),this.sendBuffer=[]}ondisconnect(){this.destroy(),this.onclose("io server disconnect")}destroy(){this.subs&&(this.subs.forEach(e=>e()),this.subs=void 0),this.io._destroy(this)}disconnect(){return this.connected&&this.packet({type:Fl.DISCONNECT}),this.destroy(),this.connected&&this.onclose("io client disconnect"),this}close(){return this.disconnect()}compress(e){return this.flags.compress=e,this}get volatile(){return this.flags.volatile=!0,this}timeout(e){return this.flags.timeout=e,this}onAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.push(e),this}prependAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.unshift(e),this}offAny(e){if(!this._anyListeners)return this;if(e){const t=this._anyListeners;for(let n=0;n<t.length;n++)if(e===t[n])return t.splice(n,1),this}else this._anyListeners=[];return this}listenersAny(){return this._anyListeners||[]}onAnyOutgoing(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.push(e),this}prependAnyOutgoing(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.unshift(e),this}offAnyOutgoing(e){if(!this._anyOutgoingListeners)return this;if(e){const t=this._anyOutgoingListeners;for(let n=0;n<t.length;n++)if(e===t[n])return t.splice(n,1),this}else this._anyOutgoingListeners=[];return this}listenersAnyOutgoing(){return this._anyOutgoingListeners||[]}notifyOutgoingListeners(e){if(this._anyOutgoingListeners&&this._anyOutgoingListeners.length){const t=this._anyOutgoingListeners.slice();for(const n of t)n.apply(this,e.data)}}}function Jl(e){e=e||{},this.ms=e.min||100,this.max=e.max||1e4,this.factor=e.factor||2,this.jitter=e.jitter>0&&e.jitter<=1?e.jitter:0,this.attempts=0}Jl.prototype.duration=function(){var e=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var t=Math.random(),n=Math.floor(t*this.jitter*e);e=1&Math.floor(10*t)?e+n:e-n}return 0|Math.min(e,this.max)},Jl.prototype.reset=function(){this.attempts=0},Jl.prototype.setMin=function(e){this.ms=e},Jl.prototype.setMax=function(e){this.max=e},Jl.prototype.setJitter=function(e){this.jitter=e};class Kl extends Yc{constructor(e,t){var n;super(),this.nsps={},this.subs=[],e&&"object"==typeof e&&(t=e,e=void 0),(t=t||{}).path=t.path||"/socket.io",this.opts=t,il(this,t),this.reconnection(!1!==t.reconnection),this.reconnectionAttempts(t.reconnectionAttempts||1/0),this.reconnectionDelay(t.reconnectionDelay||1e3),this.reconnectionDelayMax(t.reconnectionDelayMax||5e3),this.randomizationFactor(null!==(n=t.randomizationFactor)&&void 0!==n?n:.5),this.backoff=new Jl({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(null==t.timeout?2e4:t.timeout),this._readyState="closed",this.uri=e;const i=t.parser||vt;this.encoder=new i.Encoder,this.decoder=new i.Decoder,this._autoConnect=!1!==t.autoConnect,this._autoConnect&&this.open()}reconnection(e){return arguments.length?(this._reconnection=!!e,e||(this.skipReconnect=!0),this):this._reconnection}reconnectionAttempts(e){return void 0===e?this._reconnectionAttempts:(this._reconnectionAttempts=e,this)}reconnectionDelay(e){var t;return void 0===e?this._reconnectionDelay:(this._reconnectionDelay=e,null===(t=this.backoff)||void 0===t||t.setMin(e),this)}randomizationFactor(e){var t;return void 0===e?this._randomizationFactor:(this._randomizationFactor=e,null===(t=this.backoff)||void 0===t||t.setJitter(e),this)}reconnectionDelayMax(e){var t;return void 0===e?this._reconnectionDelayMax:(this._reconnectionDelayMax=e,null===(t=this.backoff)||void 0===t||t.setMax(e),this)}timeout(e){return arguments.length?(this._timeout=e,this):this._timeout}maybeReconnectOnOpen(){!this._reconnecting&&this._reconnection&&0===this.backoff.attempts&&this.reconnect()}open(e){if(~this._readyState.indexOf("open"))return this;this.engine=new Tl(this.uri,this.opts);const t=this.engine,n=this;this._readyState="opening",this.skipReconnect=!1;const i=ql(t,"open",function(){n.onopen(),e&&e()}),r=t=>{this.cleanup(),this._readyState="closed",this.emitReserved("error",t),e?e(t):this.maybeReconnectOnOpen()},s=ql(t,"error",r);if(!1!==this._timeout){const e=this._timeout,n=this.setTimeoutFn(()=>{i(),r(new Error("timeout")),t.close()},e);this.opts.autoUnref&&n.unref(),this.subs.push(()=>{this.clearTimeoutFn(n)})}return this.subs.push(i),this.subs.push(s),this}connect(e){return this.open(e)}onopen(){this.cleanup(),this._readyState="open",this.emitReserved("open");const e=this.engine;this.subs.push(ql(e,"ping",this.onping.bind(this)),ql(e,"data",this.ondata.bind(this)),ql(e,"error",this.onerror.bind(this)),ql(e,"close",this.onclose.bind(this)),ql(this.decoder,"decoded",this.ondecoded.bind(this)))}onping(){this.emitReserved("ping")}ondata(e){try{this.decoder.add(e)}catch(e){this.onclose("parse error",e)}}ondecoded(e){Xc(()=>{this.emitReserved("packet",e)},this.setTimeoutFn)}onerror(e){this.emitReserved("error",e)}socket(e,t){let n=this.nsps[e];return n?this._autoConnect&&!n.active&&n.connect():(n=new Wl(this,e,t),this.nsps[e]=n),n}_destroy(e){const t=Object.keys(this.nsps);for(const e of t){if(this.nsps[e].active)return}this._close()}_packet(e){const t=this.encoder.encode(e);for(let n=0;n<t.length;n++)this.engine.write(t[n],e.options)}cleanup(){this.subs.forEach(e=>e()),this.subs.length=0,this.decoder.destroy()}_close(){this.skipReconnect=!0,this._reconnecting=!1,this.onclose("forced close")}disconnect(){return this._close()}onclose(e,t){var n;this.cleanup(),null===(n=this.engine)||void 0===n||n.close(),this.backoff.reset(),this._readyState="closed",this.emitReserved("close",e,t),this._reconnection&&!this.skipReconnect&&this.reconnect()}reconnect(){if(this._reconnecting||this.skipReconnect)return this;const e=this;if(this.backoff.attempts>=this._reconnectionAttempts)this.backoff.reset(),this.emitReserved("reconnect_failed"),this._reconnecting=!1;else{const t=this.backoff.duration();this._reconnecting=!0;const n=this.setTimeoutFn(()=>{e.skipReconnect||(this.emitReserved("reconnect_attempt",e.backoff.attempts),e.skipReconnect||e.open(t=>{t?(e._reconnecting=!1,e.reconnect(),this.emitReserved("reconnect_error",t)):e.onreconnect()}))},t);this.opts.autoUnref&&n.unref(),this.subs.push(()=>{this.clearTimeoutFn(n)})}}onreconnect(){const e=this.backoff.attempts;this._reconnecting=!1,this.backoff.reset(),this.emitReserved("reconnect",e)}}const Yl={};function Xl(e,t){"object"==typeof e&&(t=e,e=void 0);const n=function(e,t="",n){let i=e;n=n||"undefined"!=typeof location&&location,null==e&&(e=n.protocol+"//"+n.host),"string"==typeof e&&("/"===e.charAt(0)&&(e="/"===e.charAt(1)?n.protocol+e:n.host+e),/^(https?|wss?):\/\//.test(e)||(e=void 0!==n?n.protocol+"//"+e:"https://"+e),i=kl(e)),i.port||(/^(http|ws)$/.test(i.protocol)?i.port="80":/^(http|ws)s$/.test(i.protocol)&&(i.port="443")),i.path=i.path||"/";const r=-1!==i.host.indexOf(":")?"["+i.host+"]":i.host;return i.id=i.protocol+"://"+r+":"+i.port+t,i.href=i.protocol+"://"+r+(n&&n.port===i.port?"":":"+i.port),i}(e,(t=t||{}).path||"/socket.io"),i=n.source,r=n.id,s=n.path,a=Yl[r]&&s in Yl[r].nsps;let o;return t.forceNew||t["force new connection"]||!1===t.multiplex||a?o=new Kl(i,t):(Yl[r]||(Yl[r]=new Kl(i,t)),o=Yl[r]),n.query&&!t.query&&(t.query=n.queryKey),o.socket(n.path,t)}Object.assign(Xl,{Manager:Kl,Socket:Wl,io:Xl,connect:Xl});const Ql=`${Ot}/src/component/listener`,eu=!1,tu="http://localhost:6621",nu=1e3,iu=!0;let ru,su;function au(){su=_.debounce(ou,Dt("listener.duration"))}async function ou(){Pt().info("[Listener] 已将 iframe 刷新为最新版本");a[H]&&await j();const e=ji.getInstance(),t=e.getGlobalScripts();await e.stopScriptsByType(t,ki.GLOBAL),await e.runScriptsByType(t,ki.GLOBAL),await D()}function cu(e){e?$("#online_status_indicator").addClass("success"):$("#online_status_indicator").removeClass("success")}function lu(e){ru&&(cu(!1),ru.close()),Dt("listener.enabled")&&Dt("listener.url")&&(ru=Xl(e,{transports:["websocket"]}),ru.on("connect_error",e=>{cu(!1),Dt("listener.enable_echo")&&toastr.error(`连接酒馆助手实时监听功能出错, 尝试重连...\n${e.name}: ${e.message}`),Pt().error(`${e.name}: ${e.message}${e.stack??""}`)}),ru.on("connect",()=>{cu(!0),Pt().info("[Listener] 成功连接至服务器")}),ru.on("iframe_updated",()=>{su()}),ru.on("disconnect",(e,t)=>{Dt("listener.enable_echo")&&toastr.warning(`酒馆助手实时监听器断开连接: ${e}`),cu(!1),Pt().info(`[Listener] 与服务器断开连接: ${e}\n${t}`)}))}function uu(){const e=Object.keys(Ce.commands).filter(e=>Ce.commands[e].name===e).sort((e,t)=>e.toLowerCase().localeCompare(t.toLowerCase())).map(e=>Ce.commands[e]),t=e=>({is_required:e.isRequired,default_value:e.defaultValue??void 0,accepts_multiple:e.acceptsMultiple,enum_list:e.enumList.length>0?e.enumList.map(e=>e.value):void 0,type_list:e.typeList.length>0?e.typeList:void 0}),n=e=>({name:e.name,...t(e)});return e.map(e=>{return{name:e.name,named_args:e.namedArgumentList.map(n)??[],unnamed_args:e.unnamedArgumentList.map(t)??[],return_type:e.returns??"void",help_string:(i=e.helpString,$("<span>").html(i).text().split("\n").map(e=>e.trim()).filter(e=>""!==e).join(" ")??"NO DETAILS")};var i}).map(e=>`/${e.name}${e.named_args.length>0?" ":""}${e.named_args.map(e=>`[${e.accepts_multiple?"...":""}${e.name}=${e.enum_list?e.enum_list.join("|"):e.type_list?e.type_list.join("|"):""}]${e.is_required?"":"?"}${e.default_value?`=${e.default_value}`:""}`).join(" ")}${e.unnamed_args.length>0?" ":""}${e.unnamed_args.map(e=>`(${e.accepts_multiple?"...":""}${e.enum_list?e.enum_list.join("|"):e.type_list?e.type_list.join("|"):""})${e.is_required?"":"?"}${e.default_value?`=${e.default_value}`:""}`).join(" ")} // ${e.help_string}`).join("\n")}function du(){const e=$('\n  <div class="flex-container flexFlowColumn">\n  <a href="https://n0vi028.github.io/JS-Slash-Runner-Doc/guide/基本用法/如何正确使用酒馆助手.html" target="_blank" class="menu_button interactable width100p">\n    查看酒馆助手帮助文档\n  </a>\n  <a href="https://rentry.org/sillytavern-script-book" target="_blank" class="menu_button interactable width100p">\n    查看 STScript 命令手册中文版\n  </a>\n  </div>\n  ');ie(e,ne.DISPLAY)}function pu(){const e=$('\n  <div class="flex-container flexFlowColumn">\n  <a href="https://gitlab.com/novi028/JS-Slash-Runner/-/raw/main/dist/@types.zip?ref_type=heads&inline=false" target="_blank" class="menu_button interactable width100p">\n    下载酒馆助手类型声明文件 (电脑编写模板用的压缩包)\n  </a>\n  <a href="https://gitlab.com/novi028/JS-Slash-Runner/-/raw/main/dist/@types.txt?ref_type=heads&inline=false" target="_blank" class="menu_button interactable width100p">\n    下载酒馆助手类型声明文件 (手机或 AI 官网用的单文件)\n  </a>\n  <div class="menu_button interactable width100p" id="download_slash_commands">\n    下载文本版酒馆 STScript 命令大全\n  </div>\n  </div>\n  ');e.find("#download_slash_commands").on("click",function(){const e=URL.createObjectURL(new Blob([uu()],{type:"text/plain"})),t=document.createElement("a");t.href=e,t.download="slash_command.txt",t.click(),setTimeout(()=>URL.revokeObjectURL(e),0)}),ie(e,ne.DISPLAY)}function hu(){["auto_fix_generated_markdown","trim_sentences","forbid_external_media","encode_tags"].map(e=>function(e,t){return _.get(Re,e)!==t&&(_.set(Re,e,t),$(`#${e}`).prop("checked",t),!0)}(e,!1)).some(e=>!!e)&&M()}function fu(e,t=!1){const n=Number($("#world_editor_select").val()),i=Je.indexOf(e);-1===i||!t&&n!==i||$("#world_editor_select").val(i).trigger("change")}const mu=_.debounce(fu,1e3),gu={max_context_unlocked:{selector:"#oai_max_context_unlocked",oai_setting:"max_context_unlocked",type:"checkbox"},openai_max_context:{selector:"#openai_max_context",oai_setting:"openai_max_context",type:"input"},openai_max_tokens:{selector:"#openai_max_tokens",oai_setting:"openai_max_tokens",type:"input"},n:{selector:"#n_openai",oai_setting:"n",type:"input"},stream_openai:{selector:"#stream_toggle",oai_setting:"stream_openai",type:"checkbox"},temperature:{selector:"#temp_openai",oai_setting:"temp_openai",type:"input"},frequency_penalty:{selector:"#freq_pen_openai",oai_setting:"freq_pen_openai",type:"input"},presence_penalty:{selector:"#pres_pen_openai",oai_setting:"pres_pen_openai",type:"input"},top_p:{selector:"#top_p_openai",oai_setting:"top_p_openai",type:"input"},repetition_penalty:{selector:"#repetition_penalty_openai",oai_setting:"repetition_penalty_openai",type:"input"},min_p:{selector:"#min_p_openai",oai_setting:"min_p_openai",type:"input"},top_k:{selector:"#top_k_openai",oai_setting:"top_k_openai",type:"input"},top_a:{selector:"#top_a_openai",oai_setting:"top_a_openai",type:"input"},seed:{selector:"#seed_openai",oai_setting:"seed",type:"input"},squash_system_messages:{selector:"#squash_system_messages",oai_setting:"squash_system_messages",type:"checkbox"},reasoning_effort:{selector:"#openai_reasoning_effort",oai_setting:"reasoning_effort",type:"input"},show_thoughts:{selector:"#openai_show_thoughts",oai_setting:"show_thoughts",type:"checkbox"},request_images:{selector:"#openai_request_images",oai_setting:"request_images",type:"checkbox"},function_calling:{selector:"#openai_function_calling",oai_setting:"function_calling",type:"checkbox"},enable_web_search:{selector:"#openai_enable_web_search",oai_setting:"enable_web_search",type:"checkbox"},image_inlining:{selector:"#openai_image_inlining",oai_setting:"image_inlining",type:"checkbox"},inline_image_quality:{selector:"#openai_inline_image_quality",oai_setting:"inline_image_quality",type:"input"},video_inlining:{selector:"#openai_video_inlining",oai_setting:"video_inlining",type:"checkbox"},names_behavior:{selector:"#names_behavior",oai_setting:"names_behavior",type:"input"},wrap_in_quotes:{selector:"#wrap_in_quotes",oai_setting:"wrap_in_quotes",type:"checkbox"},prompts:{selector:"#prompts",oai_setting:"prompts",type:"none"},prompt_order:{selector:"#prompt_order",oai_setting:"prompt_order",type:"none"},extensions:{selector:"#extensions",oai_setting:"extensions",type:"none"}},vu={addOneMessage:r,saveSettings:U,reloadEditor:fu,reloadEditorDebounced:mu,promptManager:Se,renderPromptManager:Se.render,renderPromptManagerDebounced:Se.renderDebounced};class yu{character_data;constructor(e){this.character_data=e}static find({name:e,allow_avatar:t=!0}){if(!e||"current"===e)return H?a[Number(H)]:null;if(t){const t=a.find(t=>t.avatar===e);if(t)return t}const n=a.filter(n=>n.name===e||t&&n.avatar===e);return n.length>1&&Pt().warn(`找到多个符合条件的角色, 返回导入时间最早的角色: ${e}`),n[0]||null}static findCharacterIndex(e){const t=[(e,t)=>e===t,(e,t)=>e.startsWith(t),(e,t)=>e.includes(t)],n=a.findIndex(t=>t.avatar===e);if(-1!==n)return n;for(const n of t){const t=a.findIndex(t=>n(t.name.toLowerCase(),e.toLowerCase()));if(-1!==t)return t}return-1}static async getChatsFromFiles(e,t){const n={},i=Object.values(e).sort((e,t)=>e.file_name.localeCompare(t.file_name)).reverse().map(async({file_name:e})=>{const i=t?"":e.split(" - ")[0];let r=null,s="";!t&&i&&(r=yu.find({name:i}),r&&(s=r.avatar));const a=t?"/api/chats/group/get":"/api/chats/get",o=t?JSON.stringify({id:e}):JSON.stringify({ch_name:i,file_name:e.replace(".jsonl",""),avatar_url:s}),c=await fetch(a,{method:"POST",headers:I(),body:o,cache:"no-cache"});if(!c.ok)return;const l=await c.json();t||l.shift(),n[e]=l});return await Promise.all(i),n}getCardData(){return this.character_data}getAvatarId(){return this.character_data.avatar||""}getRegexScripts(){return this.character_data.data?.extensions?.regex_scripts||[]}getCharacterBook(){return this.character_data.data?.character_book||null}getWorldName(){return this.character_data.data?.extensions?.world||""}}function _u(e,t=!0){try{e=e||"current";const n=yu.find({name:e,allow_avatar:t});if(!n)return null;const i=new yu(n);return Pt().info(`获取角色卡数据成功, 角色: ${e||"未知"}`),i.getCardData()}catch(t){return Pt().error(`获取角色卡数据失败, 角色: ${e||"未知"}`,t),null}}function bu(e,t=!0){e=e||"current";const n=yu.find({name:e,allow_avatar:t});if(!n)return null;const i=new yu(n).getAvatarId(),r=x("avatar",i),s=r.substring(r.lastIndexOf("=")+1);return Pt().info(`获取角色头像路径成功, 角色: ${e||"未知"}`),At+s}async function wu(e,t=!0){e=e||"current";const n=yu.find({name:e,allow_avatar:t});if(!n)return null;const i=new yu(n),r=yu.findCharacterIndex(i.getAvatarId());if(-1===r)return null;const s=await E(r);return Pt().info(`获取角色聊天历史摘要成功, 角色: ${e||"未知"}`),s}async function $u(e,t=!1){const n=await yu.getChatsFromFiles(e,t);return Pt().info("获取聊天文件详情成功"),n}function ku(e,{message_id:t="last"}={}){if("number"!=typeof t&&!["last","last_user","last_char"].includes(t))throw Error(`提供的 message_id 无效, 请提供 'last', 'last_user', 'last_char' 或楼层消息号, 你提供的是: ${t}`);const n=ge();if(null===n)throw Error(`未找到任何消息楼层, 你提供的是: ${t}`);switch(t){case"last":t=n;break;case"last_user":{const e=ge({filter:e=>e.is_user&&!e.is_system});if(null===e)throw Error(`未找到任何 user 消息楼层, 你提供的是: ${t}`);t=e;break}case"last_char":{const e=ge({filter:e=>!e.is_user&&!e.is_system});if(null===e)throw Error(`未找到任何 char 消息楼层, 你提供的是: ${t}`);t=e;break}}if(t<0||t>n)throw Error(`提供的 message_id 不在 [0, ${n}] 内, 你提供的是: ${t} `);const i=o[t],r=O(e,i.name,i.is_system,i.is_user,t);return Pt().info(`将字符串处理为酒馆用于显示的 html 格式, 字符串: '${e}', 选项: '${JSON.stringify({message_id:t})}', 结果: '${r}'`),r}function Su(e){return $(`div.mes[mesid = "${e}"]`,window.parent.document).find("div.mes_text")}function Eu(e){return`${String(nc.call(this))}_${e}`}function Iu(e){if(!e)throw new Error("脚本ID不能为空");return ji.getInstance().getScriptButton(e)}function xu(e,t){if(!e)throw new Error("脚本ID不能为空");const n=ji.getInstance().getScriptById(e);if(!n)throw new Error(`脚本不存在: ${e}`);const i=Ni.getInstance().getScriptType(n);n.buttons=t,ji.getInstance().setScriptButton(n,i)}function Tu(e,t){const n=Iu(e),i=t.filter(e=>!n.some(t=>t.name===e.name));0!==i.length&&xu(e,[...n,...i])}const Ou=new Map;function Au(e,t){const n=this.frameElement?.id;if(!n)return;const i=yn(Ou,n,()=>new Map);yn(i,e,()=>new Set).add(t)}function Nu(){const e=this.frameElement?.id;return e?yn(Ou,e,()=>new Map):new Map}function Cu(e,t){Au.call(this,e,t),p.on(e,t)}function Du(e,t){Cu.call(this,Eu.call(this,e),t)}function Lu(e,t){Au.call(this,e,t),p.makeLast(e,t)}function Ru(e,t){Au.call(this,e,t),p.makeFirst(e,t)}function ju(e,t){const n=(...i)=>(Nu.call(this).get(e)?.delete(n),t(...i));Au.call(this,e,n),p.once(e,n)}async function Pu(e,...t){await p.emit(e,...t)}function Uu(e,...t){p.emitAndWait(e,...t)}function Mu(e,t){Nu.call(this).get(e)?.delete(t),p.removeListener(e,t)}function zu(e){const t=Nu.call(this);t.get(e)?.forEach(t=>{p.removeListener(e,t)}),t.delete(e)}function Fu(e){Nu.call(this).forEach((t,n)=>{p.removeListener(n,e),t.delete(e)})}function Bu(){Nu.call(this).forEach((e,t)=>{e.forEach(e=>{p.removeListener(t,e)})}),Ou.delete(this.frameElement?.id??"unknown_iframe")}const Gu={MESSAGE_IFRAME_RENDER_STARTED:"message_iframe_render_started",MESSAGE_IFRAME_RENDER_ENDED:"message_iframe_render_ended",GENERATION_STARTED:"js_generation_started",STREAM_TOKEN_RECEIVED_FULLY:"js_stream_token_received_fully",STREAM_TOKEN_RECEIVED_INCREMENTALLY:"js_stream_token_received_incrementally",GENERATION_ENDED:"js_generation_ended"},Vu={APP_READY:"app_ready",EXTRAS_CONNECTED:"extras_connected",MESSAGE_SWIPED:"message_swiped",MESSAGE_SENT:"message_sent",MESSAGE_RECEIVED:"message_received",MESSAGE_EDITED:"message_edited",MESSAGE_DELETED:"message_deleted",MESSAGE_UPDATED:"message_updated",MESSAGE_FILE_EMBEDDED:"message_file_embedded",IMPERSONATE_READY:"impersonate_ready",CHAT_CHANGED:"chat_id_changed",GENERATION_AFTER_COMMANDS:"GENERATION_AFTER_COMMANDS",GENERATION_STARTED:"generation_started",GENERATION_STOPPED:"generation_stopped",GENERATION_ENDED:"generation_ended",EXTENSIONS_FIRST_LOAD:"extensions_first_load",EXTENSION_SETTINGS_LOADED:"extension_settings_loaded",SETTINGS_LOADED:"settings_loaded",SETTINGS_UPDATED:"settings_updated",GROUP_UPDATED:"group_updated",MOVABLE_PANELS_RESET:"movable_panels_reset",SETTINGS_LOADED_BEFORE:"settings_loaded_before",SETTINGS_LOADED_AFTER:"settings_loaded_after",CHATCOMPLETION_SOURCE_CHANGED:"chatcompletion_source_changed",CHATCOMPLETION_MODEL_CHANGED:"chatcompletion_model_changed",OAI_PRESET_CHANGED_BEFORE:"oai_preset_changed_before",OAI_PRESET_CHANGED_AFTER:"oai_preset_changed_after",OAI_PRESET_EXPORT_READY:"oai_preset_export_ready",OAI_PRESET_IMPORT_READY:"oai_preset_import_ready",WORLDINFO_SETTINGS_UPDATED:"worldinfo_settings_updated",WORLDINFO_UPDATED:"worldinfo_updated",CHARACTER_EDITED:"character_edited",CHARACTER_PAGE_LOADED:"character_page_loaded",CHARACTER_GROUP_OVERLAY_STATE_CHANGE_BEFORE:"character_group_overlay_state_change_before",CHARACTER_GROUP_OVERLAY_STATE_CHANGE_AFTER:"character_group_overlay_state_change_after",USER_MESSAGE_RENDERED:"user_message_rendered",CHARACTER_MESSAGE_RENDERED:"character_message_rendered",FORCE_SET_BACKGROUND:"force_set_background",CHAT_DELETED:"chat_deleted",CHAT_CREATED:"chat_created",GROUP_CHAT_DELETED:"group_chat_deleted",GROUP_CHAT_CREATED:"group_chat_created",GENERATE_BEFORE_COMBINE_PROMPTS:"generate_before_combine_prompts",GENERATE_AFTER_COMBINE_PROMPTS:"generate_after_combine_prompts",GENERATE_AFTER_DATA:"generate_after_data",GROUP_MEMBER_DRAFTED:"group_member_drafted",WORLD_INFO_ACTIVATED:"world_info_activated",TEXT_COMPLETION_SETTINGS_READY:"text_completion_settings_ready",CHAT_COMPLETION_SETTINGS_READY:"chat_completion_settings_ready",CHAT_COMPLETION_PROMPT_READY:"chat_completion_prompt_ready",CHARACTER_FIRST_MESSAGE_SELECTED:"character_first_message_selected",CHARACTER_DELETED:"characterDeleted",CHARACTER_DUPLICATED:"character_duplicated",STREAM_TOKEN_RECEIVED:"stream_token_received",FILE_ATTACHMENT_DELETED:"file_attachment_deleted",WORLDINFO_FORCE_ACTIVATE:"worldinfo_force_activate",OPEN_CHARACTER_LIBRARY:"open_character_library",ONLINE_STATUS_CHANGED:"online_status_changed",IMAGE_SWIPED:"image_swiped",CONNECTION_PROFILE_LOADED:"connection_profile_loaded",TOOL_CALLS_PERFORMED:"tool_calls_performed",TOOL_CALLS_RENDERED:"tool_calls_rendered"},Zu=["world_info_before","persona_description","char_description","char_personality","scenario","world_info_after","dialogue_examples","chat_history","user_input"],qu={system:0,user:1,assistant:2},Hu=["world_info_before","persona_description","char_description","char_personality","scenario","world_info_after","dialogue_examples","chat_history","user_input"],Wu=1;async function Ju(e){let t;if(!("string"==typeof e&&de(e)))try{if("string"==typeof e){const n=await fetch(e,{method:"GET",cache:"force-cache"});if(!n.ok)throw new Error("Failed to fetch image");const i=await n.blob();t=await ce(i)}else t=await ce(e)}catch(e){Pt().error("[Generate:图片数组处理] 图片处理失败:",e)}return t}function Ku(e){if(0===e.length||"<START>"===e)return[];e.startsWith("<START>")||(e="<START>\n"+e.trim());return e.split(/<START>/gi).slice(1).map(e=>`<START>\n${e.trim()}\n`)}function Yu(e){switch(e){case f.SYSTEM:return"system";case f.USER:return"user";case f.ASSISTANT:return"assistant";default:return"system"}}function Xu(e,t){if(!t.overrides)return!1;if("with_depth_entries"===e)return!1===t.overrides.with_depth_entries;if("chat_history"===e){const e=t.overrides.chat_history;return void 0!==e&&0===e.length}const n=t.overrides[e];return void 0!==n&&""===n}function Qu(){i(),B(),F(0),De()}async function ed(e){const t=X().extensionPrompts;Object.keys(t).filter(t=>e.some(e=>t.startsWith(e))).forEach(e=>delete t[e]),await j()}async function td(e,t){const n=t=>{if(!e.overrides)return;const n=e.overrides[t];return"boolean"!=typeof n?n:void 0};Xu("chat_history",e)||function(){const e=s(a[H]?.data?.extensions?.depth_prompt?.prompt?.trim(),A,N)||"",t=a[H]?.data?.extensions?.depth_prompt?.depth??"4",n=w(a[H]?.data?.extensions?.depth_prompt?.role??"system");z("DEPTH_PROMPT",e,m.IN_CHAT,t,Y.note.allowWIScan,n)}(),Xu("chat_history",e)||Xu("author_note",e)||function(e){const t=e?.overrides?.author_note,n=t??$("#extension_floating_prompt").val();z(Ke,n,c[Ye.position],c[Ye.depth],Y.note.allowWIScan,c[Ye.role])}(e),Xu("chat_history",e)||Xu("persona_description",e)||function(){const e=Re.persona_description,t="PERSONA_DESCRIPTION";if(z(t,"",m.IN_PROMPT,0),!e||Re.persona_description_position===Le.NONE)return;if([Le.BOTTOM_AN,Le.TOP_AN].includes(Re.persona_description_position)&&Xe){const t=X().extensionPrompts[Ke].value,n=Re.persona_description_position===Le.TOP_AN?`${e}\n${t}`:`${t}\n${e}`;z(Ke,n,c[Ye.position],c[Ye.depth],Y.note.allowWIScan,c[Ye.role])}Re.persona_description_position===Le.AT_DEPTH&&z(t,e,m.IN_CHAT,Re.persona_description_depth,!0,Re.persona_description_role)}();const i=s(a[H]?.data?.extensions?.depth_prompt?.prompt?.trim(),A,N),r=s(a[H]?.data?.creator_notes?.trim(),A,N),{description:l,personality:u,persona:d,scenario:p,mesExamples:h,system:y,jailbreak:_}=v(),b=Xu("char_description",e)?"":n("char_description")??l,S=Xu("char_personality",e)?"":n("char_personality")??u,E=Xu("persona_description",e)?"":n("persona_description")??d,I=Xu("scenario",e)?"":n("scenario")??p;let x=Ku(Xu("dialogue_examples",e)?"":n("dialogue_examples")??h),T=[];T=Ie(x);const{promptBias:O}=g(t,"quiet");e.inject&&await async function(e){if(!e||!Array.isArray(e.inject))return;const t=e.inject,n={before_prompt:m.BEFORE_PROMPT,in_chat:m.IN_CHAT,after_prompt:m.IN_PROMPT,none:m.NONE};for(const e of t){const t={role:qu[e.role]??f.SYSTEM,content:e.content||"",depth:Number(e.depth)||0,should_scan:Boolean(e.should_scan)||!0,position:n[e.position]??m.IN_CHAT};z(`INJECTION-${e.depth}-${e.role}`,t.content,t.position,t.depth,t.should_scan,t.role)}}(e);let C=[];e.overrides?.chat_history?C=[...e.overrides.chat_history].reverse():(C=xe(await async function(e){const t=e.filter(e=>!e.is_system);return await Promise.all(t.map(async(e,n)=>{const i=e.mes,r=e.is_user?Ne.USER_INPUT:Ne.AI_OUTPUT,s=Ae(i,r,{isPrompt:!0,depth:t.length-n-1});return{...e,mes:s,index:n}}))}(o)),void 0!==e.max_chat_history&&(C=C.slice(0,e.max_chat_history))),z("TEMP_USER_MESSAGE",t,m.IN_PROMPT,0,!0,1);const D=await async function(e,t,n){const i=e.filter(e=>"system"!==e.role).map(e=>{const t="user"===e.role?A:N;return We?`${t}: ${e.content}`:e.content}).reverse(),r=k(),s={personaDescription:t.overrides?.persona_description??n.persona,characterDescription:t.overrides?.char_description??n.description,characterPersonality:t.overrides?.char_personality??n.personality,characterDepthPrompt:n.charDepthPrompt,scenario:t.overrides?.scenario??n.scenario,creatorNotes:n.creatorNotes},{worldInfoString:a,worldInfoBefore:o,worldInfoAfter:c,worldInfoExamples:l,worldInfoDepth:u}=await Me(i,r,!1,s);await ed(["customDepthWI"]),Xu("with_depth_entries",t)||function(e){Array.isArray(e)&&e.forEach(e=>{const t=e.entries.join("\n");z(`customDepthWI-${e.depth}-${e.role}`,t,m.IN_CHAT,e.depth,!1,e.role)})}(u);const d=Xu("world_info_before",t)?null:void 0!==t.overrides?.world_info_before?t.overrides.world_info_before:o,p=Xu("world_info_after",t)?null:void 0!==t.overrides?.world_info_after?t.overrides.world_info_after:c;return{worldInfoString:a,worldInfoBefore:d,worldInfoAfter:p,worldInfoExamples:l,worldInfoDepth:Xu("with_depth_entries",t)?null:u}}(C,e,{description:l,personality:u,persona:d,scenario:p,charDepthPrompt:i,creatorNotes:r});return z("TEMP_USER_MESSAGE","",m.IN_PROMPT,0,!0,1),x=Xu("dialogue_examples",e)?[]:await async function(e,t){for(const n of t){if(!n.content.length)continue;const t=Ku(s(n.content,A,N));n.position===qe.before?e.unshift(...t):e.push(...t)}return e}(x,D.worldInfoExamples),{characterInfo:{description:b,personality:S,persona:E,scenario:I,system:y,jailbreak:_},chatContext:{oaiMessages:C,oaiMessageExamples:T,promptBias:O},worldInfo:D}}async function nd(e,t,i,r,s){const a=t.order||Hu,o=a.findIndex(e=>"string"==typeof e&&"chat_history"===e.toLowerCase()),c=a.findIndex(e=>"string"==typeof e&&"user_input"===e.toLowerCase()),l=-1!==c,u=-1!==o,d=Xu("chat_history",t);let p;if(s&&l)p=await ye.createAsync("user",s,"user_input");else if(p=await ye.createAsync("user",r,"user_input"),t.image&&l&&!Array.isArray(t.image)){const e=await Ju(t.image);e&&await p.addImage(e)}if(d||!u){const e=l?c:a.length;return void i.add(new _e("user_input",p),e)}const h=new _e("chat_history"),f=$e.new_chat_prompt,m=await ye.createAsync("system",V(f),"newMainChat");i.reserveBudget(m),h.add(m);const g=e.chatContext.oaiMessages[e.chatContext.oaiMessages.length-1],v=await ye.createAsync("user",$e.send_if_empty,"emptyUserMessageReplacement");if(g&&"assistant"===g.role&&$e.send_if_empty&&i.canAfford(v)&&h.add(v),!l){let n;n=s?{role:"user",content:s,identifier:"user_input"}:{role:"user",content:r,identifier:"user_input",image:t.image&&!Array.isArray(t.image)?await Ju(t.image):void 0},e.chatContext.oaiMessages.unshift(n)}const y=(await async function(e,t,i=[],r){const s=[...t];let a=0;const o=[],c=X().extensionPrompts[Ke];c&&c.value&&o.push({role:Yu(c.role),content:c.value,identifier:"authorsNote",injection_depth:c.depth,injected:!0});Re.persona_description&&Re.persona_description_position===Le.AT_DEPTH&&o.push({role:"system",content:Re.persona_description,identifier:"persona_description",injection_depth:Re.persona_description_depth,injected:!0});if(!Xu("char_depth_prompt",r)){const t=e.worldInfo.worldInfoDepth;if(t)for(const e of t){const t=await b(`customDepthWI-${e.depth}-${e.role}`);o.push({role:Yu(e.role),content:t,injection_depth:e.depth,injected:!0}),Pt().info("injectionPrompts",o)}}if(Array.isArray(i))for(const e of i)o.push({identifier:`INJECTION-${e.role}-${e.depth}`,role:e.role,content:e.content,injection_depth:e.depth||0,injected:!0});for(let e=0;e<=n;e++){const t=o.filter(t=>t.injection_depth===e&&t.content),n=["system","user","assistant"],i=[],r="\n";for(const e of n){const n=t.filter(t=>t.role===e).map(e=>e.content.trim()).join(r);n&&i.push({role:e,content:n,injected:!0})}if(i.length){const t=e+a;s.splice(t,0,...i),a+=i.length}}return s}(e,e.chatContext.oaiMessages,t.inject,t)).reverse(),_=we(),w=[...y];for(const e of w){const t=new Qe(e);t.identifier="chat_history-"+(y.length-w.indexOf(e)),t.content=V(t.content);const n=await ye.fromPromptAsync(t),r=Te($e);if(r&&r.serviceSettings.names_behavior===Wu&&t.name){const e=r.isValidName(t.name)?t.name:r.sanitizeName(t.name);await n.setName(e)}if(_&&e.image&&await n.addImage(e.image),!i.canAfford(n))break;h.add(n)}i.freeBudget(m),l?(i.add(h,o),i.add(new _e("user_input",p),c)):i.add(h,o)}async function id(e,t,n){const i=new ve;i.setTokenBudget($e.openai_max_context,$e.openai_max_tokens),i.reserveBudget(3);const r=t.order||Hu,s=r.reduce((e,t,n)=>("string"==typeof t?e[t.toLowerCase()]=n:"object"==typeof t&&(e[`custom_prompt_${n}`]=n),e),{}),{systemPrompts:a,dialogue_examples:o}=await async function(e,t){const n=new et,i=new _e("dialogue_examples"),r=t.order||Zu,s={world_info_before:e.worldInfo.worldInfoBefore,persona_description:Re.persona_description&&Re.persona_description_position===Le.IN_PROMPT?e.characterInfo.persona:null,char_description:e.characterInfo.description,char_personality:e.characterInfo.personality,scenario:e.characterInfo.scenario,world_info_after:e.worldInfo.worldInfoAfter};for(const[e,t]of r.entries())if("string"==typeof t){const e=s[t];e&&n.add(new Qe({identifier:t,role:"system",content:e,system_prompt:!0}))}else if("object"==typeof t&&t.role&&t.content){const i=`custom_prompt_${e}`;n.add(new Qe({identifier:i,role:t.role,content:t.content,system_prompt:"system"===t.role}))}if(e.chatContext.oaiMessageExamples.length>0)for(const t of[...e.chatContext.oaiMessageExamples]){const n=e.chatContext.oaiMessageExamples.indexOf(t),r=[];for(let e=0;e<t.length;e++){const i=t[e],s="system",a=i.content||"",o=`dialogue_examples ${n}-${e}`,c=await ye.createAsync(s,a,o);await c.setName(i.name),r.push(c)}for(const e of r)i.add(e)}return{systemPrompts:n,dialogue_examples:i}}(e,t),c=async(e,t)=>{if("object"==typeof e){const n=new _e(`custom_prompt_${t}`),r=await ye.createAsync(e.role,e.content,`custom_prompt_${t}`);n.add(r),i.add(n,t)}else if(a.has(e)){const t=a.get(e),n=new _e(e),r=await ye.fromPromptAsync(t);n.add(r),i.add(n,s[e])}};for(const[e,n]of r.entries())"string"==typeof n?Xu(n,t)||await c(n,e):"object"==typeof n&&n.role&&n.content&&await c(n,e);const l=r.findIndex(e=>"string"==typeof e&&"dialogue_examples"===e.toLowerCase());-1===l||Xu("dialogue_examples",t)||i.add(o,l);const u=await ye.createAsync("user",n,"user_input");i.reserveBudget(u),await nd(e,t,i,n,t.processedImageArray),i.freeBudget(u),$e.squash_system_messages&&await i.squashSystemMessages();return{prompt:i.getChat()}}function rd(e=""){const t=function(e){return""===e&&(e=$e.send_if_empty.trim()),Ae(e,Ne.USER_INPUT,{isPrompt:!0,depth:0})}(V(e))||"";return t}async function sd(e="",t=!0,n=void 0){let i,r,s=rd(e);return Array.isArray(n)&&n.length>0&&(t?(i=function(e,t){const n="__IMG_ARRAY_MARKER_",i=e+n;let r,s;const a=new Promise((e,t)=>{r=e,s=t});let o=null,c=!0;const l=async e=>{Pt().debug("[Generate:图片数组处理] imageArrayHandler 被调用");try{o=setTimeout(()=>{Pt().warn("[Generate:图片数组处理] 图片处理超时"),s(new Error("图片处理超时"))},3e4);for(let i=e.chat.length-1;i>=0;i--){const a=e.chat[i],c="string"==typeof a.content?a.content:"";if("user"===a.role&&c.includes(n))try{const e=$e.inline_image_quality||"low",i=(await Promise.all(t.map(async t=>{try{const n=await Ju(t);return n?{type:"image_url",image_url:{url:n,detail:e}}:(Pt().warn("[Generate:图片数组处理] 图片处理失败，跳过该图片"),null)}catch(e){return Pt().error("[Generate:图片数组处理] 单个图片处理失败:",e),null}}))).filter(e=>null!==e),s={type:"text",text:c.replace(n,"")};return a.content=[s,...i],o&&(clearTimeout(o),o=null),Pt().info("[Generate:图片数组处理] 成功将",i.length,"张图片插入到用户消息中"),void r()}catch(e){return o&&(clearTimeout(o),o=null),Pt().error("[Generate:图片数组处理] 处理图片时出错:",e),void s(e)}}Pt().warn("[Generate:图片数组处理] 未找到包含图片标记的用户消息"),r()}catch(e){Pt().error("[Generate:图片数组处理] imageArrayHandler 异常:",e),s(e)}};return p.once("chat_completion_prompt_ready",l),{userInputWithMarker:i,imageProcessingPromise:a,resolveImageProcessing:r,rejectImageProcessing:s,cleanup:()=>{if(o&&(clearTimeout(o),o=null),c)try{p.removeListener("chat_completion_prompt_ready",l),c=!1,Pt().debug("[Generate:图片数组处理] 已清理事件监听器")}catch(e){Pt().warn("[Generate:图片数组处理] 清理事件监听器时出错:",e)}}}}(s,n),s=i.userInputWithMarker):r=await async function(e,t){const n=$e.inline_image_quality||"low",i=(await Promise.all(t.map(async e=>{try{const t=await Ju(e);return t?{type:"image_url",image_url:{url:t,detail:n}}:(Pt().warn("[Generate:图片数组处理] 图片处理失败，跳过该图片"),null)}catch(e){return Pt().error("[Generate:图片数组处理] 单个图片处理失败:",e),null}}))).filter(e=>null!==e),r={type:"text",text:e};return Pt().info("[Generate:图片数组处理] 成功处理",i.length,"张图片"),[r,...i]}(s,n)),{processedUserInput:s,imageProcessingSetup:i,processedImageArray:r}}class ad{generator;stoppingStrings;result;isStopped;isFinished;abortController;messageBuffer;constructor(){this.result="",this.messageBuffer="",this.isStopped=!1,this.isFinished=!1,this.generator=this.nullStreamingGeneration,this.abortController=new AbortController}onProgressStreaming(e,t){const n=e.slice(this.messageBuffer.length);this.messageBuffer=e;let i=l(n,!1,!1,!t,this.stoppingStrings);const r=["*",'"',"```"];for(const e of r)if(!t&&T(u(i,e))){const t=e.length>1?"\n":"";i=i.trimEnd()+t+e}if(p.emit("js_stream_token_received_fully",e),p.emit("js_stream_token_received_incrementally",i),t){const t=l(e,!1,!1,!1,this.stoppingStrings);p.emit("js_generation_ended",t)}}onErrorStreaming(){this.abortController&&this.abortController.abort(),this.isStopped=!0,Qu(),j()}async*nullStreamingGeneration(){throw Error("Generation function for streaming is not hooked up")}async generate(){try{const e=new se(1e3/Re.streaming_fps),t=[];for await(const{text:n}of this.generator()){if(t.push(Date.now()),this.isStopped)return void(this.messageBuffer="");this.result=n,await e.tick(()=>this.onProgressStreaming(n,!1))}this.isStopped?this.messageBuffer="":this.onProgressStreaming(this.result,!0);const n=(t[t.length-1]-t[0])/1e3;Pt().warn(`Stream stats: ${t.length} tokens, ${n.toFixed(2)} seconds, rate: ${Number(t.length/n).toFixed(2)} TPS`)}catch(e){if(!this.isFinished)throw this.onErrorStreaming(),Error(`Generate method error: ${e}`);return this.messageBuffer="",this.result}return this.isFinished=!0,this.result}}async function od(e,t=!1,n=void 0,i,r){let s="",a=null;try{if(d(),r?.apiurl&&(a=e=>{if(e.chat_completion_source=r.source||"openai",e.reverse_proxy=r.apiurl,e.proxy_password=r.key,!r.model)throw toastr.error("[Generate] 自定义API未指定模型"),Pt().error("[Generate] 自定义API未指定模型"),new Error("[Generate] 自定义API未指定模型");return e.model=r.model,Pt().info("[Generate] API配置修改完成",{newSource:e.chat_completion_source,newProxy:e.reverse_proxy,newModel:e.model,hasKey:e.proxy_password}),e},p.once(h.CHAT_COMPLETION_SETTINGS_READY,a)),n)try{await n.imageProcessingPromise,Pt().debug("[Generate:图片数组处理] 图片处理已完成，继续生成流程")}catch(e){throw Pt().error("[Generate:图片数组处理] 图片处理失败:",e),new Error(`图片处理失败: ${e?.message||"未知错误"}`)}if(t){const t=$e.stream_openai;t||($e.stream_openai=!0,M());const n=new ad;n.generator=await Ee("normal",e.prompt,i.signal),s=await n.generate(),t!==$e.stream_openai&&($e.stream_openai=t,M())}else{p.emit("js_generation_started");const t=await Ee("quiet",e.prompt,i.signal);s=await async function(e){if(!e)throw Error("未得到响应");if(e.error)throw e?.response&&toastr.error(e.response,tt`API Error`,{preventDuplicates:!0}),Error(e?.response);const t="string"==typeof(n=e)?n:n?.choices?.[0]?.message?.content??n?.choices?.[0]?.text??n?.text??n?.message?.content?.[0]?.text??n?.message?.tool_plan??"";var n;return p.emit("js_generation_ended",t),t}(t)}}catch(e){throw n&&n.rejectImageProcessing(e),Pt().error(e),e}finally{a&&(p.removeListener(h.CHAT_COMPLETION_SETTINGS_READY,a),Pt().debug("[Generate:自定义API] 已清理事件监听器")),Qu(),await ed(["INJECTION"])}return s}let cd,ld=new AbortController;function ud(e){return{world_info_before:e.world_info_before,persona_description:e.persona_description,char_description:e.char_description,char_personality:e.char_personality,scenario:e.scenario,world_info_after:e.world_info_after,dialogue_examples:e.dialogue_examples,with_depth_entries:e.chat_history?.with_depth_entries,author_note:e.chat_history?.author_note,chat_history:e.chat_history?.prompts}}function dd(e){return{role:e.role,content:e.content,position:{before_prompt:"before_prompt",in_chat:"in_chat",after_prompt:"after_prompt",none:"none"}[e.position],depth:e.depth,should_scan:e.should_scan}}async function pd({user_input:e="",use_preset:t=!0,image:n,overrides:i,max_chat_history:r,inject:s=[],order:o,stream:c=!1,custom_api:l}={}){ld=new AbortController;const u=await sd(e,t,n),{processedUserInput:d,imageProcessingSetup:f,processedImageArray:m}=u;cd=f,await p.emit(h.GENERATION_AFTER_COMMANDS,"quiet",{},!1);const g=await td({overrides:i,max_chat_history:r,inject:s,order:o},d),v=t?await async function(e,t,n){let i=null;try{const r=n?.overrides?.scenario;r&&a&&a[H]&&(i=a[H].scenario||null,a[H].scenario=r);const s={role:"user",content:t,image:n.image};n.image&&(Array.isArray(n.image)?delete s.image:s.image=await Ju(n.image)),e.chatContext.oaiMessages.unshift(s);const o={name2:N,charDescription:e.characterInfo.description,charPersonality:e.characterInfo.personality,Scenario:e.characterInfo.scenario,worldInfoBefore:e.worldInfo.worldInfoBefore,worldInfoAfter:e.worldInfo.worldInfoAfter,extensionPrompts:X().extensionPrompts,bias:e.chatContext.promptBias,type:"normal",quietPrompt:"",quietImage:null,cyclePrompt:"",systemPromptOverride:e.characterInfo.system,jailbreakPromptOverride:e.characterInfo.jailbreak,personaDescription:e.characterInfo.persona,messages:e.chatContext.oaiMessages,messageExamples:e.chatContext.oaiMessageExamples},[c]=await ke(o,!1);return{prompt:c}}finally{null!==i&&a&&a[H]&&(a[H].scenario=i)}}(g,d,{image:n,overrides:i,max_chat_history:r,inject:s,order:o}):await id(g,{image:n,overrides:i,max_chat_history:r,inject:s,order:o,processedImageArray:m},d);await p.emit(h.GENERATE_AFTER_DATA,v);try{Pt().info("[Generate:发送提示词]",v);const e=await od(v,c,f,ld,l);return cd=void 0,e}catch(e){throw f&&f.rejectImageProcessing(e),cd=void 0,e}}async function hd(e){const t=function(e){return{user_input:e.user_input,use_preset:!0,image:e.image,stream:e.should_stream??!1,overrides:void 0!==e.overrides?ud(e.overrides):void 0,inject:void 0!==e.injects?e.injects.map(dd):void 0,max_chat_history:"number"==typeof e.max_chat_history?e.max_chat_history:void 0,custom_api:e.custom_api}}(e);return await pd(t)}async function fd(e){const t=function(e){return{user_input:e.user_input,use_preset:!1,image:e.image,stream:e.should_stream??!1,max_chat_history:"number"==typeof e.max_chat_history?e.max_chat_history:void 0,overrides:e.overrides?ud(e.overrides):void 0,inject:e.injects?e.injects.map(dd):void 0,order:e.ordered_prompts,custom_api:e.custom_api}}(e);return await pd(t)}function md(){const e={selected_global_lorebooks:(t=ze()).world_info.globalSelect,scan_depth:t.world_info_depth,context_percentage:t.world_info_budget,budget_cap:t.world_info_budget_cap,min_activations:t.world_info_min_activations,max_depth:t.world_info_min_activations_depth_max,max_recursion_steps:t.world_info_max_recursion_steps,insertion_strategy:{0:"evenly",1:"character_first",2:"global_first"}[t.world_info_character_strategy],include_names:t.world_info_include_names,recursive:t.world_info_recursive,case_sensitive:t.world_info_case_sensitive,match_whole_words:t.world_info_match_whole_words,use_group_scoring:t.world_info_use_group_scoring,overflow_alert:t.world_info_overflow_alert};var t;return Pt().info(`获取世界书全局设置:\n${JSON.stringify(e)}`),structuredClone(e)}function gd(e){if(e.selected_global_lorebooks){const t=e.selected_global_lorebooks.filter(e=>!Je.includes(e));if(t.length>0)throw Error(`尝试修改要全局启用的世界书, 但未找到以下世界书: ${JSON.stringify(t)}`)}const t=md();e=_.omitBy(e,(e,n)=>e===t[n]),function(e){const t=$(),n=$(),i={selected_global_lorebooks:e=>{$("#world_info").find('option[value!=""]').remove(),Je.forEach((t,n)=>$("#world_info").append(`<option value='${n}'${e.includes(t)?" selected":""}>${t}</option>`)),Ve.length=0,Ve.push(...e),U()},scan_depth:e=>{t.add($("#world_info_depth").val(e))},context_percentage:e=>{t.add($("#world_info_budget").val(e))},budget_cap:e=>{t.add($("#world_info_budget_cap").val(e))},min_activations:e=>{t.add($("#world_info_min_activations").val(e))},max_depth:e=>{t.add($("#world_info_min_activations_depth_max").val(e))},max_recursion_steps:e=>{t.add($("#world_info_max_recursion_steps").val(e))},insertion_strategy:e=>{const t={evenly:0,character_first:1,global_first:2}[e];$(`#world_info_character_strategy option[value='${t}']`).prop("selected",!0),n.add($("#world_info_character_strategy").val(t))},include_names:e=>{t.add($("#world_info_include_names").prop("checked",e))},recursive:e=>{t.add($("#world_info_recursive").prop("checked",e))},case_sensitive:e=>{t.add($("#world_info_case_sensitive").prop("checked",e))},match_whole_words:e=>{t.add($("#world_info_match_whole_words").prop("checked",e))},use_group_scoring:e=>{n.add($("#world_info_use_group_scoring").prop("checked",e))},overflow_alert:e=>{n.add($("#world_info_overflow_alert").prop("checked",e))}};Object.entries(e).filter(([e,t])=>void 0!==t).forEach(([e,t])=>{i[e]?.(t)}),t.trigger("input"),n.trigger("change")}(e),Pt().info(`修改世界书全局设置:\n${JSON.stringify(e)}`)}function vd(){return Pt().info(`获取世界书列表: ${JSON.stringify(Je)}`),structuredClone(Je)}async function yd(e){const t=await Ue(e);return Pt().info(`移除世界书 '${e}' ${t?"成功":"失败"}`),t}async function _d(e){const t=await Pe(e,{interactive:!1});return Pt().info(`新建世界书 '${e}' ${t?"成功":"失败"}`),t}function bd({name:e=a[H]?.avatar??null,type:t="all"}={}){const n=yu.find({name:e??"current"});if(!n)throw Error(`未找到${"current"===e?"当前打开":`名为 '${e}' `}的角色卡`);const i={primary:null,additional:[]};n.data?.extensions?.world&&(i.primary=n.data?.extensions?.world);const r=n.avatar.replace(/\.[^/.]+$/,""),s=He.charLore?.find(e=>e.name===r);return s&&Array.isArray(s.extraBooks)&&(i.additional=s.extraBooks),Pt().info(`获取角色卡绑定的世界书, 选项: ${JSON.stringify({name:e,type:t})}, 获取结果: ${JSON.stringify(i)}`),structuredClone(i)}function wd(){return bd().primary}async function $d(e){const t=le(H);if(!t)throw Error("未打开任何角色卡");const n=_(_.concat(e.primary?[e.primary]:[],e.additional)).reject(_.isNull).reject(e=>vd().some(t=>t===e)).value();if(n.length>0)throw Error(`尝试修改 '${t}' 绑定的世界书, 但未找到以下世界书: ${n}`);if(void 0!==e.primary){const n=String($("#character_world").val());if($("#character_world").val(e.primary?e.primary:""),$(".character_world_info_selector").find("option:selected").val(e.primary?Je.indexOf(e.primary):""),n&&!e.primary){const e=JSON.parse(String($("#character_json_data").val()));e?.data?.character_book&&(e.data.character_book=void 0),$("#character_json_data").val(JSON.stringify(e))}if(!await async function(){$("#rm_info_avatar").html("");const e=new FormData($("#form_create").get(0)),t=e.get("avatar");if(t instanceof File){const n=await oe(t);e.set("avatar",n)}const n=I();delete n["Content-Type"],e.delete("alternate_greetings");const i=$(".open_alternate_greetings").data("chid");if(i&&Array.isArray(a[i]?.data?.alternate_greetings))for(const t of a[i].data.alternate_greetings)e.append("alternate_greetings",t);return!!(await fetch("/api/characters/edit",{method:"POST",headers:n,body:e,cache:"no-cache"})).ok&&(await S(e.get("avatar_url")),$("#add_avatar_button").replaceWith($("#add_avatar_button").val("").clone(!0)),$("#create_button").attr("value","Save"),!0)}())throw Error(`尝试为 '${t}' 绑定主要世界书, 但在访问酒馆后端时出错`);Ze(void 0,!!e.primary)}if(void 0!==e.additional){const n=He.charLore??[],i=n.findIndex(e=>e.name===t);-1===i?n.push({name:t,extraBooks:e.additional}):0===e.additional.length?n.splice(i,1):n[i].extraBooks=e.additional,Object.assign(He,{charLore:n})}R(),M(),Pt().info(`修改角色卡绑定的世界书, 要修改的部分: ${JSON.stringify(e)}${void 0===e.primary?", 主要世界书保持不变":""}${void 0===e.additional?", 附加世界书保持不变":""}`)}function kd(){if(!y())throw Error("未打开任何聊天, 不可获取聊天世界书");const e=_.get(c,je,"");return Je.includes(e)?e:(_.unset(c,je),null)}async function Sd(e){if(null===e)_.unset(c,je),$(".chat_lorebook_button").removeClass("world_set");else{if(!Je.includes(e))throw new Error(`尝试为角色卡绑定聊天世界书, 但该世界书 '${e}' 不存在`);_.set(c,je,e),$(".chat_lorebook_button").addClass("world_set")}await P()}async function Ed(e){const t=await kd();if(null!==t)return t;const n=(()=>{if(e){if(Je.includes(e))throw new Error(`尝试创建聊天世界书, 但该名称 '${e}' 已存在`);return e}return`Chat Book ${y()}`.replace(/[^a-z0-9]/gi,"_").replace(/_{2,}/g,"_").substring(0,64)})();return await Pe(n),await Sd(n),n}$(document).on("click","#mes_stop",function(){G()&&(ld&&ld.abort("Clicked stop button"),function(){if(cd){try{cd.cleanup(),cd.rejectImageProcessing(new Error("Generation stopped by user")),Pt().info("[Generate:停止] 已清理图片处理相关逻辑")}catch(e){Pt().warn("[Generate:停止] 清理图片处理时出错:",e)}cd=void 0}}(),Qu())});const Id={key:[],keysecondary:[],comment:"",content:"",constant:!1,vectorized:!1,selective:!0,selectiveLogic:0,addMemo:!0,order:100,position:0,disable:!1,excludeRecursion:!1,preventRecursion:!1,matchPersonaDescription:!1,matchCharacterDescription:!1,matchCharacterPersonality:!1,matchCharacterDepthPrompt:!1,matchScenario:!1,matchCreatorNotes:!1,delayUntilRecursion:0,probability:100,useProbability:!0,depth:4,group:"",groupOverride:!1,groupWeight:100,scanDepth:null,caseSensitive:null,matchWholeWords:null,useGroupScoring:null,automationId:"",role:0,sticky:null,cooldown:null,delay:null};function xd(e){return{uid:e.uid,display_index:e.displayIndex,comment:e.comment,enabled:!e.disable,type:e.constant?"constant":e.vectorized?"vectorized":"selective",position:{0:"before_character_definition",1:"after_character_definition",5:"before_example_messages",6:"after_example_messages",2:"before_author_note",3:"after_author_note"}[e.position]??(1===e.role?"at_depth_as_user":2===e.role?"at_depth_as_assistant":"at_depth_as_system"),depth:4===e.position?e.depth:null,order:e.order,probability:e.probability,key:e.key,keys:e.key,logic:{0:"and_any",1:"not_all",2:"not_any",3:"and_all"}[e.selectiveLogic],filter:e.keysecondary,filters:e.keysecondary,scan_depth:e.scanDepth??"same_as_global",case_sensitive:e.caseSensitive??"same_as_global",match_whole_words:e.matchWholeWords??"same_as_global",use_group_scoring:e.useGroupScoring??"same_as_global",automation_id:e.automationId||null,exclude_recursion:e.excludeRecursion,prevent_recursion:e.preventRecursion,delay_until_recursion:e.delayUntilRecursion,content:e.content,group:e.group,group_prioritized:e.groupOverride,group_weight:e.groupWeight,sticky:e.sticky||null,cooldown:e.cooldown||null,delay:e.delay||null}}async function Td(e,{filter:t="none"}={}){if(!Je.includes(e))throw Error(`未能找到世界书 '${e}'`);const n=await Fe(e);let i=_(n.entries).values().map(xd).value();return"none"!==t&&(i=i.filter(e=>Object.entries(t).every(([t,n])=>{const i=e[t];return Array.isArray(i)?n.every(e=>i.includes(e)):"string"==typeof i?i.includes(n):i===n}))),Pt().info(`获取世界书 '${e}' 中的条目, 选项: ${JSON.stringify({filter:t})}`),structuredClone(i)}function Od(e){const t={uid:e=>({uid:e}),display_index:e=>({displayIndex:e}),comment:e=>({comment:e}),enabled:e=>({disable:!e}),type:e=>({constant:"constant"===e,vectorized:"vectorized"===e}),position:e=>({position:{before_character_definition:0,after_character_definition:1,before_example_messages:5,after_example_messages:6,before_author_note:2,after_author_note:3,at_depth_as_system:4,at_depth_as_user:4,at_depth_as_assistant:4}[e],role:{at_depth_as_system:0,at_depth_as_user:1,at_depth_as_assistant:2}[e]??null}),depth:e=>({depth:null===e?4:e}),order:e=>({order:e}),probability:e=>({probability:e}),keys:e=>({key:e}),logic:e=>({selectiveLogic:{and_any:0,not_all:1,not_any:2,and_all:3}[e]}),filters:e=>({keysecondary:e}),scan_depth:e=>({scanDepth:"same_as_global"===e?null:e}),case_sensitive:e=>({caseSensitive:"same_as_global"===e?null:e}),match_whole_words:e=>({matchWholeWords:"same_as_global"===e?null:e}),use_group_scoring:e=>({useGroupScoring:"same_as_global"===e?null:e}),automation_id:e=>({automationId:null===e?"":e}),exclude_recursion:e=>({excludeRecursion:e}),prevent_recursion:e=>({preventRecursion:e}),delay_until_recursion:e=>({delayUntilRecursion:e}),content:e=>({content:e}),group:e=>({group:e}),group_prioritized:e=>({groupOverride:e}),group_weight:e=>({groupWeight:e}),sticky:e=>({sticky:null===e?0:e}),cooldown:e=>({cooldown:null===e?0:e}),delay:e=>({delay:null===e?0:e})};return _.merge({},Id,...Object.entries(e).filter(([e,t])=>void 0!==t).map(([e,n])=>t[e]?.(n)))}const Ad=1e6;function Nd(e){const t=new Set,n=e=>{void 0===e&&(e=_.random(0,999999));let n=1;for(;;){if(!t.has(e))return t.add(e),e;e=(e+n*n)%Ad,++n}};let i=_.max(e.map(e=>e.display_index??-1))??-1;return e.map(e=>({...e,uid:n(e.uid),display_index:e.display_index??++i}))}async function Cd(e,t){if(!Je.includes(e))throw Error(`未能找到世界书 '${e}'`);const n={entries:_.merge({},...Nd(t).map(Od).map(e=>({[e.uid]:e})))};await Ge(e,n),mu(e),Pt().info(`更新世界书 '${e}' 中的条目`)}async function Dd(e,t){return Pt().info(`对世界书 '${e}' 中的条目进行更新`),await Cd(e,await t(await Td(e))),Td(e)}async function Ld(e,t){return await Dd(e,e=>{for(const n of t){const t=e.find(e=>e.uid===n.uid);t&&_.merge(t,n)}return e})}async function Rd(e,t){const n=[];return{entries:await Dd(e,e=>{const i=new Set(e.map(e=>e.uid));return t.forEach(e=>e.uid=(()=>{for(let e=0;e<Ad;++e)if(!i.has(e))return i.add(e),n.push(e),e;throw Error("无法找到可用的世界书条目 uid")})()),[...e,...t]}),new_uids:n}}async function jd(e,t){let n=!1;return{entries:await Dd(e,e=>{const i=_.remove(e,e=>t.includes(e.uid));return n=i.length>0,e}),delete_occurred:n}}async function Pd(e,t){return(await Rd(e,[t])).new_uids[0]}async function Ud(e,t){return(await jd(e,[t])).delete_occurred}function Md(e){return!zd(e)&&!Fd(e)}function zd(e){return["main","nsfw","jailbreak","enhanceDefinitions"].includes(e.id)}function Fd(e){return["worldInfoBefore","personaDescription","charDescription","charPersonality","scenario","worldInfoAfter","dialogueExamples","chatHistory"].includes(e.id)}const Bd={settings:{max_context:2e6,max_completion_tokens:300,reply_count:1,should_stream:!1,temperature:1,frequency_penalty:0,presence_penalty:0,repetition_penalty:1,top_p:1,min_p:0,top_k:0,top_a:0,seed:-1,squash_system_messages:!1,reasoning_effort:"auto",request_thoughts:!1,request_images:!1,enable_function_calling:!1,enable_web_search:!1,allow_sending_images:"disabled",allow_sending_videos:!1,character_name_prefix:"none",wrap_user_messages_in_quotes:!1},prompts:[{id:"worldInfoBefore",name:"World Info (before)",enabled:!0,position:{type:"relative"},role:"system"},{id:"personaDescription",name:"Persona Description",enabled:!0,position:{type:"relative"},role:"system"},{id:"charDescription",name:"Char Description",enabled:!0,position:{type:"relative"},role:"system"},{id:"charPersonality",name:"Char Personality",enabled:!0,position:{type:"relative"},role:"system"},{id:"scenario",name:"Scenario",enabled:!0,position:{type:"relative"},role:"system"},{id:"worldInfoAfter",name:"World Info (after)",enabled:!0,position:{type:"relative"},role:"system"},{id:"dialogueExamples",name:"Chat Examples",enabled:!0,position:{type:"relative"},role:"system"},{id:"chatHistory",name:"Chat History",enabled:!0,position:{type:"relative"},role:"system"}],prompts_unused:[],extensions:{}},Gd={temp_openai:"temperature",freq_pen_openai:"frequency_penalty",pres_pen_openai:"presence_penalty",top_p_openai:"top_p",repetition_penalty_openai:"repetition_penalty",min_p_openai:"min_p",top_k_openai:"top_k",top_a_openai:"top_a"};function Vd(e){const t=Md(e),n=zd(e),i=Fd(e);let r=_({}).set("identifier",e.id).set("name",e.name).set("enabled",e.enabled);return!t&&!i||["dialogueExamples","chatHistory"].includes(e.id)||(r=r.set("injection_position","relative"===e.position.type?0:1).set("injection_depth",e.position.depth??4).set("injection_order",e.position.order??100)),r=r.set("role",e.role),(t||n)&&(r=r.set("content",e.content)),r=r.set("system_prompt",n||i).set("marker",i),e.extra&&(r=r.set("extra",e.extra)),r=r.set("forbid_overrides",!1),r.value()}function Zd(e,{in_use:t}){const n=e.prompt_order.find(e=>100001===e.character_id)?.order??[],i=e.prompts.map(e=>function(e,t){const n=!1===e.system_prompt&&(void 0===e.marker||!1===e.marker),i=!0===e.system_prompt&&(void 0===e.marker||!1===e.marker),r=!0===e.marker;let s=_({}).set("id",e.identifier??fe()).set("name",e.name??"unnamed").set("enabled",t.find(t=>t.identifier===e.identifier)?.enabled??e.enabled??!0);return(n||r)&&(s=s.set("position.type",{0:"relative",1:"in_chat"}[e.injection_position??0]),1===e.injection_position&&(s=s.set("position.depth",e.injection_depth??4),s=s.set("position.order",e.injection_order??100))),s=s.set("role",e.role??"system"),(n||i)&&(s=s.set("content",e.content??"")),e.extra&&(s=s.set("extra",e.extra)),s.value()}(e,n)),r=n.map(e=>e.identifier),[s,a]=_.partition(i,e=>r.includes(e.id)),o=r.map(e=>s.find(t=>t.id===e));return{settings:{max_context:e.openai_max_context,max_completion_tokens:e.openai_max_tokens,reply_count:e.n,should_stream:e.stream_openai,temperature:t?e.temp_openai:e.temperature,frequency_penalty:t?e.freq_pen_openai:e.frequency_penalty,presence_penalty:t?e.pres_pen_openai:e.presence_penalty,top_p:t?e.top_p_openai:e.top_p,repetition_penalty:t?e.repetition_penalty_openai:e.repetition_penalty,min_p:t?e.min_p_openai:e.min_p,top_k:t?e.top_k_openai:e.top_k,top_a:t?e.top_a_openai:e.top_a,seed:e.seed,squash_system_messages:e.squash_system_messages,reasoning_effort:e.reasoning_effort,request_thoughts:e.show_thoughts,request_images:e.request_images,enable_function_calling:e.function_calling,enable_web_search:e.enable_web_search,allow_sending_images:!1===e.image_inlining?"disabled":e.inline_image_quality,allow_sending_videos:e.video_inlining,character_name_prefix:{[-1]:"none",0:"default",2:"content",1:"completion"}[e.names_behavior],wrap_user_messages_in_quotes:e.wrap_in_quotes},prompts:o,prompts_unused:a,extensions:e.extensions}}function qd(e){const t=new Set,n=e=>e.map(e=>{const n=((e,n)=>{if(!t.has(e))return t.add(e),e;if(!n)throw Error(`修改的预设中存在重复的系统/占位提示词 '${e}'`);const i=fe();return t.add(i),i})(e.id,Md(e));return{...e,id:n}});e.prompts=n(e.prompts),e.prompts_unused=n(e.prompts_unused);const i=e.prompts.map(e=>Vd(e)),r=e.prompts_unused.map(e=>Vd(e));return{max_context_unlocked:!0,openai_max_context:e.settings.max_context,openai_max_tokens:e.settings.max_completion_tokens,n:e.settings.reply_count,stream_openai:e.settings.should_stream,temp_openai:e.settings.temperature,freq_pen_openai:e.settings.frequency_penalty,pres_pen_openai:e.settings.presence_penalty,top_p_openai:e.settings.top_p,repetition_penalty_openai:e.settings.repetition_penalty,min_p_openai:e.settings.min_p,top_k_openai:e.settings.top_k,top_a_openai:e.settings.top_a,temperature:e.settings.temperature,frequency_penalty:e.settings.frequency_penalty,presence_penalty:e.settings.presence_penalty,top_p:e.settings.top_p,repetition_penalty:e.settings.repetition_penalty,min_p:e.settings.min_p,top_k:e.settings.top_k,top_a:e.settings.top_a,seed:e.settings.seed,squash_system_messages:e.settings.squash_system_messages,reasoning_effort:e.settings.reasoning_effort,show_thoughts:e.settings.request_thoughts,request_images:e.settings.request_images,function_calling:e.settings.enable_function_calling,enable_web_search:e.settings.enable_web_search,image_inlining:"disabled"!==e.settings.allow_sending_images,inline_image_quality:"disabled"===e.settings.allow_sending_images?"auto":e.settings.allow_sending_images,video_inlining:e.settings.allow_sending_videos,names_behavior:{none:-1,default:0,content:2,completion:1}[e.settings.character_name_prefix],wrap_in_quotes:e.settings.wrap_user_messages_in_quotes,prompts:[...i,...r],prompt_order:[{character_id:100001,order:i.map(e=>({identifier:e.identifier,enabled:e.enabled??!0}))}],extensions:e.extensions}}const Hd=nt("openai");function Wd(){return structuredClone(["in_use",...Hd.getAllPresets()])}function Jd(){return Hd.getSelectedPresetName()}function Kd(e){const t=Hd.findPreset(e);return!!t&&(Hd.selectPreset(t),!0)}async function Yd(e,t=Bd){return!Wd().includes(e)&&(await Xd(e,t),!0)}async function Xd(e,t=Bd,{render:n="debounced"}={}){const i=qd(t),r=Wd().includes(e);if(r)!function(e,t,{in_use:n,render:i}){let r=_(e);if(Object.entries(gu).forEach(([e,{oai_setting:i}])=>{r=r.set(n?i:_.get(Gd,i,i),t[e])}),r.value(),!n)return;const s=$(),a=$();Object.entries(gu).forEach(([e,{selector:n,type:i}])=>{switch(i){case"checkbox":$(n).prop("checked",t[e]),s.add(n);break;case"input":$(n).val(t[e]),a.add(n)}}),$(s).trigger("input",{source:"preset"}),$(a).trigger("input",{source:"preset"}),M(),"debounced"===i?Se.renderDebounced():Se.render(!1)}("in_use"===e?$e:Hd.getCompletionPresetByName(e),i,{in_use:"in_use"===e,render:n});else{const{presets:t,preset_names:n}=Hd.getPresetList();t.push(i),n[e]=t.length-1,Hd.select.append($("<option></option>",{value:t.length-1,text:e,selected:!1}))}return"in_use"!==e&&await Hd.savePreset(e,Hd.getCompletionPresetByName(e),{skipUpdate:!0}),!r}async function Qd(e){return Boolean(await Hd.deletePreset(e))}async function ep(e,t){return!!Wd().includes(e)&&(await Yd(t,tp(e)),await Qd(e),!0)}function tp(e){const t="in_use"===e?$e:Hd.getCompletionPresetByName(e);if(!t)throw Error(`预设 '${e}' 不存在`);return structuredClone(Zd(t,{in_use:"in_use"===e}))}async function np(e,t,n={}){if(!Wd().includes(e))throw Error(`预设 '${e}' 不存在`);await Xd(e,t,n)}async function ip(e,t,n={}){if(!Wd().includes(e))throw Error(`预设 '${e}' 不存在`);const i=await t(tp(e));return await np(e,i,n),i}async function rp(e,t,n={}){return await ip(e,e=>({settings:_.defaultsDeep(t.settings,e.settings),prompts:t.prompts??e.prompts,prompts_unused:t.prompts_unused??e.prompts_unused,extensions:_.defaultsDeep(t.extensions,e.extensions)}),n)}async function sp(e){const t=await it(e);if(t.isError)throw Error(`运行 Slash 命令 '${e}' 时出错: ${t.errorMessage}`);return Pt().info(`运行 Slash 命令: ${e}`),t.pipe}const ap="novi028/JS-Slash-Runner",op="manifest.json",cp="CHANGELOG.md",lp=`/scripts/extensions/${Ot}/manifest.json`;let up,dp,pp;async function hp(e){const t=`https://gitlab.com/api/v4/projects/${ap.includes("/")?encodeURIComponent(ap):ap}/repository/files/${encodeURIComponent(e)}/raw?ref=main`,n={"Cache-Control":"no-cache"};try{const e=await fetch(t,{method:"GET",headers:n});if(!e.ok){let n="";try{n=await e.text()}catch(e){}throw new Error(`[TavernHelper] 无法获取 GitLab 文件: ${e.status} ${e.statusText}. URL: ${t}. Response: ${n}`)}return(await e.text()).trim()}catch(e){throw Pt().error("[TavernHelper] 获取 GitLab 文件内容时出错:",e),e}}function fp(e){try{const t=JSON.parse(e);if(t&&"string"==typeof t.version)return t.version;throw new Error("[TavernHelper] 在 JSON 数据中未找到有效的 'version' 字段 (必须是字符串类型)")}catch(e){if(Pt().error("[TavernHelper] 解析版本文件内容时出错:",e),e instanceof SyntaxError)throw new Error(`[TavernHelper] 无法将文件内容解析为 JSON: ${e.message}`);throw new Error(`[TavernHelper] 无法从文件内容中解析版本号: ${e instanceof Error?e.message:String(e)}`)}}async function mp(e){return up=fp(await vp(e)),up}function gp(e,t){const n=e.split("-")[0].split("+")[0],i=t.split("-")[0].split("+")[0],r=n.split(".").map(Number),s=i.split(".").map(Number);for(let n=0;n<3;n++){const i=r[n]||0,a=s[n]||0;if(isNaN(i)||isNaN(a))return Pt().warn(`[TavernHelper] 版本号 "${e}" 或 "${t}" 包含非数字部分，可能导致比较不准确。`),0;if(i>a)return 1;if(i<a)return-1}return 0}async function vp(e){try{const t=await fetch(e);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return await t.text()}catch(t){throw Pt().error(`读取文件 ${e} 失败:`,t),t}}function yp(e,t,n){const i=[...e.matchAll(/(?:^|\n)(?:#{1,3}\s*|\[)([0-9]+\.[0-9]+\.[0-9]+)(?:\]|\s|$)/g)];if(0===i.length)return void toastr.error("无法找到版本日志。");let r="";if(gp(n,t)<=0){const t=i.find(e=>e[1]===n);if(!t)return void toastr.error("获取更新日志失败");const s=t.index,a=i.find(e=>e.index>s),o=a?a.index:e.length;r=e.substring(s,o).trim()}else{const s=i.find(e=>e[1]===t);if(!s)return void toastr.error(`无法找到版本 ${t} 的日志。`);const a=i.find(e=>e[1]===n);if(!a)return void toastr.error(`无法找到版本 ${n} 的日志。`);const o=s.index,c=a.index;r=e.substring(o,c).trim()}return Yi(r)}async function _p(){pp||await async function(){toastr.info("获取更新日志中……");const e=await hp(cp);void 0===dp&&(dp=fp(await hp(op)));void 0===up&&(up=fp(await vp(lp)));const t=yp(e,up,dp);if(!t)return void toastr.error("无法获取更新日志");pp=t}();await ie(pp,ne.CONFIRM,"",{okButton:"更新",cancelButton:"取消"})&&(toastr.info("更新中……"),await wp())}async function bp(e,t){const n=await async function(e,t){return await fetch("/api/extensions/delete",{method:"POST",headers:I(),body:JSON.stringify({extensionName:e,global:t})})}(e,t);return n.ok?async function(e,t){return await fetch("/api/extensions/install",{method:"POST",headers:I(),body:JSON.stringify({url:e,global:t})})}(e,t):n}async function wp(){const e="global"===function(e){const t=Object.keys(K).find(t=>t===e||t.startsWith("third-party")&&t.endsWith(e));return t?K[t]:"local"}(xt),t=()=>{toastr.success("成功更新酒馆助手, 准备刷新页面以生效..."),Pt().info("成功更新酒馆助手, 准备刷新页面以生效..."),setTimeout(()=>location.reload(),3e3)},n=await async function(e,t){return await fetch("/api/extensions/update",{method:"POST",headers:I(),body:JSON.stringify({extensionName:e,global:t})})}(xt,e);if(n.ok)return(await n.json()).isUpToDate?(toastr.success("酒馆助手已是最新版本, 无需更新"),Pt().info("酒馆助手已是最新版本, 无需更新")):t(),!0;if(!await ie(`更新失败: ${await n.text()||n.statusText}\n  是否尝试通过卸载重装来更新?\n  (可能因为网络问题而只卸载了没能重装, 请先复制 \`https://gitlab.com/novi028/JS-Slash-Runner\`)\n  `,ne.CONFIRM))return;const i=await bp(xt,e);if(!i.ok){const e=await i.text();return toastr.error(e||i.statusText,tt`更新酒馆助手失败`,{timeOut:5e3}),Pt().error(`更新酒馆助手失败: ${e}`),!1}return t(),!0}async function $p(){const e=await mp(lp);if("string"!=typeof e)throw new Error("获取的版本号无效");return e}async function kp(){return wp()}function Sp(){return structuredClone(Je)}function Ep(){return structuredClone(ze().world_info.globalSelect)}async function Ip(e){const t=$("#world_info");t.find('option[value!=""]').remove(),t.append(Je.map((t,n)=>{const i=e.includes(t);return new Option(t,String(n),i,i)})),Ve.length=0,Ve.push(...e),M()}function xp(e){return bd("current"===e?void 0:{name:e})}async function Tp(e,t){if("current"!==e)throw Error("目前不支持对非当前角色卡调用 bindCharWorldbooks");return $d(t)}function Op(e){if("current"!==e)throw Error("目前不支持对非当前聊天调用 getChatWorldbookName");return kd()}async function Ap(e,t){if("current"!==e)throw Error("目前不支持对非当前聊天调用 getChatWorldbookName");await Sd(t)}async function Np(e,t){if("current"!==e)throw Error("目前不支持对非当前聊天调用 getChatWorldbookName");return await Ed(t)}const Cp={addMemo:!0,matchPersonaDescription:!1,matchCharacterDescription:!1,matchCharacterPersonality:!1,matchCharacterDepthPrompt:!1,matchScenario:!1,matchCreatorNotes:!1,group:"",groupOverride:!1,groupWeight:100,caseSensitive:null,matchWholeWords:null,useGroupScoring:null,automationId:""};function Dp(e){let t=_({}).set("uid",e.uid).set("name",e.comment).set("enabled",!e.disable).set("strategy.type",e.constant?"constant":e.vectorized?"vectorized":"selective").set("strategy.keys",e.key.map(e=>Be(e)??e)).set("strategy.keys_secondary",{logic:{0:"and_any",1:"not_all",2:"not_any",3:"and_all"}[e.selectiveLogic],keys:e.keysecondary.map(e=>Be(e)??e)}).set("strategy.scan_depth",e.scanDepth??"same_as_global").set("position.type",{0:"before_character_definition",1:"after_character_definition",5:"before_example_messages",6:"after_example_messages",2:"before_author_note",3:"after_author_note",4:"at_depth"}[e.position]).set("position.role",{0:"system",1:"user",2:"assistant"}[e.role??0]).set("position.depth",e.depth).set("position.order",e.order).set("content",e.content).set("probability",e.useProbability?e.probability:100).set("recursion.prevent_incoming",e.excludeRecursion).set("recursion.prevent_outgoing",e.preventRecursion).set("recursion.delay_until","number"==typeof e.delayUntilRecursion?e.delayUntilRecursion:null).set("effect.sticky","number"==typeof e.sticky?e.sticky:null).set("effect.cooldown","number"==typeof e.cooldown?e.cooldown:null).set("effect.delay","number"==typeof e.delay?e.delay:null);return e.extra&&(t=t.set("extra",e.extra)),t=t.merge(_.pick(e,Object.keys(Cp))),t.value()}function Lp(e,t){let n=_({}).set("uid",e.uid).set("displayIndex",t).set("comment",e.name??"").set("disable",!(e.enabled??1)).set("constant",!e?.strategy?.type||"constant"===e?.strategy?.type).set("selective","selective"===e?.strategy?.type).set("key",e?.strategy?.keys?.map(_.toString)??[]).set("selectiveLogic",{and_any:0,not_all:1,not_any:2,and_all:3}[e?.strategy?.keys_secondary?.logic??"and_any"]).set("keysecondary",e?.strategy?.keys_secondary?.keys?.map(_.toString)??[]).set("scanDepth","same_as_global"===e?.strategy?.scan_depth?null:e?.strategy?.scan_depth??null).set("vectorized","vectorized"===e?.strategy?.type).set("position",{before_character_definition:0,after_character_definition:1,before_example_messages:5,after_example_messages:6,before_author_note:2,after_author_note:3,at_depth:4}[e?.position?.type??"at_depth"]).set("role",{system:0,user:1,assistant:2}[e?.position?.role??"system"]).set("depth",e?.position?.depth??4).set("order",e?.position?.order??100).set("content",e.content??"").set("useProbability",!0).set("probability",e.probability??100).set("excludeRecursion",e.recursion?.prevent_incoming??!1).set("preventRecursion",e.recursion?.prevent_outgoing??!1).set("delayUntilRecursion",e.recursion?.delay_until??!1).set("sticky",e.effect?.sticky??null).set("cooldown",e.effect?.cooldown??null).set("delay",e.effect?.delay??null);return e.extra&&(n=n.set("extra",e.extra)),n=n.merge(Cp).merge(_.pick(e,Object.keys(Cp))),n.value()}function Rp(e){const t=1e6,n=new Set,i=e=>{void 0===e&&(e=_.random(0,999999));let i=1;for(;;){if(!n.has(e))return n.add(e),e;e=(e+i*i)%t,++i}};return e.map(e=>({...e,uid:i(e.uid)}))}async function jp(e,t=[]){return!Sp().includes(e)&&await Pp(e,t)}async function Pp(e,t=[],{render:n="debounced"}={}){const i=Sp().includes(e);if(!Sp().includes(e)){if(!await Pe(e,{interactive:!1}))return!1}return(i||t.length>0)&&(await Ge(e,{entries:_.merge({},..._(Rp(t)).map(Lp).map(e=>({[e.uid]:e})).value())}),"debounced"===n?mu(e):fu(e)),!i}async function Up(e){return await Ue(e)}async function Mp(e){if(!Sp().includes(e))throw Error(`未能找到世界书 '${e}'`);const t=await Fe(e).then(e=>e??{});return structuredClone(_(t.entries).values().sortBy("displayIndex").map(Dp).value())}async function zp(e,t,n){if(!Sp().includes(e))throw Error(`未能找到世界书 '${e}'`);await Pp(e,t,n)}async function Fp(e,t,n){return await zp(e,await t(await Mp(e)),n),await Mp(e)}async function Bp(e,t,n){let i;const r=await Fp(e,e=>(i=e.length,[...e,...t]),n);return{worldbook:r,new_entries:r.slice(i)}}async function Gp(e,t,n){let i=[];return{worldbook:await Fp(e,e=>(i=_.remove(e,t),e),n),deleted_entries:i}}async function Vp(e){const t=e.type.toLowerCase(),n=e.mode.toLowerCase();if(!["bgm","ambient"].includes(t)||!["repeat","random","single","stop"].includes(n))return Pt().warn("WARN: Invalid arguments for /audiomode command"),"";if("bgm"===t){Lt("audio.bgm_mode",n);const e={repeat:"fa-repeat",random:"fa-random",single:"fa-redo-alt",stop:"fa-cancel"};$("#audio_bgm_mode_icon").removeClass("fa-repeat fa-random fa-redo-alt fa-cancel"),$("#audio_bgm_mode_icon").addClass(e[n])}else if("ambient"===t){Lt("audio.ambient_mode",n);const e={repeat:"fa-repeat",random:"fa-random",single:"fa-redo-alt",stop:"fa-cancel"};$("#audio_ambient_mode_icon").removeClass("fa-repeat fa-random fa-redo-alt fa-cancel"),$("#audio_ambient_mode_icon").addClass(e[n])}return M(),""}async function Zp(e){const t=e.type.toLowerCase(),n=(e.state||"true").toLowerCase();return t?("bgm"===t?"true"===n?($("#enable_bgm").prop("checked",!0),await Jt("bgm")):"false"===n&&($("#enable_bgm").prop("checked",!1),await Jt("bgm")):"ambient"===t&&("true"===n?($("#enable_ambient").prop("checked",!0),await Jt("ambient")):"false"===n&&($("#enable_ambient").prop("checked",!1),await Jt("ambient"))),""):(Pt().warn("WARN: Missing arguments for /audioenable command"),"")}async function qp(e){const t=e.type.toLowerCase(),n=(e.play||"true").toLowerCase();if(!t)return Pt().warn("WARN: Missing arguments for /audioplaypause command"),"";if("bgm"===t){if("true"===n)await nn("bgm");else if("false"===n){$("#audio_bgm")[0].pause()}}else if("ambient"===t)if("true"===n)await nn("ambient");else if("false"===n){$("#audio_ambient")[0].pause()}return""}async function Hp(e,t){const n=e.type.toLowerCase(),i=(e.play||"true").toLowerCase();if(!n||!t)return Pt().warn("WARN: Missing arguments for /audioimport command"),"";const r=t.split(",").map(e=>e.trim()).filter(e=>""!==e).filter((e,t,n)=>n.indexOf(e)===t);if(0===r.length)return Pt().warn("WARN: Invalid or empty URLs provided."),"";c.variables||(c.variables={});const s="bgm"===n?"bgmurl":"ambienturl",a=c.variables[s]||[],o=[...new Set([...r,...a])];if(c.variables[s]=o,ee(),"bgm"===n?qt("bgm"):"ambient"===n&&qt("ambient"),"true"===i&&r[0]){const e=r[0];"bgm"===n?(Lt("audio.bgm_selected",e),await Zt("bgm",!0)):"ambient"===n&&(Lt("audio.ambient_selected",e),await Zt("ambient",!0))}return""}async function Wp(e,t){const n=e.type.toLowerCase();if(!t)return Pt().warn("WARN: Missing URL for /audioselect command"),"";c.variables||(c.variables={});const i="bgm"===n?zt:Ft,r="bgm"===n?"bgmurl":"ambienturl";if(i&&i.includes(t))return"bgm"===n?(Lt("audio.bgm_selected",t),await Zt("bgm",!0)):"ambient"===n&&(Lt("audio.ambient_selected",t),await Zt("ambient",!0)),"";const s=c.variables[r]||[],a=[...new Set([t,...s])];return c.variables[r]=a,ee(),"bgm"===n?(qt("bgm"),Lt("audio.bgm_selected",t),await Zt("bgm",!0)):"ambient"===n&&(qt("ambient"),Lt("audio.ambient_selected",t),await Zt("ambient",!0)),""}function Jp(){globalThis.TavernHelper={_bind:{_eventOn:Cu,_eventOnButton:Du,_eventMakeLast:Lu,_eventMakeFirst:Ru,_eventOnce:ju,_eventEmit:Pu,_eventEmitAndWait:Uu,_eventRemoveListener:Mu,_eventClearEvent:zu,_eventClearListener:Fu,_eventClearAll:Bu,_getButtonEvent:Eu,_getAllVariables:cc,_getIframeName:tc,_getScriptId:nc,_getCurrentMessageId:ic},audioEnable:Zp,audioImport:Hp,audioMode:Vp,audioPlay:qp,audioSelect:Wp,builtin:vu,Character:yu,getCharData:_u,getCharAvatarPath:bu,getChatHistoryBrief:wu,getChatHistoryDetail:$u,getChatMessages:qo,setChatMessages:Ho,setChatMessage:Yo,createChatMessages:Wo,deleteChatMessages:Jo,rotateChatMessages:Ko,formatAsDisplayedMessage:ku,retrieveDisplayedMessage:Su,tavern_events:Vu,iframe_events:Gu,builtin_prompt_default_order:Zu,generate:hd,generateRaw:fd,getLorebookEntries:Td,replaceLorebookEntries:Cd,updateLorebookEntriesWith:Dd,setLorebookEntries:Ld,createLorebookEntries:Rd,createLorebookEntry:Pd,deleteLorebookEntries:jd,deleteLorebookEntry:Ud,getLorebookSettings:md,setLorebookSettings:gd,getCharLorebooks:bd,setCurrentCharLorebooks:$d,getLorebooks:vd,deleteLorebook:yd,createLorebook:_d,getCurrentCharPrimaryLorebook:wd,getChatLorebook:kd,setChatLorebook:Sd,getOrCreateChatLorebook:Ed,isPresetNormalPrompt:Md,isPresetSystemPrompt:zd,isPresetPlaceholderPrompt:Fd,default_preset:Bd,getPresetNames:Wd,getLoadedPresetName:Jd,loadPreset:Kd,createPreset:Yd,createOrReplacePreset:Xd,deletePreset:Qd,renamePreset:ep,getPreset:tp,replacePreset:np,updatePresetWith:ip,setPreset:rp,registerMacroLike:ni,triggerSlash:sp,triggerSlashWithResult:sp,formatAsTavernRegexedString:ci,isCharacterTavernRegexesEnabled:fi,getTavernRegexes:mi,replaceTavernRegexes:gi,updateTavernRegexesWith:vi,substitudeMacros:Xo,getLastMessageId:Qo,errorCatched:ec,getMessageId:rc,getVariables:oc,replaceVariables:lc,updateVariablesWith:uc,insertOrAssignVariables:dc,deleteVariable:hc,insertVariables:pc,getScriptButtons:Iu,replaceScriptButtons:xu,appendInexistentScriptButtons:Tu,getTavernHelperVersion:$p,updateTavernHelper:kp,getFrontendVersion:$p,updateFrontendVersion:kp,getWorldbookNames:Sp,getGlobalWorldbookNames:Ep,rebindGlobalWorldbooks:Ip,getCharWorldbookNames:xp,rebindCharWorldbooks:Tp,getChatWorldbookName:Op,rebindChatWorldbook:Ap,getOrCreateChatWorldbook:Np,createWorldbook:jp,createOrReplaceWorldbook:Pp,deleteWorldbook:Up,getWorldbook:Mp,replaceWorldbook:zp,updateWorldbookWith:Fp,createWorldbookEntries:Bp,deleteWorldbookEntries:Gp}}async function Kp(e){const t=e.event,n=e.data??[];return p.emit(t,...n),Pt().info(`[Event][/event-emit] 发送 '${t}' 事件, 携带数据: ${JSON.stringify(n)}`),t}const Yp=Object.freeze({status:"aborted"});function Xp(e,t,n){function i(n,i){var r;Object.defineProperty(n,"_zod",{value:n._zod??{},enumerable:!1}),(r=n._zod).traits??(r.traits=new Set),n._zod.traits.add(e),t(n,i);for(const e in a.prototype)e in n||Object.defineProperty(n,e,{value:a.prototype[e].bind(n)});n._zod.constr=a,n._zod.def=i}const r=n?.Parent??Object;class s extends r{}function a(e){var t;const r=n?.Parent?new s:this;i(r,e),(t=r._zod).deferred??(t.deferred=[]);for(const e of r._zod.deferred)e();return r}return Object.defineProperty(s,"name",{value:e}),Object.defineProperty(a,"init",{value:i}),Object.defineProperty(a,Symbol.hasInstance,{value:t=>!!(n?.Parent&&t instanceof n.Parent)||t?._zod?.traits?.has(e)}),Object.defineProperty(a,"name",{value:e}),a}const Qp=Symbol("zod_brand");class eh extends Error{constructor(){super("Encountered Promise during synchronous parse. Use .parseAsync() instead.")}}const th={};function nh(e){return e&&Object.assign(th,e),th}function ih(e){return e}function rh(e){return e}function sh(e){}function ah(e){throw new Error}function oh(e){}function ch(e){const t=Object.values(e).filter(e=>"number"==typeof e);return Object.entries(e).filter(([e,n])=>-1===t.indexOf(+e)).map(([e,t])=>t)}function lh(e,t="|"){return e.map(e=>Uh(e)).join(t)}function uh(e,t){return"bigint"==typeof t?t.toString():t}function dh(e){return{get value(){{const t=e();return Object.defineProperty(this,"value",{value:t}),t}}}}function ph(e){return null==e}function hh(e){const t=e.startsWith("^")?1:0,n=e.endsWith("$")?e.length-1:e.length;return e.slice(t,n)}function fh(e,t){const n=(e.toString().split(".")[1]||"").length,i=t.toString();let r=(i.split(".")[1]||"").length;if(0===r&&/\d?e-\d?/.test(i)){const e=i.match(/\d?e-(\d?)/);e?.[1]&&(r=Number.parseInt(e[1]))}const s=n>r?n:r;return Number.parseInt(e.toFixed(s).replace(".",""))%Number.parseInt(t.toFixed(s).replace(".",""))/10**s}const mh=Symbol("evaluating");function gh(e,t,n){let i;Object.defineProperty(e,t,{get(){if(i!==mh)return void 0===i&&(i=mh,i=n()),i},set(n){Object.defineProperty(e,t,{value:n})},configurable:!0})}function vh(e){return Object.create(Object.getPrototypeOf(e),Object.getOwnPropertyDescriptors(e))}function yh(e,t,n){Object.defineProperty(e,t,{value:n,writable:!0,enumerable:!0,configurable:!0})}function _h(...e){const t={};for(const n of e){const e=Object.getOwnPropertyDescriptors(n);Object.assign(t,e)}return Object.defineProperties({},t)}function bh(e){return _h(e._zod.def)}function wh(e,t){return t?t.reduce((e,t)=>e?.[t],e):e}function $h(e){const t=Object.keys(e),n=t.map(t=>e[t]);return Promise.all(n).then(e=>{const n={};for(let i=0;i<t.length;i++)n[t[i]]=e[i];return n})}function kh(e=10){const t="abcdefghijklmnopqrstuvwxyz";let n="";for(let i=0;i<e;i++)n+=t[Math.floor(26*Math.random())];return n}function Sh(e){return JSON.stringify(e)}const Eh="captureStackTrace"in Error?Error.captureStackTrace:(...e)=>{};function Ih(e){return"object"==typeof e&&null!==e&&!Array.isArray(e)}const xh=dh(()=>{if("undefined"!=typeof navigator&&navigator?.userAgent?.includes("Cloudflare"))return!1;try{return new Function(""),!0}catch(e){return!1}});function Th(e){if(!1===Ih(e))return!1;const t=e.constructor;if(void 0===t)return!0;const n=t.prototype;return!1!==Ih(n)&&!1!==Object.prototype.hasOwnProperty.call(n,"isPrototypeOf")}function Oh(e){return Th(e)?{...e}:e}function Ah(e){let t=0;for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t++;return t}const Nh=e=>{const t=typeof e;switch(t){case"undefined":return"undefined";case"string":return"string";case"number":return Number.isNaN(e)?"nan":"number";case"boolean":return"boolean";case"function":return"function";case"bigint":return"bigint";case"symbol":return"symbol";case"object":return Array.isArray(e)?"array":null===e?"null":e.then&&"function"==typeof e.then&&e.catch&&"function"==typeof e.catch?"promise":"undefined"!=typeof Map&&e instanceof Map?"map":"undefined"!=typeof Set&&e instanceof Set?"set":"undefined"!=typeof Date&&e instanceof Date?"date":"undefined"!=typeof File&&e instanceof File?"file":"object";default:throw new Error(`Unknown data type: ${t}`)}},Ch=new Set(["string","number","symbol"]),Dh=new Set(["string","number","bigint","boolean","symbol","undefined"]);function Lh(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function Rh(e,t,n){const i=new e._zod.constr(t??e._zod.def);return t&&!n?.parent||(i._zod.parent=e),i}function jh(e){const t=e;if(!t)return{};if("string"==typeof t)return{error:()=>t};if(void 0!==t?.message){if(void 0!==t?.error)throw new Error("Cannot specify both `message` and `error` params");t.error=t.message}return delete t.message,"string"==typeof t.error?{...t,error:()=>t.error}:t}function Ph(e){let t;return new Proxy({},{get:(n,i,r)=>(t??(t=e()),Reflect.get(t,i,r)),set:(n,i,r,s)=>(t??(t=e()),Reflect.set(t,i,r,s)),has:(n,i)=>(t??(t=e()),Reflect.has(t,i)),deleteProperty:(n,i)=>(t??(t=e()),Reflect.deleteProperty(t,i)),ownKeys:n=>(t??(t=e()),Reflect.ownKeys(t)),getOwnPropertyDescriptor:(n,i)=>(t??(t=e()),Reflect.getOwnPropertyDescriptor(t,i)),defineProperty:(n,i,r)=>(t??(t=e()),Reflect.defineProperty(t,i,r))})}function Uh(e){return"bigint"==typeof e?e.toString()+"n":"string"==typeof e?`"${e}"`:`${e}`}function Mh(e){return Object.keys(e).filter(t=>"optional"===e[t]._zod.optin&&"optional"===e[t]._zod.optout)}const zh={safeint:[Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],int32:[-2147483648,2147483647],uint32:[0,4294967295],float32:[-34028234663852886e22,34028234663852886e22],float64:[-Number.MAX_VALUE,Number.MAX_VALUE]},Fh={int64:[BigInt("-9223372036854775808"),BigInt("9223372036854775807")],uint64:[BigInt(0),BigInt("18446744073709551615")]};function Bh(e,t){const n=e._zod.def;return Rh(e,_h(e._zod.def,{get shape(){const e={};for(const i in t){if(!(i in n.shape))throw new Error(`Unrecognized key: "${i}"`);t[i]&&(e[i]=n.shape[i])}return yh(this,"shape",e),e},checks:[]}))}function Gh(e,t){const n=e._zod.def,i=_h(e._zod.def,{get shape(){const i={...e._zod.def.shape};for(const e in t){if(!(e in n.shape))throw new Error(`Unrecognized key: "${e}"`);t[e]&&delete i[e]}return yh(this,"shape",i),i},checks:[]});return Rh(e,i)}function Vh(e,t){if(!Th(t))throw new Error("Invalid input to extend: expected a plain object");const n=_h(e._zod.def,{get shape(){const n={...e._zod.def.shape,...t};return yh(this,"shape",n),n},checks:[]});return Rh(e,n)}function Zh(e,t){const n=_h(e._zod.def,{get shape(){const n={...e._zod.def.shape,...t._zod.def.shape};return yh(this,"shape",n),n},get catchall(){return t._zod.def.catchall},checks:[]});return Rh(e,n)}function qh(e,t,n){const i=_h(t._zod.def,{get shape(){const i=t._zod.def.shape,r={...i};if(n)for(const t in n){if(!(t in i))throw new Error(`Unrecognized key: "${t}"`);n[t]&&(r[t]=e?new e({type:"optional",innerType:i[t]}):i[t])}else for(const t in i)r[t]=e?new e({type:"optional",innerType:i[t]}):i[t];return yh(this,"shape",r),r},checks:[]});return Rh(t,i)}function Hh(e,t,n){const i=_h(t._zod.def,{get shape(){const i=t._zod.def.shape,r={...i};if(n)for(const t in n){if(!(t in r))throw new Error(`Unrecognized key: "${t}"`);n[t]&&(r[t]=new e({type:"nonoptional",innerType:i[t]}))}else for(const t in i)r[t]=new e({type:"nonoptional",innerType:i[t]});return yh(this,"shape",r),r},checks:[]});return Rh(t,i)}function Wh(e,t=0){for(let n=t;n<e.issues.length;n++)if(!0!==e.issues[n]?.continue)return!0;return!1}function Jh(e,t){return t.map(t=>{var n;return(n=t).path??(n.path=[]),t.path.unshift(e),t})}function Kh(e){return"string"==typeof e?e:e?.message}function Yh(e,t,n){const i={...e,path:e.path??[]};if(!e.message){const r=Kh(e.inst?._zod.def?.error?.(e))??Kh(t?.error?.(e))??Kh(n.customError?.(e))??Kh(n.localeError?.(e))??"Invalid input";i.message=r}return delete i.inst,delete i.continue,t?.reportInput||delete i.input,i}function Xh(e){return e instanceof Set?"set":e instanceof Map?"map":e instanceof File?"file":"unknown"}function Qh(e){return Array.isArray(e)?"array":"string"==typeof e?"string":"unknown"}function ef(...e){const[t,n,i]=e;return"string"==typeof t?{message:t,code:"custom",input:n,inst:i}:{...t}}function tf(e){return Object.entries(e).filter(([e,t])=>Number.isNaN(Number.parseInt(e,10))).map(e=>e[1])}class nf{constructor(...e){}}const rf=(e,t)=>{e.name="$ZodError",Object.defineProperty(e,"_zod",{value:e._zod,enumerable:!1}),Object.defineProperty(e,"issues",{value:t,enumerable:!1}),e.message=JSON.stringify(t,uh,2),Object.defineProperty(e,"toString",{value:()=>e.message,enumerable:!1})},sf=Xp("$ZodError",rf),af=Xp("$ZodError",rf,{Parent:Error});function of(e,t=e=>e.message){const n={},i=[];for(const r of e.issues)r.path.length>0?(n[r.path[0]]=n[r.path[0]]||[],n[r.path[0]].push(t(r))):i.push(t(r));return{formErrors:i,fieldErrors:n}}function cf(e,t){const n=t||function(e){return e.message},i={_errors:[]},r=e=>{for(const t of e.issues)if("invalid_union"===t.code&&t.errors.length)t.errors.map(e=>r({issues:e}));else if("invalid_key"===t.code)r({issues:t.issues});else if("invalid_element"===t.code)r({issues:t.issues});else if(0===t.path.length)i._errors.push(n(t));else{let e=i,r=0;for(;r<t.path.length;){const i=t.path[r];r===t.path.length-1?(e[i]=e[i]||{_errors:[]},e[i]._errors.push(n(t))):e[i]=e[i]||{_errors:[]},e=e[i],r++}}};return r(e),i}function lf(e,t){const n=t||function(e){return e.message},i={errors:[]},r=(e,t=[])=>{var s,a;for(const o of e.issues)if("invalid_union"===o.code&&o.errors.length)o.errors.map(e=>r({issues:e},o.path));else if("invalid_key"===o.code)r({issues:o.issues},o.path);else if("invalid_element"===o.code)r({issues:o.issues},o.path);else{const e=[...t,...o.path];if(0===e.length){i.errors.push(n(o));continue}let r=i,c=0;for(;c<e.length;){const t=e[c],i=c===e.length-1;"string"==typeof t?(r.properties??(r.properties={}),(s=r.properties)[t]??(s[t]={errors:[]}),r=r.properties[t]):(r.items??(r.items=[]),(a=r.items)[t]??(a[t]={errors:[]}),r=r.items[t]),i&&r.errors.push(n(o)),c++}}};return r(e),i}function uf(e){const t=[],n=e.map(e=>"object"==typeof e?e.key:e);for(const e of n)"number"==typeof e?t.push(`[${e}]`):"symbol"==typeof e?t.push(`[${JSON.stringify(String(e))}]`):/[^\w$]/.test(e)?t.push(`[${JSON.stringify(e)}]`):(t.length&&t.push("."),t.push(e));return t.join("")}function df(e){const t=[],n=[...e.issues].sort((e,t)=>(e.path??[]).length-(t.path??[]).length);for(const e of n)t.push(`✖ ${e.message}`),e.path?.length&&t.push(`  → at ${uf(e.path)}`);return t.join("\n")}const pf=e=>(t,n,i,r)=>{const s=i?Object.assign(i,{async:!1}):{async:!1},a=t._zod.run({value:n,issues:[]},s);if(a instanceof Promise)throw new eh;if(a.issues.length){const t=new(r?.Err??e)(a.issues.map(e=>Yh(e,s,nh())));throw Eh(t,r?.callee),t}return a.value},hf=pf(af),ff=e=>async(t,n,i,r)=>{const s=i?Object.assign(i,{async:!0}):{async:!0};let a=t._zod.run({value:n,issues:[]},s);if(a instanceof Promise&&(a=await a),a.issues.length){const t=new(r?.Err??e)(a.issues.map(e=>Yh(e,s,nh())));throw Eh(t,r?.callee),t}return a.value},mf=ff(af),gf=e=>(t,n,i)=>{const r=i?{...i,async:!1}:{async:!1},s=t._zod.run({value:n,issues:[]},r);if(s instanceof Promise)throw new eh;return s.issues.length?{success:!1,error:new(e??sf)(s.issues.map(e=>Yh(e,r,nh())))}:{success:!0,data:s.value}},vf=gf(af),yf=e=>async(t,n,i)=>{const r=i?Object.assign(i,{async:!0}):{async:!0};let s=t._zod.run({value:n,issues:[]},r);return s instanceof Promise&&(s=await s),s.issues.length?{success:!1,error:new e(s.issues.map(e=>Yh(e,r,nh())))}:{success:!0,data:s.value}},_f=yf(af),bf=/^[cC][^\s-]{8,}$/,wf=/^[0-9a-z]+$/,$f=/^[0-9A-HJKMNP-TV-Za-hjkmnp-tv-z]{26}$/,kf=/^[0-9a-vA-V]{20}$/,Sf=/^[A-Za-z0-9]{27}$/,Ef=/^[a-zA-Z0-9_-]{21}$/,If=/^P(?:(\d+W)|(?!.*W)(?=\d|T\d)(\d+Y)?(\d+M)?(\d+D)?(T(?=\d)(\d+H)?(\d+M)?(\d+([.,]\d+)?S)?)?)$/,xf=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,Tf=/^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12})$/,Of=e=>e?new RegExp(`^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-${e}[0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12})$`):/^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-8][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}|00000000-0000-0000-0000-000000000000)$/,Af=Of(4),Nf=Of(6),Cf=Of(7),Df=/^(?!\.)(?!.*\.\.)([A-Za-z0-9_'+\-\.]*)[A-Za-z0-9_+-]@([A-Za-z0-9][A-Za-z0-9\-]*\.)+[A-Za-z]{2,}$/,Lf=/^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/,Rf=/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/,jf=/^[^\s@"]{1,64}@[^\s@]{1,255}$/u,Pf=/^[^\s@"]{1,64}@[^\s@]{1,255}$/u,Uf=/^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/,Mf="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$";function zf(){return new RegExp(Mf,"u")}const Ff=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,Bf=/^(([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}|::|([0-9a-fA-F]{1,4})?::([0-9a-fA-F]{1,4}:?){0,6})$/,Gf=/^((25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/([0-9]|[1-2][0-9]|3[0-2])$/,Vf=/^(([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}|::|([0-9a-fA-F]{1,4})?::([0-9a-fA-F]{1,4}:?){0,6})\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,Zf=/^$|^(?:[0-9a-zA-Z+/]{4})*(?:(?:[0-9a-zA-Z+/]{2}==)|(?:[0-9a-zA-Z+/]{3}=))?$/,qf=/^[A-Za-z0-9_-]*$/,Hf=/^(?=.{1,253}\.?$)[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[-0-9a-zA-Z]{0,61}[0-9a-zA-Z])?)*\.?$/,Wf=/^([a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?\.)+[a-zA-Z]{2,}$/,Jf=/^\+(?:[0-9]){6,14}[0-9]$/,Kf="(?:(?:\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-(?:(?:0[13578]|1[02])-(?:0[1-9]|[12]\\d|3[01])|(?:0[469]|11)-(?:0[1-9]|[12]\\d|30)|(?:02)-(?:0[1-9]|1\\d|2[0-8])))",Yf=new RegExp(`^${Kf}$`);function Xf(e){const t="(?:[01]\\d|2[0-3]):[0-5]\\d";return"number"==typeof e.precision?-1===e.precision?`${t}`:0===e.precision?`${t}:[0-5]\\d`:`${t}:[0-5]\\d\\.\\d{${e.precision}}`:`${t}(?::[0-5]\\d(?:\\.\\d+)?)?`}function Qf(e){return new RegExp(`^${Xf(e)}$`)}function em(e){const t=Xf({precision:e.precision}),n=["Z"];e.local&&n.push(""),e.offset&&n.push("([+-](?:[01]\\d|2[0-3]):[0-5]\\d)");const i=`${t}(?:${n.join("|")})`;return new RegExp(`^${Kf}T(?:${i})$`)}const tm=e=>new RegExp(`^${e?`[\\s\\S]{${e?.minimum??0},${e?.maximum??""}}`:"[\\s\\S]*"}$`),nm=/^\d+n?$/,im=/^\d+$/,rm=/^-?\d+(?:\.\d+)?/i,sm=/true|false/i,am=/null/i,om=/undefined/i,cm=/^[^A-Z]*$/,lm=/^[^a-z]*$/,um=Xp("$ZodCheck",(e,t)=>{var n;e._zod??(e._zod={}),e._zod.def=t,(n=e._zod).onattach??(n.onattach=[])}),dm={number:"number",bigint:"bigint",object:"date"},pm=Xp("$ZodCheckLessThan",(e,t)=>{um.init(e,t);const n=dm[typeof t.value];e._zod.onattach.push(e=>{const n=e._zod.bag,i=(t.inclusive?n.maximum:n.exclusiveMaximum)??Number.POSITIVE_INFINITY;t.value<i&&(t.inclusive?n.maximum=t.value:n.exclusiveMaximum=t.value)}),e._zod.check=i=>{(t.inclusive?i.value<=t.value:i.value<t.value)||i.issues.push({origin:n,code:"too_big",maximum:t.value,input:i.value,inclusive:t.inclusive,inst:e,continue:!t.abort})}}),hm=Xp("$ZodCheckGreaterThan",(e,t)=>{um.init(e,t);const n=dm[typeof t.value];e._zod.onattach.push(e=>{const n=e._zod.bag,i=(t.inclusive?n.minimum:n.exclusiveMinimum)??Number.NEGATIVE_INFINITY;t.value>i&&(t.inclusive?n.minimum=t.value:n.exclusiveMinimum=t.value)}),e._zod.check=i=>{(t.inclusive?i.value>=t.value:i.value>t.value)||i.issues.push({origin:n,code:"too_small",minimum:t.value,input:i.value,inclusive:t.inclusive,inst:e,continue:!t.abort})}}),fm=Xp("$ZodCheckMultipleOf",(e,t)=>{um.init(e,t),e._zod.onattach.push(e=>{var n;(n=e._zod.bag).multipleOf??(n.multipleOf=t.value)}),e._zod.check=n=>{if(typeof n.value!=typeof t.value)throw new Error("Cannot mix number and bigint in multiple_of check.");("bigint"==typeof n.value?n.value%t.value===BigInt(0):0===fh(n.value,t.value))||n.issues.push({origin:typeof n.value,code:"not_multiple_of",divisor:t.value,input:n.value,inst:e,continue:!t.abort})}}),mm=Xp("$ZodCheckNumberFormat",(e,t)=>{um.init(e,t),t.format=t.format||"float64";const n=t.format?.includes("int"),i=n?"int":"number",[r,s]=zh[t.format];e._zod.onattach.push(e=>{const i=e._zod.bag;i.format=t.format,i.minimum=r,i.maximum=s,n&&(i.pattern=im)}),e._zod.check=a=>{const o=a.value;if(n){if(!Number.isInteger(o))return void a.issues.push({expected:i,format:t.format,code:"invalid_type",continue:!1,input:o,inst:e});if(!Number.isSafeInteger(o))return void(o>0?a.issues.push({input:o,code:"too_big",maximum:Number.MAX_SAFE_INTEGER,note:"Integers must be within the safe integer range.",inst:e,origin:i,continue:!t.abort}):a.issues.push({input:o,code:"too_small",minimum:Number.MIN_SAFE_INTEGER,note:"Integers must be within the safe integer range.",inst:e,origin:i,continue:!t.abort}))}o<r&&a.issues.push({origin:"number",input:o,code:"too_small",minimum:r,inclusive:!0,inst:e,continue:!t.abort}),o>s&&a.issues.push({origin:"number",input:o,code:"too_big",maximum:s,inst:e})}}),gm=Xp("$ZodCheckBigIntFormat",(e,t)=>{um.init(e,t);const[n,i]=Fh[t.format];e._zod.onattach.push(e=>{const r=e._zod.bag;r.format=t.format,r.minimum=n,r.maximum=i}),e._zod.check=r=>{const s=r.value;s<n&&r.issues.push({origin:"bigint",input:s,code:"too_small",minimum:n,inclusive:!0,inst:e,continue:!t.abort}),s>i&&r.issues.push({origin:"bigint",input:s,code:"too_big",maximum:i,inst:e})}}),vm=Xp("$ZodCheckMaxSize",(e,t)=>{var n;um.init(e,t),(n=e._zod.def).when??(n.when=e=>{const t=e.value;return!ph(t)&&void 0!==t.size}),e._zod.onattach.push(e=>{const n=e._zod.bag.maximum??Number.POSITIVE_INFINITY;t.maximum<n&&(e._zod.bag.maximum=t.maximum)}),e._zod.check=n=>{const i=n.value;i.size<=t.maximum||n.issues.push({origin:Xh(i),code:"too_big",maximum:t.maximum,input:i,inst:e,continue:!t.abort})}}),ym=Xp("$ZodCheckMinSize",(e,t)=>{var n;um.init(e,t),(n=e._zod.def).when??(n.when=e=>{const t=e.value;return!ph(t)&&void 0!==t.size}),e._zod.onattach.push(e=>{const n=e._zod.bag.minimum??Number.NEGATIVE_INFINITY;t.minimum>n&&(e._zod.bag.minimum=t.minimum)}),e._zod.check=n=>{const i=n.value;i.size>=t.minimum||n.issues.push({origin:Xh(i),code:"too_small",minimum:t.minimum,input:i,inst:e,continue:!t.abort})}}),_m=Xp("$ZodCheckSizeEquals",(e,t)=>{var n;um.init(e,t),(n=e._zod.def).when??(n.when=e=>{const t=e.value;return!ph(t)&&void 0!==t.size}),e._zod.onattach.push(e=>{const n=e._zod.bag;n.minimum=t.size,n.maximum=t.size,n.size=t.size}),e._zod.check=n=>{const i=n.value,r=i.size;if(r===t.size)return;const s=r>t.size;n.issues.push({origin:Xh(i),...s?{code:"too_big",maximum:t.size}:{code:"too_small",minimum:t.size},inclusive:!0,exact:!0,input:n.value,inst:e,continue:!t.abort})}}),bm=Xp("$ZodCheckMaxLength",(e,t)=>{var n;um.init(e,t),(n=e._zod.def).when??(n.when=e=>{const t=e.value;return!ph(t)&&void 0!==t.length}),e._zod.onattach.push(e=>{const n=e._zod.bag.maximum??Number.POSITIVE_INFINITY;t.maximum<n&&(e._zod.bag.maximum=t.maximum)}),e._zod.check=n=>{const i=n.value;if(i.length<=t.maximum)return;const r=Qh(i);n.issues.push({origin:r,code:"too_big",maximum:t.maximum,inclusive:!0,input:i,inst:e,continue:!t.abort})}}),wm=Xp("$ZodCheckMinLength",(e,t)=>{var n;um.init(e,t),(n=e._zod.def).when??(n.when=e=>{const t=e.value;return!ph(t)&&void 0!==t.length}),e._zod.onattach.push(e=>{const n=e._zod.bag.minimum??Number.NEGATIVE_INFINITY;t.minimum>n&&(e._zod.bag.minimum=t.minimum)}),e._zod.check=n=>{const i=n.value;if(i.length>=t.minimum)return;const r=Qh(i);n.issues.push({origin:r,code:"too_small",minimum:t.minimum,inclusive:!0,input:i,inst:e,continue:!t.abort})}}),$m=Xp("$ZodCheckLengthEquals",(e,t)=>{var n;um.init(e,t),(n=e._zod.def).when??(n.when=e=>{const t=e.value;return!ph(t)&&void 0!==t.length}),e._zod.onattach.push(e=>{const n=e._zod.bag;n.minimum=t.length,n.maximum=t.length,n.length=t.length}),e._zod.check=n=>{const i=n.value,r=i.length;if(r===t.length)return;const s=Qh(i),a=r>t.length;n.issues.push({origin:s,...a?{code:"too_big",maximum:t.length}:{code:"too_small",minimum:t.length},inclusive:!0,exact:!0,input:n.value,inst:e,continue:!t.abort})}}),km=Xp("$ZodCheckStringFormat",(e,t)=>{var n,i;um.init(e,t),e._zod.onattach.push(e=>{const n=e._zod.bag;n.format=t.format,t.pattern&&(n.patterns??(n.patterns=new Set),n.patterns.add(t.pattern))}),t.pattern?(n=e._zod).check??(n.check=n=>{t.pattern.lastIndex=0,t.pattern.test(n.value)||n.issues.push({origin:"string",code:"invalid_format",format:t.format,input:n.value,...t.pattern?{pattern:t.pattern.toString()}:{},inst:e,continue:!t.abort})}):(i=e._zod).check??(i.check=()=>{})}),Sm=Xp("$ZodCheckRegex",(e,t)=>{km.init(e,t),e._zod.check=n=>{t.pattern.lastIndex=0,t.pattern.test(n.value)||n.issues.push({origin:"string",code:"invalid_format",format:"regex",input:n.value,pattern:t.pattern.toString(),inst:e,continue:!t.abort})}}),Em=Xp("$ZodCheckLowerCase",(e,t)=>{t.pattern??(t.pattern=cm),km.init(e,t)}),Im=Xp("$ZodCheckUpperCase",(e,t)=>{t.pattern??(t.pattern=lm),km.init(e,t)}),xm=Xp("$ZodCheckIncludes",(e,t)=>{um.init(e,t);const n=Lh(t.includes),i=new RegExp("number"==typeof t.position?`^.{${t.position}}${n}`:n);t.pattern=i,e._zod.onattach.push(e=>{const t=e._zod.bag;t.patterns??(t.patterns=new Set),t.patterns.add(i)}),e._zod.check=n=>{n.value.includes(t.includes,t.position)||n.issues.push({origin:"string",code:"invalid_format",format:"includes",includes:t.includes,input:n.value,inst:e,continue:!t.abort})}}),Tm=Xp("$ZodCheckStartsWith",(e,t)=>{um.init(e,t);const n=new RegExp(`^${Lh(t.prefix)}.*`);t.pattern??(t.pattern=n),e._zod.onattach.push(e=>{const t=e._zod.bag;t.patterns??(t.patterns=new Set),t.patterns.add(n)}),e._zod.check=n=>{n.value.startsWith(t.prefix)||n.issues.push({origin:"string",code:"invalid_format",format:"starts_with",prefix:t.prefix,input:n.value,inst:e,continue:!t.abort})}}),Om=Xp("$ZodCheckEndsWith",(e,t)=>{um.init(e,t);const n=new RegExp(`.*${Lh(t.suffix)}$`);t.pattern??(t.pattern=n),e._zod.onattach.push(e=>{const t=e._zod.bag;t.patterns??(t.patterns=new Set),t.patterns.add(n)}),e._zod.check=n=>{n.value.endsWith(t.suffix)||n.issues.push({origin:"string",code:"invalid_format",format:"ends_with",suffix:t.suffix,input:n.value,inst:e,continue:!t.abort})}});function Am(e,t,n){e.issues.length&&t.issues.push(...Jh(n,e.issues))}const Nm=Xp("$ZodCheckProperty",(e,t)=>{um.init(e,t),e._zod.check=e=>{const n=t.schema._zod.run({value:e.value[t.property],issues:[]},{});if(n instanceof Promise)return n.then(n=>Am(n,e,t.property));Am(n,e,t.property)}}),Cm=Xp("$ZodCheckMimeType",(e,t)=>{um.init(e,t);const n=new Set(t.mime);e._zod.onattach.push(e=>{e._zod.bag.mime=t.mime}),e._zod.check=i=>{n.has(i.value.type)||i.issues.push({code:"invalid_value",values:t.mime,input:i.value.type,inst:e,continue:!t.abort})}}),Dm=Xp("$ZodCheckOverwrite",(e,t)=>{um.init(e,t),e._zod.check=e=>{e.value=t.tx(e.value)}});class Lm{constructor(e=[]){this.content=[],this.indent=0,this&&(this.args=e)}indented(e){this.indent+=1,e(this),this.indent-=1}write(e){if("function"==typeof e)return e(this,{execution:"sync"}),void e(this,{execution:"async"});const t=e.split("\n").filter(e=>e),n=Math.min(...t.map(e=>e.length-e.trimStart().length)),i=t.map(e=>e.slice(n)).map(e=>" ".repeat(2*this.indent)+e);for(const e of i)this.content.push(e)}compile(){const e=Function,t=this?.args;return new e(...t,[...(this?.content??[""]).map(e=>`  ${e}`)].join("\n"))}}const Rm={major:4,minor:0,patch:17},jm=Xp("$ZodType",(e,t)=>{var n;e??(e={}),e._zod.def=t,e._zod.bag=e._zod.bag||{},e._zod.version=Rm;const i=[...e._zod.def.checks??[]];e._zod.traits.has("$ZodCheck")&&i.unshift(e);for(const t of i)for(const n of t._zod.onattach)n(e);if(0===i.length)(n=e._zod).deferred??(n.deferred=[]),e._zod.deferred?.push(()=>{e._zod.run=e._zod.parse});else{const t=(e,t,n)=>{let i,r=Wh(e);for(const s of t){if(s._zod.def.when){if(!s._zod.def.when(e))continue}else if(r)continue;const t=e.issues.length,a=s._zod.check(e);if(a instanceof Promise&&!1===n?.async)throw new eh;if(i||a instanceof Promise)i=(i??Promise.resolve()).then(async()=>{await a;e.issues.length!==t&&(r||(r=Wh(e,t)))});else{if(e.issues.length===t)continue;r||(r=Wh(e,t))}}return i?i.then(()=>e):e};e._zod.run=(n,r)=>{const s=e._zod.parse(n,r);if(s instanceof Promise){if(!1===r.async)throw new eh;return s.then(e=>t(e,i,r))}return t(s,i,r)}}e["~standard"]={validate:t=>{try{const n=vf(e,t);return n.success?{value:n.data}:{issues:n.error?.issues}}catch(n){return _f(e,t).then(e=>e.success?{value:e.data}:{issues:e.error?.issues})}},vendor:"zod",version:1}}),Pm=Xp("$ZodString",(e,t)=>{jm.init(e,t),e._zod.pattern=[...e?._zod.bag?.patterns??[]].pop()??tm(e._zod.bag),e._zod.parse=(n,i)=>{if(t.coerce)try{n.value=String(n.value)}catch(i){}return"string"==typeof n.value||n.issues.push({expected:"string",code:"invalid_type",input:n.value,inst:e}),n}}),Um=Xp("$ZodStringFormat",(e,t)=>{km.init(e,t),Pm.init(e,t)}),Mm=Xp("$ZodGUID",(e,t)=>{t.pattern??(t.pattern=Tf),Um.init(e,t)}),zm=Xp("$ZodUUID",(e,t)=>{if(t.version){const e={v1:1,v2:2,v3:3,v4:4,v5:5,v6:6,v7:7,v8:8}[t.version];if(void 0===e)throw new Error(`Invalid UUID version: "${t.version}"`);t.pattern??(t.pattern=Of(e))}else t.pattern??(t.pattern=Of());Um.init(e,t)}),Fm=Xp("$ZodEmail",(e,t)=>{t.pattern??(t.pattern=Df),Um.init(e,t)}),Bm=Xp("$ZodURL",(e,t)=>{Um.init(e,t),e._zod.check=n=>{try{const i=n.value.trim(),r=new URL(i);return t.hostname&&(t.hostname.lastIndex=0,t.hostname.test(r.hostname)||n.issues.push({code:"invalid_format",format:"url",note:"Invalid hostname",pattern:Hf.source,input:n.value,inst:e,continue:!t.abort})),t.protocol&&(t.protocol.lastIndex=0,t.protocol.test(r.protocol.endsWith(":")?r.protocol.slice(0,-1):r.protocol)||n.issues.push({code:"invalid_format",format:"url",note:"Invalid protocol",pattern:t.protocol.source,input:n.value,inst:e,continue:!t.abort})),void(t.normalize?n.value=r.href:n.value=i)}catch(i){n.issues.push({code:"invalid_format",format:"url",input:n.value,inst:e,continue:!t.abort})}}}),Gm=Xp("$ZodEmoji",(e,t)=>{t.pattern??(t.pattern=zf()),Um.init(e,t)}),Vm=Xp("$ZodNanoID",(e,t)=>{t.pattern??(t.pattern=Ef),Um.init(e,t)}),Zm=Xp("$ZodCUID",(e,t)=>{t.pattern??(t.pattern=bf),Um.init(e,t)}),qm=Xp("$ZodCUID2",(e,t)=>{t.pattern??(t.pattern=wf),Um.init(e,t)}),Hm=Xp("$ZodULID",(e,t)=>{t.pattern??(t.pattern=$f),Um.init(e,t)}),Wm=Xp("$ZodXID",(e,t)=>{t.pattern??(t.pattern=kf),Um.init(e,t)}),Jm=Xp("$ZodKSUID",(e,t)=>{t.pattern??(t.pattern=Sf),Um.init(e,t)}),Km=Xp("$ZodISODateTime",(e,t)=>{t.pattern??(t.pattern=em(t)),Um.init(e,t)}),Ym=Xp("$ZodISODate",(e,t)=>{t.pattern??(t.pattern=Yf),Um.init(e,t)}),Xm=Xp("$ZodISOTime",(e,t)=>{t.pattern??(t.pattern=Qf(t)),Um.init(e,t)}),Qm=Xp("$ZodISODuration",(e,t)=>{t.pattern??(t.pattern=If),Um.init(e,t)}),eg=Xp("$ZodIPv4",(e,t)=>{t.pattern??(t.pattern=Ff),Um.init(e,t),e._zod.onattach.push(e=>{e._zod.bag.format="ipv4"})}),tg=Xp("$ZodIPv6",(e,t)=>{t.pattern??(t.pattern=Bf),Um.init(e,t),e._zod.onattach.push(e=>{e._zod.bag.format="ipv6"}),e._zod.check=n=>{try{new URL(`http://[${n.value}]`)}catch{n.issues.push({code:"invalid_format",format:"ipv6",input:n.value,inst:e,continue:!t.abort})}}}),ng=Xp("$ZodCIDRv4",(e,t)=>{t.pattern??(t.pattern=Gf),Um.init(e,t)}),ig=Xp("$ZodCIDRv6",(e,t)=>{t.pattern??(t.pattern=Vf),Um.init(e,t),e._zod.check=n=>{const[i,r]=n.value.split("/");try{if(!r)throw new Error;const e=Number(r);if(`${e}`!==r)throw new Error;if(e<0||e>128)throw new Error;new URL(`http://[${i}]`)}catch{n.issues.push({code:"invalid_format",format:"cidrv6",input:n.value,inst:e,continue:!t.abort})}}});function rg(e){if(""===e)return!0;if(e.length%4!=0)return!1;try{return atob(e),!0}catch{return!1}}const sg=Xp("$ZodBase64",(e,t)=>{t.pattern??(t.pattern=Zf),Um.init(e,t),e._zod.onattach.push(e=>{e._zod.bag.contentEncoding="base64"}),e._zod.check=n=>{rg(n.value)||n.issues.push({code:"invalid_format",format:"base64",input:n.value,inst:e,continue:!t.abort})}});function ag(e){if(!qf.test(e))return!1;const t=e.replace(/[-_]/g,e=>"-"===e?"+":"/");return rg(t.padEnd(4*Math.ceil(t.length/4),"="))}const og=Xp("$ZodBase64URL",(e,t)=>{t.pattern??(t.pattern=qf),Um.init(e,t),e._zod.onattach.push(e=>{e._zod.bag.contentEncoding="base64url"}),e._zod.check=n=>{ag(n.value)||n.issues.push({code:"invalid_format",format:"base64url",input:n.value,inst:e,continue:!t.abort})}}),cg=Xp("$ZodE164",(e,t)=>{t.pattern??(t.pattern=Jf),Um.init(e,t)});function lg(e,t=null){try{const n=e.split(".");if(3!==n.length)return!1;const[i]=n;if(!i)return!1;const r=JSON.parse(atob(i));return(!("typ"in r)||"JWT"===r?.typ)&&(!!r.alg&&(!t||"alg"in r&&r.alg===t))}catch{return!1}}const ug=Xp("$ZodJWT",(e,t)=>{Um.init(e,t),e._zod.check=n=>{lg(n.value,t.alg)||n.issues.push({code:"invalid_format",format:"jwt",input:n.value,inst:e,continue:!t.abort})}}),dg=Xp("$ZodCustomStringFormat",(e,t)=>{Um.init(e,t),e._zod.check=n=>{t.fn(n.value)||n.issues.push({code:"invalid_format",format:t.format,input:n.value,inst:e,continue:!t.abort})}}),pg=Xp("$ZodNumber",(e,t)=>{jm.init(e,t),e._zod.pattern=e._zod.bag.pattern??rm,e._zod.parse=(n,i)=>{if(t.coerce)try{n.value=Number(n.value)}catch(e){}const r=n.value;if("number"==typeof r&&!Number.isNaN(r)&&Number.isFinite(r))return n;const s="number"==typeof r?Number.isNaN(r)?"NaN":Number.isFinite(r)?void 0:"Infinity":void 0;return n.issues.push({expected:"number",code:"invalid_type",input:r,inst:e,...s?{received:s}:{}}),n}}),hg=Xp("$ZodNumber",(e,t)=>{mm.init(e,t),pg.init(e,t)}),fg=Xp("$ZodBoolean",(e,t)=>{jm.init(e,t),e._zod.pattern=sm,e._zod.parse=(n,i)=>{if(t.coerce)try{n.value=Boolean(n.value)}catch(e){}const r=n.value;return"boolean"==typeof r||n.issues.push({expected:"boolean",code:"invalid_type",input:r,inst:e}),n}}),mg=Xp("$ZodBigInt",(e,t)=>{jm.init(e,t),e._zod.pattern=nm,e._zod.parse=(n,i)=>{if(t.coerce)try{n.value=BigInt(n.value)}catch(e){}return"bigint"==typeof n.value||n.issues.push({expected:"bigint",code:"invalid_type",input:n.value,inst:e}),n}}),gg=Xp("$ZodBigInt",(e,t)=>{gm.init(e,t),mg.init(e,t)}),vg=Xp("$ZodSymbol",(e,t)=>{jm.init(e,t),e._zod.parse=(t,n)=>{const i=t.value;return"symbol"==typeof i||t.issues.push({expected:"symbol",code:"invalid_type",input:i,inst:e}),t}}),yg=Xp("$ZodUndefined",(e,t)=>{jm.init(e,t),e._zod.pattern=om,e._zod.values=new Set([void 0]),e._zod.optin="optional",e._zod.optout="optional",e._zod.parse=(t,n)=>{const i=t.value;return void 0===i||t.issues.push({expected:"undefined",code:"invalid_type",input:i,inst:e}),t}}),_g=Xp("$ZodNull",(e,t)=>{jm.init(e,t),e._zod.pattern=am,e._zod.values=new Set([null]),e._zod.parse=(t,n)=>{const i=t.value;return null===i||t.issues.push({expected:"null",code:"invalid_type",input:i,inst:e}),t}}),bg=Xp("$ZodAny",(e,t)=>{jm.init(e,t),e._zod.parse=e=>e}),wg=Xp("$ZodUnknown",(e,t)=>{jm.init(e,t),e._zod.parse=e=>e}),$g=Xp("$ZodNever",(e,t)=>{jm.init(e,t),e._zod.parse=(t,n)=>(t.issues.push({expected:"never",code:"invalid_type",input:t.value,inst:e}),t)}),kg=Xp("$ZodVoid",(e,t)=>{jm.init(e,t),e._zod.parse=(t,n)=>{const i=t.value;return void 0===i||t.issues.push({expected:"void",code:"invalid_type",input:i,inst:e}),t}}),Sg=Xp("$ZodDate",(e,t)=>{jm.init(e,t),e._zod.parse=(n,i)=>{if(t.coerce)try{n.value=new Date(n.value)}catch(e){}const r=n.value,s=r instanceof Date;return s&&!Number.isNaN(r.getTime())||n.issues.push({expected:"date",code:"invalid_type",input:r,...s?{received:"Invalid Date"}:{},inst:e}),n}});function Eg(e,t,n){e.issues.length&&t.issues.push(...Jh(n,e.issues)),t.value[n]=e.value}const Ig=Xp("$ZodArray",(e,t)=>{jm.init(e,t),e._zod.parse=(n,i)=>{const r=n.value;if(!Array.isArray(r))return n.issues.push({expected:"array",code:"invalid_type",input:r,inst:e}),n;n.value=Array(r.length);const s=[];for(let e=0;e<r.length;e++){const a=r[e],o=t.element._zod.run({value:a,issues:[]},i);o instanceof Promise?s.push(o.then(t=>Eg(t,n,e))):Eg(o,n,e)}return s.length?Promise.all(s).then(()=>n):n}});function xg(e,t,n,i){e.issues.length&&t.issues.push(...Jh(n,e.issues)),void 0===e.value?n in i&&(t.value[n]=void 0):t.value[n]=e.value}const Tg=Xp("$ZodObject",(e,t)=>{jm.init(e,t);const n=dh(()=>{const e=Object.keys(t.shape);for(const n of e)if(!t.shape[n]._zod.traits.has("$ZodType"))throw new Error(`Invalid element at key "${n}": expected a Zod schema`);const n=Mh(t.shape);return{shape:t.shape,keys:e,keySet:new Set(e),numKeys:e.length,optionalKeys:new Set(n)}});gh(e._zod,"propValues",()=>{const e=t.shape,n={};for(const t in e){const i=e[t]._zod;if(i.values){n[t]??(n[t]=new Set);for(const e of i.values)n[t].add(e)}}return n});let i;const r=Ih,s=!th.jitless,a=s&&xh.value,o=t.catchall;let c;e._zod.parse=(l,u)=>{c??(c=n.value);const d=l.value;if(!r(d))return l.issues.push({expected:"object",code:"invalid_type",input:d,inst:e}),l;const p=[];if(s&&a&&!1===u?.async&&!0!==u.jitless)i||(i=(e=>{const t=new Lm(["shape","payload","ctx"]),i=n.value,r=e=>{const t=Sh(e);return`shape[${t}]._zod.run({ value: input[${t}], issues: [] }, ctx)`};t.write("const input = payload.value;");const s=Object.create(null);let a=0;for(const e of i.keys)s[e]="key_"+a++;t.write("const newResult = {}");for(const e of i.keys){const n=s[e],i=Sh(e);t.write(`const ${n} = ${r(e)};`),t.write(`\n        if (${n}.issues.length) {\n          payload.issues = payload.issues.concat(${n}.issues.map(iss => ({\n            ...iss,\n            path: iss.path ? [${i}, ...iss.path] : [${i}]\n          })));\n        }\n        \n        if (${n}.value === undefined) {\n          if (${i} in input) {\n            newResult[${i}] = undefined;\n          }\n        } else {\n          newResult[${i}] = ${n}.value;\n        }\n      `)}t.write("payload.value = newResult;"),t.write("return payload;");const o=t.compile();return(t,n)=>o(e,t,n)})(t.shape)),l=i(l,u);else{l.value={};const e=c.shape;for(const t of c.keys){const n=e[t]._zod.run({value:d[t],issues:[]},u);n instanceof Promise?p.push(n.then(e=>xg(e,l,t,d))):xg(n,l,t,d)}}if(!o)return p.length?Promise.all(p).then(()=>l):l;const h=[],f=c.keySet,m=o._zod,g=m.def.type;for(const e of Object.keys(d)){if(f.has(e))continue;if("never"===g){h.push(e);continue}const t=m.run({value:d[e],issues:[]},u);t instanceof Promise?p.push(t.then(t=>xg(t,l,e,d))):xg(t,l,e,d)}return h.length&&l.issues.push({code:"unrecognized_keys",keys:h,input:d,inst:e}),p.length?Promise.all(p).then(()=>l):l}});function Og(e,t,n,i){for(const n of e)if(0===n.issues.length)return t.value=n.value,t;const r=e.filter(e=>!Wh(e));return 1===r.length?(t.value=r[0].value,r[0]):(t.issues.push({code:"invalid_union",input:t.value,inst:n,errors:e.map(e=>e.issues.map(e=>Yh(e,i,nh())))}),t)}const Ag=Xp("$ZodUnion",(e,t)=>{jm.init(e,t),gh(e._zod,"optin",()=>t.options.some(e=>"optional"===e._zod.optin)?"optional":void 0),gh(e._zod,"optout",()=>t.options.some(e=>"optional"===e._zod.optout)?"optional":void 0),gh(e._zod,"values",()=>{if(t.options.every(e=>e._zod.values))return new Set(t.options.flatMap(e=>Array.from(e._zod.values)))}),gh(e._zod,"pattern",()=>{if(t.options.every(e=>e._zod.pattern)){const e=t.options.map(e=>e._zod.pattern);return new RegExp(`^(${e.map(e=>hh(e.source)).join("|")})$`)}});const n=1===t.options.length,i=t.options[0]._zod.run;e._zod.parse=(r,s)=>{if(n)return i(r,s);let a=!1;const o=[];for(const e of t.options){const t=e._zod.run({value:r.value,issues:[]},s);if(t instanceof Promise)o.push(t),a=!0;else{if(0===t.issues.length)return t;o.push(t)}}return a?Promise.all(o).then(t=>Og(t,r,e,s)):Og(o,r,e,s)}}),Ng=Xp("$ZodDiscriminatedUnion",(e,t)=>{Ag.init(e,t);const n=e._zod.parse;gh(e._zod,"propValues",()=>{const e={};for(const n of t.options){const i=n._zod.propValues;if(!i||0===Object.keys(i).length)throw new Error(`Invalid discriminated union option at index "${t.options.indexOf(n)}"`);for(const[t,n]of Object.entries(i)){e[t]||(e[t]=new Set);for(const i of n)e[t].add(i)}}return e});const i=dh(()=>{const e=t.options,n=new Map;for(const i of e){const e=i._zod.propValues?.[t.discriminator];if(!e||0===e.size)throw new Error(`Invalid discriminated union option at index "${t.options.indexOf(i)}"`);for(const t of e){if(n.has(t))throw new Error(`Duplicate discriminator value "${String(t)}"`);n.set(t,i)}}return n});e._zod.parse=(r,s)=>{const a=r.value;if(!Ih(a))return r.issues.push({code:"invalid_type",expected:"object",input:a,inst:e}),r;const o=i.value.get(a?.[t.discriminator]);return o?o._zod.run(r,s):t.unionFallback?n(r,s):(r.issues.push({code:"invalid_union",errors:[],note:"No matching discriminator",discriminator:t.discriminator,input:a,path:[t.discriminator],inst:e}),r)}}),Cg=Xp("$ZodIntersection",(e,t)=>{jm.init(e,t),e._zod.parse=(e,n)=>{const i=e.value,r=t.left._zod.run({value:i,issues:[]},n),s=t.right._zod.run({value:i,issues:[]},n);return r instanceof Promise||s instanceof Promise?Promise.all([r,s]).then(([t,n])=>Lg(e,t,n)):Lg(e,r,s)}});function Dg(e,t){if(e===t)return{valid:!0,data:e};if(e instanceof Date&&t instanceof Date&&+e===+t)return{valid:!0,data:e};if(Th(e)&&Th(t)){const n=Object.keys(t),i=Object.keys(e).filter(e=>-1!==n.indexOf(e)),r={...e,...t};for(const n of i){const i=Dg(e[n],t[n]);if(!i.valid)return{valid:!1,mergeErrorPath:[n,...i.mergeErrorPath]};r[n]=i.data}return{valid:!0,data:r}}if(Array.isArray(e)&&Array.isArray(t)){if(e.length!==t.length)return{valid:!1,mergeErrorPath:[]};const n=[];for(let i=0;i<e.length;i++){const r=Dg(e[i],t[i]);if(!r.valid)return{valid:!1,mergeErrorPath:[i,...r.mergeErrorPath]};n.push(r.data)}return{valid:!0,data:n}}return{valid:!1,mergeErrorPath:[]}}function Lg(e,t,n){if(t.issues.length&&e.issues.push(...t.issues),n.issues.length&&e.issues.push(...n.issues),Wh(e))return e;const i=Dg(t.value,n.value);if(!i.valid)throw new Error(`Unmergable intersection. Error path: ${JSON.stringify(i.mergeErrorPath)}`);return e.value=i.data,e}const Rg=Xp("$ZodTuple",(e,t)=>{jm.init(e,t);const n=t.items,i=n.length-[...n].reverse().findIndex(e=>"optional"!==e._zod.optin);e._zod.parse=(r,s)=>{const a=r.value;if(!Array.isArray(a))return r.issues.push({input:a,inst:e,expected:"tuple",code:"invalid_type"}),r;r.value=[];const o=[];if(!t.rest){const t=a.length>n.length,s=a.length<i-1;if(t||s)return r.issues.push({...t?{code:"too_big",maximum:n.length}:{code:"too_small",minimum:n.length},input:a,inst:e,origin:"array"}),r}let c=-1;for(const e of n){if(c++,c>=a.length&&c>=i)continue;const t=e._zod.run({value:a[c],issues:[]},s);t instanceof Promise?o.push(t.then(e=>jg(e,r,c))):jg(t,r,c)}if(t.rest){const e=a.slice(n.length);for(const n of e){c++;const e=t.rest._zod.run({value:n,issues:[]},s);e instanceof Promise?o.push(e.then(e=>jg(e,r,c))):jg(e,r,c)}}return o.length?Promise.all(o).then(()=>r):r}});function jg(e,t,n){e.issues.length&&t.issues.push(...Jh(n,e.issues)),t.value[n]=e.value}const Pg=Xp("$ZodRecord",(e,t)=>{jm.init(e,t),e._zod.parse=(n,i)=>{const r=n.value;if(!Th(r))return n.issues.push({expected:"record",code:"invalid_type",input:r,inst:e}),n;const s=[];if(t.keyType._zod.values){const a=t.keyType._zod.values;n.value={};for(const e of a)if("string"==typeof e||"number"==typeof e||"symbol"==typeof e){const a=t.valueType._zod.run({value:r[e],issues:[]},i);a instanceof Promise?s.push(a.then(t=>{t.issues.length&&n.issues.push(...Jh(e,t.issues)),n.value[e]=t.value})):(a.issues.length&&n.issues.push(...Jh(e,a.issues)),n.value[e]=a.value)}let o;for(const e in r)a.has(e)||(o=o??[],o.push(e));o&&o.length>0&&n.issues.push({code:"unrecognized_keys",input:r,inst:e,keys:o})}else{n.value={};for(const a of Reflect.ownKeys(r)){if("__proto__"===a)continue;const o=t.keyType._zod.run({value:a,issues:[]},i);if(o instanceof Promise)throw new Error("Async schemas not supported in object keys currently");if(o.issues.length){n.issues.push({code:"invalid_key",origin:"record",issues:o.issues.map(e=>Yh(e,i,nh())),input:a,path:[a],inst:e}),n.value[o.value]=o.value;continue}const c=t.valueType._zod.run({value:r[a],issues:[]},i);c instanceof Promise?s.push(c.then(e=>{e.issues.length&&n.issues.push(...Jh(a,e.issues)),n.value[o.value]=e.value})):(c.issues.length&&n.issues.push(...Jh(a,c.issues)),n.value[o.value]=c.value)}}return s.length?Promise.all(s).then(()=>n):n}}),Ug=Xp("$ZodMap",(e,t)=>{jm.init(e,t),e._zod.parse=(n,i)=>{const r=n.value;if(!(r instanceof Map))return n.issues.push({expected:"map",code:"invalid_type",input:r,inst:e}),n;const s=[];n.value=new Map;for(const[a,o]of r){const c=t.keyType._zod.run({value:a,issues:[]},i),l=t.valueType._zod.run({value:o,issues:[]},i);c instanceof Promise||l instanceof Promise?s.push(Promise.all([c,l]).then(([t,s])=>{Mg(t,s,n,a,r,e,i)})):Mg(c,l,n,a,r,e,i)}return s.length?Promise.all(s).then(()=>n):n}});function Mg(e,t,n,i,r,s,a){e.issues.length&&(Ch.has(typeof i)?n.issues.push(...Jh(i,e.issues)):n.issues.push({code:"invalid_key",origin:"map",input:r,inst:s,issues:e.issues.map(e=>Yh(e,a,nh()))})),t.issues.length&&(Ch.has(typeof i)?n.issues.push(...Jh(i,t.issues)):n.issues.push({origin:"map",code:"invalid_element",input:r,inst:s,key:i,issues:t.issues.map(e=>Yh(e,a,nh()))})),n.value.set(e.value,t.value)}const zg=Xp("$ZodSet",(e,t)=>{jm.init(e,t),e._zod.parse=(n,i)=>{const r=n.value;if(!(r instanceof Set))return n.issues.push({input:r,inst:e,expected:"set",code:"invalid_type"}),n;const s=[];n.value=new Set;for(const e of r){const r=t.valueType._zod.run({value:e,issues:[]},i);r instanceof Promise?s.push(r.then(e=>Fg(e,n))):Fg(r,n)}return s.length?Promise.all(s).then(()=>n):n}});function Fg(e,t){e.issues.length&&t.issues.push(...e.issues),t.value.add(e.value)}const Bg=Xp("$ZodEnum",(e,t)=>{jm.init(e,t);const n=ch(t.entries),i=new Set(n);e._zod.values=i,e._zod.pattern=new RegExp(`^(${n.filter(e=>Ch.has(typeof e)).map(e=>"string"==typeof e?Lh(e):e.toString()).join("|")})$`),e._zod.parse=(t,r)=>{const s=t.value;return i.has(s)||t.issues.push({code:"invalid_value",values:n,input:s,inst:e}),t}}),Gg=Xp("$ZodLiteral",(e,t)=>{if(jm.init(e,t),0===t.values.length)throw new Error("Cannot create literal schema with no valid values");e._zod.values=new Set(t.values),e._zod.pattern=new RegExp(`^(${t.values.map(e=>"string"==typeof e?Lh(e):e?Lh(e.toString()):String(e)).join("|")})$`),e._zod.parse=(n,i)=>{const r=n.value;return e._zod.values.has(r)||n.issues.push({code:"invalid_value",values:t.values,input:r,inst:e}),n}}),Vg=Xp("$ZodFile",(e,t)=>{jm.init(e,t),e._zod.parse=(t,n)=>{const i=t.value;return i instanceof File||t.issues.push({expected:"file",code:"invalid_type",input:i,inst:e}),t}}),Zg=Xp("$ZodTransform",(e,t)=>{jm.init(e,t),e._zod.parse=(e,n)=>{const i=t.transform(e.value,e);if(n.async){return(i instanceof Promise?i:Promise.resolve(i)).then(t=>(e.value=t,e))}if(i instanceof Promise)throw new eh;return e.value=i,e}});function qg(e,t){return e.issues.length&&void 0===t?{issues:[],value:void 0}:e}const Hg=Xp("$ZodOptional",(e,t)=>{jm.init(e,t),e._zod.optin="optional",e._zod.optout="optional",gh(e._zod,"values",()=>t.innerType._zod.values?new Set([...t.innerType._zod.values,void 0]):void 0),gh(e._zod,"pattern",()=>{const e=t.innerType._zod.pattern;return e?new RegExp(`^(${hh(e.source)})?$`):void 0}),e._zod.parse=(e,n)=>{if("optional"===t.innerType._zod.optin){const i=t.innerType._zod.run(e,n);return i instanceof Promise?i.then(t=>qg(t,e.value)):qg(i,e.value)}return void 0===e.value?e:t.innerType._zod.run(e,n)}}),Wg=Xp("$ZodNullable",(e,t)=>{jm.init(e,t),gh(e._zod,"optin",()=>t.innerType._zod.optin),gh(e._zod,"optout",()=>t.innerType._zod.optout),gh(e._zod,"pattern",()=>{const e=t.innerType._zod.pattern;return e?new RegExp(`^(${hh(e.source)}|null)$`):void 0}),gh(e._zod,"values",()=>t.innerType._zod.values?new Set([...t.innerType._zod.values,null]):void 0),e._zod.parse=(e,n)=>null===e.value?e:t.innerType._zod.run(e,n)}),Jg=Xp("$ZodDefault",(e,t)=>{jm.init(e,t),e._zod.optin="optional",gh(e._zod,"values",()=>t.innerType._zod.values),e._zod.parse=(e,n)=>{if(void 0===e.value)return e.value=t.defaultValue,e;const i=t.innerType._zod.run(e,n);return i instanceof Promise?i.then(e=>Kg(e,t)):Kg(i,t)}});function Kg(e,t){return void 0===e.value&&(e.value=t.defaultValue),e}const Yg=Xp("$ZodPrefault",(e,t)=>{jm.init(e,t),e._zod.optin="optional",gh(e._zod,"values",()=>t.innerType._zod.values),e._zod.parse=(e,n)=>(void 0===e.value&&(e.value=t.defaultValue),t.innerType._zod.run(e,n))}),Xg=Xp("$ZodNonOptional",(e,t)=>{jm.init(e,t),gh(e._zod,"values",()=>{const e=t.innerType._zod.values;return e?new Set([...e].filter(e=>void 0!==e)):void 0}),e._zod.parse=(n,i)=>{const r=t.innerType._zod.run(n,i);return r instanceof Promise?r.then(t=>Qg(t,e)):Qg(r,e)}});function Qg(e,t){return e.issues.length||void 0!==e.value||e.issues.push({code:"invalid_type",expected:"nonoptional",input:e.value,inst:t}),e}const ev=Xp("$ZodSuccess",(e,t)=>{jm.init(e,t),e._zod.parse=(e,n)=>{const i=t.innerType._zod.run(e,n);return i instanceof Promise?i.then(t=>(e.value=0===t.issues.length,e)):(e.value=0===i.issues.length,e)}}),tv=Xp("$ZodCatch",(e,t)=>{jm.init(e,t),gh(e._zod,"optin",()=>t.innerType._zod.optin),gh(e._zod,"optout",()=>t.innerType._zod.optout),gh(e._zod,"values",()=>t.innerType._zod.values),e._zod.parse=(e,n)=>{const i=t.innerType._zod.run(e,n);return i instanceof Promise?i.then(i=>(e.value=i.value,i.issues.length&&(e.value=t.catchValue({...e,error:{issues:i.issues.map(e=>Yh(e,n,nh()))},input:e.value}),e.issues=[]),e)):(e.value=i.value,i.issues.length&&(e.value=t.catchValue({...e,error:{issues:i.issues.map(e=>Yh(e,n,nh()))},input:e.value}),e.issues=[]),e)}}),nv=Xp("$ZodNaN",(e,t)=>{jm.init(e,t),e._zod.parse=(t,n)=>("number"==typeof t.value&&Number.isNaN(t.value)||t.issues.push({input:t.value,inst:e,expected:"nan",code:"invalid_type"}),t)}),iv=Xp("$ZodPipe",(e,t)=>{jm.init(e,t),gh(e._zod,"values",()=>t.in._zod.values),gh(e._zod,"optin",()=>t.in._zod.optin),gh(e._zod,"optout",()=>t.out._zod.optout),gh(e._zod,"propValues",()=>t.in._zod.propValues),e._zod.parse=(e,n)=>{const i=t.in._zod.run(e,n);return i instanceof Promise?i.then(e=>rv(e,t,n)):rv(i,t,n)}});function rv(e,t,n){return e.issues.length?e:t.out._zod.run({value:e.value,issues:e.issues},n)}const sv=Xp("$ZodReadonly",(e,t)=>{jm.init(e,t),gh(e._zod,"propValues",()=>t.innerType._zod.propValues),gh(e._zod,"values",()=>t.innerType._zod.values),gh(e._zod,"optin",()=>t.innerType._zod.optin),gh(e._zod,"optout",()=>t.innerType._zod.optout),e._zod.parse=(e,n)=>{const i=t.innerType._zod.run(e,n);return i instanceof Promise?i.then(av):av(i)}});function av(e){return e.value=Object.freeze(e.value),e}const ov=Xp("$ZodTemplateLiteral",(e,t)=>{jm.init(e,t);const n=[];for(const e of t.parts)if("object"==typeof e&&null!==e){if(!e._zod.pattern)throw new Error(`Invalid template literal part, no pattern found: ${[...e._zod.traits].shift()}`);const t=e._zod.pattern instanceof RegExp?e._zod.pattern.source:e._zod.pattern;if(!t)throw new Error(`Invalid template literal part: ${e._zod.traits}`);const i=t.startsWith("^")?1:0,r=t.endsWith("$")?t.length-1:t.length;n.push(t.slice(i,r))}else{if(null!==e&&!Dh.has(typeof e))throw new Error(`Invalid template literal part: ${e}`);n.push(Lh(`${e}`))}e._zod.pattern=new RegExp(`^${n.join("")}$`),e._zod.parse=(n,i)=>"string"!=typeof n.value?(n.issues.push({input:n.value,inst:e,expected:"template_literal",code:"invalid_type"}),n):(e._zod.pattern.lastIndex=0,e._zod.pattern.test(n.value)||n.issues.push({input:n.value,inst:e,code:"invalid_format",format:t.format??"template_literal",pattern:e._zod.pattern.source}),n)}),cv=Xp("$ZodPromise",(e,t)=>{jm.init(e,t),e._zod.parse=(e,n)=>Promise.resolve(e.value).then(e=>t.innerType._zod.run({value:e,issues:[]},n))}),lv=Xp("$ZodLazy",(e,t)=>{jm.init(e,t),gh(e._zod,"innerType",()=>t.getter()),gh(e._zod,"pattern",()=>e._zod.innerType._zod.pattern),gh(e._zod,"propValues",()=>e._zod.innerType._zod.propValues),gh(e._zod,"optin",()=>e._zod.innerType._zod.optin??void 0),gh(e._zod,"optout",()=>e._zod.innerType._zod.optout??void 0),e._zod.parse=(t,n)=>e._zod.innerType._zod.run(t,n)}),uv=Xp("$ZodCustom",(e,t)=>{um.init(e,t),jm.init(e,t),e._zod.parse=(e,t)=>e,e._zod.check=n=>{const i=n.value,r=t.fn(i);if(r instanceof Promise)return r.then(t=>dv(t,n,i,e));dv(r,n,i,e)}});function dv(e,t,n,i){if(!e){const e={code:"custom",input:n,inst:i,path:[...i._zod.def.path??[]],continue:!i._zod.def.abort};i._zod.def.params&&(e.params=i._zod.def.params),t.issues.push(ef(e))}}const pv=()=>{const e={string:{unit:"حرف",verb:"أن يحوي"},file:{unit:"بايت",verb:"أن يحوي"},array:{unit:"عنصر",verb:"أن يحوي"},set:{unit:"عنصر",verb:"أن يحوي"}};function t(t){return e[t]??null}const n={regex:"مدخل",email:"بريد إلكتروني",url:"رابط",emoji:"إيموجي",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"تاريخ ووقت بمعيار ISO",date:"تاريخ بمعيار ISO",time:"وقت بمعيار ISO",duration:"مدة بمعيار ISO",ipv4:"عنوان IPv4",ipv6:"عنوان IPv6",cidrv4:"مدى عناوين بصيغة IPv4",cidrv6:"مدى عناوين بصيغة IPv6",base64:"نَص بترميز base64-encoded",base64url:"نَص بترميز base64url-encoded",json_string:"نَص على هيئة JSON",e164:"رقم هاتف بمعيار E.164",jwt:"JWT",template_literal:"مدخل"};return e=>{switch(e.code){case"invalid_type":return`مدخلات غير مقبولة: يفترض إدخال ${e.expected}، ولكن تم إدخال ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"number";case"object":if(Array.isArray(e))return"array";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`مدخلات غير مقبولة: يفترض إدخال ${Uh(e.values[0])}`:`اختيار غير مقبول: يتوقع انتقاء أحد هذه الخيارات: ${lh(e.values,"|")}`;case"too_big":{const n=e.inclusive?"<=":"<",i=t(e.origin);return i?` أكبر من اللازم: يفترض أن تكون ${e.origin??"القيمة"} ${n} ${e.maximum.toString()} ${i.unit??"عنصر"}`:`أكبر من اللازم: يفترض أن تكون ${e.origin??"القيمة"} ${n} ${e.maximum.toString()}`}case"too_small":{const n=e.inclusive?">=":">",i=t(e.origin);return i?`أصغر من اللازم: يفترض لـ ${e.origin} أن يكون ${n} ${e.minimum.toString()} ${i.unit}`:`أصغر من اللازم: يفترض لـ ${e.origin} أن يكون ${n} ${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`نَص غير مقبول: يجب أن يبدأ بـ "${e.prefix}"`:"ends_with"===t.format?`نَص غير مقبول: يجب أن ينتهي بـ "${t.suffix}"`:"includes"===t.format?`نَص غير مقبول: يجب أن يتضمَّن "${t.includes}"`:"regex"===t.format?`نَص غير مقبول: يجب أن يطابق النمط ${t.pattern}`:`${n[t.format]??e.format} غير مقبول`}case"not_multiple_of":return`رقم غير مقبول: يجب أن يكون من مضاعفات ${e.divisor}`;case"unrecognized_keys":return`معرف${e.keys.length>1?"ات":""} غريب${e.keys.length>1?"ة":""}: ${lh(e.keys,"، ")}`;case"invalid_key":return`معرف غير مقبول في ${e.origin}`;case"invalid_union":default:return"مدخل غير مقبول";case"invalid_element":return`مدخل غير مقبول في ${e.origin}`}}};function hv(){return{localeError:pv()}}const fv=()=>{const e={string:{unit:"simvol",verb:"olmalıdır"},file:{unit:"bayt",verb:"olmalıdır"},array:{unit:"element",verb:"olmalıdır"},set:{unit:"element",verb:"olmalıdır"}};function t(t){return e[t]??null}const n={regex:"input",email:"email address",url:"URL",emoji:"emoji",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"ISO datetime",date:"ISO date",time:"ISO time",duration:"ISO duration",ipv4:"IPv4 address",ipv6:"IPv6 address",cidrv4:"IPv4 range",cidrv6:"IPv6 range",base64:"base64-encoded string",base64url:"base64url-encoded string",json_string:"JSON string",e164:"E.164 number",jwt:"JWT",template_literal:"input"};return e=>{switch(e.code){case"invalid_type":return`Yanlış dəyər: gözlənilən ${e.expected}, daxil olan ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"number";case"object":if(Array.isArray(e))return"array";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`Yanlış dəyər: gözlənilən ${Uh(e.values[0])}`:`Yanlış seçim: aşağıdakılardan biri olmalıdır: ${lh(e.values,"|")}`;case"too_big":{const n=e.inclusive?"<=":"<",i=t(e.origin);return i?`Çox böyük: gözlənilən ${e.origin??"dəyər"} ${n}${e.maximum.toString()} ${i.unit??"element"}`:`Çox böyük: gözlənilən ${e.origin??"dəyər"} ${n}${e.maximum.toString()}`}case"too_small":{const n=e.inclusive?">=":">",i=t(e.origin);return i?`Çox kiçik: gözlənilən ${e.origin} ${n}${e.minimum.toString()} ${i.unit}`:`Çox kiçik: gözlənilən ${e.origin} ${n}${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`Yanlış mətn: "${t.prefix}" ilə başlamalıdır`:"ends_with"===t.format?`Yanlış mətn: "${t.suffix}" ilə bitməlidir`:"includes"===t.format?`Yanlış mətn: "${t.includes}" daxil olmalıdır`:"regex"===t.format?`Yanlış mətn: ${t.pattern} şablonuna uyğun olmalıdır`:`Yanlış ${n[t.format]??e.format}`}case"not_multiple_of":return`Yanlış ədəd: ${e.divisor} ilə bölünə bilən olmalıdır`;case"unrecognized_keys":return`Tanınmayan açar${e.keys.length>1?"lar":""}: ${lh(e.keys,", ")}`;case"invalid_key":return`${e.origin} daxilində yanlış açar`;case"invalid_union":default:return"Yanlış dəyər";case"invalid_element":return`${e.origin} daxilində yanlış dəyər`}}};function mv(){return{localeError:fv()}}function gv(e,t,n,i){const r=Math.abs(e),s=r%10,a=r%100;return a>=11&&a<=19?i:1===s?t:s>=2&&s<=4?n:i}const vv=()=>{const e={string:{unit:{one:"сімвал",few:"сімвалы",many:"сімвалаў"},verb:"мець"},array:{unit:{one:"элемент",few:"элементы",many:"элементаў"},verb:"мець"},set:{unit:{one:"элемент",few:"элементы",many:"элементаў"},verb:"мець"},file:{unit:{one:"байт",few:"байты",many:"байтаў"},verb:"мець"}};function t(t){return e[t]??null}const n={regex:"увод",email:"email адрас",url:"URL",emoji:"эмодзі",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"ISO дата і час",date:"ISO дата",time:"ISO час",duration:"ISO працягласць",ipv4:"IPv4 адрас",ipv6:"IPv6 адрас",cidrv4:"IPv4 дыяпазон",cidrv6:"IPv6 дыяпазон",base64:"радок у фармаце base64",base64url:"радок у фармаце base64url",json_string:"JSON радок",e164:"нумар E.164",jwt:"JWT",template_literal:"увод"};return e=>{switch(e.code){case"invalid_type":return`Няправільны ўвод: чакаўся ${e.expected}, атрымана ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"лік";case"object":if(Array.isArray(e))return"масіў";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`Няправільны ўвод: чакалася ${Uh(e.values[0])}`:`Няправільны варыянт: чакаўся адзін з ${lh(e.values,"|")}`;case"too_big":{const n=e.inclusive?"<=":"<",i=t(e.origin);if(i){const t=gv(Number(e.maximum),i.unit.one,i.unit.few,i.unit.many);return`Занадта вялікі: чакалася, што ${e.origin??"значэнне"} павінна ${i.verb} ${n}${e.maximum.toString()} ${t}`}return`Занадта вялікі: чакалася, што ${e.origin??"значэнне"} павінна быць ${n}${e.maximum.toString()}`}case"too_small":{const n=e.inclusive?">=":">",i=t(e.origin);if(i){const t=gv(Number(e.minimum),i.unit.one,i.unit.few,i.unit.many);return`Занадта малы: чакалася, што ${e.origin} павінна ${i.verb} ${n}${e.minimum.toString()} ${t}`}return`Занадта малы: чакалася, што ${e.origin} павінна быць ${n}${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`Няправільны радок: павінен пачынацца з "${t.prefix}"`:"ends_with"===t.format?`Няправільны радок: павінен заканчвацца на "${t.suffix}"`:"includes"===t.format?`Няправільны радок: павінен змяшчаць "${t.includes}"`:"regex"===t.format?`Няправільны радок: павінен адпавядаць шаблону ${t.pattern}`:`Няправільны ${n[t.format]??e.format}`}case"not_multiple_of":return`Няправільны лік: павінен быць кратным ${e.divisor}`;case"unrecognized_keys":return`Нераспазнаны ${e.keys.length>1?"ключы":"ключ"}: ${lh(e.keys,", ")}`;case"invalid_key":return`Няправільны ключ у ${e.origin}`;case"invalid_union":default:return"Няправільны ўвод";case"invalid_element":return`Няправільнае значэнне ў ${e.origin}`}}};function yv(){return{localeError:vv()}}const _v=()=>{const e={string:{unit:"caràcters",verb:"contenir"},file:{unit:"bytes",verb:"contenir"},array:{unit:"elements",verb:"contenir"},set:{unit:"elements",verb:"contenir"}};function t(t){return e[t]??null}const n={regex:"entrada",email:"adreça electrònica",url:"URL",emoji:"emoji",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"data i hora ISO",date:"data ISO",time:"hora ISO",duration:"durada ISO",ipv4:"adreça IPv4",ipv6:"adreça IPv6",cidrv4:"rang IPv4",cidrv6:"rang IPv6",base64:"cadena codificada en base64",base64url:"cadena codificada en base64url",json_string:"cadena JSON",e164:"número E.164",jwt:"JWT",template_literal:"entrada"};return e=>{switch(e.code){case"invalid_type":return`Tipus invàlid: s'esperava ${e.expected}, s'ha rebut ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"number";case"object":if(Array.isArray(e))return"array";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`Valor invàlid: s'esperava ${Uh(e.values[0])}`:`Opció invàlida: s'esperava una de ${lh(e.values," o ")}`;case"too_big":{const n=e.inclusive?"com a màxim":"menys de",i=t(e.origin);return i?`Massa gran: s'esperava que ${e.origin??"el valor"} contingués ${n} ${e.maximum.toString()} ${i.unit??"elements"}`:`Massa gran: s'esperava que ${e.origin??"el valor"} fos ${n} ${e.maximum.toString()}`}case"too_small":{const n=e.inclusive?"com a mínim":"més de",i=t(e.origin);return i?`Massa petit: s'esperava que ${e.origin} contingués ${n} ${e.minimum.toString()} ${i.unit}`:`Massa petit: s'esperava que ${e.origin} fos ${n} ${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`Format invàlid: ha de començar amb "${t.prefix}"`:"ends_with"===t.format?`Format invàlid: ha d'acabar amb "${t.suffix}"`:"includes"===t.format?`Format invàlid: ha d'incloure "${t.includes}"`:"regex"===t.format?`Format invàlid: ha de coincidir amb el patró ${t.pattern}`:`Format invàlid per a ${n[t.format]??e.format}`}case"not_multiple_of":return`Número invàlid: ha de ser múltiple de ${e.divisor}`;case"unrecognized_keys":return`Clau${e.keys.length>1?"s":""} no reconeguda${e.keys.length>1?"s":""}: ${lh(e.keys,", ")}`;case"invalid_key":return`Clau invàlida a ${e.origin}`;case"invalid_union":default:return"Entrada invàlida";case"invalid_element":return`Element invàlid a ${e.origin}`}}};function bv(){return{localeError:_v()}}const wv=()=>{const e={string:{unit:"znaků",verb:"mít"},file:{unit:"bajtů",verb:"mít"},array:{unit:"prvků",verb:"mít"},set:{unit:"prvků",verb:"mít"}};function t(t){return e[t]??null}const n={regex:"regulární výraz",email:"e-mailová adresa",url:"URL",emoji:"emoji",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"datum a čas ve formátu ISO",date:"datum ve formátu ISO",time:"čas ve formátu ISO",duration:"doba trvání ISO",ipv4:"IPv4 adresa",ipv6:"IPv6 adresa",cidrv4:"rozsah IPv4",cidrv6:"rozsah IPv6",base64:"řetězec zakódovaný ve formátu base64",base64url:"řetězec zakódovaný ve formátu base64url",json_string:"řetězec ve formátu JSON",e164:"číslo E.164",jwt:"JWT",template_literal:"vstup"};return e=>{switch(e.code){case"invalid_type":return`Neplatný vstup: očekáváno ${e.expected}, obdrženo ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"číslo";case"string":return"řetězec";case"boolean":return"boolean";case"bigint":return"bigint";case"function":return"funkce";case"symbol":return"symbol";case"undefined":return"undefined";case"object":if(Array.isArray(e))return"pole";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`Neplatný vstup: očekáváno ${Uh(e.values[0])}`:`Neplatná možnost: očekávána jedna z hodnot ${lh(e.values,"|")}`;case"too_big":{const n=e.inclusive?"<=":"<",i=t(e.origin);return i?`Hodnota je příliš velká: ${e.origin??"hodnota"} musí mít ${n}${e.maximum.toString()} ${i.unit??"prvků"}`:`Hodnota je příliš velká: ${e.origin??"hodnota"} musí být ${n}${e.maximum.toString()}`}case"too_small":{const n=e.inclusive?">=":">",i=t(e.origin);return i?`Hodnota je příliš malá: ${e.origin??"hodnota"} musí mít ${n}${e.minimum.toString()} ${i.unit??"prvků"}`:`Hodnota je příliš malá: ${e.origin??"hodnota"} musí být ${n}${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`Neplatný řetězec: musí začínat na "${t.prefix}"`:"ends_with"===t.format?`Neplatný řetězec: musí končit na "${t.suffix}"`:"includes"===t.format?`Neplatný řetězec: musí obsahovat "${t.includes}"`:"regex"===t.format?`Neplatný řetězec: musí odpovídat vzoru ${t.pattern}`:`Neplatný formát ${n[t.format]??e.format}`}case"not_multiple_of":return`Neplatné číslo: musí být násobkem ${e.divisor}`;case"unrecognized_keys":return`Neznámé klíče: ${lh(e.keys,", ")}`;case"invalid_key":return`Neplatný klíč v ${e.origin}`;case"invalid_union":default:return"Neplatný vstup";case"invalid_element":return`Neplatná hodnota v ${e.origin}`}}};function $v(){return{localeError:wv()}}const kv=()=>{const e={string:{unit:"tegn",verb:"havde"},file:{unit:"bytes",verb:"havde"},array:{unit:"elementer",verb:"indeholdt"},set:{unit:"elementer",verb:"indeholdt"}},t={string:"streng",number:"tal",boolean:"boolean",array:"liste",object:"objekt",set:"sæt",file:"fil"};function n(t){return e[t]??null}function i(e){return t[e]??e}const r={regex:"input",email:"e-mailadresse",url:"URL",emoji:"emoji",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"ISO dato- og klokkeslæt",date:"ISO-dato",time:"ISO-klokkeslæt",duration:"ISO-varighed",ipv4:"IPv4-område",ipv6:"IPv6-område",cidrv4:"IPv4-spektrum",cidrv6:"IPv6-spektrum",base64:"base64-kodet streng",base64url:"base64url-kodet streng",json_string:"JSON-streng",e164:"E.164-nummer",jwt:"JWT",template_literal:"input"};return e=>{switch(e.code){case"invalid_type":return`Ugyldigt input: forventede ${i(e.expected)}, fik ${i((e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"tal";case"object":return Array.isArray(e)?"liste":null===e?"null":Object.getPrototypeOf(e)!==Object.prototype&&e.constructor?e.constructor.name:"objekt"}return t})(e.input))}`;case"invalid_value":return 1===e.values.length?`Ugyldig værdi: forventede ${Uh(e.values[0])}`:`Ugyldigt valg: forventede en af følgende ${lh(e.values,"|")}`;case"too_big":{const t=e.inclusive?"<=":"<",r=n(e.origin),s=i(e.origin);return r?`For stor: forventede ${s??"value"} ${r.verb} ${t} ${e.maximum.toString()} ${r.unit??"elementer"}`:`For stor: forventede ${s??"value"} havde ${t} ${e.maximum.toString()}`}case"too_small":{const t=e.inclusive?">=":">",r=n(e.origin),s=i(e.origin);return r?`For lille: forventede ${s} ${r.verb} ${t} ${e.minimum.toString()} ${r.unit}`:`For lille: forventede ${s} havde ${t} ${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`Ugyldig streng: skal starte med "${t.prefix}"`:"ends_with"===t.format?`Ugyldig streng: skal ende med "${t.suffix}"`:"includes"===t.format?`Ugyldig streng: skal indeholde "${t.includes}"`:"regex"===t.format?`Ugyldig streng: skal matche mønsteret ${t.pattern}`:`Ugyldig ${r[t.format]??e.format}`}case"not_multiple_of":return`Ugyldigt tal: skal være deleligt med ${e.divisor}`;case"unrecognized_keys":return`${e.keys.length>1?"Ukendte nøgler":"Ukendt nøgle"}: ${lh(e.keys,", ")}`;case"invalid_key":return`Ugyldig nøgle i ${e.origin}`;case"invalid_union":return"Ugyldigt input: matcher ingen af de tilladte typer";case"invalid_element":return`Ugyldig værdi i ${e.origin}`;default:return"Ugyldigt input"}}};function Sv(){return{localeError:kv()}}const Ev=()=>{const e={string:{unit:"Zeichen",verb:"zu haben"},file:{unit:"Bytes",verb:"zu haben"},array:{unit:"Elemente",verb:"zu haben"},set:{unit:"Elemente",verb:"zu haben"}};function t(t){return e[t]??null}const n={regex:"Eingabe",email:"E-Mail-Adresse",url:"URL",emoji:"Emoji",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"ISO-Datum und -Uhrzeit",date:"ISO-Datum",time:"ISO-Uhrzeit",duration:"ISO-Dauer",ipv4:"IPv4-Adresse",ipv6:"IPv6-Adresse",cidrv4:"IPv4-Bereich",cidrv6:"IPv6-Bereich",base64:"Base64-codierter String",base64url:"Base64-URL-codierter String",json_string:"JSON-String",e164:"E.164-Nummer",jwt:"JWT",template_literal:"Eingabe"};return e=>{switch(e.code){case"invalid_type":return`Ungültige Eingabe: erwartet ${e.expected}, erhalten ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"Zahl";case"object":if(Array.isArray(e))return"Array";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`Ungültige Eingabe: erwartet ${Uh(e.values[0])}`:`Ungültige Option: erwartet eine von ${lh(e.values,"|")}`;case"too_big":{const n=e.inclusive?"<=":"<",i=t(e.origin);return i?`Zu groß: erwartet, dass ${e.origin??"Wert"} ${n}${e.maximum.toString()} ${i.unit??"Elemente"} hat`:`Zu groß: erwartet, dass ${e.origin??"Wert"} ${n}${e.maximum.toString()} ist`}case"too_small":{const n=e.inclusive?">=":">",i=t(e.origin);return i?`Zu klein: erwartet, dass ${e.origin} ${n}${e.minimum.toString()} ${i.unit} hat`:`Zu klein: erwartet, dass ${e.origin} ${n}${e.minimum.toString()} ist`}case"invalid_format":{const t=e;return"starts_with"===t.format?`Ungültiger String: muss mit "${t.prefix}" beginnen`:"ends_with"===t.format?`Ungültiger String: muss mit "${t.suffix}" enden`:"includes"===t.format?`Ungültiger String: muss "${t.includes}" enthalten`:"regex"===t.format?`Ungültiger String: muss dem Muster ${t.pattern} entsprechen`:`Ungültig: ${n[t.format]??e.format}`}case"not_multiple_of":return`Ungültige Zahl: muss ein Vielfaches von ${e.divisor} sein`;case"unrecognized_keys":return`${e.keys.length>1?"Unbekannte Schlüssel":"Unbekannter Schlüssel"}: ${lh(e.keys,", ")}`;case"invalid_key":return`Ungültiger Schlüssel in ${e.origin}`;case"invalid_union":default:return"Ungültige Eingabe";case"invalid_element":return`Ungültiger Wert in ${e.origin}`}}};function Iv(){return{localeError:Ev()}}const xv=()=>{const e={string:{unit:"characters",verb:"to have"},file:{unit:"bytes",verb:"to have"},array:{unit:"items",verb:"to have"},set:{unit:"items",verb:"to have"}};function t(t){return e[t]??null}const n={regex:"input",email:"email address",url:"URL",emoji:"emoji",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"ISO datetime",date:"ISO date",time:"ISO time",duration:"ISO duration",ipv4:"IPv4 address",ipv6:"IPv6 address",cidrv4:"IPv4 range",cidrv6:"IPv6 range",base64:"base64-encoded string",base64url:"base64url-encoded string",json_string:"JSON string",e164:"E.164 number",jwt:"JWT",template_literal:"input"};return e=>{switch(e.code){case"invalid_type":return`Invalid input: expected ${e.expected}, received ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"number";case"object":if(Array.isArray(e))return"array";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`Invalid input: expected ${Uh(e.values[0])}`:`Invalid option: expected one of ${lh(e.values,"|")}`;case"too_big":{const n=e.inclusive?"<=":"<",i=t(e.origin);return i?`Too big: expected ${e.origin??"value"} to have ${n}${e.maximum.toString()} ${i.unit??"elements"}`:`Too big: expected ${e.origin??"value"} to be ${n}${e.maximum.toString()}`}case"too_small":{const n=e.inclusive?">=":">",i=t(e.origin);return i?`Too small: expected ${e.origin} to have ${n}${e.minimum.toString()} ${i.unit}`:`Too small: expected ${e.origin} to be ${n}${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`Invalid string: must start with "${t.prefix}"`:"ends_with"===t.format?`Invalid string: must end with "${t.suffix}"`:"includes"===t.format?`Invalid string: must include "${t.includes}"`:"regex"===t.format?`Invalid string: must match pattern ${t.pattern}`:`Invalid ${n[t.format]??e.format}`}case"not_multiple_of":return`Invalid number: must be a multiple of ${e.divisor}`;case"unrecognized_keys":return`Unrecognized key${e.keys.length>1?"s":""}: ${lh(e.keys,", ")}`;case"invalid_key":return`Invalid key in ${e.origin}`;case"invalid_union":default:return"Invalid input";case"invalid_element":return`Invalid value in ${e.origin}`}}};function Tv(){return{localeError:xv()}}const Ov=()=>{const e={string:{unit:"karaktrojn",verb:"havi"},file:{unit:"bajtojn",verb:"havi"},array:{unit:"elementojn",verb:"havi"},set:{unit:"elementojn",verb:"havi"}};function t(t){return e[t]??null}const n={regex:"enigo",email:"retadreso",url:"URL",emoji:"emoĝio",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"ISO-datotempo",date:"ISO-dato",time:"ISO-tempo",duration:"ISO-daŭro",ipv4:"IPv4-adreso",ipv6:"IPv6-adreso",cidrv4:"IPv4-rango",cidrv6:"IPv6-rango",base64:"64-ume kodita karaktraro",base64url:"URL-64-ume kodita karaktraro",json_string:"JSON-karaktraro",e164:"E.164-nombro",jwt:"JWT",template_literal:"enigo"};return e=>{switch(e.code){case"invalid_type":return`Nevalida enigo: atendiĝis ${e.expected}, riceviĝis ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"nombro";case"object":if(Array.isArray(e))return"tabelo";if(null===e)return"senvalora";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`Nevalida enigo: atendiĝis ${Uh(e.values[0])}`:`Nevalida opcio: atendiĝis unu el ${lh(e.values,"|")}`;case"too_big":{const n=e.inclusive?"<=":"<",i=t(e.origin);return i?`Tro granda: atendiĝis ke ${e.origin??"valoro"} havu ${n}${e.maximum.toString()} ${i.unit??"elementojn"}`:`Tro granda: atendiĝis ke ${e.origin??"valoro"} havu ${n}${e.maximum.toString()}`}case"too_small":{const n=e.inclusive?">=":">",i=t(e.origin);return i?`Tro malgranda: atendiĝis ke ${e.origin} havu ${n}${e.minimum.toString()} ${i.unit}`:`Tro malgranda: atendiĝis ke ${e.origin} estu ${n}${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`Nevalida karaktraro: devas komenciĝi per "${t.prefix}"`:"ends_with"===t.format?`Nevalida karaktraro: devas finiĝi per "${t.suffix}"`:"includes"===t.format?`Nevalida karaktraro: devas inkluzivi "${t.includes}"`:"regex"===t.format?`Nevalida karaktraro: devas kongrui kun la modelo ${t.pattern}`:`Nevalida ${n[t.format]??e.format}`}case"not_multiple_of":return`Nevalida nombro: devas esti oblo de ${e.divisor}`;case"unrecognized_keys":return`Nekonata${e.keys.length>1?"j":""} ŝlosilo${e.keys.length>1?"j":""}: ${lh(e.keys,", ")}`;case"invalid_key":return`Nevalida ŝlosilo en ${e.origin}`;case"invalid_union":default:return"Nevalida enigo";case"invalid_element":return`Nevalida valoro en ${e.origin}`}}};function Av(){return{localeError:Ov()}}const Nv=()=>{const e={string:{unit:"caracteres",verb:"tener"},file:{unit:"bytes",verb:"tener"},array:{unit:"elementos",verb:"tener"},set:{unit:"elementos",verb:"tener"}};function t(t){return e[t]??null}const n={regex:"entrada",email:"dirección de correo electrónico",url:"URL",emoji:"emoji",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"fecha y hora ISO",date:"fecha ISO",time:"hora ISO",duration:"duración ISO",ipv4:"dirección IPv4",ipv6:"dirección IPv6",cidrv4:"rango IPv4",cidrv6:"rango IPv6",base64:"cadena codificada en base64",base64url:"URL codificada en base64",json_string:"cadena JSON",e164:"número E.164",jwt:"JWT",template_literal:"entrada"};return e=>{switch(e.code){case"invalid_type":return`Entrada inválida: se esperaba ${e.expected}, recibido ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"número";case"object":if(Array.isArray(e))return"arreglo";if(null===e)return"nulo";if(Object.getPrototypeOf(e)!==Object.prototype)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`Entrada inválida: se esperaba ${Uh(e.values[0])}`:`Opción inválida: se esperaba una de ${lh(e.values,"|")}`;case"too_big":{const n=e.inclusive?"<=":"<",i=t(e.origin);return i?`Demasiado grande: se esperaba que ${e.origin??"valor"} tuviera ${n}${e.maximum.toString()} ${i.unit??"elementos"}`:`Demasiado grande: se esperaba que ${e.origin??"valor"} fuera ${n}${e.maximum.toString()}`}case"too_small":{const n=e.inclusive?">=":">",i=t(e.origin);return i?`Demasiado pequeño: se esperaba que ${e.origin} tuviera ${n}${e.minimum.toString()} ${i.unit}`:`Demasiado pequeño: se esperaba que ${e.origin} fuera ${n}${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`Cadena inválida: debe comenzar con "${t.prefix}"`:"ends_with"===t.format?`Cadena inválida: debe terminar en "${t.suffix}"`:"includes"===t.format?`Cadena inválida: debe incluir "${t.includes}"`:"regex"===t.format?`Cadena inválida: debe coincidir con el patrón ${t.pattern}`:`Inválido ${n[t.format]??e.format}`}case"not_multiple_of":return`Número inválido: debe ser múltiplo de ${e.divisor}`;case"unrecognized_keys":return`Llave${e.keys.length>1?"s":""} desconocida${e.keys.length>1?"s":""}: ${lh(e.keys,", ")}`;case"invalid_key":return`Llave inválida en ${e.origin}`;case"invalid_union":default:return"Entrada inválida";case"invalid_element":return`Valor inválido en ${e.origin}`}}};function Cv(){return{localeError:Nv()}}const Dv=()=>{const e={string:{unit:"کاراکتر",verb:"داشته باشد"},file:{unit:"بایت",verb:"داشته باشد"},array:{unit:"آیتم",verb:"داشته باشد"},set:{unit:"آیتم",verb:"داشته باشد"}};function t(t){return e[t]??null}const n={regex:"ورودی",email:"آدرس ایمیل",url:"URL",emoji:"ایموجی",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"تاریخ و زمان ایزو",date:"تاریخ ایزو",time:"زمان ایزو",duration:"مدت زمان ایزو",ipv4:"IPv4 آدرس",ipv6:"IPv6 آدرس",cidrv4:"IPv4 دامنه",cidrv6:"IPv6 دامنه",base64:"base64-encoded رشته",base64url:"base64url-encoded رشته",json_string:"JSON رشته",e164:"E.164 عدد",jwt:"JWT",template_literal:"ورودی"};return e=>{switch(e.code){case"invalid_type":return`ورودی نامعتبر: می‌بایست ${e.expected} می‌بود، ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"عدد";case"object":if(Array.isArray(e))return"آرایه";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)} دریافت شد`;case"invalid_value":return 1===e.values.length?`ورودی نامعتبر: می‌بایست ${Uh(e.values[0])} می‌بود`:`گزینه نامعتبر: می‌بایست یکی از ${lh(e.values,"|")} می‌بود`;case"too_big":{const n=e.inclusive?"<=":"<",i=t(e.origin);return i?`خیلی بزرگ: ${e.origin??"مقدار"} باید ${n}${e.maximum.toString()} ${i.unit??"عنصر"} باشد`:`خیلی بزرگ: ${e.origin??"مقدار"} باید ${n}${e.maximum.toString()} باشد`}case"too_small":{const n=e.inclusive?">=":">",i=t(e.origin);return i?`خیلی کوچک: ${e.origin} باید ${n}${e.minimum.toString()} ${i.unit} باشد`:`خیلی کوچک: ${e.origin} باید ${n}${e.minimum.toString()} باشد`}case"invalid_format":{const t=e;return"starts_with"===t.format?`رشته نامعتبر: باید با "${t.prefix}" شروع شود`:"ends_with"===t.format?`رشته نامعتبر: باید با "${t.suffix}" تمام شود`:"includes"===t.format?`رشته نامعتبر: باید شامل "${t.includes}" باشد`:"regex"===t.format?`رشته نامعتبر: باید با الگوی ${t.pattern} مطابقت داشته باشد`:`${n[t.format]??e.format} نامعتبر`}case"not_multiple_of":return`عدد نامعتبر: باید مضرب ${e.divisor} باشد`;case"unrecognized_keys":return`کلید${e.keys.length>1?"های":""} ناشناس: ${lh(e.keys,", ")}`;case"invalid_key":return`کلید ناشناس در ${e.origin}`;case"invalid_union":default:return"ورودی نامعتبر";case"invalid_element":return`مقدار نامعتبر در ${e.origin}`}}};function Lv(){return{localeError:Dv()}}const Rv=()=>{const e={string:{unit:"merkkiä",subject:"merkkijonon"},file:{unit:"tavua",subject:"tiedoston"},array:{unit:"alkiota",subject:"listan"},set:{unit:"alkiota",subject:"joukon"},number:{unit:"",subject:"luvun"},bigint:{unit:"",subject:"suuren kokonaisluvun"},int:{unit:"",subject:"kokonaisluvun"},date:{unit:"",subject:"päivämäärän"}};function t(t){return e[t]??null}const n={regex:"säännöllinen lauseke",email:"sähköpostiosoite",url:"URL-osoite",emoji:"emoji",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"ISO-aikaleima",date:"ISO-päivämäärä",time:"ISO-aika",duration:"ISO-kesto",ipv4:"IPv4-osoite",ipv6:"IPv6-osoite",cidrv4:"IPv4-alue",cidrv6:"IPv6-alue",base64:"base64-koodattu merkkijono",base64url:"base64url-koodattu merkkijono",json_string:"JSON-merkkijono",e164:"E.164-luku",jwt:"JWT",template_literal:"templaattimerkkijono"};return e=>{switch(e.code){case"invalid_type":return`Virheellinen tyyppi: odotettiin ${e.expected}, oli ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"number";case"object":if(Array.isArray(e))return"array";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`Virheellinen syöte: täytyy olla ${Uh(e.values[0])}`:`Virheellinen valinta: täytyy olla yksi seuraavista: ${lh(e.values,"|")}`;case"too_big":{const n=e.inclusive?"<=":"<",i=t(e.origin);return i?`Liian suuri: ${i.subject} täytyy olla ${n}${e.maximum.toString()} ${i.unit}`.trim():`Liian suuri: arvon täytyy olla ${n}${e.maximum.toString()}`}case"too_small":{const n=e.inclusive?">=":">",i=t(e.origin);return i?`Liian pieni: ${i.subject} täytyy olla ${n}${e.minimum.toString()} ${i.unit}`.trim():`Liian pieni: arvon täytyy olla ${n}${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`Virheellinen syöte: täytyy alkaa "${t.prefix}"`:"ends_with"===t.format?`Virheellinen syöte: täytyy loppua "${t.suffix}"`:"includes"===t.format?`Virheellinen syöte: täytyy sisältää "${t.includes}"`:"regex"===t.format?`Virheellinen syöte: täytyy vastata säännöllistä lauseketta ${t.pattern}`:`Virheellinen ${n[t.format]??e.format}`}case"not_multiple_of":return`Virheellinen luku: täytyy olla luvun ${e.divisor} monikerta`;case"unrecognized_keys":return`${e.keys.length>1?"Tuntemattomat avaimet":"Tuntematon avain"}: ${lh(e.keys,", ")}`;case"invalid_key":return"Virheellinen avain tietueessa";case"invalid_union":return"Virheellinen unioni";case"invalid_element":return"Virheellinen arvo joukossa";default:return"Virheellinen syöte"}}};function jv(){return{localeError:Rv()}}const Pv=()=>{const e={string:{unit:"caractères",verb:"avoir"},file:{unit:"octets",verb:"avoir"},array:{unit:"éléments",verb:"avoir"},set:{unit:"éléments",verb:"avoir"}};function t(t){return e[t]??null}const n={regex:"entrée",email:"adresse e-mail",url:"URL",emoji:"emoji",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"date et heure ISO",date:"date ISO",time:"heure ISO",duration:"durée ISO",ipv4:"adresse IPv4",ipv6:"adresse IPv6",cidrv4:"plage IPv4",cidrv6:"plage IPv6",base64:"chaîne encodée en base64",base64url:"chaîne encodée en base64url",json_string:"chaîne JSON",e164:"numéro E.164",jwt:"JWT",template_literal:"entrée"};return e=>{switch(e.code){case"invalid_type":return`Entrée invalide : ${e.expected} attendu, ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"nombre";case"object":if(Array.isArray(e))return"tableau";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)} reçu`;case"invalid_value":return 1===e.values.length?`Entrée invalide : ${Uh(e.values[0])} attendu`:`Option invalide : une valeur parmi ${lh(e.values,"|")} attendue`;case"too_big":{const n=e.inclusive?"<=":"<",i=t(e.origin);return i?`Trop grand : ${e.origin??"valeur"} doit ${i.verb} ${n}${e.maximum.toString()} ${i.unit??"élément(s)"}`:`Trop grand : ${e.origin??"valeur"} doit être ${n}${e.maximum.toString()}`}case"too_small":{const n=e.inclusive?">=":">",i=t(e.origin);return i?`Trop petit : ${e.origin} doit ${i.verb} ${n}${e.minimum.toString()} ${i.unit}`:`Trop petit : ${e.origin} doit être ${n}${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`Chaîne invalide : doit commencer par "${t.prefix}"`:"ends_with"===t.format?`Chaîne invalide : doit se terminer par "${t.suffix}"`:"includes"===t.format?`Chaîne invalide : doit inclure "${t.includes}"`:"regex"===t.format?`Chaîne invalide : doit correspondre au modèle ${t.pattern}`:`${n[t.format]??e.format} invalide`}case"not_multiple_of":return`Nombre invalide : doit être un multiple de ${e.divisor}`;case"unrecognized_keys":return`Clé${e.keys.length>1?"s":""} non reconnue${e.keys.length>1?"s":""} : ${lh(e.keys,", ")}`;case"invalid_key":return`Clé invalide dans ${e.origin}`;case"invalid_union":default:return"Entrée invalide";case"invalid_element":return`Valeur invalide dans ${e.origin}`}}};function Uv(){return{localeError:Pv()}}const Mv=()=>{const e={string:{unit:"caractères",verb:"avoir"},file:{unit:"octets",verb:"avoir"},array:{unit:"éléments",verb:"avoir"},set:{unit:"éléments",verb:"avoir"}};function t(t){return e[t]??null}const n={regex:"entrée",email:"adresse courriel",url:"URL",emoji:"emoji",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"date-heure ISO",date:"date ISO",time:"heure ISO",duration:"durée ISO",ipv4:"adresse IPv4",ipv6:"adresse IPv6",cidrv4:"plage IPv4",cidrv6:"plage IPv6",base64:"chaîne encodée en base64",base64url:"chaîne encodée en base64url",json_string:"chaîne JSON",e164:"numéro E.164",jwt:"JWT",template_literal:"entrée"};return e=>{switch(e.code){case"invalid_type":return`Entrée invalide : attendu ${e.expected}, reçu ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"number";case"object":if(Array.isArray(e))return"array";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`Entrée invalide : attendu ${Uh(e.values[0])}`:`Option invalide : attendu l'une des valeurs suivantes ${lh(e.values,"|")}`;case"too_big":{const n=e.inclusive?"≤":"<",i=t(e.origin);return i?`Trop grand : attendu que ${e.origin??"la valeur"} ait ${n}${e.maximum.toString()} ${i.unit}`:`Trop grand : attendu que ${e.origin??"la valeur"} soit ${n}${e.maximum.toString()}`}case"too_small":{const n=e.inclusive?"≥":">",i=t(e.origin);return i?`Trop petit : attendu que ${e.origin} ait ${n}${e.minimum.toString()} ${i.unit}`:`Trop petit : attendu que ${e.origin} soit ${n}${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`Chaîne invalide : doit commencer par "${t.prefix}"`:"ends_with"===t.format?`Chaîne invalide : doit se terminer par "${t.suffix}"`:"includes"===t.format?`Chaîne invalide : doit inclure "${t.includes}"`:"regex"===t.format?`Chaîne invalide : doit correspondre au motif ${t.pattern}`:`${n[t.format]??e.format} invalide`}case"not_multiple_of":return`Nombre invalide : doit être un multiple de ${e.divisor}`;case"unrecognized_keys":return`Clé${e.keys.length>1?"s":""} non reconnue${e.keys.length>1?"s":""} : ${lh(e.keys,", ")}`;case"invalid_key":return`Clé invalide dans ${e.origin}`;case"invalid_union":default:return"Entrée invalide";case"invalid_element":return`Valeur invalide dans ${e.origin}`}}};function zv(){return{localeError:Mv()}}const Fv=()=>{const e={string:{unit:"אותיות",verb:"לכלול"},file:{unit:"בייטים",verb:"לכלול"},array:{unit:"פריטים",verb:"לכלול"},set:{unit:"פריטים",verb:"לכלול"}};function t(t){return e[t]??null}const n={regex:"קלט",email:"כתובת אימייל",url:"כתובת רשת",emoji:"אימוג'י",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"תאריך וזמן ISO",date:"תאריך ISO",time:"זמן ISO",duration:"משך זמן ISO",ipv4:"כתובת IPv4",ipv6:"כתובת IPv6",cidrv4:"טווח IPv4",cidrv6:"טווח IPv6",base64:"מחרוזת בבסיס 64",base64url:"מחרוזת בבסיס 64 לכתובות רשת",json_string:"מחרוזת JSON",e164:"מספר E.164",jwt:"JWT",template_literal:"קלט"};return e=>{switch(e.code){case"invalid_type":return`קלט לא תקין: צריך ${e.expected}, התקבל ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"number";case"object":if(Array.isArray(e))return"array";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`קלט לא תקין: צריך ${Uh(e.values[0])}`:`קלט לא תקין: צריך אחת מהאפשרויות  ${lh(e.values,"|")}`;case"too_big":{const n=e.inclusive?"<=":"<",i=t(e.origin);return i?`גדול מדי: ${e.origin??"value"} צריך להיות ${n}${e.maximum.toString()} ${i.unit??"elements"}`:`גדול מדי: ${e.origin??"value"} צריך להיות ${n}${e.maximum.toString()}`}case"too_small":{const n=e.inclusive?">=":">",i=t(e.origin);return i?`קטן מדי: ${e.origin} צריך להיות ${n}${e.minimum.toString()} ${i.unit}`:`קטן מדי: ${e.origin} צריך להיות ${n}${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`מחרוזת לא תקינה: חייבת להתחיל ב"${t.prefix}"`:"ends_with"===t.format?`מחרוזת לא תקינה: חייבת להסתיים ב "${t.suffix}"`:"includes"===t.format?`מחרוזת לא תקינה: חייבת לכלול "${t.includes}"`:"regex"===t.format?`מחרוזת לא תקינה: חייבת להתאים לתבנית ${t.pattern}`:`${n[t.format]??e.format} לא תקין`}case"not_multiple_of":return`מספר לא תקין: חייב להיות מכפלה של ${e.divisor}`;case"unrecognized_keys":return`מפתח${e.keys.length>1?"ות":""} לא מזוה${e.keys.length>1?"ים":"ה"}: ${lh(e.keys,", ")}`;case"invalid_key":return`מפתח לא תקין ב${e.origin}`;case"invalid_union":default:return"קלט לא תקין";case"invalid_element":return`ערך לא תקין ב${e.origin}`}}};function Bv(){return{localeError:Fv()}}const Gv=()=>{const e={string:{unit:"karakter",verb:"legyen"},file:{unit:"byte",verb:"legyen"},array:{unit:"elem",verb:"legyen"},set:{unit:"elem",verb:"legyen"}};function t(t){return e[t]??null}const n={regex:"bemenet",email:"email cím",url:"URL",emoji:"emoji",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"ISO időbélyeg",date:"ISO dátum",time:"ISO idő",duration:"ISO időintervallum",ipv4:"IPv4 cím",ipv6:"IPv6 cím",cidrv4:"IPv4 tartomány",cidrv6:"IPv6 tartomány",base64:"base64-kódolt string",base64url:"base64url-kódolt string",json_string:"JSON string",e164:"E.164 szám",jwt:"JWT",template_literal:"bemenet"};return e=>{switch(e.code){case"invalid_type":return`Érvénytelen bemenet: a várt érték ${e.expected}, a kapott érték ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"szám";case"object":if(Array.isArray(e))return"tömb";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`Érvénytelen bemenet: a várt érték ${Uh(e.values[0])}`:`Érvénytelen opció: valamelyik érték várt ${lh(e.values,"|")}`;case"too_big":{const n=e.inclusive?"<=":"<",i=t(e.origin);return i?`Túl nagy: ${e.origin??"érték"} mérete túl nagy ${n}${e.maximum.toString()} ${i.unit??"elem"}`:`Túl nagy: a bemeneti érték ${e.origin??"érték"} túl nagy: ${n}${e.maximum.toString()}`}case"too_small":{const n=e.inclusive?">=":">",i=t(e.origin);return i?`Túl kicsi: a bemeneti érték ${e.origin} mérete túl kicsi ${n}${e.minimum.toString()} ${i.unit}`:`Túl kicsi: a bemeneti érték ${e.origin} túl kicsi ${n}${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`Érvénytelen string: "${t.prefix}" értékkel kell kezdődnie`:"ends_with"===t.format?`Érvénytelen string: "${t.suffix}" értékkel kell végződnie`:"includes"===t.format?`Érvénytelen string: "${t.includes}" értéket kell tartalmaznia`:"regex"===t.format?`Érvénytelen string: ${t.pattern} mintának kell megfelelnie`:`Érvénytelen ${n[t.format]??e.format}`}case"not_multiple_of":return`Érvénytelen szám: ${e.divisor} többszörösének kell lennie`;case"unrecognized_keys":return`Ismeretlen kulcs${e.keys.length>1?"s":""}: ${lh(e.keys,", ")}`;case"invalid_key":return`Érvénytelen kulcs ${e.origin}`;case"invalid_union":default:return"Érvénytelen bemenet";case"invalid_element":return`Érvénytelen érték: ${e.origin}`}}};function Vv(){return{localeError:Gv()}}const Zv=()=>{const e={string:{unit:"karakter",verb:"memiliki"},file:{unit:"byte",verb:"memiliki"},array:{unit:"item",verb:"memiliki"},set:{unit:"item",verb:"memiliki"}};function t(t){return e[t]??null}const n={regex:"input",email:"alamat email",url:"URL",emoji:"emoji",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"tanggal dan waktu format ISO",date:"tanggal format ISO",time:"jam format ISO",duration:"durasi format ISO",ipv4:"alamat IPv4",ipv6:"alamat IPv6",cidrv4:"rentang alamat IPv4",cidrv6:"rentang alamat IPv6",base64:"string dengan enkode base64",base64url:"string dengan enkode base64url",json_string:"string JSON",e164:"angka E.164",jwt:"JWT",template_literal:"input"};return e=>{switch(e.code){case"invalid_type":return`Input tidak valid: diharapkan ${e.expected}, diterima ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"number";case"object":if(Array.isArray(e))return"array";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`Input tidak valid: diharapkan ${Uh(e.values[0])}`:`Pilihan tidak valid: diharapkan salah satu dari ${lh(e.values,"|")}`;case"too_big":{const n=e.inclusive?"<=":"<",i=t(e.origin);return i?`Terlalu besar: diharapkan ${e.origin??"value"} memiliki ${n}${e.maximum.toString()} ${i.unit??"elemen"}`:`Terlalu besar: diharapkan ${e.origin??"value"} menjadi ${n}${e.maximum.toString()}`}case"too_small":{const n=e.inclusive?">=":">",i=t(e.origin);return i?`Terlalu kecil: diharapkan ${e.origin} memiliki ${n}${e.minimum.toString()} ${i.unit}`:`Terlalu kecil: diharapkan ${e.origin} menjadi ${n}${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`String tidak valid: harus dimulai dengan "${t.prefix}"`:"ends_with"===t.format?`String tidak valid: harus berakhir dengan "${t.suffix}"`:"includes"===t.format?`String tidak valid: harus menyertakan "${t.includes}"`:"regex"===t.format?`String tidak valid: harus sesuai pola ${t.pattern}`:`${n[t.format]??e.format} tidak valid`}case"not_multiple_of":return`Angka tidak valid: harus kelipatan dari ${e.divisor}`;case"unrecognized_keys":return`Kunci tidak dikenali ${e.keys.length>1?"s":""}: ${lh(e.keys,", ")}`;case"invalid_key":return`Kunci tidak valid di ${e.origin}`;case"invalid_union":default:return"Input tidak valid";case"invalid_element":return`Nilai tidak valid di ${e.origin}`}}};function qv(){return{localeError:Zv()}}const Hv=()=>{const e={string:{unit:"stafi",verb:"að hafa"},file:{unit:"bæti",verb:"að hafa"},array:{unit:"hluti",verb:"að hafa"},set:{unit:"hluti",verb:"að hafa"}};function t(t){return e[t]??null}const n={regex:"gildi",email:"netfang",url:"vefslóð",emoji:"emoji",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"ISO dagsetning og tími",date:"ISO dagsetning",time:"ISO tími",duration:"ISO tímalengd",ipv4:"IPv4 address",ipv6:"IPv6 address",cidrv4:"IPv4 range",cidrv6:"IPv6 range",base64:"base64-encoded strengur",base64url:"base64url-encoded strengur",json_string:"JSON strengur",e164:"E.164 tölugildi",jwt:"JWT",template_literal:"gildi"};return e=>{switch(e.code){case"invalid_type":return`Rangt gildi: Þú slóst inn ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"númer";case"object":if(Array.isArray(e))return"fylki";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)} þar sem á að vera ${e.expected}`;case"invalid_value":return 1===e.values.length?`Rangt gildi: gert ráð fyrir ${Uh(e.values[0])}`:`Ógilt val: má vera eitt af eftirfarandi ${lh(e.values,"|")}`;case"too_big":{const n=e.inclusive?"<=":"<",i=t(e.origin);return i?`Of stórt: gert er ráð fyrir að ${e.origin??"gildi"} hafi ${n}${e.maximum.toString()} ${i.unit??"hluti"}`:`Of stórt: gert er ráð fyrir að ${e.origin??"gildi"} sé ${n}${e.maximum.toString()}`}case"too_small":{const n=e.inclusive?">=":">",i=t(e.origin);return i?`Of lítið: gert er ráð fyrir að ${e.origin} hafi ${n}${e.minimum.toString()} ${i.unit}`:`Of lítið: gert er ráð fyrir að ${e.origin} sé ${n}${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`Ógildur strengur: verður að byrja á "${t.prefix}"`:"ends_with"===t.format?`Ógildur strengur: verður að enda á "${t.suffix}"`:"includes"===t.format?`Ógildur strengur: verður að innihalda "${t.includes}"`:"regex"===t.format?`Ógildur strengur: verður að fylgja mynstri ${t.pattern}`:`Rangt ${n[t.format]??e.format}`}case"not_multiple_of":return`Röng tala: verður að vera margfeldi af ${e.divisor}`;case"unrecognized_keys":return`Óþekkt ${e.keys.length>1?"ir lyklar":"ur lykill"}: ${lh(e.keys,", ")}`;case"invalid_key":return`Rangur lykill í ${e.origin}`;case"invalid_union":default:return"Rangt gildi";case"invalid_element":return`Rangt gildi í ${e.origin}`}}};function Wv(){return{localeError:Hv()}}const Jv=()=>{const e={string:{unit:"caratteri",verb:"avere"},file:{unit:"byte",verb:"avere"},array:{unit:"elementi",verb:"avere"},set:{unit:"elementi",verb:"avere"}};function t(t){return e[t]??null}const n={regex:"input",email:"indirizzo email",url:"URL",emoji:"emoji",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"data e ora ISO",date:"data ISO",time:"ora ISO",duration:"durata ISO",ipv4:"indirizzo IPv4",ipv6:"indirizzo IPv6",cidrv4:"intervallo IPv4",cidrv6:"intervallo IPv6",base64:"stringa codificata in base64",base64url:"URL codificata in base64",json_string:"stringa JSON",e164:"numero E.164",jwt:"JWT",template_literal:"input"};return e=>{switch(e.code){case"invalid_type":return`Input non valido: atteso ${e.expected}, ricevuto ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"numero";case"object":if(Array.isArray(e))return"vettore";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`Input non valido: atteso ${Uh(e.values[0])}`:`Opzione non valida: atteso uno tra ${lh(e.values,"|")}`;case"too_big":{const n=e.inclusive?"<=":"<",i=t(e.origin);return i?`Troppo grande: ${e.origin??"valore"} deve avere ${n}${e.maximum.toString()} ${i.unit??"elementi"}`:`Troppo grande: ${e.origin??"valore"} deve essere ${n}${e.maximum.toString()}`}case"too_small":{const n=e.inclusive?">=":">",i=t(e.origin);return i?`Troppo piccolo: ${e.origin} deve avere ${n}${e.minimum.toString()} ${i.unit}`:`Troppo piccolo: ${e.origin} deve essere ${n}${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`Stringa non valida: deve iniziare con "${t.prefix}"`:"ends_with"===t.format?`Stringa non valida: deve terminare con "${t.suffix}"`:"includes"===t.format?`Stringa non valida: deve includere "${t.includes}"`:"regex"===t.format?`Stringa non valida: deve corrispondere al pattern ${t.pattern}`:`Invalid ${n[t.format]??e.format}`}case"not_multiple_of":return`Numero non valido: deve essere un multiplo di ${e.divisor}`;case"unrecognized_keys":return`Chiav${e.keys.length>1?"i":"e"} non riconosciut${e.keys.length>1?"e":"a"}: ${lh(e.keys,", ")}`;case"invalid_key":return`Chiave non valida in ${e.origin}`;case"invalid_union":default:return"Input non valido";case"invalid_element":return`Valore non valido in ${e.origin}`}}};function Kv(){return{localeError:Jv()}}const Yv=()=>{const e={string:{unit:"文字",verb:"である"},file:{unit:"バイト",verb:"である"},array:{unit:"要素",verb:"である"},set:{unit:"要素",verb:"である"}};function t(t){return e[t]??null}const n={regex:"入力値",email:"メールアドレス",url:"URL",emoji:"絵文字",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"ISO日時",date:"ISO日付",time:"ISO時刻",duration:"ISO期間",ipv4:"IPv4アドレス",ipv6:"IPv6アドレス",cidrv4:"IPv4範囲",cidrv6:"IPv6範囲",base64:"base64エンコード文字列",base64url:"base64urlエンコード文字列",json_string:"JSON文字列",e164:"E.164番号",jwt:"JWT",template_literal:"入力値"};return e=>{switch(e.code){case"invalid_type":return`無効な入力: ${e.expected}が期待されましたが、${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"数値";case"object":if(Array.isArray(e))return"配列";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}が入力されました`;case"invalid_value":return 1===e.values.length?`無効な入力: ${Uh(e.values[0])}が期待されました`:`無効な選択: ${lh(e.values,"、")}のいずれかである必要があります`;case"too_big":{const n=e.inclusive?"以下である":"より小さい",i=t(e.origin);return i?`大きすぎる値: ${e.origin??"値"}は${e.maximum.toString()}${i.unit??"要素"}${n}必要があります`:`大きすぎる値: ${e.origin??"値"}は${e.maximum.toString()}${n}必要があります`}case"too_small":{const n=e.inclusive?"以上である":"より大きい",i=t(e.origin);return i?`小さすぎる値: ${e.origin}は${e.minimum.toString()}${i.unit}${n}必要があります`:`小さすぎる値: ${e.origin}は${e.minimum.toString()}${n}必要があります`}case"invalid_format":{const t=e;return"starts_with"===t.format?`無効な文字列: "${t.prefix}"で始まる必要があります`:"ends_with"===t.format?`無効な文字列: "${t.suffix}"で終わる必要があります`:"includes"===t.format?`無効な文字列: "${t.includes}"を含む必要があります`:"regex"===t.format?`無効な文字列: パターン${t.pattern}に一致する必要があります`:`無効な${n[t.format]??e.format}`}case"not_multiple_of":return`無効な数値: ${e.divisor}の倍数である必要があります`;case"unrecognized_keys":return`認識されていないキー${e.keys.length>1?"群":""}: ${lh(e.keys,"、")}`;case"invalid_key":return`${e.origin}内の無効なキー`;case"invalid_union":default:return"無効な入力";case"invalid_element":return`${e.origin}内の無効な値`}}};function Xv(){return{localeError:Yv()}}const Qv=()=>{const e={string:{unit:"តួអក្សរ",verb:"គួរមាន"},file:{unit:"បៃ",verb:"គួរមាន"},array:{unit:"ធាតុ",verb:"គួរមាន"},set:{unit:"ធាតុ",verb:"គួរមាន"}};function t(t){return e[t]??null}const n={regex:"ទិន្នន័យបញ្ចូល",email:"អាសយដ្ឋានអ៊ីមែល",url:"URL",emoji:"សញ្ញាអារម្មណ៍",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"កាលបរិច្ឆេទ និងម៉ោង ISO",date:"កាលបរិច្ឆេទ ISO",time:"ម៉ោង ISO",duration:"រយៈពេល ISO",ipv4:"អាសយដ្ឋាន IPv4",ipv6:"អាសយដ្ឋាន IPv6",cidrv4:"ដែនអាសយដ្ឋាន IPv4",cidrv6:"ដែនអាសយដ្ឋាន IPv6",base64:"ខ្សែអក្សរអ៊ិកូដ base64",base64url:"ខ្សែអក្សរអ៊ិកូដ base64url",json_string:"ខ្សែអក្សរ JSON",e164:"លេខ E.164",jwt:"JWT",template_literal:"ទិន្នន័យបញ្ចូល"};return e=>{switch(e.code){case"invalid_type":return`ទិន្នន័យបញ្ចូលមិនត្រឹមត្រូវ៖ ត្រូវការ ${e.expected} ប៉ុន្តែទទួលបាន ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"មិនមែនជាលេខ (NaN)":"លេខ";case"object":if(Array.isArray(e))return"អារេ (Array)";if(null===e)return"គ្មានតម្លៃ (null)";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`ទិន្នន័យបញ្ចូលមិនត្រឹមត្រូវ៖ ត្រូវការ ${Uh(e.values[0])}`:`ជម្រើសមិនត្រឹមត្រូវ៖ ត្រូវជាមួយក្នុងចំណោម ${lh(e.values,"|")}`;case"too_big":{const n=e.inclusive?"<=":"<",i=t(e.origin);return i?`ធំពេក៖ ត្រូវការ ${e.origin??"តម្លៃ"} ${n} ${e.maximum.toString()} ${i.unit??"ធាតុ"}`:`ធំពេក៖ ត្រូវការ ${e.origin??"តម្លៃ"} ${n} ${e.maximum.toString()}`}case"too_small":{const n=e.inclusive?">=":">",i=t(e.origin);return i?`តូចពេក៖ ត្រូវការ ${e.origin} ${n} ${e.minimum.toString()} ${i.unit}`:`តូចពេក៖ ត្រូវការ ${e.origin} ${n} ${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`ខ្សែអក្សរមិនត្រឹមត្រូវ៖ ត្រូវចាប់ផ្តើមដោយ "${t.prefix}"`:"ends_with"===t.format?`ខ្សែអក្សរមិនត្រឹមត្រូវ៖ ត្រូវបញ្ចប់ដោយ "${t.suffix}"`:"includes"===t.format?`ខ្សែអក្សរមិនត្រឹមត្រូវ៖ ត្រូវមាន "${t.includes}"`:"regex"===t.format?`ខ្សែអក្សរមិនត្រឹមត្រូវ៖ ត្រូវតែផ្គូផ្គងនឹងទម្រង់ដែលបានកំណត់ ${t.pattern}`:`មិនត្រឹមត្រូវ៖ ${n[t.format]??e.format}`}case"not_multiple_of":return`លេខមិនត្រឹមត្រូវ៖ ត្រូវតែជាពហុគុណនៃ ${e.divisor}`;case"unrecognized_keys":return`រកឃើញសោមិនស្គាល់៖ ${lh(e.keys,", ")}`;case"invalid_key":return`សោមិនត្រឹមត្រូវនៅក្នុង ${e.origin}`;case"invalid_union":default:return"ទិន្នន័យមិនត្រឹមត្រូវ";case"invalid_element":return`ទិន្នន័យមិនត្រឹមត្រូវនៅក្នុង ${e.origin}`}}};function ey(){return{localeError:Qv()}}const ty=()=>{const e={string:{unit:"문자",verb:"to have"},file:{unit:"바이트",verb:"to have"},array:{unit:"개",verb:"to have"},set:{unit:"개",verb:"to have"}};function t(t){return e[t]??null}const n={regex:"입력",email:"이메일 주소",url:"URL",emoji:"이모지",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"ISO 날짜시간",date:"ISO 날짜",time:"ISO 시간",duration:"ISO 기간",ipv4:"IPv4 주소",ipv6:"IPv6 주소",cidrv4:"IPv4 범위",cidrv6:"IPv6 범위",base64:"base64 인코딩 문자열",base64url:"base64url 인코딩 문자열",json_string:"JSON 문자열",e164:"E.164 번호",jwt:"JWT",template_literal:"입력"};return e=>{switch(e.code){case"invalid_type":return`잘못된 입력: 예상 타입은 ${e.expected}, 받은 타입은 ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"number";case"object":if(Array.isArray(e))return"array";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}입니다`;case"invalid_value":return 1===e.values.length?`잘못된 입력: 값은 ${Uh(e.values[0])} 이어야 합니다`:`잘못된 옵션: ${lh(e.values,"또는 ")} 중 하나여야 합니다`;case"too_big":{const n=e.inclusive?"이하":"미만",i="미만"===n?"이어야 합니다":"여야 합니다",r=t(e.origin),s=r?.unit??"요소";return r?`${e.origin??"값"}이 너무 큽니다: ${e.maximum.toString()}${s} ${n}${i}`:`${e.origin??"값"}이 너무 큽니다: ${e.maximum.toString()} ${n}${i}`}case"too_small":{const n=e.inclusive?"이상":"초과",i="이상"===n?"이어야 합니다":"여야 합니다",r=t(e.origin),s=r?.unit??"요소";return r?`${e.origin??"값"}이 너무 작습니다: ${e.minimum.toString()}${s} ${n}${i}`:`${e.origin??"값"}이 너무 작습니다: ${e.minimum.toString()} ${n}${i}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`잘못된 문자열: "${t.prefix}"(으)로 시작해야 합니다`:"ends_with"===t.format?`잘못된 문자열: "${t.suffix}"(으)로 끝나야 합니다`:"includes"===t.format?`잘못된 문자열: "${t.includes}"을(를) 포함해야 합니다`:"regex"===t.format?`잘못된 문자열: 정규식 ${t.pattern} 패턴과 일치해야 합니다`:`잘못된 ${n[t.format]??e.format}`}case"not_multiple_of":return`잘못된 숫자: ${e.divisor}의 배수여야 합니다`;case"unrecognized_keys":return`인식할 수 없는 키: ${lh(e.keys,", ")}`;case"invalid_key":return`잘못된 키: ${e.origin}`;case"invalid_union":default:return"잘못된 입력";case"invalid_element":return`잘못된 값: ${e.origin}`}}};function ny(){return{localeError:ty()}}const iy=()=>{const e={string:{unit:"знаци",verb:"да имаат"},file:{unit:"бајти",verb:"да имаат"},array:{unit:"ставки",verb:"да имаат"},set:{unit:"ставки",verb:"да имаат"}};function t(t){return e[t]??null}const n={regex:"внес",email:"адреса на е-пошта",url:"URL",emoji:"емоџи",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"ISO датум и време",date:"ISO датум",time:"ISO време",duration:"ISO времетраење",ipv4:"IPv4 адреса",ipv6:"IPv6 адреса",cidrv4:"IPv4 опсег",cidrv6:"IPv6 опсег",base64:"base64-енкодирана низа",base64url:"base64url-енкодирана низа",json_string:"JSON низа",e164:"E.164 број",jwt:"JWT",template_literal:"внес"};return e=>{switch(e.code){case"invalid_type":return`Грешен внес: се очекува ${e.expected}, примено ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"број";case"object":if(Array.isArray(e))return"низа";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`Invalid input: expected ${Uh(e.values[0])}`:`Грешана опција: се очекува една ${lh(e.values,"|")}`;case"too_big":{const n=e.inclusive?"<=":"<",i=t(e.origin);return i?`Премногу голем: се очекува ${e.origin??"вредноста"} да има ${n}${e.maximum.toString()} ${i.unit??"елементи"}`:`Премногу голем: се очекува ${e.origin??"вредноста"} да биде ${n}${e.maximum.toString()}`}case"too_small":{const n=e.inclusive?">=":">",i=t(e.origin);return i?`Премногу мал: се очекува ${e.origin} да има ${n}${e.minimum.toString()} ${i.unit}`:`Премногу мал: се очекува ${e.origin} да биде ${n}${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`Неважечка низа: мора да започнува со "${t.prefix}"`:"ends_with"===t.format?`Неважечка низа: мора да завршува со "${t.suffix}"`:"includes"===t.format?`Неважечка низа: мора да вклучува "${t.includes}"`:"regex"===t.format?`Неважечка низа: мора да одгоара на патернот ${t.pattern}`:`Invalid ${n[t.format]??e.format}`}case"not_multiple_of":return`Грешен број: мора да биде делив со ${e.divisor}`;case"unrecognized_keys":return`${e.keys.length>1?"Непрепознаени клучеви":"Непрепознаен клуч"}: ${lh(e.keys,", ")}`;case"invalid_key":return`Грешен клуч во ${e.origin}`;case"invalid_union":default:return"Грешен внес";case"invalid_element":return`Грешна вредност во ${e.origin}`}}};function ry(){return{localeError:iy()}}const sy=()=>{const e={string:{unit:"aksara",verb:"mempunyai"},file:{unit:"bait",verb:"mempunyai"},array:{unit:"elemen",verb:"mempunyai"},set:{unit:"elemen",verb:"mempunyai"}};function t(t){return e[t]??null}const n={regex:"input",email:"alamat e-mel",url:"URL",emoji:"emoji",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"tarikh masa ISO",date:"tarikh ISO",time:"masa ISO",duration:"tempoh ISO",ipv4:"alamat IPv4",ipv6:"alamat IPv6",cidrv4:"julat IPv4",cidrv6:"julat IPv6",base64:"string dikodkan base64",base64url:"string dikodkan base64url",json_string:"string JSON",e164:"nombor E.164",jwt:"JWT",template_literal:"input"};return e=>{switch(e.code){case"invalid_type":return`Input tidak sah: dijangka ${e.expected}, diterima ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"nombor";case"object":if(Array.isArray(e))return"array";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`Input tidak sah: dijangka ${Uh(e.values[0])}`:`Pilihan tidak sah: dijangka salah satu daripada ${lh(e.values,"|")}`;case"too_big":{const n=e.inclusive?"<=":"<",i=t(e.origin);return i?`Terlalu besar: dijangka ${e.origin??"nilai"} ${i.verb} ${n}${e.maximum.toString()} ${i.unit??"elemen"}`:`Terlalu besar: dijangka ${e.origin??"nilai"} adalah ${n}${e.maximum.toString()}`}case"too_small":{const n=e.inclusive?">=":">",i=t(e.origin);return i?`Terlalu kecil: dijangka ${e.origin} ${i.verb} ${n}${e.minimum.toString()} ${i.unit}`:`Terlalu kecil: dijangka ${e.origin} adalah ${n}${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`String tidak sah: mesti bermula dengan "${t.prefix}"`:"ends_with"===t.format?`String tidak sah: mesti berakhir dengan "${t.suffix}"`:"includes"===t.format?`String tidak sah: mesti mengandungi "${t.includes}"`:"regex"===t.format?`String tidak sah: mesti sepadan dengan corak ${t.pattern}`:`${n[t.format]??e.format} tidak sah`}case"not_multiple_of":return`Nombor tidak sah: perlu gandaan ${e.divisor}`;case"unrecognized_keys":return`Kunci tidak dikenali: ${lh(e.keys,", ")}`;case"invalid_key":return`Kunci tidak sah dalam ${e.origin}`;case"invalid_union":default:return"Input tidak sah";case"invalid_element":return`Nilai tidak sah dalam ${e.origin}`}}};function ay(){return{localeError:sy()}}const oy=()=>{const e={string:{unit:"tekens"},file:{unit:"bytes"},array:{unit:"elementen"},set:{unit:"elementen"}};function t(t){return e[t]??null}const n={regex:"invoer",email:"emailadres",url:"URL",emoji:"emoji",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"ISO datum en tijd",date:"ISO datum",time:"ISO tijd",duration:"ISO duur",ipv4:"IPv4-adres",ipv6:"IPv6-adres",cidrv4:"IPv4-bereik",cidrv6:"IPv6-bereik",base64:"base64-gecodeerde tekst",base64url:"base64 URL-gecodeerde tekst",json_string:"JSON string",e164:"E.164-nummer",jwt:"JWT",template_literal:"invoer"};return e=>{switch(e.code){case"invalid_type":return`Ongeldige invoer: verwacht ${e.expected}, ontving ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"getal";case"object":if(Array.isArray(e))return"array";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`Ongeldige invoer: verwacht ${Uh(e.values[0])}`:`Ongeldige optie: verwacht één van ${lh(e.values,"|")}`;case"too_big":{const n=e.inclusive?"<=":"<",i=t(e.origin);return i?`Te lang: verwacht dat ${e.origin??"waarde"} ${n}${e.maximum.toString()} ${i.unit??"elementen"} bevat`:`Te lang: verwacht dat ${e.origin??"waarde"} ${n}${e.maximum.toString()} is`}case"too_small":{const n=e.inclusive?">=":">",i=t(e.origin);return i?`Te kort: verwacht dat ${e.origin} ${n}${e.minimum.toString()} ${i.unit} bevat`:`Te kort: verwacht dat ${e.origin} ${n}${e.minimum.toString()} is`}case"invalid_format":{const t=e;return"starts_with"===t.format?`Ongeldige tekst: moet met "${t.prefix}" beginnen`:"ends_with"===t.format?`Ongeldige tekst: moet op "${t.suffix}" eindigen`:"includes"===t.format?`Ongeldige tekst: moet "${t.includes}" bevatten`:"regex"===t.format?`Ongeldige tekst: moet overeenkomen met patroon ${t.pattern}`:`Ongeldig: ${n[t.format]??e.format}`}case"not_multiple_of":return`Ongeldig getal: moet een veelvoud van ${e.divisor} zijn`;case"unrecognized_keys":return`Onbekende key${e.keys.length>1?"s":""}: ${lh(e.keys,", ")}`;case"invalid_key":return`Ongeldige key in ${e.origin}`;case"invalid_union":default:return"Ongeldige invoer";case"invalid_element":return`Ongeldige waarde in ${e.origin}`}}};function cy(){return{localeError:oy()}}const ly=()=>{const e={string:{unit:"tegn",verb:"å ha"},file:{unit:"bytes",verb:"å ha"},array:{unit:"elementer",verb:"å inneholde"},set:{unit:"elementer",verb:"å inneholde"}};function t(t){return e[t]??null}const n={regex:"input",email:"e-postadresse",url:"URL",emoji:"emoji",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"ISO dato- og klokkeslett",date:"ISO-dato",time:"ISO-klokkeslett",duration:"ISO-varighet",ipv4:"IPv4-område",ipv6:"IPv6-område",cidrv4:"IPv4-spekter",cidrv6:"IPv6-spekter",base64:"base64-enkodet streng",base64url:"base64url-enkodet streng",json_string:"JSON-streng",e164:"E.164-nummer",jwt:"JWT",template_literal:"input"};return e=>{switch(e.code){case"invalid_type":return`Ugyldig input: forventet ${e.expected}, fikk ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"tall";case"object":if(Array.isArray(e))return"liste";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`Ugyldig verdi: forventet ${Uh(e.values[0])}`:`Ugyldig valg: forventet en av ${lh(e.values,"|")}`;case"too_big":{const n=e.inclusive?"<=":"<",i=t(e.origin);return i?`For stor(t): forventet ${e.origin??"value"} til å ha ${n}${e.maximum.toString()} ${i.unit??"elementer"}`:`For stor(t): forventet ${e.origin??"value"} til å ha ${n}${e.maximum.toString()}`}case"too_small":{const n=e.inclusive?">=":">",i=t(e.origin);return i?`For lite(n): forventet ${e.origin} til å ha ${n}${e.minimum.toString()} ${i.unit}`:`For lite(n): forventet ${e.origin} til å ha ${n}${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`Ugyldig streng: må starte med "${t.prefix}"`:"ends_with"===t.format?`Ugyldig streng: må ende med "${t.suffix}"`:"includes"===t.format?`Ugyldig streng: må inneholde "${t.includes}"`:"regex"===t.format?`Ugyldig streng: må matche mønsteret ${t.pattern}`:`Ugyldig ${n[t.format]??e.format}`}case"not_multiple_of":return`Ugyldig tall: må være et multiplum av ${e.divisor}`;case"unrecognized_keys":return`${e.keys.length>1?"Ukjente nøkler":"Ukjent nøkkel"}: ${lh(e.keys,", ")}`;case"invalid_key":return`Ugyldig nøkkel i ${e.origin}`;case"invalid_union":default:return"Ugyldig input";case"invalid_element":return`Ugyldig verdi i ${e.origin}`}}};function uy(){return{localeError:ly()}}const dy=()=>{const e={string:{unit:"harf",verb:"olmalıdır"},file:{unit:"bayt",verb:"olmalıdır"},array:{unit:"unsur",verb:"olmalıdır"},set:{unit:"unsur",verb:"olmalıdır"}};function t(t){return e[t]??null}const n={regex:"giren",email:"epostagâh",url:"URL",emoji:"emoji",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"ISO hengâmı",date:"ISO tarihi",time:"ISO zamanı",duration:"ISO müddeti",ipv4:"IPv4 nişânı",ipv6:"IPv6 nişânı",cidrv4:"IPv4 menzili",cidrv6:"IPv6 menzili",base64:"base64-şifreli metin",base64url:"base64url-şifreli metin",json_string:"JSON metin",e164:"E.164 sayısı",jwt:"JWT",template_literal:"giren"};return e=>{switch(e.code){case"invalid_type":return`Fâsit giren: umulan ${e.expected}, alınan ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"numara";case"object":if(Array.isArray(e))return"saf";if(null===e)return"gayb";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`Fâsit giren: umulan ${Uh(e.values[0])}`:`Fâsit tercih: mûteberler ${lh(e.values,"|")}`;case"too_big":{const n=e.inclusive?"<=":"<",i=t(e.origin);return i?`Fazla büyük: ${e.origin??"value"}, ${n}${e.maximum.toString()} ${i.unit??"elements"} sahip olmalıydı.`:`Fazla büyük: ${e.origin??"value"}, ${n}${e.maximum.toString()} olmalıydı.`}case"too_small":{const n=e.inclusive?">=":">",i=t(e.origin);return i?`Fazla küçük: ${e.origin}, ${n}${e.minimum.toString()} ${i.unit} sahip olmalıydı.`:`Fazla küçük: ${e.origin}, ${n}${e.minimum.toString()} olmalıydı.`}case"invalid_format":{const t=e;return"starts_with"===t.format?`Fâsit metin: "${t.prefix}" ile başlamalı.`:"ends_with"===t.format?`Fâsit metin: "${t.suffix}" ile bitmeli.`:"includes"===t.format?`Fâsit metin: "${t.includes}" ihtivâ etmeli.`:"regex"===t.format?`Fâsit metin: ${t.pattern} nakşına uymalı.`:`Fâsit ${n[t.format]??e.format}`}case"not_multiple_of":return`Fâsit sayı: ${e.divisor} katı olmalıydı.`;case"unrecognized_keys":return`Tanınmayan anahtar ${e.keys.length>1?"s":""}: ${lh(e.keys,", ")}`;case"invalid_key":return`${e.origin} için tanınmayan anahtar var.`;case"invalid_union":return"Giren tanınamadı.";case"invalid_element":return`${e.origin} için tanınmayan kıymet var.`;default:return"Kıymet tanınamadı."}}};function py(){return{localeError:dy()}}const hy=()=>{const e={string:{unit:"توکي",verb:"ولري"},file:{unit:"بایټس",verb:"ولري"},array:{unit:"توکي",verb:"ولري"},set:{unit:"توکي",verb:"ولري"}};function t(t){return e[t]??null}const n={regex:"ورودي",email:"بریښنالیک",url:"یو آر ال",emoji:"ایموجي",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"نیټه او وخت",date:"نېټه",time:"وخت",duration:"موده",ipv4:"د IPv4 پته",ipv6:"د IPv6 پته",cidrv4:"د IPv4 ساحه",cidrv6:"د IPv6 ساحه",base64:"base64-encoded متن",base64url:"base64url-encoded متن",json_string:"JSON متن",e164:"د E.164 شمېره",jwt:"JWT",template_literal:"ورودي"};return e=>{switch(e.code){case"invalid_type":return`ناسم ورودي: باید ${e.expected} وای, مګر ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"عدد";case"object":if(Array.isArray(e))return"ارې";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)} ترلاسه شو`;case"invalid_value":return 1===e.values.length?`ناسم ورودي: باید ${Uh(e.values[0])} وای`:`ناسم انتخاب: باید یو له ${lh(e.values,"|")} څخه وای`;case"too_big":{const n=e.inclusive?"<=":"<",i=t(e.origin);return i?`ډیر لوی: ${e.origin??"ارزښت"} باید ${n}${e.maximum.toString()} ${i.unit??"عنصرونه"} ولري`:`ډیر لوی: ${e.origin??"ارزښت"} باید ${n}${e.maximum.toString()} وي`}case"too_small":{const n=e.inclusive?">=":">",i=t(e.origin);return i?`ډیر کوچنی: ${e.origin} باید ${n}${e.minimum.toString()} ${i.unit} ولري`:`ډیر کوچنی: ${e.origin} باید ${n}${e.minimum.toString()} وي`}case"invalid_format":{const t=e;return"starts_with"===t.format?`ناسم متن: باید د "${t.prefix}" سره پیل شي`:"ends_with"===t.format?`ناسم متن: باید د "${t.suffix}" سره پای ته ورسيږي`:"includes"===t.format?`ناسم متن: باید "${t.includes}" ولري`:"regex"===t.format?`ناسم متن: باید د ${t.pattern} سره مطابقت ولري`:`${n[t.format]??e.format} ناسم دی`}case"not_multiple_of":return`ناسم عدد: باید د ${e.divisor} مضرب وي`;case"unrecognized_keys":return`ناسم ${e.keys.length>1?"کلیډونه":"کلیډ"}: ${lh(e.keys,", ")}`;case"invalid_key":return`ناسم کلیډ په ${e.origin} کې`;case"invalid_union":default:return"ناسمه ورودي";case"invalid_element":return`ناسم عنصر په ${e.origin} کې`}}};function fy(){return{localeError:hy()}}const my=()=>{const e={string:{unit:"znaków",verb:"mieć"},file:{unit:"bajtów",verb:"mieć"},array:{unit:"elementów",verb:"mieć"},set:{unit:"elementów",verb:"mieć"}};function t(t){return e[t]??null}const n={regex:"wyrażenie",email:"adres email",url:"URL",emoji:"emoji",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"data i godzina w formacie ISO",date:"data w formacie ISO",time:"godzina w formacie ISO",duration:"czas trwania ISO",ipv4:"adres IPv4",ipv6:"adres IPv6",cidrv4:"zakres IPv4",cidrv6:"zakres IPv6",base64:"ciąg znaków zakodowany w formacie base64",base64url:"ciąg znaków zakodowany w formacie base64url",json_string:"ciąg znaków w formacie JSON",e164:"liczba E.164",jwt:"JWT",template_literal:"wejście"};return e=>{switch(e.code){case"invalid_type":return`Nieprawidłowe dane wejściowe: oczekiwano ${e.expected}, otrzymano ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"liczba";case"object":if(Array.isArray(e))return"tablica";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`Nieprawidłowe dane wejściowe: oczekiwano ${Uh(e.values[0])}`:`Nieprawidłowa opcja: oczekiwano jednej z wartości ${lh(e.values,"|")}`;case"too_big":{const n=e.inclusive?"<=":"<",i=t(e.origin);return i?`Za duża wartość: oczekiwano, że ${e.origin??"wartość"} będzie mieć ${n}${e.maximum.toString()} ${i.unit??"elementów"}`:`Zbyt duż(y/a/e): oczekiwano, że ${e.origin??"wartość"} będzie wynosić ${n}${e.maximum.toString()}`}case"too_small":{const n=e.inclusive?">=":">",i=t(e.origin);return i?`Za mała wartość: oczekiwano, że ${e.origin??"wartość"} będzie mieć ${n}${e.minimum.toString()} ${i.unit??"elementów"}`:`Zbyt mał(y/a/e): oczekiwano, że ${e.origin??"wartość"} będzie wynosić ${n}${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`Nieprawidłowy ciąg znaków: musi zaczynać się od "${t.prefix}"`:"ends_with"===t.format?`Nieprawidłowy ciąg znaków: musi kończyć się na "${t.suffix}"`:"includes"===t.format?`Nieprawidłowy ciąg znaków: musi zawierać "${t.includes}"`:"regex"===t.format?`Nieprawidłowy ciąg znaków: musi odpowiadać wzorcowi ${t.pattern}`:`Nieprawidłow(y/a/e) ${n[t.format]??e.format}`}case"not_multiple_of":return`Nieprawidłowa liczba: musi być wielokrotnością ${e.divisor}`;case"unrecognized_keys":return`Nierozpoznane klucze${e.keys.length>1?"s":""}: ${lh(e.keys,", ")}`;case"invalid_key":return`Nieprawidłowy klucz w ${e.origin}`;case"invalid_union":default:return"Nieprawidłowe dane wejściowe";case"invalid_element":return`Nieprawidłowa wartość w ${e.origin}`}}};function gy(){return{localeError:my()}}const vy=()=>{const e={string:{unit:"caracteres",verb:"ter"},file:{unit:"bytes",verb:"ter"},array:{unit:"itens",verb:"ter"},set:{unit:"itens",verb:"ter"}};function t(t){return e[t]??null}const n={regex:"padrão",email:"endereço de e-mail",url:"URL",emoji:"emoji",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"data e hora ISO",date:"data ISO",time:"hora ISO",duration:"duração ISO",ipv4:"endereço IPv4",ipv6:"endereço IPv6",cidrv4:"faixa de IPv4",cidrv6:"faixa de IPv6",base64:"texto codificado em base64",base64url:"URL codificada em base64",json_string:"texto JSON",e164:"número E.164",jwt:"JWT",template_literal:"entrada"};return e=>{switch(e.code){case"invalid_type":return`Tipo inválido: esperado ${e.expected}, recebido ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"número";case"object":if(Array.isArray(e))return"array";if(null===e)return"nulo";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`Entrada inválida: esperado ${Uh(e.values[0])}`:`Opção inválida: esperada uma das ${lh(e.values,"|")}`;case"too_big":{const n=e.inclusive?"<=":"<",i=t(e.origin);return i?`Muito grande: esperado que ${e.origin??"valor"} tivesse ${n}${e.maximum.toString()} ${i.unit??"elementos"}`:`Muito grande: esperado que ${e.origin??"valor"} fosse ${n}${e.maximum.toString()}`}case"too_small":{const n=e.inclusive?">=":">",i=t(e.origin);return i?`Muito pequeno: esperado que ${e.origin} tivesse ${n}${e.minimum.toString()} ${i.unit}`:`Muito pequeno: esperado que ${e.origin} fosse ${n}${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`Texto inválido: deve começar com "${t.prefix}"`:"ends_with"===t.format?`Texto inválido: deve terminar com "${t.suffix}"`:"includes"===t.format?`Texto inválido: deve incluir "${t.includes}"`:"regex"===t.format?`Texto inválido: deve corresponder ao padrão ${t.pattern}`:`${n[t.format]??e.format} inválido`}case"not_multiple_of":return`Número inválido: deve ser múltiplo de ${e.divisor}`;case"unrecognized_keys":return`Chave${e.keys.length>1?"s":""} desconhecida${e.keys.length>1?"s":""}: ${lh(e.keys,", ")}`;case"invalid_key":return`Chave inválida em ${e.origin}`;case"invalid_union":return"Entrada inválida";case"invalid_element":return`Valor inválido em ${e.origin}`;default:return"Campo inválido"}}};function yy(){return{localeError:vy()}}function _y(e,t,n,i){const r=Math.abs(e),s=r%10,a=r%100;return a>=11&&a<=19?i:1===s?t:s>=2&&s<=4?n:i}const by=()=>{const e={string:{unit:{one:"символ",few:"символа",many:"символов"},verb:"иметь"},file:{unit:{one:"байт",few:"байта",many:"байт"},verb:"иметь"},array:{unit:{one:"элемент",few:"элемента",many:"элементов"},verb:"иметь"},set:{unit:{one:"элемент",few:"элемента",many:"элементов"},verb:"иметь"}};function t(t){return e[t]??null}const n={regex:"ввод",email:"email адрес",url:"URL",emoji:"эмодзи",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"ISO дата и время",date:"ISO дата",time:"ISO время",duration:"ISO длительность",ipv4:"IPv4 адрес",ipv6:"IPv6 адрес",cidrv4:"IPv4 диапазон",cidrv6:"IPv6 диапазон",base64:"строка в формате base64",base64url:"строка в формате base64url",json_string:"JSON строка",e164:"номер E.164",jwt:"JWT",template_literal:"ввод"};return e=>{switch(e.code){case"invalid_type":return`Неверный ввод: ожидалось ${e.expected}, получено ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"число";case"object":if(Array.isArray(e))return"массив";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`Неверный ввод: ожидалось ${Uh(e.values[0])}`:`Неверный вариант: ожидалось одно из ${lh(e.values,"|")}`;case"too_big":{const n=e.inclusive?"<=":"<",i=t(e.origin);if(i){const t=_y(Number(e.maximum),i.unit.one,i.unit.few,i.unit.many);return`Слишком большое значение: ожидалось, что ${e.origin??"значение"} будет иметь ${n}${e.maximum.toString()} ${t}`}return`Слишком большое значение: ожидалось, что ${e.origin??"значение"} будет ${n}${e.maximum.toString()}`}case"too_small":{const n=e.inclusive?">=":">",i=t(e.origin);if(i){const t=_y(Number(e.minimum),i.unit.one,i.unit.few,i.unit.many);return`Слишком маленькое значение: ожидалось, что ${e.origin} будет иметь ${n}${e.minimum.toString()} ${t}`}return`Слишком маленькое значение: ожидалось, что ${e.origin} будет ${n}${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`Неверная строка: должна начинаться с "${t.prefix}"`:"ends_with"===t.format?`Неверная строка: должна заканчиваться на "${t.suffix}"`:"includes"===t.format?`Неверная строка: должна содержать "${t.includes}"`:"regex"===t.format?`Неверная строка: должна соответствовать шаблону ${t.pattern}`:`Неверный ${n[t.format]??e.format}`}case"not_multiple_of":return`Неверное число: должно быть кратным ${e.divisor}`;case"unrecognized_keys":return`Нераспознанн${e.keys.length>1?"ые":"ый"} ключ${e.keys.length>1?"и":""}: ${lh(e.keys,", ")}`;case"invalid_key":return`Неверный ключ в ${e.origin}`;case"invalid_union":default:return"Неверные входные данные";case"invalid_element":return`Неверное значение в ${e.origin}`}}};function wy(){return{localeError:by()}}const $y=()=>{const e={string:{unit:"znakov",verb:"imeti"},file:{unit:"bajtov",verb:"imeti"},array:{unit:"elementov",verb:"imeti"},set:{unit:"elementov",verb:"imeti"}};function t(t){return e[t]??null}const n={regex:"vnos",email:"e-poštni naslov",url:"URL",emoji:"emoji",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"ISO datum in čas",date:"ISO datum",time:"ISO čas",duration:"ISO trajanje",ipv4:"IPv4 naslov",ipv6:"IPv6 naslov",cidrv4:"obseg IPv4",cidrv6:"obseg IPv6",base64:"base64 kodiran niz",base64url:"base64url kodiran niz",json_string:"JSON niz",e164:"E.164 številka",jwt:"JWT",template_literal:"vnos"};return e=>{switch(e.code){case"invalid_type":return`Neveljaven vnos: pričakovano ${e.expected}, prejeto ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"število";case"object":if(Array.isArray(e))return"tabela";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`Neveljaven vnos: pričakovano ${Uh(e.values[0])}`:`Neveljavna možnost: pričakovano eno izmed ${lh(e.values,"|")}`;case"too_big":{const n=e.inclusive?"<=":"<",i=t(e.origin);return i?`Preveliko: pričakovano, da bo ${e.origin??"vrednost"} imelo ${n}${e.maximum.toString()} ${i.unit??"elementov"}`:`Preveliko: pričakovano, da bo ${e.origin??"vrednost"} ${n}${e.maximum.toString()}`}case"too_small":{const n=e.inclusive?">=":">",i=t(e.origin);return i?`Premajhno: pričakovano, da bo ${e.origin} imelo ${n}${e.minimum.toString()} ${i.unit}`:`Premajhno: pričakovano, da bo ${e.origin} ${n}${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`Neveljaven niz: mora se začeti z "${t.prefix}"`:"ends_with"===t.format?`Neveljaven niz: mora se končati z "${t.suffix}"`:"includes"===t.format?`Neveljaven niz: mora vsebovati "${t.includes}"`:"regex"===t.format?`Neveljaven niz: mora ustrezati vzorcu ${t.pattern}`:`Neveljaven ${n[t.format]??e.format}`}case"not_multiple_of":return`Neveljavno število: mora biti večkratnik ${e.divisor}`;case"unrecognized_keys":return`Neprepoznan${e.keys.length>1?"i ključi":" ključ"}: ${lh(e.keys,", ")}`;case"invalid_key":return`Neveljaven ključ v ${e.origin}`;case"invalid_union":default:return"Neveljaven vnos";case"invalid_element":return`Neveljavna vrednost v ${e.origin}`}}};function ky(){return{localeError:$y()}}const Sy=()=>{const e={string:{unit:"tecken",verb:"att ha"},file:{unit:"bytes",verb:"att ha"},array:{unit:"objekt",verb:"att innehålla"},set:{unit:"objekt",verb:"att innehålla"}};function t(t){return e[t]??null}const n={regex:"reguljärt uttryck",email:"e-postadress",url:"URL",emoji:"emoji",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"ISO-datum och tid",date:"ISO-datum",time:"ISO-tid",duration:"ISO-varaktighet",ipv4:"IPv4-intervall",ipv6:"IPv6-intervall",cidrv4:"IPv4-spektrum",cidrv6:"IPv6-spektrum",base64:"base64-kodad sträng",base64url:"base64url-kodad sträng",json_string:"JSON-sträng",e164:"E.164-nummer",jwt:"JWT",template_literal:"mall-literal"};return e=>{switch(e.code){case"invalid_type":return`Ogiltig inmatning: förväntat ${e.expected}, fick ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"antal";case"object":if(Array.isArray(e))return"lista";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`Ogiltig inmatning: förväntat ${Uh(e.values[0])}`:`Ogiltigt val: förväntade en av ${lh(e.values,"|")}`;case"too_big":{const n=e.inclusive?"<=":"<",i=t(e.origin);return i?`För stor(t): förväntade ${e.origin??"värdet"} att ha ${n}${e.maximum.toString()} ${i.unit??"element"}`:`För stor(t): förväntat ${e.origin??"värdet"} att ha ${n}${e.maximum.toString()}`}case"too_small":{const n=e.inclusive?">=":">",i=t(e.origin);return i?`För lite(t): förväntade ${e.origin??"värdet"} att ha ${n}${e.minimum.toString()} ${i.unit}`:`För lite(t): förväntade ${e.origin??"värdet"} att ha ${n}${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`Ogiltig sträng: måste börja med "${t.prefix}"`:"ends_with"===t.format?`Ogiltig sträng: måste sluta med "${t.suffix}"`:"includes"===t.format?`Ogiltig sträng: måste innehålla "${t.includes}"`:"regex"===t.format?`Ogiltig sträng: måste matcha mönstret "${t.pattern}"`:`Ogiltig(t) ${n[t.format]??e.format}`}case"not_multiple_of":return`Ogiltigt tal: måste vara en multipel av ${e.divisor}`;case"unrecognized_keys":return`${e.keys.length>1?"Okända nycklar":"Okänd nyckel"}: ${lh(e.keys,", ")}`;case"invalid_key":return`Ogiltig nyckel i ${e.origin??"värdet"}`;case"invalid_union":default:return"Ogiltig input";case"invalid_element":return`Ogiltigt värde i ${e.origin??"värdet"}`}}};function Ey(){return{localeError:Sy()}}const Iy=()=>{const e={string:{unit:"எழுத்துக்கள்",verb:"கொண்டிருக்க வேண்டும்"},file:{unit:"பைட்டுகள்",verb:"கொண்டிருக்க வேண்டும்"},array:{unit:"உறுப்புகள்",verb:"கொண்டிருக்க வேண்டும்"},set:{unit:"உறுப்புகள்",verb:"கொண்டிருக்க வேண்டும்"}};function t(t){return e[t]??null}const n={regex:"உள்ளீடு",email:"மின்னஞ்சல் முகவரி",url:"URL",emoji:"emoji",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"ISO தேதி நேரம்",date:"ISO தேதி",time:"ISO நேரம்",duration:"ISO கால அளவு",ipv4:"IPv4 முகவரி",ipv6:"IPv6 முகவரி",cidrv4:"IPv4 வரம்பு",cidrv6:"IPv6 வரம்பு",base64:"base64-encoded சரம்",base64url:"base64url-encoded சரம்",json_string:"JSON சரம்",e164:"E.164 எண்",jwt:"JWT",template_literal:"input"};return e=>{switch(e.code){case"invalid_type":return`தவறான உள்ளீடு: எதிர்பார்க்கப்பட்டது ${e.expected}, பெறப்பட்டது ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"எண் அல்லாதது":"எண்";case"object":if(Array.isArray(e))return"அணி";if(null===e)return"வெறுமை";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`தவறான உள்ளீடு: எதிர்பார்க்கப்பட்டது ${Uh(e.values[0])}`:`தவறான விருப்பம்: எதிர்பார்க்கப்பட்டது ${lh(e.values,"|")} இல் ஒன்று`;case"too_big":{const n=e.inclusive?"<=":"<",i=t(e.origin);return i?`மிக பெரியது: எதிர்பார்க்கப்பட்டது ${e.origin??"மதிப்பு"} ${n}${e.maximum.toString()} ${i.unit??"உறுப்புகள்"} ஆக இருக்க வேண்டும்`:`மிக பெரியது: எதிர்பார்க்கப்பட்டது ${e.origin??"மதிப்பு"} ${n}${e.maximum.toString()} ஆக இருக்க வேண்டும்`}case"too_small":{const n=e.inclusive?">=":">",i=t(e.origin);return i?`மிகச் சிறியது: எதிர்பார்க்கப்பட்டது ${e.origin} ${n}${e.minimum.toString()} ${i.unit} ஆக இருக்க வேண்டும்`:`மிகச் சிறியது: எதிர்பார்க்கப்பட்டது ${e.origin} ${n}${e.minimum.toString()} ஆக இருக்க வேண்டும்`}case"invalid_format":{const t=e;return"starts_with"===t.format?`தவறான சரம்: "${t.prefix}" இல் தொடங்க வேண்டும்`:"ends_with"===t.format?`தவறான சரம்: "${t.suffix}" இல் முடிவடைய வேண்டும்`:"includes"===t.format?`தவறான சரம்: "${t.includes}" ஐ உள்ளடக்க வேண்டும்`:"regex"===t.format?`தவறான சரம்: ${t.pattern} முறைபாட்டுடன் பொருந்த வேண்டும்`:`தவறான ${n[t.format]??e.format}`}case"not_multiple_of":return`தவறான எண்: ${e.divisor} இன் பலமாக இருக்க வேண்டும்`;case"unrecognized_keys":return`அடையாளம் தெரியாத விசை${e.keys.length>1?"கள்":""}: ${lh(e.keys,", ")}`;case"invalid_key":return`${e.origin} இல் தவறான விசை`;case"invalid_union":default:return"தவறான உள்ளீடு";case"invalid_element":return`${e.origin} இல் தவறான மதிப்பு`}}};function xy(){return{localeError:Iy()}}const Ty=()=>{const e={string:{unit:"ตัวอักษร",verb:"ควรมี"},file:{unit:"ไบต์",verb:"ควรมี"},array:{unit:"รายการ",verb:"ควรมี"},set:{unit:"รายการ",verb:"ควรมี"}};function t(t){return e[t]??null}const n={regex:"ข้อมูลที่ป้อน",email:"ที่อยู่อีเมล",url:"URL",emoji:"อิโมจิ",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"วันที่เวลาแบบ ISO",date:"วันที่แบบ ISO",time:"เวลาแบบ ISO",duration:"ช่วงเวลาแบบ ISO",ipv4:"ที่อยู่ IPv4",ipv6:"ที่อยู่ IPv6",cidrv4:"ช่วง IP แบบ IPv4",cidrv6:"ช่วง IP แบบ IPv6",base64:"ข้อความแบบ Base64",base64url:"ข้อความแบบ Base64 สำหรับ URL",json_string:"ข้อความแบบ JSON",e164:"เบอร์โทรศัพท์ระหว่างประเทศ (E.164)",jwt:"โทเคน JWT",template_literal:"ข้อมูลที่ป้อน"};return e=>{switch(e.code){case"invalid_type":return`ประเภทข้อมูลไม่ถูกต้อง: ควรเป็น ${e.expected} แต่ได้รับ ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"ไม่ใช่ตัวเลข (NaN)":"ตัวเลข";case"object":if(Array.isArray(e))return"อาร์เรย์ (Array)";if(null===e)return"ไม่มีค่า (null)";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`ค่าไม่ถูกต้อง: ควรเป็น ${Uh(e.values[0])}`:`ตัวเลือกไม่ถูกต้อง: ควรเป็นหนึ่งใน ${lh(e.values,"|")}`;case"too_big":{const n=e.inclusive?"ไม่เกิน":"น้อยกว่า",i=t(e.origin);return i?`เกินกำหนด: ${e.origin??"ค่า"} ควรมี${n} ${e.maximum.toString()} ${i.unit??"รายการ"}`:`เกินกำหนด: ${e.origin??"ค่า"} ควรมี${n} ${e.maximum.toString()}`}case"too_small":{const n=e.inclusive?"อย่างน้อย":"มากกว่า",i=t(e.origin);return i?`น้อยกว่ากำหนด: ${e.origin} ควรมี${n} ${e.minimum.toString()} ${i.unit}`:`น้อยกว่ากำหนด: ${e.origin} ควรมี${n} ${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`รูปแบบไม่ถูกต้อง: ข้อความต้องขึ้นต้นด้วย "${t.prefix}"`:"ends_with"===t.format?`รูปแบบไม่ถูกต้อง: ข้อความต้องลงท้ายด้วย "${t.suffix}"`:"includes"===t.format?`รูปแบบไม่ถูกต้อง: ข้อความต้องมี "${t.includes}" อยู่ในข้อความ`:"regex"===t.format?`รูปแบบไม่ถูกต้อง: ต้องตรงกับรูปแบบที่กำหนด ${t.pattern}`:`รูปแบบไม่ถูกต้อง: ${n[t.format]??e.format}`}case"not_multiple_of":return`ตัวเลขไม่ถูกต้อง: ต้องเป็นจำนวนที่หารด้วย ${e.divisor} ได้ลงตัว`;case"unrecognized_keys":return`พบคีย์ที่ไม่รู้จัก: ${lh(e.keys,", ")}`;case"invalid_key":return`คีย์ไม่ถูกต้องใน ${e.origin}`;case"invalid_union":return"ข้อมูลไม่ถูกต้อง: ไม่ตรงกับรูปแบบยูเนียนที่กำหนดไว้";case"invalid_element":return`ข้อมูลไม่ถูกต้องใน ${e.origin}`;default:return"ข้อมูลไม่ถูกต้อง"}}};function Oy(){return{localeError:Ty()}}const Ay=()=>{const e={string:{unit:"karakter",verb:"olmalı"},file:{unit:"bayt",verb:"olmalı"},array:{unit:"öğe",verb:"olmalı"},set:{unit:"öğe",verb:"olmalı"}};function t(t){return e[t]??null}const n={regex:"girdi",email:"e-posta adresi",url:"URL",emoji:"emoji",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"ISO tarih ve saat",date:"ISO tarih",time:"ISO saat",duration:"ISO süre",ipv4:"IPv4 adresi",ipv6:"IPv6 adresi",cidrv4:"IPv4 aralığı",cidrv6:"IPv6 aralığı",base64:"base64 ile şifrelenmiş metin",base64url:"base64url ile şifrelenmiş metin",json_string:"JSON dizesi",e164:"E.164 sayısı",jwt:"JWT",template_literal:"Şablon dizesi"};return e=>{switch(e.code){case"invalid_type":return`Geçersiz değer: beklenen ${e.expected}, alınan ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"number";case"object":if(Array.isArray(e))return"array";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`Geçersiz değer: beklenen ${Uh(e.values[0])}`:`Geçersiz seçenek: aşağıdakilerden biri olmalı: ${lh(e.values,"|")}`;case"too_big":{const n=e.inclusive?"<=":"<",i=t(e.origin);return i?`Çok büyük: beklenen ${e.origin??"değer"} ${n}${e.maximum.toString()} ${i.unit??"öğe"}`:`Çok büyük: beklenen ${e.origin??"değer"} ${n}${e.maximum.toString()}`}case"too_small":{const n=e.inclusive?">=":">",i=t(e.origin);return i?`Çok küçük: beklenen ${e.origin} ${n}${e.minimum.toString()} ${i.unit}`:`Çok küçük: beklenen ${e.origin} ${n}${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`Geçersiz metin: "${t.prefix}" ile başlamalı`:"ends_with"===t.format?`Geçersiz metin: "${t.suffix}" ile bitmeli`:"includes"===t.format?`Geçersiz metin: "${t.includes}" içermeli`:"regex"===t.format?`Geçersiz metin: ${t.pattern} desenine uymalı`:`Geçersiz ${n[t.format]??e.format}`}case"not_multiple_of":return`Geçersiz sayı: ${e.divisor} ile tam bölünebilmeli`;case"unrecognized_keys":return`Tanınmayan anahtar${e.keys.length>1?"lar":""}: ${lh(e.keys,", ")}`;case"invalid_key":return`${e.origin} içinde geçersiz anahtar`;case"invalid_union":default:return"Geçersiz değer";case"invalid_element":return`${e.origin} içinde geçersiz değer`}}};function Ny(){return{localeError:Ay()}}const Cy=()=>{const e={string:{unit:"символів",verb:"матиме"},file:{unit:"байтів",verb:"матиме"},array:{unit:"елементів",verb:"матиме"},set:{unit:"елементів",verb:"матиме"}};function t(t){return e[t]??null}const n={regex:"вхідні дані",email:"адреса електронної пошти",url:"URL",emoji:"емодзі",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"дата та час ISO",date:"дата ISO",time:"час ISO",duration:"тривалість ISO",ipv4:"адреса IPv4",ipv6:"адреса IPv6",cidrv4:"діапазон IPv4",cidrv6:"діапазон IPv6",base64:"рядок у кодуванні base64",base64url:"рядок у кодуванні base64url",json_string:"рядок JSON",e164:"номер E.164",jwt:"JWT",template_literal:"вхідні дані"};return e=>{switch(e.code){case"invalid_type":return`Неправильні вхідні дані: очікується ${e.expected}, отримано ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"число";case"object":if(Array.isArray(e))return"масив";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`Неправильні вхідні дані: очікується ${Uh(e.values[0])}`:`Неправильна опція: очікується одне з ${lh(e.values,"|")}`;case"too_big":{const n=e.inclusive?"<=":"<",i=t(e.origin);return i?`Занадто велике: очікується, що ${e.origin??"значення"} ${i.verb} ${n}${e.maximum.toString()} ${i.unit??"елементів"}`:`Занадто велике: очікується, що ${e.origin??"значення"} буде ${n}${e.maximum.toString()}`}case"too_small":{const n=e.inclusive?">=":">",i=t(e.origin);return i?`Занадто мале: очікується, що ${e.origin} ${i.verb} ${n}${e.minimum.toString()} ${i.unit}`:`Занадто мале: очікується, що ${e.origin} буде ${n}${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`Неправильний рядок: повинен починатися з "${t.prefix}"`:"ends_with"===t.format?`Неправильний рядок: повинен закінчуватися на "${t.suffix}"`:"includes"===t.format?`Неправильний рядок: повинен містити "${t.includes}"`:"regex"===t.format?`Неправильний рядок: повинен відповідати шаблону ${t.pattern}`:`Неправильний ${n[t.format]??e.format}`}case"not_multiple_of":return`Неправильне число: повинно бути кратним ${e.divisor}`;case"unrecognized_keys":return`Нерозпізнаний ключ${e.keys.length>1?"і":""}: ${lh(e.keys,", ")}`;case"invalid_key":return`Неправильний ключ у ${e.origin}`;case"invalid_union":default:return"Неправильні вхідні дані";case"invalid_element":return`Неправильне значення у ${e.origin}`}}};function Dy(){return{localeError:Cy()}}const Ly=()=>{const e={string:{unit:"حروف",verb:"ہونا"},file:{unit:"بائٹس",verb:"ہونا"},array:{unit:"آئٹمز",verb:"ہونا"},set:{unit:"آئٹمز",verb:"ہونا"}};function t(t){return e[t]??null}const n={regex:"ان پٹ",email:"ای میل ایڈریس",url:"یو آر ایل",emoji:"ایموجی",uuid:"یو یو آئی ڈی",uuidv4:"یو یو آئی ڈی وی 4",uuidv6:"یو یو آئی ڈی وی 6",nanoid:"نینو آئی ڈی",guid:"جی یو آئی ڈی",cuid:"سی یو آئی ڈی",cuid2:"سی یو آئی ڈی 2",ulid:"یو ایل آئی ڈی",xid:"ایکس آئی ڈی",ksuid:"کے ایس یو آئی ڈی",datetime:"آئی ایس او ڈیٹ ٹائم",date:"آئی ایس او تاریخ",time:"آئی ایس او وقت",duration:"آئی ایس او مدت",ipv4:"آئی پی وی 4 ایڈریس",ipv6:"آئی پی وی 6 ایڈریس",cidrv4:"آئی پی وی 4 رینج",cidrv6:"آئی پی وی 6 رینج",base64:"بیس 64 ان کوڈڈ سٹرنگ",base64url:"بیس 64 یو آر ایل ان کوڈڈ سٹرنگ",json_string:"جے ایس او این سٹرنگ",e164:"ای 164 نمبر",jwt:"جے ڈبلیو ٹی",template_literal:"ان پٹ"};return e=>{switch(e.code){case"invalid_type":return`غلط ان پٹ: ${e.expected} متوقع تھا، ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"نمبر";case"object":if(Array.isArray(e))return"آرے";if(null===e)return"نل";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)} موصول ہوا`;case"invalid_value":return 1===e.values.length?`غلط ان پٹ: ${Uh(e.values[0])} متوقع تھا`:`غلط آپشن: ${lh(e.values,"|")} میں سے ایک متوقع تھا`;case"too_big":{const n=e.inclusive?"<=":"<",i=t(e.origin);return i?`بہت بڑا: ${e.origin??"ویلیو"} کے ${n}${e.maximum.toString()} ${i.unit??"عناصر"} ہونے متوقع تھے`:`بہت بڑا: ${e.origin??"ویلیو"} کا ${n}${e.maximum.toString()} ہونا متوقع تھا`}case"too_small":{const n=e.inclusive?">=":">",i=t(e.origin);return i?`بہت چھوٹا: ${e.origin} کے ${n}${e.minimum.toString()} ${i.unit} ہونے متوقع تھے`:`بہت چھوٹا: ${e.origin} کا ${n}${e.minimum.toString()} ہونا متوقع تھا`}case"invalid_format":{const t=e;return"starts_with"===t.format?`غلط سٹرنگ: "${t.prefix}" سے شروع ہونا چاہیے`:"ends_with"===t.format?`غلط سٹرنگ: "${t.suffix}" پر ختم ہونا چاہیے`:"includes"===t.format?`غلط سٹرنگ: "${t.includes}" شامل ہونا چاہیے`:"regex"===t.format?`غلط سٹرنگ: پیٹرن ${t.pattern} سے میچ ہونا چاہیے`:`غلط ${n[t.format]??e.format}`}case"not_multiple_of":return`غلط نمبر: ${e.divisor} کا مضاعف ہونا چاہیے`;case"unrecognized_keys":return`غیر تسلیم شدہ کی${e.keys.length>1?"ز":""}: ${lh(e.keys,"، ")}`;case"invalid_key":return`${e.origin} میں غلط کی`;case"invalid_union":default:return"غلط ان پٹ";case"invalid_element":return`${e.origin} میں غلط ویلیو`}}};function Ry(){return{localeError:Ly()}}const jy=()=>{const e={string:{unit:"ký tự",verb:"có"},file:{unit:"byte",verb:"có"},array:{unit:"phần tử",verb:"có"},set:{unit:"phần tử",verb:"có"}};function t(t){return e[t]??null}const n={regex:"đầu vào",email:"địa chỉ email",url:"URL",emoji:"emoji",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"ngày giờ ISO",date:"ngày ISO",time:"giờ ISO",duration:"khoảng thời gian ISO",ipv4:"địa chỉ IPv4",ipv6:"địa chỉ IPv6",cidrv4:"dải IPv4",cidrv6:"dải IPv6",base64:"chuỗi mã hóa base64",base64url:"chuỗi mã hóa base64url",json_string:"chuỗi JSON",e164:"số E.164",jwt:"JWT",template_literal:"đầu vào"};return e=>{switch(e.code){case"invalid_type":return`Đầu vào không hợp lệ: mong đợi ${e.expected}, nhận được ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"số";case"object":if(Array.isArray(e))return"mảng";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`Đầu vào không hợp lệ: mong đợi ${Uh(e.values[0])}`:`Tùy chọn không hợp lệ: mong đợi một trong các giá trị ${lh(e.values,"|")}`;case"too_big":{const n=e.inclusive?"<=":"<",i=t(e.origin);return i?`Quá lớn: mong đợi ${e.origin??"giá trị"} ${i.verb} ${n}${e.maximum.toString()} ${i.unit??"phần tử"}`:`Quá lớn: mong đợi ${e.origin??"giá trị"} ${n}${e.maximum.toString()}`}case"too_small":{const n=e.inclusive?">=":">",i=t(e.origin);return i?`Quá nhỏ: mong đợi ${e.origin} ${i.verb} ${n}${e.minimum.toString()} ${i.unit}`:`Quá nhỏ: mong đợi ${e.origin} ${n}${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`Chuỗi không hợp lệ: phải bắt đầu bằng "${t.prefix}"`:"ends_with"===t.format?`Chuỗi không hợp lệ: phải kết thúc bằng "${t.suffix}"`:"includes"===t.format?`Chuỗi không hợp lệ: phải bao gồm "${t.includes}"`:"regex"===t.format?`Chuỗi không hợp lệ: phải khớp với mẫu ${t.pattern}`:`${n[t.format]??e.format} không hợp lệ`}case"not_multiple_of":return`Số không hợp lệ: phải là bội số của ${e.divisor}`;case"unrecognized_keys":return`Khóa không được nhận dạng: ${lh(e.keys,", ")}`;case"invalid_key":return`Khóa không hợp lệ trong ${e.origin}`;case"invalid_union":default:return"Đầu vào không hợp lệ";case"invalid_element":return`Giá trị không hợp lệ trong ${e.origin}`}}};function Py(){return{localeError:jy()}}const Uy=()=>{const e={string:{unit:"字符",verb:"包含"},file:{unit:"字节",verb:"包含"},array:{unit:"项",verb:"包含"},set:{unit:"项",verb:"包含"}};function t(t){return e[t]??null}const n={regex:"输入",email:"电子邮件",url:"URL",emoji:"表情符号",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"ISO日期时间",date:"ISO日期",time:"ISO时间",duration:"ISO时长",ipv4:"IPv4地址",ipv6:"IPv6地址",cidrv4:"IPv4网段",cidrv6:"IPv6网段",base64:"base64编码字符串",base64url:"base64url编码字符串",json_string:"JSON字符串",e164:"E.164号码",jwt:"JWT",template_literal:"输入"};return e=>{switch(e.code){case"invalid_type":return`无效输入：期望 ${e.expected}，实际接收 ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"非数字(NaN)":"数字";case"object":if(Array.isArray(e))return"数组";if(null===e)return"空值(null)";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`无效输入：期望 ${Uh(e.values[0])}`:`无效选项：期望以下之一 ${lh(e.values,"|")}`;case"too_big":{const n=e.inclusive?"<=":"<",i=t(e.origin);return i?`数值过大：期望 ${e.origin??"值"} ${n}${e.maximum.toString()} ${i.unit??"个元素"}`:`数值过大：期望 ${e.origin??"值"} ${n}${e.maximum.toString()}`}case"too_small":{const n=e.inclusive?">=":">",i=t(e.origin);return i?`数值过小：期望 ${e.origin} ${n}${e.minimum.toString()} ${i.unit}`:`数值过小：期望 ${e.origin} ${n}${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`无效字符串：必须以 "${t.prefix}" 开头`:"ends_with"===t.format?`无效字符串：必须以 "${t.suffix}" 结尾`:"includes"===t.format?`无效字符串：必须包含 "${t.includes}"`:"regex"===t.format?`无效字符串：必须满足正则表达式 ${t.pattern}`:`无效${n[t.format]??e.format}`}case"not_multiple_of":return`无效数字：必须是 ${e.divisor} 的倍数`;case"unrecognized_keys":return`出现未知的键(key): ${lh(e.keys,", ")}`;case"invalid_key":return`${e.origin} 中的键(key)无效`;case"invalid_union":default:return"无效输入";case"invalid_element":return`${e.origin} 中包含无效值(value)`}}};function My(){return{localeError:Uy()}}const zy=()=>{const e={string:{unit:"字元",verb:"擁有"},file:{unit:"位元組",verb:"擁有"},array:{unit:"項目",verb:"擁有"},set:{unit:"項目",verb:"擁有"}};function t(t){return e[t]??null}const n={regex:"輸入",email:"郵件地址",url:"URL",emoji:"emoji",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"ISO 日期時間",date:"ISO 日期",time:"ISO 時間",duration:"ISO 期間",ipv4:"IPv4 位址",ipv6:"IPv6 位址",cidrv4:"IPv4 範圍",cidrv6:"IPv6 範圍",base64:"base64 編碼字串",base64url:"base64url 編碼字串",json_string:"JSON 字串",e164:"E.164 數值",jwt:"JWT",template_literal:"輸入"};return e=>{switch(e.code){case"invalid_type":return`無效的輸入值：預期為 ${e.expected}，但收到 ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"number";case"object":if(Array.isArray(e))return"array";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`無效的輸入值：預期為 ${Uh(e.values[0])}`:`無效的選項：預期為以下其中之一 ${lh(e.values,"|")}`;case"too_big":{const n=e.inclusive?"<=":"<",i=t(e.origin);return i?`數值過大：預期 ${e.origin??"值"} 應為 ${n}${e.maximum.toString()} ${i.unit??"個元素"}`:`數值過大：預期 ${e.origin??"值"} 應為 ${n}${e.maximum.toString()}`}case"too_small":{const n=e.inclusive?">=":">",i=t(e.origin);return i?`數值過小：預期 ${e.origin} 應為 ${n}${e.minimum.toString()} ${i.unit}`:`數值過小：預期 ${e.origin} 應為 ${n}${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`無效的字串：必須以 "${t.prefix}" 開頭`:"ends_with"===t.format?`無效的字串：必須以 "${t.suffix}" 結尾`:"includes"===t.format?`無效的字串：必須包含 "${t.includes}"`:"regex"===t.format?`無效的字串：必須符合格式 ${t.pattern}`:`無效的 ${n[t.format]??e.format}`}case"not_multiple_of":return`無效的數字：必須為 ${e.divisor} 的倍數`;case"unrecognized_keys":return`無法識別的鍵值${e.keys.length>1?"們":""}：${lh(e.keys,"、")}`;case"invalid_key":return`${e.origin} 中有無效的鍵值`;case"invalid_union":default:return"無效的輸入值";case"invalid_element":return`${e.origin} 中有無效的值`}}};function Fy(){return{localeError:zy()}}const By=()=>{const e={string:{unit:"àmi",verb:"ní"},file:{unit:"bytes",verb:"ní"},array:{unit:"nkan",verb:"ní"},set:{unit:"nkan",verb:"ní"}};function t(t){return e[t]??null}const n={regex:"ẹ̀rọ ìbáwọlé",email:"àdírẹ́sì ìmẹ́lì",url:"URL",emoji:"emoji",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"àkókò ISO",date:"ọjọ́ ISO",time:"àkókò ISO",duration:"àkókò tó pé ISO",ipv4:"àdírẹ́sì IPv4",ipv6:"àdírẹ́sì IPv6",cidrv4:"àgbègbè IPv4",cidrv6:"àgbègbè IPv6",base64:"ọ̀rọ̀ tí a kọ́ ní base64",base64url:"ọ̀rọ̀ base64url",json_string:"ọ̀rọ̀ JSON",e164:"nọ́mbà E.164",jwt:"JWT",template_literal:"ẹ̀rọ ìbáwọlé"};return e=>{switch(e.code){case"invalid_type":return`Ìbáwọlé aṣìṣe: a ní láti fi ${e.expected}, àmọ̀ a rí ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"nọ́mbà";case"object":if(Array.isArray(e))return"akopọ";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`Ìbáwọlé aṣìṣe: a ní láti fi ${Uh(e.values[0])}`:`Àṣàyàn aṣìṣe: yan ọ̀kan lára ${lh(e.values,"|")}`;case"too_big":{const n=e.inclusive?"<=":"<",i=t(e.origin);return i?`Tó pọ̀ jù: a ní láti jẹ́ pé ${e.origin??"iye"} ${i.verb} ${n}${e.maximum} ${i.unit}`:`Tó pọ̀ jù: a ní láti jẹ́ ${n}${e.maximum}`}case"too_small":{const n=e.inclusive?">=":">",i=t(e.origin);return i?`Kéré ju: a ní láti jẹ́ pé ${e.origin} ${i.verb} ${n}${e.minimum} ${i.unit}`:`Kéré ju: a ní láti jẹ́ ${n}${e.minimum}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`Ọ̀rọ̀ aṣìṣe: gbọ́dọ̀ bẹ̀rẹ̀ pẹ̀lú "${t.prefix}"`:"ends_with"===t.format?`Ọ̀rọ̀ aṣìṣe: gbọ́dọ̀ parí pẹ̀lú "${t.suffix}"`:"includes"===t.format?`Ọ̀rọ̀ aṣìṣe: gbọ́dọ̀ ní "${t.includes}"`:"regex"===t.format?`Ọ̀rọ̀ aṣìṣe: gbọ́dọ̀ bá àpẹẹrẹ mu ${t.pattern}`:`Aṣìṣe: ${n[t.format]??e.format}`}case"not_multiple_of":return`Nọ́mbà aṣìṣe: gbọ́dọ̀ jẹ́ èyà pípín ti ${e.divisor}`;case"unrecognized_keys":return`Bọtìnì àìmọ̀: ${lh(e.keys,", ")}`;case"invalid_key":return`Bọtìnì aṣìṣe nínú ${e.origin}`;case"invalid_union":default:return"Ìbáwọlé aṣìṣe";case"invalid_element":return`Iye aṣìṣe nínú ${e.origin}`}}};function Gy(){return{localeError:By()}}const Vy=Symbol("ZodOutput"),Zy=Symbol("ZodInput");class qy{constructor(){this._map=new Map,this._idmap=new Map}add(e,...t){const n=t[0];if(this._map.set(e,n),n&&"object"==typeof n&&"id"in n){if(this._idmap.has(n.id))throw new Error(`ID ${n.id} already exists in the registry`);this._idmap.set(n.id,e)}return this}clear(){return this._map=new Map,this._idmap=new Map,this}remove(e){const t=this._map.get(e);return t&&"object"==typeof t&&"id"in t&&this._idmap.delete(t.id),this._map.delete(e),this}get(e){const t=e._zod.parent;if(t){const n={...this.get(t)??{}};delete n.id;const i={...n,...this._map.get(e)};return Object.keys(i).length?i:void 0}return this._map.get(e)}has(e){return this._map.has(e)}}function Hy(){return new qy}const Wy=Hy();function Jy(e,t){return new e({type:"string",...jh(t)})}function Ky(e,t){return new e({type:"string",coerce:!0,...jh(t)})}function Yy(e,t){return new e({type:"string",format:"email",check:"string_format",abort:!1,...jh(t)})}function Xy(e,t){return new e({type:"string",format:"guid",check:"string_format",abort:!1,...jh(t)})}function Qy(e,t){return new e({type:"string",format:"uuid",check:"string_format",abort:!1,...jh(t)})}function e_(e,t){return new e({type:"string",format:"uuid",check:"string_format",abort:!1,version:"v4",...jh(t)})}function t_(e,t){return new e({type:"string",format:"uuid",check:"string_format",abort:!1,version:"v6",...jh(t)})}function n_(e,t){return new e({type:"string",format:"uuid",check:"string_format",abort:!1,version:"v7",...jh(t)})}function i_(e,t){return new e({type:"string",format:"url",check:"string_format",abort:!1,...jh(t)})}function r_(e,t){return new e({type:"string",format:"emoji",check:"string_format",abort:!1,...jh(t)})}function s_(e,t){return new e({type:"string",format:"nanoid",check:"string_format",abort:!1,...jh(t)})}function a_(e,t){return new e({type:"string",format:"cuid",check:"string_format",abort:!1,...jh(t)})}function o_(e,t){return new e({type:"string",format:"cuid2",check:"string_format",abort:!1,...jh(t)})}function c_(e,t){return new e({type:"string",format:"ulid",check:"string_format",abort:!1,...jh(t)})}function l_(e,t){return new e({type:"string",format:"xid",check:"string_format",abort:!1,...jh(t)})}function u_(e,t){return new e({type:"string",format:"ksuid",check:"string_format",abort:!1,...jh(t)})}function d_(e,t){return new e({type:"string",format:"ipv4",check:"string_format",abort:!1,...jh(t)})}function p_(e,t){return new e({type:"string",format:"ipv6",check:"string_format",abort:!1,...jh(t)})}function h_(e,t){return new e({type:"string",format:"cidrv4",check:"string_format",abort:!1,...jh(t)})}function f_(e,t){return new e({type:"string",format:"cidrv6",check:"string_format",abort:!1,...jh(t)})}function m_(e,t){return new e({type:"string",format:"base64",check:"string_format",abort:!1,...jh(t)})}function g_(e,t){return new e({type:"string",format:"base64url",check:"string_format",abort:!1,...jh(t)})}function v_(e,t){return new e({type:"string",format:"e164",check:"string_format",abort:!1,...jh(t)})}function y_(e,t){return new e({type:"string",format:"jwt",check:"string_format",abort:!1,...jh(t)})}const __={Any:null,Minute:-1,Second:0,Millisecond:3,Microsecond:6};function b_(e,t){return new e({type:"string",format:"datetime",check:"string_format",offset:!1,local:!1,precision:null,...jh(t)})}function w_(e,t){return new e({type:"string",format:"date",check:"string_format",...jh(t)})}function $_(e,t){return new e({type:"string",format:"time",check:"string_format",precision:null,...jh(t)})}function k_(e,t){return new e({type:"string",format:"duration",check:"string_format",...jh(t)})}function S_(e,t){return new e({type:"number",checks:[],...jh(t)})}function E_(e,t){return new e({type:"number",coerce:!0,checks:[],...jh(t)})}function I_(e,t){return new e({type:"number",check:"number_format",abort:!1,format:"safeint",...jh(t)})}function x_(e,t){return new e({type:"number",check:"number_format",abort:!1,format:"float32",...jh(t)})}function T_(e,t){return new e({type:"number",check:"number_format",abort:!1,format:"float64",...jh(t)})}function O_(e,t){return new e({type:"number",check:"number_format",abort:!1,format:"int32",...jh(t)})}function A_(e,t){return new e({type:"number",check:"number_format",abort:!1,format:"uint32",...jh(t)})}function N_(e,t){return new e({type:"boolean",...jh(t)})}function C_(e,t){return new e({type:"boolean",coerce:!0,...jh(t)})}function D_(e,t){return new e({type:"bigint",...jh(t)})}function L_(e,t){return new e({type:"bigint",coerce:!0,...jh(t)})}function R_(e,t){return new e({type:"bigint",check:"bigint_format",abort:!1,format:"int64",...jh(t)})}function j_(e,t){return new e({type:"bigint",check:"bigint_format",abort:!1,format:"uint64",...jh(t)})}function P_(e,t){return new e({type:"symbol",...jh(t)})}function U_(e,t){return new e({type:"undefined",...jh(t)})}function M_(e,t){return new e({type:"null",...jh(t)})}function z_(e){return new e({type:"any"})}function F_(e){return new e({type:"unknown"})}function B_(e,t){return new e({type:"never",...jh(t)})}function G_(e,t){return new e({type:"void",...jh(t)})}function V_(e,t){return new e({type:"date",...jh(t)})}function Z_(e,t){return new e({type:"date",coerce:!0,...jh(t)})}function q_(e,t){return new e({type:"nan",...jh(t)})}function H_(e,t){return new pm({check:"less_than",...jh(t),value:e,inclusive:!1})}function W_(e,t){return new pm({check:"less_than",...jh(t),value:e,inclusive:!0})}function J_(e,t){return new hm({check:"greater_than",...jh(t),value:e,inclusive:!1})}function K_(e,t){return new hm({check:"greater_than",...jh(t),value:e,inclusive:!0})}function Y_(e){return J_(0,e)}function X_(e){return H_(0,e)}function Q_(e){return W_(0,e)}function eb(e){return K_(0,e)}function tb(e,t){return new fm({check:"multiple_of",...jh(t),value:e})}function nb(e,t){return new vm({check:"max_size",...jh(t),maximum:e})}function ib(e,t){return new ym({check:"min_size",...jh(t),minimum:e})}function rb(e,t){return new _m({check:"size_equals",...jh(t),size:e})}function sb(e,t){return new bm({check:"max_length",...jh(t),maximum:e})}function ab(e,t){return new wm({check:"min_length",...jh(t),minimum:e})}function ob(e,t){return new $m({check:"length_equals",...jh(t),length:e})}function cb(e,t){return new Sm({check:"string_format",format:"regex",...jh(t),pattern:e})}function lb(e){return new Em({check:"string_format",format:"lowercase",...jh(e)})}function ub(e){return new Im({check:"string_format",format:"uppercase",...jh(e)})}function db(e,t){return new xm({check:"string_format",format:"includes",...jh(t),includes:e})}function pb(e,t){return new Tm({check:"string_format",format:"starts_with",...jh(t),prefix:e})}function hb(e,t){return new Om({check:"string_format",format:"ends_with",...jh(t),suffix:e})}function fb(e,t,n){return new Nm({check:"property",property:e,schema:t,...jh(n)})}function mb(e,t){return new Cm({check:"mime_type",mime:e,...jh(t)})}function gb(e){return new Dm({check:"overwrite",tx:e})}function vb(e){return gb(t=>t.normalize(e))}function yb(){return gb(e=>e.trim())}function _b(){return gb(e=>e.toLowerCase())}function bb(){return gb(e=>e.toUpperCase())}function wb(e,t,n){return new e({type:"array",element:t,...jh(n)})}function $b(e,t,n){return new e({type:"union",options:t,...jh(n)})}function kb(e,t,n,i){return new e({type:"union",options:n,discriminator:t,...jh(i)})}function Sb(e,t,n){return new e({type:"intersection",left:t,right:n})}function Eb(e,t,n,i){const r=n instanceof jm;return new e({type:"tuple",items:t,rest:r?n:null,...jh(r?i:n)})}function Ib(e,t,n,i){return new e({type:"record",keyType:t,valueType:n,...jh(i)})}function xb(e,t,n,i){return new e({type:"map",keyType:t,valueType:n,...jh(i)})}function Tb(e,t,n){return new e({type:"set",valueType:t,...jh(n)})}function Ob(e,t,n){return new e({type:"enum",entries:Array.isArray(t)?Object.fromEntries(t.map(e=>[e,e])):t,...jh(n)})}function Ab(e,t,n){return new e({type:"enum",entries:t,...jh(n)})}function Nb(e,t,n){return new e({type:"literal",values:Array.isArray(t)?t:[t],...jh(n)})}function Cb(e,t){return new e({type:"file",...jh(t)})}function Db(e,t){return new e({type:"transform",transform:t})}function Lb(e,t){return new e({type:"optional",innerType:t})}function Rb(e,t){return new e({type:"nullable",innerType:t})}function jb(e,t,n){return new e({type:"default",innerType:t,get defaultValue(){return"function"==typeof n?n():Oh(n)}})}function Pb(e,t,n){return new e({type:"nonoptional",innerType:t,...jh(n)})}function Ub(e,t){return new e({type:"success",innerType:t})}function Mb(e,t,n){return new e({type:"catch",innerType:t,catchValue:"function"==typeof n?n:()=>n})}function zb(e,t,n){return new e({type:"pipe",in:t,out:n})}function Fb(e,t){return new e({type:"readonly",innerType:t})}function Bb(e,t,n){return new e({type:"template_literal",parts:t,...jh(n)})}function Gb(e,t){return new e({type:"lazy",getter:t})}function Vb(e,t){return new e({type:"promise",innerType:t})}function Zb(e,t,n){const i=jh(n);i.abort??(i.abort=!0);return new e({type:"custom",check:"custom",fn:t,...i})}function qb(e,t,n){return new e({type:"custom",check:"custom",fn:t,...jh(n)})}function Hb(e){const t=Wb(n=>(n.addIssue=e=>{if("string"==typeof e)n.issues.push(ef(e,n.value,t._zod.def));else{const i=e;i.fatal&&(i.continue=!1),i.code??(i.code="custom"),i.input??(i.input=n.value),i.inst??(i.inst=t),i.continue??(i.continue=!t._zod.def.abort),n.issues.push(ef(i))}},e(n.value,n)));return t}function Wb(e,t){const n=new um({check:"custom",...jh(t)});return n._zod.check=e,n}function Jb(e,t){const n=jh(t);let i=n.truthy??["true","1","yes","on","y","enabled"],r=n.falsy??["false","0","no","off","n","disabled"];"sensitive"!==n.case&&(i=i.map(e=>"string"==typeof e?e.toLowerCase():e),r=r.map(e=>"string"==typeof e?e.toLowerCase():e));const s=new Set(i),a=new Set(r),o=e.Pipe??iv,c=e.Boolean??fg,l=e.String??Pm,u=new(e.Transform??Zg)({type:"transform",transform:(e,t)=>{let i=e;return"sensitive"!==n.case&&(i=i.toLowerCase()),!!s.has(i)||!a.has(i)&&(t.issues.push({code:"invalid_value",expected:"stringbool",values:[...s,...a],input:t.value,inst:u,continue:!1}),{})},error:n.error}),d=new o({type:"pipe",in:new l({type:"string",error:n.error}),out:u,error:n.error});return new o({type:"pipe",in:d,out:new c({type:"boolean",error:n.error}),error:n.error})}function Kb(e,t,n,i={}){const r=jh(i),s={...jh(i),check:"string_format",type:"string",format:t,fn:"function"==typeof n?n:e=>n.test(e),...r};n instanceof RegExp&&(s.pattern=n);return new e(s)}class Yb{constructor(e){this._def=e,this.def=e}implement(e){if("function"!=typeof e)throw new Error("implement() must be called with a function");const t=(...n)=>{const i=this._def.input?hf(this._def.input,n,void 0,{callee:t}):n;if(!Array.isArray(i))throw new Error("Invalid arguments schema: not an array or tuple schema.");const r=e(...i);return this._def.output?hf(this._def.output,r,void 0,{callee:t}):r};return t}implementAsync(e){if("function"!=typeof e)throw new Error("implement() must be called with a function");const t=async(...n)=>{const i=this._def.input?await mf(this._def.input,n,void 0,{callee:t}):n;if(!Array.isArray(i))throw new Error("Invalid arguments schema: not an array or tuple schema.");const r=await e(...i);return this._def.output?mf(this._def.output,r,void 0,{callee:t}):r};return t}input(...e){const t=this.constructor;return Array.isArray(e[0])?new t({type:"function",input:new Rg({type:"tuple",items:e[0],rest:e[1]}),output:this._def.output}):new t({type:"function",input:e[0],output:this._def.output})}output(e){return new(0,this.constructor)({type:"function",input:this._def.input,output:e})}}function Xb(e){return new Yb({type:"function",input:Array.isArray(e?.input)?Eb(Rg,e?.input):e?.input??wb(Ig,F_(wg)),output:e?.output??F_(wg)})}class Qb{constructor(e){this.counter=0,this.metadataRegistry=e?.metadata??Wy,this.target=e?.target??"draft-2020-12",this.unrepresentable=e?.unrepresentable??"throw",this.override=e?.override??(()=>{}),this.io=e?.io??"output",this.seen=new Map}process(e,t={path:[],schemaPath:[]}){var n;const i=e._zod.def,r={guid:"uuid",url:"uri",datetime:"date-time",json_string:"json-string",regex:""},s=this.seen.get(e);if(s){s.count++;return t.schemaPath.includes(e)&&(s.cycle=t.path),s.schema}const a={schema:{},count:1,cycle:void 0,path:t.path};this.seen.set(e,a);const o=e._zod.toJSONSchema?.();if(o)a.schema=o;else{const n={...t,schemaPath:[...t.schemaPath,e],path:t.path},s=e._zod.parent;if(s)a.ref=s,this.process(s,n),this.seen.get(s).isParent=!0;else{const t=a.schema;switch(i.type){case"string":{const n=t;n.type="string";const{minimum:i,maximum:s,format:o,patterns:c,contentEncoding:l}=e._zod.bag;if("number"==typeof i&&(n.minLength=i),"number"==typeof s&&(n.maxLength=s),o&&(n.format=r[o]??o,""===n.format&&delete n.format),l&&(n.contentEncoding=l),c&&c.size>0){const e=[...c];1===e.length?n.pattern=e[0].source:e.length>1&&(a.schema.allOf=[...e.map(e=>({..."draft-7"===this.target||"draft-4"===this.target?{type:"string"}:{},pattern:e.source}))])}break}case"number":{const n=t,{minimum:i,maximum:r,format:s,multipleOf:a,exclusiveMaximum:o,exclusiveMinimum:c}=e._zod.bag;"string"==typeof s&&s.includes("int")?n.type="integer":n.type="number","number"==typeof c&&("draft-4"===this.target?(n.minimum=c,n.exclusiveMinimum=!0):n.exclusiveMinimum=c),"number"==typeof i&&(n.minimum=i,"number"==typeof c&&"draft-4"!==this.target&&(c>=i?delete n.minimum:delete n.exclusiveMinimum)),"number"==typeof o&&("draft-4"===this.target?(n.maximum=o,n.exclusiveMaximum=!0):n.exclusiveMaximum=o),"number"==typeof r&&(n.maximum=r,"number"==typeof o&&"draft-4"!==this.target&&(o<=r?delete n.maximum:delete n.exclusiveMaximum)),"number"==typeof a&&(n.multipleOf=a);break}case"boolean":t.type="boolean";break;case"bigint":if("throw"===this.unrepresentable)throw new Error("BigInt cannot be represented in JSON Schema");break;case"symbol":if("throw"===this.unrepresentable)throw new Error("Symbols cannot be represented in JSON Schema");break;case"null":t.type="null";break;case"any":case"unknown":break;case"undefined":if("throw"===this.unrepresentable)throw new Error("Undefined cannot be represented in JSON Schema");break;case"void":if("throw"===this.unrepresentable)throw new Error("Void cannot be represented in JSON Schema");break;case"never":t.not={};break;case"date":if("throw"===this.unrepresentable)throw new Error("Date cannot be represented in JSON Schema");break;case"array":{const r=t,{minimum:s,maximum:a}=e._zod.bag;"number"==typeof s&&(r.minItems=s),"number"==typeof a&&(r.maxItems=a),r.type="array",r.items=this.process(i.element,{...n,path:[...n.path,"items"]});break}case"object":{const e=t;e.type="object",e.properties={};const r=i.shape;for(const t in r)e.properties[t]=this.process(r[t],{...n,path:[...n.path,"properties",t]});const s=new Set(Object.keys(r)),a=new Set([...s].filter(e=>{const t=i.shape[e]._zod;return"input"===this.io?void 0===t.optin:void 0===t.optout}));a.size>0&&(e.required=Array.from(a)),"never"===i.catchall?._zod.def.type?e.additionalProperties=!1:i.catchall?i.catchall&&(e.additionalProperties=this.process(i.catchall,{...n,path:[...n.path,"additionalProperties"]})):"output"===this.io&&(e.additionalProperties=!1);break}case"union":t.anyOf=i.options.map((e,t)=>this.process(e,{...n,path:[...n.path,"anyOf",t]}));break;case"intersection":{const e=t,r=this.process(i.left,{...n,path:[...n.path,"allOf",0]}),s=this.process(i.right,{...n,path:[...n.path,"allOf",1]}),a=e=>"allOf"in e&&1===Object.keys(e).length,o=[...a(r)?r.allOf:[r],...a(s)?s.allOf:[s]];e.allOf=o;break}case"tuple":{const r=t;r.type="array";const s=i.items.map((e,t)=>this.process(e,{...n,path:[...n.path,"prefixItems",t]}));if("draft-2020-12"===this.target?r.prefixItems=s:r.items=s,i.rest){const e=this.process(i.rest,{...n,path:[...n.path,"items"]});"draft-2020-12"===this.target?r.items=e:r.additionalItems=e}i.rest&&(r.items=this.process(i.rest,{...n,path:[...n.path,"items"]}));const{minimum:a,maximum:o}=e._zod.bag;"number"==typeof a&&(r.minItems=a),"number"==typeof o&&(r.maxItems=o);break}case"record":{const e=t;e.type="object","draft-4"!==this.target&&(e.propertyNames=this.process(i.keyType,{...n,path:[...n.path,"propertyNames"]})),e.additionalProperties=this.process(i.valueType,{...n,path:[...n.path,"additionalProperties"]});break}case"map":if("throw"===this.unrepresentable)throw new Error("Map cannot be represented in JSON Schema");break;case"set":if("throw"===this.unrepresentable)throw new Error("Set cannot be represented in JSON Schema");break;case"enum":{const e=t,n=ch(i.entries);n.every(e=>"number"==typeof e)&&(e.type="number"),n.every(e=>"string"==typeof e)&&(e.type="string"),e.enum=n;break}case"literal":{const e=t,n=[];for(const e of i.values)if(void 0===e){if("throw"===this.unrepresentable)throw new Error("Literal `undefined` cannot be represented in JSON Schema")}else if("bigint"==typeof e){if("throw"===this.unrepresentable)throw new Error("BigInt literals cannot be represented in JSON Schema");n.push(Number(e))}else n.push(e);if(0===n.length);else if(1===n.length){const t=n[0];e.type=null===t?"null":typeof t,"draft-4"===this.target?e.enum=[t]:e.const=t}else n.every(e=>"number"==typeof e)&&(e.type="number"),n.every(e=>"string"==typeof e)&&(e.type="string"),n.every(e=>"boolean"==typeof e)&&(e.type="string"),n.every(e=>null===e)&&(e.type="null"),e.enum=n;break}case"file":{const n=t,i={type:"string",format:"binary",contentEncoding:"binary"},{minimum:r,maximum:s,mime:a}=e._zod.bag;void 0!==r&&(i.minLength=r),void 0!==s&&(i.maxLength=s),a?1===a.length?(i.contentMediaType=a[0],Object.assign(n,i)):n.anyOf=a.map(e=>({...i,contentMediaType:e})):Object.assign(n,i);break}case"transform":if("throw"===this.unrepresentable)throw new Error("Transforms cannot be represented in JSON Schema");break;case"nullable":{const e=this.process(i.innerType,n);t.anyOf=[e,{type:"null"}];break}case"nonoptional":case"promise":case"optional":this.process(i.innerType,n),a.ref=i.innerType;break;case"success":t.type="boolean";break;case"default":this.process(i.innerType,n),a.ref=i.innerType,t.default=JSON.parse(JSON.stringify(i.defaultValue));break;case"prefault":this.process(i.innerType,n),a.ref=i.innerType,"input"===this.io&&(t._prefault=JSON.parse(JSON.stringify(i.defaultValue)));break;case"catch":{let e;this.process(i.innerType,n),a.ref=i.innerType;try{e=i.catchValue(void 0)}catch{throw new Error("Dynamic catch values are not supported in JSON Schema")}t.default=e;break}case"nan":if("throw"===this.unrepresentable)throw new Error("NaN cannot be represented in JSON Schema");break;case"template_literal":{const n=t,i=e._zod.pattern;if(!i)throw new Error("Pattern not found in template literal");n.type="string",n.pattern=i.source;break}case"pipe":{const e="input"===this.io?"transform"===i.in._zod.def.type?i.out:i.in:i.out;this.process(e,n),a.ref=e;break}case"readonly":this.process(i.innerType,n),a.ref=i.innerType,t.readOnly=!0;break;case"lazy":{const t=e._zod.innerType;this.process(t,n),a.ref=t;break}case"custom":if("throw"===this.unrepresentable)throw new Error("Custom types cannot be represented in JSON Schema")}}}const c=this.metadataRegistry.get(e);c&&Object.assign(a.schema,c),"input"===this.io&&tw(e)&&(delete a.schema.examples,delete a.schema.default),"input"===this.io&&a.schema._prefault&&((n=a.schema).default??(n.default=a.schema._prefault)),delete a.schema._prefault;return this.seen.get(e).schema}emit(e,t){const n={cycles:t?.cycles??"ref",reused:t?.reused??"inline",external:t?.external??void 0},i=this.seen.get(e);if(!i)throw new Error("Unprocessed schema. This is a bug in Zod.");const r=e=>{const t="draft-2020-12"===this.target?"$defs":"definitions";if(n.external){const i=n.external.registry.get(e[0])?.id,r=n.external.uri??(e=>e);if(i)return{ref:r(i)};const s=e[1].defId??e[1].schema.id??"schema"+this.counter++;return e[1].defId=s,{defId:s,ref:`${r("__shared")}#/${t}/${s}`}}if(e[1]===i)return{ref:"#"};const r=`#/${t}/`,s=e[1].schema.id??"__schema"+this.counter++;return{defId:s,ref:r+s}},s=e=>{if(e[1].schema.$ref)return;const t=e[1],{ref:n,defId:i}=r(e);t.def={...t.schema},i&&(t.defId=i);const s=t.schema;for(const e in s)delete s[e];s.$ref=n};if("throw"===n.cycles)for(const e of this.seen.entries()){const t=e[1];if(t.cycle)throw new Error(`Cycle detected: #/${t.cycle?.join("/")}/<root>\n\nSet the \`cycles\` parameter to \`"ref"\` to resolve cyclical schemas with defs.`)}for(const t of this.seen.entries()){const i=t[1];if(e===t[0]){s(t);continue}if(n.external){const i=n.external.registry.get(t[0])?.id;if(e!==t[0]&&i){s(t);continue}}const r=this.metadataRegistry.get(t[0])?.id;r?s(t):(i.cycle||i.count>1&&"ref"===n.reused)&&s(t)}const a=(e,t)=>{const n=this.seen.get(e),i=n.def??n.schema,r={...i};if(null===n.ref)return;const s=n.ref;if(n.ref=null,s){a(s,t);const e=this.seen.get(s).schema;!e.$ref||"draft-7"!==t.target&&"draft-4"!==t.target?(Object.assign(i,e),Object.assign(i,r)):(i.allOf=i.allOf??[],i.allOf.push(e))}n.isParent||this.override({zodSchema:e,jsonSchema:i,path:n.path??[]})};for(const e of[...this.seen.entries()].reverse())a(e[0],{target:this.target});const o={};if("draft-2020-12"===this.target?o.$schema="https://json-schema.org/draft/2020-12/schema":"draft-7"===this.target?o.$schema="http://json-schema.org/draft-07/schema#":"draft-4"===this.target?o.$schema="http://json-schema.org/draft-04/schema#":console.warn(`Invalid target: ${this.target}`),n.external?.uri){const t=n.external.registry.get(e)?.id;if(!t)throw new Error("Schema is missing an `id` property");o.$id=n.external.uri(t)}Object.assign(o,i.def);const c=n.external?.defs??{};for(const e of this.seen.entries()){const t=e[1];t.def&&t.defId&&(c[t.defId]=t.def)}n.external||Object.keys(c).length>0&&("draft-2020-12"===this.target?o.$defs=c:o.definitions=c);try{return JSON.parse(JSON.stringify(o))}catch(e){throw new Error("Error converting schema to JSON.")}}}function ew(e,t){if(e instanceof qy){const n=new Qb(t),i={};for(const t of e._idmap.entries()){const[e,i]=t;n.process(i)}const r={},s={registry:e,uri:t?.uri,defs:i};for(const i of e._idmap.entries()){const[e,a]=i;r[e]=n.emit(a,{...t,external:s})}if(Object.keys(i).length>0){const e="draft-2020-12"===n.target?"$defs":"definitions";r.__shared={[e]:i}}return{schemas:r}}const n=new Qb(t);return n.process(e),n.emit(e,t)}function tw(e,t){const n=t??{seen:new Set};if(n.seen.has(e))return!1;n.seen.add(e);const i=e._zod.def;switch(i.type){case"string":case"number":case"bigint":case"boolean":case"date":case"symbol":case"undefined":case"null":case"any":case"unknown":case"never":case"void":case"literal":case"enum":case"nan":case"file":case"template_literal":case"custom":case"success":case"catch":return!1;case"array":return tw(i.element,n);case"object":for(const e in i.shape)if(tw(i.shape[e],n))return!0;return!1;case"union":for(const e of i.options)if(tw(e,n))return!0;return!1;case"intersection":return tw(i.left,n)||tw(i.right,n);case"tuple":for(const e of i.items)if(tw(e,n))return!0;return!(!i.rest||!tw(i.rest,n));case"record":case"map":return tw(i.keyType,n)||tw(i.valueType,n);case"set":return tw(i.valueType,n);case"promise":case"optional":case"nonoptional":case"nullable":case"readonly":case"default":case"prefault":return tw(i.innerType,n);case"lazy":return tw(i.getter(),n);case"transform":return!0;case"pipe":return tw(i.in,n)||tw(i.out,n)}throw new Error(`Unknown schema type: ${i.type}`)}const nw=Xp("ZodISODateTime",(e,t)=>{Km.init(e,t),ww.init(e,t)});function iw(e){return b_(nw,e)}const rw=Xp("ZodISODate",(e,t)=>{Ym.init(e,t),ww.init(e,t)});function sw(e){return w_(rw,e)}const aw=Xp("ZodISOTime",(e,t)=>{Xm.init(e,t),ww.init(e,t)});function ow(e){return $_(aw,e)}const cw=Xp("ZodISODuration",(e,t)=>{Qm.init(e,t),ww.init(e,t)});function lw(e){return k_(cw,e)}const uw=(e,t)=>{sf.init(e,t),e.name="ZodError",Object.defineProperties(e,{format:{value:t=>cf(e,t)},flatten:{value:t=>of(e,t)},addIssue:{value:t=>{e.issues.push(t),e.message=JSON.stringify(e.issues,uh,2)}},addIssues:{value:t=>{e.issues.push(...t),e.message=JSON.stringify(e.issues,uh,2)}},isEmpty:{get:()=>0===e.issues.length}})},dw=Xp("ZodError",uw),pw=Xp("ZodError",uw,{Parent:Error}),hw=pf(pw),fw=ff(pw),mw=gf(pw),gw=yf(pw),vw=Xp("ZodType",(e,t)=>(jm.init(e,t),e.def=t,Object.defineProperty(e,"_def",{value:t}),e.check=(...n)=>e.clone({...t,checks:[...t.checks??[],...n.map(e=>"function"==typeof e?{_zod:{check:e,def:{check:"custom"},onattach:[]}}:e)]}),e.clone=(t,n)=>Rh(e,t,n),e.brand=()=>e,e.register=(t,n)=>(t.add(e,n),e),e.parse=(t,n)=>hw(e,t,n,{callee:e.parse}),e.safeParse=(t,n)=>mw(e,t,n),e.parseAsync=async(t,n)=>fw(e,t,n,{callee:e.parseAsync}),e.safeParseAsync=async(t,n)=>gw(e,t,n),e.spa=e.safeParseAsync,e.refine=(t,n)=>e.check(Kk(t,n)),e.superRefine=t=>e.check(Yk(t)),e.overwrite=t=>e.check(gb(t)),e.optional=()=>wk(e),e.nullable=()=>kk(e),e.nullish=()=>wk(kk(e)),e.nonoptional=t=>Ak(e,t),e.array=()=>V$(e),e.or=t=>Y$([e,t]),e.and=t=>tk(e,t),e.transform=t=>Uk(e,_k(t)),e.default=t=>Ik(e,t),e.prefault=t=>Tk(e,t),e.catch=t=>Lk(e,t),e.pipe=t=>Uk(e,t),e.readonly=()=>zk(e),e.describe=t=>{const n=e.clone();return Wy.add(n,{description:t}),n},Object.defineProperty(e,"description",{get:()=>Wy.get(e)?.description,configurable:!0}),e.meta=(...t)=>{if(0===t.length)return Wy.get(e);const n=e.clone();return Wy.add(n,t[0]),n},e.isOptional=()=>e.safeParse(void 0).success,e.isNullable=()=>e.safeParse(null).success,e)),yw=Xp("_ZodString",(e,t)=>{Pm.init(e,t),vw.init(e,t);const n=e._zod.bag;e.format=n.format??null,e.minLength=n.minimum??null,e.maxLength=n.maximum??null,e.regex=(...t)=>e.check(cb(...t)),e.includes=(...t)=>e.check(db(...t)),e.startsWith=(...t)=>e.check(pb(...t)),e.endsWith=(...t)=>e.check(hb(...t)),e.min=(...t)=>e.check(ab(...t)),e.max=(...t)=>e.check(sb(...t)),e.length=(...t)=>e.check(ob(...t)),e.nonempty=(...t)=>e.check(ab(1,...t)),e.lowercase=t=>e.check(lb(t)),e.uppercase=t=>e.check(ub(t)),e.trim=()=>e.check(yb()),e.normalize=(...t)=>e.check(vb(...t)),e.toLowerCase=()=>e.check(_b()),e.toUpperCase=()=>e.check(bb())}),_w=Xp("ZodString",(e,t)=>{Pm.init(e,t),yw.init(e,t),e.email=t=>e.check(Yy($w,t)),e.url=t=>e.check(i_(Nw,t)),e.jwt=t=>e.check(y_(o$,t)),e.emoji=t=>e.check(r_(Dw,t)),e.guid=t=>e.check(Xy(Sw,t)),e.uuid=t=>e.check(Qy(Iw,t)),e.uuidv4=t=>e.check(e_(Iw,t)),e.uuidv6=t=>e.check(t_(Iw,t)),e.uuidv7=t=>e.check(n_(Iw,t)),e.nanoid=t=>e.check(s_(Rw,t)),e.guid=t=>e.check(Xy(Sw,t)),e.cuid=t=>e.check(a_(Pw,t)),e.cuid2=t=>e.check(o_(Mw,t)),e.ulid=t=>e.check(c_(Fw,t)),e.base64=t=>e.check(m_(t$,t)),e.base64url=t=>e.check(g_(i$,t)),e.xid=t=>e.check(l_(Gw,t)),e.ksuid=t=>e.check(u_(Zw,t)),e.ipv4=t=>e.check(d_(Hw,t)),e.ipv6=t=>e.check(p_(Jw,t)),e.cidrv4=t=>e.check(h_(Yw,t)),e.cidrv6=t=>e.check(f_(Qw,t)),e.e164=t=>e.check(v_(s$,t)),e.datetime=t=>e.check(iw(t)),e.date=t=>e.check(sw(t)),e.time=t=>e.check(ow(t)),e.duration=t=>e.check(lw(t))});function bw(e){return Jy(_w,e)}const ww=Xp("ZodStringFormat",(e,t)=>{Um.init(e,t),yw.init(e,t)}),$w=Xp("ZodEmail",(e,t)=>{Fm.init(e,t),ww.init(e,t)});function kw(e){return Yy($w,e)}const Sw=Xp("ZodGUID",(e,t)=>{Mm.init(e,t),ww.init(e,t)});function Ew(e){return Xy(Sw,e)}const Iw=Xp("ZodUUID",(e,t)=>{zm.init(e,t),ww.init(e,t)});function xw(e){return Qy(Iw,e)}function Tw(e){return e_(Iw,e)}function Ow(e){return t_(Iw,e)}function Aw(e){return n_(Iw,e)}const Nw=Xp("ZodURL",(e,t)=>{Bm.init(e,t),ww.init(e,t)});function Cw(e){return i_(Nw,e)}const Dw=Xp("ZodEmoji",(e,t)=>{Gm.init(e,t),ww.init(e,t)});function Lw(e){return r_(Dw,e)}const Rw=Xp("ZodNanoID",(e,t)=>{Vm.init(e,t),ww.init(e,t)});function jw(e){return s_(Rw,e)}const Pw=Xp("ZodCUID",(e,t)=>{Zm.init(e,t),ww.init(e,t)});function Uw(e){return a_(Pw,e)}const Mw=Xp("ZodCUID2",(e,t)=>{qm.init(e,t),ww.init(e,t)});function zw(e){return o_(Mw,e)}const Fw=Xp("ZodULID",(e,t)=>{Hm.init(e,t),ww.init(e,t)});function Bw(e){return c_(Fw,e)}const Gw=Xp("ZodXID",(e,t)=>{Wm.init(e,t),ww.init(e,t)});function Vw(e){return l_(Gw,e)}const Zw=Xp("ZodKSUID",(e,t)=>{Jm.init(e,t),ww.init(e,t)});function qw(e){return u_(Zw,e)}const Hw=Xp("ZodIPv4",(e,t)=>{eg.init(e,t),ww.init(e,t)});function Ww(e){return d_(Hw,e)}const Jw=Xp("ZodIPv6",(e,t)=>{tg.init(e,t),ww.init(e,t)});function Kw(e){return p_(Jw,e)}const Yw=Xp("ZodCIDRv4",(e,t)=>{ng.init(e,t),ww.init(e,t)});function Xw(e){return h_(Yw,e)}const Qw=Xp("ZodCIDRv6",(e,t)=>{ig.init(e,t),ww.init(e,t)});function e$(e){return f_(Qw,e)}const t$=Xp("ZodBase64",(e,t)=>{sg.init(e,t),ww.init(e,t)});function n$(e){return m_(t$,e)}const i$=Xp("ZodBase64URL",(e,t)=>{og.init(e,t),ww.init(e,t)});function r$(e){return g_(i$,e)}const s$=Xp("ZodE164",(e,t)=>{cg.init(e,t),ww.init(e,t)});function a$(e){return v_(s$,e)}const o$=Xp("ZodJWT",(e,t)=>{ug.init(e,t),ww.init(e,t)});function c$(e){return y_(o$,e)}const l$=Xp("ZodCustomStringFormat",(e,t)=>{dg.init(e,t),ww.init(e,t)});function u$(e,t,n={}){return Kb(l$,e,t,n)}function d$(e){return Kb(l$,"hostname",Hf,e)}const p$=Xp("ZodNumber",(e,t)=>{pg.init(e,t),vw.init(e,t),e.gt=(t,n)=>e.check(J_(t,n)),e.gte=(t,n)=>e.check(K_(t,n)),e.min=(t,n)=>e.check(K_(t,n)),e.lt=(t,n)=>e.check(H_(t,n)),e.lte=(t,n)=>e.check(W_(t,n)),e.max=(t,n)=>e.check(W_(t,n)),e.int=t=>e.check(m$(t)),e.safe=t=>e.check(m$(t)),e.positive=t=>e.check(J_(0,t)),e.nonnegative=t=>e.check(K_(0,t)),e.negative=t=>e.check(H_(0,t)),e.nonpositive=t=>e.check(W_(0,t)),e.multipleOf=(t,n)=>e.check(tb(t,n)),e.step=(t,n)=>e.check(tb(t,n)),e.finite=()=>e;const n=e._zod.bag;e.minValue=Math.max(n.minimum??Number.NEGATIVE_INFINITY,n.exclusiveMinimum??Number.NEGATIVE_INFINITY)??null,e.maxValue=Math.min(n.maximum??Number.POSITIVE_INFINITY,n.exclusiveMaximum??Number.POSITIVE_INFINITY)??null,e.isInt=(n.format??"").includes("int")||Number.isSafeInteger(n.multipleOf??.5),e.isFinite=!0,e.format=n.format??null});function h$(e){return S_(p$,e)}const f$=Xp("ZodNumberFormat",(e,t)=>{hg.init(e,t),p$.init(e,t)});function m$(e){return I_(f$,e)}function g$(e){return x_(f$,e)}function v$(e){return T_(f$,e)}function y$(e){return O_(f$,e)}function _$(e){return A_(f$,e)}const b$=Xp("ZodBoolean",(e,t)=>{fg.init(e,t),vw.init(e,t)});function w$(e){return N_(b$,e)}const $$=Xp("ZodBigInt",(e,t)=>{mg.init(e,t),vw.init(e,t),e.gte=(t,n)=>e.check(K_(t,n)),e.min=(t,n)=>e.check(K_(t,n)),e.gt=(t,n)=>e.check(J_(t,n)),e.gte=(t,n)=>e.check(K_(t,n)),e.min=(t,n)=>e.check(K_(t,n)),e.lt=(t,n)=>e.check(H_(t,n)),e.lte=(t,n)=>e.check(W_(t,n)),e.max=(t,n)=>e.check(W_(t,n)),e.positive=t=>e.check(J_(BigInt(0),t)),e.negative=t=>e.check(H_(BigInt(0),t)),e.nonpositive=t=>e.check(W_(BigInt(0),t)),e.nonnegative=t=>e.check(K_(BigInt(0),t)),e.multipleOf=(t,n)=>e.check(tb(t,n));const n=e._zod.bag;e.minValue=n.minimum??null,e.maxValue=n.maximum??null,e.format=n.format??null});function k$(e){return D_($$,e)}const S$=Xp("ZodBigIntFormat",(e,t)=>{gg.init(e,t),$$.init(e,t)});function E$(e){return R_(S$,e)}function I$(e){return j_(S$,e)}const x$=Xp("ZodSymbol",(e,t)=>{vg.init(e,t),vw.init(e,t)});function T$(e){return P_(x$,e)}const O$=Xp("ZodUndefined",(e,t)=>{yg.init(e,t),vw.init(e,t)});function A$(e){return U_(O$,e)}const N$=Xp("ZodNull",(e,t)=>{_g.init(e,t),vw.init(e,t)});function C$(e){return M_(N$,e)}const D$=Xp("ZodAny",(e,t)=>{bg.init(e,t),vw.init(e,t)});function L$(){return z_(D$)}const R$=Xp("ZodUnknown",(e,t)=>{wg.init(e,t),vw.init(e,t)});function j$(){return F_(R$)}const P$=Xp("ZodNever",(e,t)=>{$g.init(e,t),vw.init(e,t)});function U$(e){return B_(P$,e)}const M$=Xp("ZodVoid",(e,t)=>{kg.init(e,t),vw.init(e,t)});function z$(e){return G_(M$,e)}const F$=Xp("ZodDate",(e,t)=>{Sg.init(e,t),vw.init(e,t),e.min=(t,n)=>e.check(K_(t,n)),e.max=(t,n)=>e.check(W_(t,n));const n=e._zod.bag;e.minDate=n.minimum?new Date(n.minimum):null,e.maxDate=n.maximum?new Date(n.maximum):null});function B$(e){return V_(F$,e)}const G$=Xp("ZodArray",(e,t)=>{Ig.init(e,t),vw.init(e,t),e.element=t.element,e.min=(t,n)=>e.check(ab(t,n)),e.nonempty=t=>e.check(ab(1,t)),e.max=(t,n)=>e.check(sb(t,n)),e.length=(t,n)=>e.check(ob(t,n)),e.unwrap=()=>e.element});function V$(e,t){return wb(G$,e,t)}function Z$(e){const t=e._zod.def.shape;return pk(Object.keys(t))}const q$=Xp("ZodObject",(e,t)=>{Tg.init(e,t),vw.init(e,t),gh(e,"shape",()=>t.shape),e.keyof=()=>pk(Object.keys(e._zod.def.shape)),e.catchall=t=>e.clone({...e._zod.def,catchall:t}),e.passthrough=()=>e.clone({...e._zod.def,catchall:j$()}),e.loose=()=>e.clone({...e._zod.def,catchall:j$()}),e.strict=()=>e.clone({...e._zod.def,catchall:U$()}),e.strip=()=>e.clone({...e._zod.def,catchall:void 0}),e.extend=t=>Vh(e,t),e.merge=t=>Zh(e,t),e.pick=t=>Bh(e,t),e.omit=t=>Gh(e,t),e.partial=(...t)=>qh(bk,e,t[0]),e.required=(...t)=>Hh(Ok,e,t[0])});function H$(e,t){const n={type:"object",get shape(){return yh(this,"shape",e?vh(e):{}),this.shape},...jh(t)};return new q$(n)}function W$(e,t){return new q$({type:"object",get shape(){return yh(this,"shape",vh(e)),this.shape},catchall:U$(),...jh(t)})}function J$(e,t){return new q$({type:"object",get shape(){return yh(this,"shape",vh(e)),this.shape},catchall:j$(),...jh(t)})}const K$=Xp("ZodUnion",(e,t)=>{Ag.init(e,t),vw.init(e,t),e.options=t.options});function Y$(e,t){return new K$({type:"union",options:e,...jh(t)})}const X$=Xp("ZodDiscriminatedUnion",(e,t)=>{K$.init(e,t),Ng.init(e,t)});function Q$(e,t,n){return new X$({type:"union",options:t,discriminator:e,...jh(n)})}const ek=Xp("ZodIntersection",(e,t)=>{Cg.init(e,t),vw.init(e,t)});function tk(e,t){return new ek({type:"intersection",left:e,right:t})}const nk=Xp("ZodTuple",(e,t)=>{Rg.init(e,t),vw.init(e,t),e.rest=t=>e.clone({...e._zod.def,rest:t})});function ik(e,t,n){const i=t instanceof jm;return new nk({type:"tuple",items:e,rest:i?t:null,...jh(i?n:t)})}const rk=Xp("ZodRecord",(e,t)=>{Pg.init(e,t),vw.init(e,t),e.keyType=t.keyType,e.valueType=t.valueType});function sk(e,t,n){return new rk({type:"record",keyType:e,valueType:t,...jh(n)})}function ak(e,t,n){const i=Rh(e);return i._zod.values=void 0,new rk({type:"record",keyType:i,valueType:t,...jh(n)})}const ok=Xp("ZodMap",(e,t)=>{Ug.init(e,t),vw.init(e,t),e.keyType=t.keyType,e.valueType=t.valueType});function ck(e,t,n){return new ok({type:"map",keyType:e,valueType:t,...jh(n)})}const lk=Xp("ZodSet",(e,t)=>{zg.init(e,t),vw.init(e,t),e.min=(...t)=>e.check(ib(...t)),e.nonempty=t=>e.check(ib(1,t)),e.max=(...t)=>e.check(nb(...t)),e.size=(...t)=>e.check(rb(...t))});function uk(e,t){return new lk({type:"set",valueType:e,...jh(t)})}const dk=Xp("ZodEnum",(e,t)=>{Bg.init(e,t),vw.init(e,t),e.enum=t.entries,e.options=Object.values(t.entries);const n=new Set(Object.keys(t.entries));e.extract=(e,i)=>{const r={};for(const i of e){if(!n.has(i))throw new Error(`Key ${i} not found in enum`);r[i]=t.entries[i]}return new dk({...t,checks:[],...jh(i),entries:r})},e.exclude=(e,i)=>{const r={...t.entries};for(const t of e){if(!n.has(t))throw new Error(`Key ${t} not found in enum`);delete r[t]}return new dk({...t,checks:[],...jh(i),entries:r})}});function pk(e,t){const n=Array.isArray(e)?Object.fromEntries(e.map(e=>[e,e])):e;return new dk({type:"enum",entries:n,...jh(t)})}function hk(e,t){return new dk({type:"enum",entries:e,...jh(t)})}const fk=Xp("ZodLiteral",(e,t)=>{Gg.init(e,t),vw.init(e,t),e.values=new Set(t.values),Object.defineProperty(e,"value",{get(){if(t.values.length>1)throw new Error("This schema contains multiple valid literal values. Use `.values` instead.");return t.values[0]}})});function mk(e,t){return new fk({type:"literal",values:Array.isArray(e)?e:[e],...jh(t)})}const gk=Xp("ZodFile",(e,t)=>{Vg.init(e,t),vw.init(e,t),e.min=(t,n)=>e.check(ib(t,n)),e.max=(t,n)=>e.check(nb(t,n)),e.mime=(t,n)=>e.check(mb(Array.isArray(t)?t:[t],n))});function vk(e){return Cb(gk,e)}const yk=Xp("ZodTransform",(e,t)=>{Zg.init(e,t),vw.init(e,t),e._zod.parse=(n,i)=>{n.addIssue=i=>{if("string"==typeof i)n.issues.push(ef(i,n.value,t));else{const t=i;t.fatal&&(t.continue=!1),t.code??(t.code="custom"),t.input??(t.input=n.value),t.inst??(t.inst=e),n.issues.push(ef(t))}};const r=t.transform(n.value,n);return r instanceof Promise?r.then(e=>(n.value=e,n)):(n.value=r,n)}});function _k(e){return new yk({type:"transform",transform:e})}const bk=Xp("ZodOptional",(e,t)=>{Hg.init(e,t),vw.init(e,t),e.unwrap=()=>e._zod.def.innerType});function wk(e){return new bk({type:"optional",innerType:e})}const $k=Xp("ZodNullable",(e,t)=>{Wg.init(e,t),vw.init(e,t),e.unwrap=()=>e._zod.def.innerType});function kk(e){return new $k({type:"nullable",innerType:e})}function Sk(e){return wk(kk(e))}const Ek=Xp("ZodDefault",(e,t)=>{Jg.init(e,t),vw.init(e,t),e.unwrap=()=>e._zod.def.innerType,e.removeDefault=e.unwrap});function Ik(e,t){return new Ek({type:"default",innerType:e,get defaultValue(){return"function"==typeof t?t():Oh(t)}})}const xk=Xp("ZodPrefault",(e,t)=>{Yg.init(e,t),vw.init(e,t),e.unwrap=()=>e._zod.def.innerType});function Tk(e,t){return new xk({type:"prefault",innerType:e,get defaultValue(){return"function"==typeof t?t():Oh(t)}})}const Ok=Xp("ZodNonOptional",(e,t)=>{Xg.init(e,t),vw.init(e,t),e.unwrap=()=>e._zod.def.innerType});function Ak(e,t){return new Ok({type:"nonoptional",innerType:e,...jh(t)})}const Nk=Xp("ZodSuccess",(e,t)=>{ev.init(e,t),vw.init(e,t),e.unwrap=()=>e._zod.def.innerType});function Ck(e){return new Nk({type:"success",innerType:e})}const Dk=Xp("ZodCatch",(e,t)=>{tv.init(e,t),vw.init(e,t),e.unwrap=()=>e._zod.def.innerType,e.removeCatch=e.unwrap});function Lk(e,t){return new Dk({type:"catch",innerType:e,catchValue:"function"==typeof t?t:()=>t})}const Rk=Xp("ZodNaN",(e,t)=>{nv.init(e,t),vw.init(e,t)});function jk(e){return q_(Rk,e)}const Pk=Xp("ZodPipe",(e,t)=>{iv.init(e,t),vw.init(e,t),e.in=t.in,e.out=t.out});function Uk(e,t){return new Pk({type:"pipe",in:e,out:t})}const Mk=Xp("ZodReadonly",(e,t)=>{sv.init(e,t),vw.init(e,t),e.unwrap=()=>e._zod.def.innerType});function zk(e){return new Mk({type:"readonly",innerType:e})}const Fk=Xp("ZodTemplateLiteral",(e,t)=>{ov.init(e,t),vw.init(e,t)});function Bk(e,t){return new Fk({type:"template_literal",parts:e,...jh(t)})}const Gk=Xp("ZodLazy",(e,t)=>{lv.init(e,t),vw.init(e,t),e.unwrap=()=>e._zod.def.getter()});function Vk(e){return new Gk({type:"lazy",getter:e})}const Zk=Xp("ZodPromise",(e,t)=>{cv.init(e,t),vw.init(e,t),e.unwrap=()=>e._zod.def.innerType});function qk(e){return new Zk({type:"promise",innerType:e})}const Hk=Xp("ZodCustom",(e,t)=>{uv.init(e,t),vw.init(e,t)});function Wk(e){const t=new um({check:"custom"});return t._zod.check=e,t}function Jk(e,t){return Zb(Hk,e??(()=>!0),t)}function Kk(e,t={}){return qb(Hk,e,t)}function Yk(e){return Hb(e)}function Xk(e,t={error:`Input not instance of ${e.name}`}){const n=new Hk({type:"custom",check:"custom",fn:t=>t instanceof e,abort:!0,...jh(t)});return n._zod.bag.Class=e,n}const Qk=(...e)=>Jb({Pipe:Pk,Boolean:b$,String:_w,Transform:yk},...e);function eS(e){const t=Vk(()=>Y$([bw(e),h$(),w$(),C$(),V$(t),sk(bw(),t)]));return t}function tS(e,t){return Uk(_k(e),t)}const nS={invalid_type:"invalid_type",too_big:"too_big",too_small:"too_small",invalid_format:"invalid_format",not_multiple_of:"not_multiple_of",unrecognized_keys:"unrecognized_keys",invalid_union:"invalid_union",invalid_key:"invalid_key",invalid_element:"invalid_element",invalid_value:"invalid_value",custom:"custom"};function iS(e){nh({customError:e})}function rS(){return nh().customError}var sS;function aS(e){return Ky(_w,e)}function oS(e){return E_(p$,e)}function cS(e){return C_(b$,e)}function lS(e){return L_($$,e)}function uS(e){return Z_(F$,e)}sS||(sS={}),nh(Tv());const dS=Et,pS={enabled_extension:!0,render:{...jn},script:{global_script_enabled:!0,scriptsRepository:[],characters_with_scripts:[]},audio:{audio_enabled:!0,bgm_enabled:!0,ambient_enabled:!0,bgm_mode:"repeat",bgm_muted:!1,bgm_volume:50,bgm_selected:null,bgm_current_time:0,ambient_mode:"stop",ambient_muted:!1,ambient_volume:50,ambient_selected:null,ambient_current_time:0,audio_cooldown:0},macro:{replace:!0},debug:{enabled:!1}},hS=`${Ot}/src/component`;function fS(e){let t=$(e.currentTarget).attr("id");if(void 0!==t)switch(t=t.replace("-settings-title",""),$("#main-settings-title").removeClass("title-item-active"),$("#render-settings-title").removeClass("title-item-active"),$("#script-settings-title").removeClass("title-item-active"),$("#toolbox-settings-title").removeClass("title-item-active"),$("#main-settings-content").hide(),$("#render-settings-content").hide(),$("#script-settings-content").hide(),$("#toolbox-settings-content").hide(),t){case"main":$("#main-settings-title").addClass("title-item-active"),$("#main-settings-content").show();break;case"render":$("#render-settings-title").addClass("title-item-active"),$("#render-settings-content").show();break;case"script":$("#script-settings-title").addClass("title-item-active"),$("#script-settings-content").show();break;case"toolbox":$("#toolbox-settings-title").addClass("title-item-active"),$("#toolbox-settings-content").show()}}async function mS(){const e=await mp(lp);$(".version").text(`Ver ${e}`);const t=await async function(){try{dp=fp(await hp(op));const e=gp(dp,up);return e>0?(Pt().info(`[TavernHelper] 需要更新！最新版本 ${dp} > 当前版本 ${up}`),!0):0===e?(Pt().info(`[TavernHelper] 当前版本 ${up} 已是最新。`),!1):(Pt().warn(`[TavernHelper] 当前版本 ${up} 比远程版本 ${dp} 还新？`),!1)}catch(e){return Pt().error("[TavernHelper] 版本检查失败:",e),!1}}();t&&($("#tavern-helper-extension-container .inline-drawer-header b").append('\n    <span style="color: red; font-size: 12px; font-weight: bold;">\n      New!\n    </span>\n  '),$("#version-update-text").closest(".flex-container .alignItemsCenter").append(`\n      <div style='background-color: var(--SmartThemeQuoteColor);border-radius: 50px;padding: 0 5px;height: 50%; font-size: calc(var(--mainFontSize) * 0.7);'>\n        最新：Ver ${dp}\n      </div>\n    `)),$("#update-extension").on("click",async()=>await _p())}jQuery(async()=>{if(await async function(){const e=await Q(`${Ot}`,"index");$("#extensions_settings").append(e);const t=$(await Q(`${hS}/script_repository/public`,"index"));$("#script-settings-content").append(t);const n=$(await Q(`${hS}/message_iframe`,"index"));$("#render-settings-content").append(n);const i=$(await Q(`${hS}/variable_manager/public`,"variable_manager_entry")),r=$(await Q(`${hS}/prompt_view/public`,"prompt_view_entry")),s=$(await Q(`${hS}/audio`,"index"));$("#toolbox-settings-content").append(i).append(r).append(s);const a=$(await Q(`${hS}/reference`,"index"));$("#extension-reference").append(a)}(),Y[Tt]){const e=Y[Tt];_.has(e,"render.tampermonkey_compatibility")&&(_.unset(e,"render.tampermonkey_compatibility"),await U())}else _.set(Y,Tt,pS),_.unset(Y,xt),async function(){let e=await hp(cp);e+="\n\n*前端助手旧版配置已清除，请重新配置扩展设置*";const t=yp(e,"3.0.0","3.0.0");if(t){const e=t.replace(/<h2([^>]*)>([^<]*)<\/h2>/g,"<h2$1>酒馆助手 $2</h2>");await ie(e,ne.TEXT)}}(),await U();hu(),globalThis.log=Pt(),globalThis.YAML=Po,globalThis.z=dS,Jp(),$("#main-settings-title").addClass("title-item-active"),$("#main-settings-content").show(),$("#render-settings-content").hide(),$("#script-settings-content").hide(),$("#toolbox-settings-content").hide(),$("#main-settings-title").on("click",e=>fS(e)),$("#render-settings-title").on("click",e=>fS(e)),$("#script-settings-title").on("click",e=>fS(e)),$("#toolbox-settings-title").on("click",e=>fS(e)),p.once(h.APP_READY,async()=>{await async function(){const e=await Rt("macro.replace",pS.macro.replace);$("#macro-replace-disable-toggle").prop("checked",!e).on("click",function(){const e=$(this).prop("checked");Lt("macro.replace",!e),e?oi():ai()}),e&&ai()}(),await async function(){const e=await Rt("debug.enabled",pS.debug.enabled);$("#debug-mode-toggle").prop("checked",e).on("click",function(){const e=$(this).prop("checked");Lt("debug.enabled",e),e?Pt().enableAll():Pt().setLevel("warn")}),e?Pt().enableAll():Pt().setLevel("warn")}(),function(){const e=Dt("enabled_extension");e&&Oc(!1,!0),$("#extension-enable-toggle").prop("checked",e).on("change",function(e){Oc(!0,$(e.currentTarget).prop("checked"))})}(),await mS(),await dn(),Ce.addCommandObject(rt.fromProps({name:"audioselect",callback:Wp,namedArgumentList:[ot.fromProps({name:"type",description:"选择播放器类型 (bgm 或 ambient)",typeList:[st.STRING],enumList:[new ut("bgm",null,dt.enum,lt.file),new ut("ambient",null,dt.enum,lt.file)],isRequired:!0})],unnamedArgumentList:[new at("url",[st.STRING],!0)],helpString:"\n        <div>\n            选择并播放音频。如果音频链接不存在，则先导入再播放。\n        </div>\n        <div>\n            <strong>Example:</strong>\n            <ul>\n                <li>\n                    <pre><code>/audioselect type=bgm https://example.com/song.mp3</code></pre>\n                    选择并播放指定的音乐。\n                </li>\n                <li>\n                    <pre><code>/audioselect type=ambient https://example.com/sound.mp3</code></pre>\n                    选择并播放指定的音效。\n                </li>\n            </ul>\n        </div>\n      "})),Ce.addCommandObject(rt.fromProps({name:"audioimport",callback:Hp,namedArgumentList:[ot.fromProps({name:"type",description:"选择导入类型 (bgm 或 ambient)",typeList:[st.STRING],enumList:[new ut("bgm",null,dt.enum,lt.file),new ut("ambient",null,dt.enum,lt.file)],isRequired:!0}),ot.fromProps({name:"play",description:"导入后是否立即播放第一个链接",typeList:[st.BOOLEAN],defaultValue:"true",isRequired:!1})],unnamedArgumentList:[new at("url",[st.STRING],!0)],helpString:"\n        <div>\n            导入音频或音乐链接，并决定是否立即播放，默认为自动播放。可批量导入链接，使用英文逗号分隔。\n        </div>\n        <div>\n            <strong>Example:</strong>\n            <ul>\n                <li>\n                    <pre><code>/audioimport type=bgm https://example.com/song1.mp3,https://example.com/song2.mp3</code></pre>\n                    导入 BGM 音乐并立即播放第一个链接。\n                </li>\n                <li>\n                    <pre><code>/audioimport type=ambient play=false url=https://example.com/sound1.mp3,https://example.com/sound2.mp3 </code></pre>\n                    导入音效链接 (不自动播放)。\n                </li>\n            </ul>\n        </div>\n      "})),Ce.addCommandObject(rt.fromProps({name:"audioplay",callback:qp,namedArgumentList:[ot.fromProps({name:"type",description:"选择控制的播放器 (bgm 或 ambient)",typeList:[st.STRING],enumList:[new ut("bgm",null,dt.enum,lt.file),new ut("ambient",null,dt.enum,lt.file)],isRequired:!0}),new ot("play","播放或暂停",[st.STRING],!0,!1,"true",ct.boolean("trueFalse")())],helpString:"\n        <div>\n            控制音乐播放器或音效播放器的播放与暂停。\n        </div>\n        <div>\n            <strong>Example:</strong>\n            <ul>\n                <li>\n                    <pre><code>/audioplay type=bgm</code></pre>\n                    播放当前音乐。\n                </li>\n                <li>\n                    <pre><code>/audioplay type=ambient play=false</code></pre>\n                    暂停当前音效。\n                </li>\n            </ul>\n        </div>\n      "})),Ce.addCommandObject(rt.fromProps({name:"audioenable",callback:Zp,namedArgumentList:[ot.fromProps({name:"type",description:"选择控制的播放器 (bgm 或 ambient)",typeList:[st.STRING],enumList:[new ut("bgm",null,dt.enum,lt.file),new ut("ambient",null,dt.enum,lt.file)],isRequired:!0}),new ot("state","打开或关闭播放器",[st.STRING],!1,!1,"true",ct.boolean("trueFalse")())],helpString:"\n        <div>\n            控制音乐播放器或音效播放器的开启与关闭。\n        </div>\n        <div>\n            <strong>Example:</strong>\n            <ul>\n                <li>\n                    <pre><code>/audioenable type=bgm state=true</code></pre>\n                    打开音乐播放器。\n                </li>\n                <li>\n                    <pre><code>/audioenable type=ambient state=false</code></pre>\n                    关闭音效播放器。\n                </li>\n            </ul>\n        </div>\n    "})),Ce.addCommandObject(rt.fromProps({name:"audiomode",callback:Vp,namedArgumentList:[ot.fromProps({name:"type",description:"选择控制的播放器 (bgm 或 ambient)",typeList:[st.STRING],enumList:[new ut("bgm",null,dt.enum,lt.file),new ut("ambient",null,dt.enum,lt.file)],isRequired:!0}),ot.fromProps({name:"mode",description:"选择播放模式",typeList:[st.STRING],enumList:[new ut("repeat",null,dt.enum,lt.loop),new ut("random",null,dt.enum,lt.shuffle),new ut("single",null,dt.enum,lt.redo),new ut("stop",null,dt.enum,lt.stop)],isRequired:!0})],helpString:"\n        <div>\n            设置音频播放模式。\n        </div>\n        <div>\n            <strong>Example:</strong>\n            <ul>\n                <li>\n                    <pre><code>/audiomode type=bgm mode=repeat</code></pre>\n                    设置音乐为循环播放模式。\n                </li>\n                <li>\n                    <pre><code>/audiomode type=ambient mode=random</code></pre>\n                    设置音效为随机播放模式。\n                </li>\n                <li>\n                    <pre><code>/audiomode type=bgm mode=single</code></pre>\n                    设置音乐为单曲循环模式。\n                </li>\n                <li>\n                    <pre><code>/audiomode type=ambient mode=stop</code></pre>\n                    设置音效为停止播放模式。\n                </li>\n            </ul>\n        </div>\n    "})),Ce.addCommandObject(rt.fromProps({name:"event-emit",callback:Kp,returns:"发送的事件名称",namedArgumentList:[ot.fromProps({name:"event",description:"事件名称",typeList:[st.STRING],isRequired:!0}),ot.fromProps({name:"data",description:"要传输的数据",typeList:[st.STRING],isRequired:!1,acceptsMultiple:!0})],unnamedArgumentList:[],helpString:'\n    <div>\n        发送 `event` 事件, 同时可以发送一些数据.\n        所有正在监听该消息频道的 listener 函数都会自动运行, 并能用函数参数接收发送来的数据.\n        由于酒馆 STScript 输入方式的局限性, 所有数据将会以字符串 string 类型接收; 如果需要 number 等类型, 请自行转换.\n    </div>\n    <div>\n        <strong>Example:</strong>\n        <ul>\n            <li>\n                <pre><code class="language-stscript">/event-emit event="读档"</code></pre>\n            </li>\n            <li>\n                <pre><code class="language-stscript">/event-emit event="存档" data={{getvar::数据}} data=8 data=你好 {{user}}</code></pre>\n            </li>\n            <li>\n                <pre><code class="language-stscript">/event-emit event="随便什么名称" data="这是一个 数据" data={{user}}</code></pre>\n            </li>\n        </ul>\n    </div>\n  '})),await Bo(),await Pn(),await async function(){$("#view_tavern_helper_docs").on("click",du),$("#download_tavern_helper_types").on("click",pu)}(),await async function(){const e=$(await Q(`${Ql}`,"index"));e.find("#iframe_update_listener_enabled").prop("checked",await Rt("listener.enabled",eu)).on("click",async function(){Lt("listener.enabled",$(this).prop("checked")),lu(Dt("listener.url"))}),e.find("#iframe_update_listener_enable_echo").prop("checked",await Rt("listener.enable_echo",iu)).on("click",function(){Lt("listener.enable_echo",$(this).prop("checked"))}),e.find("#iframe_update_listener_url").val(await Rt("listener.url",tu)).on("input",async function(){lu(Lt("listener.url",String($(this).val())))}),e.find("#iframe_update_listener_duration").val(await Rt("listener.duration",nu)).on("input",async function(){Lt("listener.duration",Number($(this).val())),au()}),$("#extension-listener").append(e),au(),lu(Dt("listener.url"))}(),function(){const e=$("#open-variable-manager");e.length&&e.on("click",async()=>{await Sc()})}(),async function(){const e=$("#open-prompt-view");e.length&&e.off("click").on("click",async()=>{await ei()})}()}),It.initAll(".collapsible",{headerSelector:"div:first-child",contentSelector:".collapsible-content",initiallyExpanded:!1,animationDuration:{expand:280,collapse:250}})});
//# sourceMappingURL=index.js.map